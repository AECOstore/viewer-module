//@pilet v:2(webpackChunkpr_viewer,{})
System.register(["react"],(function(t,e){var i={};return Object.defineProperty(i,"__esModule",{value:!0}),{setters:[function(t){Object.keys(t).forEach((function(e){i[e]=t[e]}))}],execute:function(){t((()=>{var t={679:(t,e,i)=>{"use strict";var s=i(296),r={childContextTypes:!0,contextType:!0,contextTypes:!0,defaultProps:!0,displayName:!0,getDefaultProps:!0,getDerivedStateFromError:!0,getDerivedStateFromProps:!0,mixins:!0,propTypes:!0,type:!0},o={name:!0,length:!0,prototype:!0,caller:!0,callee:!0,arguments:!0,arity:!0},a={$$typeof:!0,compare:!0,defaultProps:!0,displayName:!0,propTypes:!0,type:!0},n={};function l(t){return s.isMemo(t)?a:n[t.$$typeof]||r}n[s.ForwardRef]={$$typeof:!0,render:!0,defaultProps:!0,displayName:!0,propTypes:!0},n[s.Memo]=a;var h=Object.defineProperty,u=Object.getOwnPropertyNames,c=Object.getOwnPropertySymbols,d=Object.getOwnPropertyDescriptor,p=Object.getPrototypeOf,f=Object.prototype;t.exports=function _(t,e,i){if("string"!=typeof e){if(f){var s=p(e);s&&s!==f&&_(t,s,i)}var r=u(e);c&&(r=r.concat(c(e)));for(var a=l(t),n=l(e),g=0;g<r.length;++g){var m=r[g];if(!(o[m]||i&&i[m]||n&&n[m]||a&&a[m])){var v=d(e,m);try{h(t,m,v)}catch(P){}}}}return t}},103:(t,e)=>{"use strict";var i="function"==typeof Symbol&&Symbol["for"],s=i?Symbol["for"]("react.element"):60103,r=i?Symbol["for"]("react.portal"):60106,o=i?Symbol["for"]("react.fragment"):60107,a=i?Symbol["for"]("react.strict_mode"):60108,n=i?Symbol["for"]("react.profiler"):60114,l=i?Symbol["for"]("react.provider"):60109,h=i?Symbol["for"]("react.context"):60110,u=i?Symbol["for"]("react.async_mode"):60111,c=i?Symbol["for"]("react.concurrent_mode"):60111,d=i?Symbol["for"]("react.forward_ref"):60112,p=i?Symbol["for"]("react.suspense"):60113,f=i?Symbol["for"]("react.suspense_list"):60120,_=i?Symbol["for"]("react.memo"):60115,g=i?Symbol["for"]("react.lazy"):60116,m=i?Symbol["for"]("react.block"):60121,v=i?Symbol["for"]("react.fundamental"):60117,P=i?Symbol["for"]("react.responder"):60118,b=i?Symbol["for"]("react.scope"):60119;function y(t){if("object"==typeof t&&null!==t){var e=t.$$typeof;switch(e){case s:switch(t=t.type){case u:case c:case o:case n:case a:case p:return t;default:switch(t=t&&t.$$typeof){case h:case d:case g:case _:case l:return t;default:return e}}case r:return e}}}function x(t){return y(t)===c}e.AsyncMode=u,e.ConcurrentMode=c,e.ContextConsumer=h,e.ContextProvider=l,e.Element=s,e.ForwardRef=d,e.Fragment=o,e.Lazy=g,e.Memo=_,e.Portal=r,e.Profiler=n,e.StrictMode=a,e.Suspense=p,e.isAsyncMode=function(t){return x(t)||y(t)===u},e.isConcurrentMode=x,e.isContextConsumer=function(t){return y(t)===h},e.isContextProvider=function(t){return y(t)===l},e.isElement=function(t){return"object"==typeof t&&null!==t&&t.$$typeof===s},e.isForwardRef=function(t){return y(t)===d},e.isFragment=function(t){return y(t)===o},e.isLazy=function(t){return y(t)===g},e.isMemo=function(t){return y(t)===_},e.isPortal=function(t){return y(t)===r},e.isProfiler=function(t){return y(t)===n},e.isStrictMode=function(t){return y(t)===a},e.isSuspense=function(t){return y(t)===p},e.isValidElementType=function(t){return"string"==typeof t||"function"==typeof t||t===o||t===c||t===n||t===a||t===p||t===f||"object"==typeof t&&null!==t&&(t.$$typeof===g||t.$$typeof===_||t.$$typeof===l||t.$$typeof===h||t.$$typeof===d||t.$$typeof===v||t.$$typeof===P||t.$$typeof===b||t.$$typeof===m)},e.typeOf=y},296:(t,e,i)=>{"use strict";t.exports=i(103)},418:t=>{"use strict";var e=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable;t.exports=function(){try{if(!Object.assign)return!1;var t=new String("abc");if(t[5]="de","5"===Object.getOwnPropertyNames(t)[0])return!1;for(var e={},i=0;i<10;i++)e["_"+String.fromCharCode(i)]=i;if("0123456789"!==Object.getOwnPropertyNames(e).map((function(t){return e[t]})).join(""))return!1;var s={};return"abcdefghijklmnopqrst".split("").forEach((function(t){s[t]=t})),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},s)).join("")}catch(r){return!1}}()?Object.assign:function(t,r){for(var o,a,n=function(t){if(null===t||t===undefined)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(t)}(t),l=1;l<arguments.length;l++){for(var h in o=Object(arguments[l]))i.call(o,h)&&(n[h]=o[h]);if(e){a=e(o);for(var u=0;u<a.length;u++)s.call(o,a[u])&&(n[a[u]]=o[a[u]])}}return n}},703:(t,e,i)=>{"use strict";var s=i(414);function r(){}function o(){}o.resetWarningCache=r,t.exports=function(){function t(t,e,i,r,o,a){if(a!==s){var n=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw n.name="Invariant Violation",n}}function e(){return t}t.isRequired=t;var i={array:t,bigint:t,bool:t,func:t,number:t,object:t,string:t,symbol:t,any:t,arrayOf:e,element:t,elementType:t,instanceOf:e,node:t,objectOf:e,oneOf:e,oneOfType:e,shape:e,exact:e,checkPropTypes:o,resetWarningCache:r};return i.PropTypes=i,i}},697:(t,e,i)=>{t.exports=i(703)()},414:t=>{"use strict";t.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"},251:(t,e,i)=>{"use strict";i(418);var s=i(954),r=60103;if(60107,"function"==typeof Symbol&&Symbol["for"]){var o=Symbol["for"];r=o("react.element"),o("react.fragment")}var a=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,n=Object.prototype.hasOwnProperty,l={key:!0,ref:!0,__self:!0,__source:!0};function h(t,e,i){var s,o={},h=null,u=null;for(s in void 0!==i&&(h=""+i),void 0!==e.key&&(h=""+e.key),void 0!==e.ref&&(u=e.ref),e)n.call(e,s)&&!l.hasOwnProperty(s)&&(o[s]=e[s]);if(t&&t.defaultProps)for(s in e=t.defaultProps)void 0===o[s]&&(o[s]=e[s]);return{$$typeof:r,type:t,key:h,ref:u,props:o,_owner:a.current}}e.jsx=h,e.jsxs=h},893:(t,e,i)=>{"use strict";t.exports=i(251)},722:(t,e,i)=>{const s=i(905).R;e.s=function(t){if(t||(t=1),!i.y.meta||!i.y.meta.url)throw console.error("__system_context__",i.y),Error("systemjs-webpack-interop was provided an unknown SystemJS context. Expected context.meta.url, but none was provided");i.p=s(i.y.meta.url,t)}},905:(t,e,i)=>{function s(t,e){var i=document.createElement("a");i.href=t;for(var s="/"===i.pathname[0]?i.pathname:"/"+i.pathname,r=0,o=s.length;r!==e&&o>=0;){"/"===s[--o]&&r++}if(r!==e)throw Error("systemjs-webpack-interop: rootDirectoryLevel ("+e+") is greater than the number of directories ("+r+") in the URL path "+t);var a=s.slice(0,o+1);return i.protocol+"//"+i.host+a}e.R=s;var r=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t}},954:t=>{"use strict";t.exports=i}},s={};function r(e){var i=s[e];if(i!==undefined)return i.exports;var o=s[e]={exports:{}};return t[e](o,o.exports,r),o.exports}r.y=e,r.n=t=>{var e=t&&t.__esModule?()=>t["default"]:()=>t;return r.d(e,{a:e}),e},r.d=(t,e)=>{for(var i in e)r.o(e,i)&&!r.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.p="./";var o={};return(0,r(722).s)(1),(()=>{"use strict";r.r(o),r.d(o,{setup:()=>Sp});var t=r(954);class e{constructor(t,e){this.items=t||[],this._lastUniqueId=(e||0)+1}addItem(){let t;if(2===arguments.length){const e=arguments[0];if(t=arguments[1],this.items[e])throw"ID clash: '"+e+"'";return this.items[e]=t,e}for(t=arguments[0]||{};;){const e=this._lastUniqueId++;if(!this.items[e])return this.items[e]=t,e}}removeItem(t){const e=this.items[t];return delete this.items[t],e}}const i={build:{version:"0.8"},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,models:0,meshes:0,objects:0},memory:{meshes:0,positions:0,colors:0,normals:0,uvs:0,indices:0,textures:0,transforms:0,materials:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,drawArrays:0,tasksRun:0,tasksScheduled:0}};var s=[["0",10],["A",26],["a",26],["_",1],["$",1]].map((function(t){for(var e=[],i=t[0].charCodeAt(0),s=i+t[1],r=i;r<s;++r)e.push(r);return String.fromCharCode.apply(null,e)})).join("");function a(t,e){return(e&&4!==e?[0,6]:[0,6,12,18]).map((function(e){return s.substr(parseInt(t/(1<<e))%64,1)})).reverse().join("")}const n={xmlToJson:function Dp(t,e){if(t.nodeType===t.TEXT_NODE){var i=t.nodeValue;if(null===i.match(/^\s+$/))return i}else if(t.nodeType===t.ELEMENT_NODE||t.nodeType===t.DOCUMENT_NODE){var s={type:t.nodeName,children:[]};if(t.nodeType===t.ELEMENT_NODE)for(var r=0;r<t.attributes.length;r++){var o=t.attributes[r];s[e[o.nodeName]||o.nodeName]=o.nodeValue}for(var a=0;a<t.childNodes.length;a++){(r=Dp(t.childNodes[a],e))&&s.children.push(r)}return s}},clone:function(t){return JSON.parse(JSON.stringify(t))},compressGuid:function(t){var e=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30].map((function(e){return parseInt(t.substr(e,2),16)}));return a(e[0],2)+[1,4,7,10,13].map((function(t){return a((e[t]<<16)+(e[t+1]<<8)+e[t+2])})).join("")},findNodeOfType:function(t,e){var i=[],s=function(t){t.type===e&&i.push(t),(t.children||[]).forEach((function(t){s(t)}))};return s(t),i},timeout:function(t){return new Promise((function(e,i){setTimeout(e,t)}))},httpRequest:function(t){return new Promise((function(e,i){var s=new XMLHttpRequest;s.open(t.method||"GET",t.url,!0),s.onload=function(r){console.log(t.url,s.readyState,s.status),4===s.readyState&&(200===s.status?e(s.responseXML):i(s.statusText))},s.send(null)}))},loadJSON:function(t,e,i){var s=t=>undefined;e=e||s,i=i||s;var r=new XMLHttpRequest;r.overrideMimeType("application/json"),r.open("GET",t,!0),r.addEventListener("load",(function(t){var s=t.target.response;if(200===this.status){var r;try{r=JSON.parse(s)}catch(o){i(`utils.loadJSON(): Failed to parse JSON response - ${o}`)}e(r)}else if(0===this.status){console.warn("loadFile: HTTP Status 0 received.");try{e(JSON.parse(s))}catch(o){i(`utils.loadJSON(): Failed to parse JSON response - ${o}`)}}else i(t)}),!1),r.addEventListener("error",(function(t){i(t)}),!1),r.send(null)},loadArraybuffer:function(t,e,i){var s=t=>undefined;e=e||s,i=i||s;const r=t.match(/^data:(.*?)(;base64)?,(.*)$/);if(r){const t=!!r[2];var o=r[3];o=window.decodeURIComponent(o),t&&(o=window.atob(o));try{const t=new ArrayBuffer(o.length),i=new Uint8Array(t);for(var a=0;a<o.length;a++)i[a]=o.charCodeAt(a);window.setTimeout((function(){e(t)}),0)}catch(n){window.setTimeout((function(){i(n)}),0)}}else{const s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="arraybuffer",s.onreadystatechange=function(){4===s.readyState&&(200===s.status?e(s.response):i("loadArrayBuffer error : "+s.response))},s.send(null)}},queryString:function(){for(var t={},e=window.location.search.substring(1).split("&"),i=0;i<e.length;i++){var s=e[i].split("=");if("undefined"==typeof t[s[0]])t[s[0]]=decodeURIComponent(s[1]);else if("string"==typeof t[s[0]]){var r=[t[s[0]],decodeURIComponent(s[1])];t[s[0]]=r}else t[s[0]].push(decodeURIComponent(s[1]))}return t}(),isArray:function(t){return t&&!t.propertyIsEnumerable("length")&&"object"==typeof t&&"number"==typeof t.length},isString:function(t){return"string"==typeof t||t instanceof String},isNumeric:function(t){return!isNaN(parseFloat(t))&&isFinite(t)},isID:function(t){return n.isString(t)||n.isNumeric(t)},isSameComponent:function(t,e){return!(!t||!e)&&(n.isNumeric(t)||n.isString(t)?`${t}`:t.id)===(n.isNumeric(e)||n.isString(e)?`${e}`:e.id)},isFunction:function(t){return"function"==typeof t},isObject:function(t){const e={}.constructor;return!!t&&t.constructor===e},copy:function(t){return n.apply(t,{})},apply:function(t,e){for(const i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e},apply2:function(t,e){for(const i in t)t.hasOwnProperty(i)&&t[i]!==undefined&&null!==t[i]&&(e[i]=t[i]);return e},applyIf:function(t,e){for(const i in t)t.hasOwnProperty(i)&&(e[i]!==undefined&&null!==e[i]||(e[i]=t[i]));return e},isEmptyObject:function(t){for(const e in t)if(t.hasOwnProperty(e))return!1;return!0},inQuotes:function(t){return n.isNumeric(t)?`${t}`:`'${t}'`},concat:function(t,e){const i=new t.constructor(t.length+e.length);return i.set(t),i.set(e,t.length),i},flattenParentChildHierarchy:function(t){var e=[];return function i(t){t.id=t.uuid,delete t.oid,e.push(t);var s=t.children;if(s)for(var r=0,o=s.length;r<o;r++){s[r].parent=t.id,i(s[r])}t.children=[]}(t),e}},l={},h=new e,u=new class{constructor(){this._head=[],this._headLength=0,this._tail=[],this._index=0,this._length=0}get length(){return this._length}shift(){if(this._index>=this._headLength){const t=this._head;if(t.length=0,this._head=this._tail,this._tail=t,this._index=0,this._headLength=this._head.length,!this._headLength)return}const t=this._head[this._index];return this._index<0?delete this._head[this._index++]:this._head[this._index++]=undefined,this._length--,t}push(t){return this._length++,this._tail.push(t),this}unshift(t){return this._head[--this._index]=t,this._length++,this}},c={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},d=10,p=[];let f,_=0,g=0;const m=new function(){this.version="1.0.0",this.scenes={},this._superTypes={},this._addScene=function(t){if(t.id){if(m.scenes[t.id])return void console.error(`[ERROR] Scene ${n.inQuotes(t.id)} already exists`)}else t.id=h.addItem({});m.scenes[t.id]=t;const e=t.ticksPerOcclusionTest,s=t.ticksPerRender;l[t.id]={ticksPerOcclusionTest:e,ticksPerRender:s,renderCountdown:s},i.components.scenes++,t.once("destroyed",(()=>{h.removeItem(t.id),delete m.scenes[t.id],delete l[t.id],i.components.scenes--}))},this.clear=function(){let t;for(const e in m.scenes)m.scenes.hasOwnProperty(e)&&(t=m.scenes[e],"default.scene"===e?t.clear():(t.destroy(),delete m.scenes[t.id]))},this.scheduleTask=function(t,e){u.push(t),u.push(e)},this.runTasks=function(t=-1){let e,i,s=(new Date).getTime(),r=0;for(;u.length>0&&(t<0||s<t);)e=u.shift(),i=u.shift(),i?e.call(i):e(),s=(new Date).getTime(),r++;return r},this.getNumTasks=function(){return u.length}},v=function(){let t=Date.now();if(_>0){f=t-_;var e=1e3/f;g+=e,p.push(e),p.length>=30&&(g-=p.shift()),i.frame.fps=Math.round(g/p.length)}!function(t){const e=m.runTasks(t+d),s=m.getNumTasks();i.frame.tasksRun=e,i.frame.tasksScheduled=s,i.frame.tasksBudget=d}(t),function(t){for(var e in c.time=t,m.scenes)if(m.scenes.hasOwnProperty(e)){var i=m.scenes[e];c.sceneId=e,c.startTime=i.startTime,c.deltaTime=null!=c.prevTime?c.time-c.prevTime:0,i.fire("tick",c,!0)}c.prevTime=t}(t),function(){const t=m.scenes,e=!1;let i,s,r,o,a;for(a in t)t.hasOwnProperty(a)&&(i=t[a],s=l[a],s||(s=l[a]={}),r=i.ticksPerOcclusionTest,s.ticksPerOcclusionTest!==r&&(s.ticksPerOcclusionTest=r,s.renderCountdown=r),--i.occlusionTestCountdown<=0&&(i.doOcclusionTest(),i.occlusionTestCountdown=r),o=i.ticksPerRender,s.ticksPerRender!==o&&(s.ticksPerRender=o,s.renderCountdown=o),0==--s.renderCountdown&&(i.render(e),s.renderCountdown=o))}(),_=t,window.requestAnimationFrame(v)};window.requestAnimationFrame(v);const P=Float64Array,b=new P(16),y=new P(16),x=new P(4),M={MIN_DOUBLE:-Number.MAX_SAFE_INTEGER,MAX_DOUBLE:Number.MAX_SAFE_INTEGER,DEGTORAD:.0174532925,RADTODEG:57.295779513,unglobalizeObjectId(t,e){const i=e.indexOf("#");return i===t.length&&e.startsWith(t)?e.substring(i+1):e},globalizeObjectId:(t,e)=>t+"#"+e,vec2:t=>new P(t||2),vec3:t=>new P(t||3),vec4:t=>new P(t||4),mat3:t=>new P(t||9),mat3ToMat4:(t,e=new P(16))=>(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[3],e[5]=t[4],e[6]=t[5],e[7]=0,e[8]=t[6],e[9]=t[7],e[10]=t[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e),mat4:t=>new P(t||16),mat4ToMat3(t,e){},doublesToFloats(t,e,i){const s=new Float32Array(2);for(let r=0,o=t.length;r<o;r++)M.splitDouble(t[r],s),e[r]=s[0],i[r]=s[1]},splitDouble(t,e){const i=Float32Array.from([t])[0],s=t-i;e[0]=i,e[1]=s},createUUID:(()=>{const t=[];for(let e=0;e<256;e++)t[e]=(e<16?"0":"")+e.toString(16);return()=>{const e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0,r=4294967295*Math.random()|0;return`${t[255&e]+t[e>>8&255]+t[e>>16&255]+t[e>>24&255]}-${t[255&i]}${t[i>>8&255]}-${t[i>>16&15|64]}${t[i>>24&255]}-${t[63&s|128]}${t[s>>8&255]}-${t[s>>16&255]}${t[s>>24&255]}${t[255&r]}${t[r>>8&255]}${t[r>>16&255]}${t[r>>24&255]}`}})(),clamp:(t,e,i)=>Math.max(e,Math.min(i,t)),fmod(t,e){if(t<e)return console.error("math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),t;for(;e<=t;)t-=e;return t},compareVec3:(t,e)=>t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2],negateVec3:(t,e)=>(e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e),negateVec4:(t,e)=>(e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e),addVec4:(t,e,i)=>(i||(i=t),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i[3]=t[3]+e[3],i),addVec4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]+e,i[1]=t[1]+e,i[2]=t[2]+e,i[3]=t[3]+e,i),addVec3:(t,e,i)=>(i||(i=t),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i),addVec3Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]+e,i[1]=t[1]+e,i[2]=t[2]+e,i),subVec4:(t,e,i)=>(i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i[3]=t[3]-e[3],i),subVec3:(t,e,i)=>(i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i),subVec2:(t,e,i)=>(i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i),geometricMeanVec2(...t){const e=new P(t[0]);for(let i=1;i<t.length;i++)e[0]+=t[i][0],e[1]+=t[i][1];return e[0]/=t.length,e[1]/=t.length,e},subVec4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]-e,i[1]=t[1]-e,i[2]=t[2]-e,i[3]=t[3]-e,i),subScalarVec4:(t,e,i)=>(i||(i=t),i[0]=e-t[0],i[1]=e-t[1],i[2]=e-t[2],i[3]=e-t[3],i),mulVec4:(t,e,i)=>(i||(i=t),i[0]=t[0]*e[0],i[1]=t[1]*e[1],i[2]=t[2]*e[2],i[3]=t[3]*e[3],i),mulVec4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3]*e,i),mulVec3Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i),mulVec2Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i),divVec3:(t,e,i)=>(i||(i=t),i[0]=t[0]/e[0],i[1]=t[1]/e[1],i[2]=t[2]/e[2],i),divVec4:(t,e,i)=>(i||(i=t),i[0]=t[0]/e[0],i[1]=t[1]/e[1],i[2]=t[2]/e[2],i[3]=t[3]/e[3],i),divScalarVec3:(t,e,i)=>(i||(i=e),i[0]=t/e[0],i[1]=t/e[1],i[2]=t/e[2],i),divVec3Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]/e,i[1]=t[1]/e,i[2]=t[2]/e,i),divVec4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]/e,i[1]=t[1]/e,i[2]=t[2]/e,i[3]=t[3]/e,i),divScalarVec4:(t,e,i)=>(i||(i=e),i[0]=t/e[0],i[1]=t/e[1],i[2]=t/e[2],i[3]=t/e[3],i),dotVec4:(t,e)=>t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3],cross3Vec4(t,e){const i=t[0],s=t[1],r=t[2],o=e[0],a=e[1],n=e[2];return[s*n-r*a,r*o-i*n,i*a-s*o,0]},cross3Vec3(t,e,i){i||(i=t);const s=t[0],r=t[1],o=t[2],a=e[0],n=e[1],l=e[2];return i[0]=r*l-o*n,i[1]=o*a-s*l,i[2]=s*n-r*a,i},sqLenVec4:t=>M.dotVec4(t,t),lenVec4:t=>Math.sqrt(M.sqLenVec4(t)),dotVec3:(t,e)=>t[0]*e[0]+t[1]*e[1]+t[2]*e[2],dotVec2:(t,e)=>t[0]*e[0]+t[1]*e[1],sqLenVec3:t=>M.dotVec3(t,t),sqLenVec2:t=>M.dotVec2(t,t),lenVec3:t=>Math.sqrt(M.sqLenVec3(t)),distVec3:(()=>{const t=new P(3);return(e,i)=>M.lenVec3(M.subVec3(e,i,t))})(),lenVec2:t=>Math.sqrt(M.sqLenVec2(t)),distVec2:(()=>{const t=new P(2);return(e,i)=>M.lenVec2(M.subVec2(e,i,t))})(),rcpVec3:(t,e)=>M.divScalarVec3(1,t,e),normalizeVec4(t,e){const i=1/M.lenVec4(t);return M.mulVec4Scalar(t,i,e)},normalizeVec3(t,e){const i=1/M.lenVec3(t);return M.mulVec3Scalar(t,i,e)},normalizeVec2(t,e){const i=1/M.lenVec2(t);return M.mulVec2Scalar(t,i,e)},angleVec3(t,e){let i=M.dotVec3(t,e)/Math.sqrt(M.sqLenVec3(t)*M.sqLenVec3(e));return i=i<-1?-1:i>1?1:i,Math.acos(i)},vec3FromMat4Scale:(()=>{const t=new P(3);return(e,i)=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],i[0]=M.lenVec3(t),t[0]=e[4],t[1]=e[5],t[2]=e[6],i[1]=M.lenVec3(t),t[0]=e[8],t[1]=e[9],t[2]=e[10],i[2]=M.lenVec3(t),i)})(),vecToArray:(()=>{function t(t){return Math.round(1e5*t)/1e5}return e=>{for(let i=0,s=(e=Array.prototype.slice.call(e)).length;i<s;i++)e[i]=t(e[i]);return e}})(),xyzArrayToObject:t=>({x:t[0],y:t[1],z:t[2]}),xyzObjectToArray:(t,e)=>((e=e||new P(3))[0]=t.x,e[1]=t.y,e[2]=t.z,e),dupMat4:t=>t.slice(0,16),mat4To3:t=>[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]],m4s:t=>[t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t],setMat4ToZeroes:()=>M.m4s(0),setMat4ToOnes:()=>M.m4s(1),diagonalMat4v:t=>new P([t[0],0,0,0,0,t[1],0,0,0,0,t[2],0,0,0,0,t[3]]),diagonalMat4c:(t,e,i,s)=>M.diagonalMat4v([t,e,i,s]),diagonalMat4s:t=>M.diagonalMat4c(t,t,t,t),identityMat4:(t=new P(16))=>(t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t),identityMat3:(t=new P(9))=>(t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t),isIdentityMat4:t=>1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&0===t[4]&&1===t[5]&&0===t[6]&&0===t[7]&&0===t[8]&&0===t[9]&&1===t[10]&&0===t[11]&&0===t[12]&&0===t[13]&&0===t[14]&&1===t[15],negateMat4:(t,e)=>(e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=-t[7],e[8]=-t[8],e[9]=-t[9],e[10]=-t[10],e[11]=-t[11],e[12]=-t[12],e[13]=-t[13],e[14]=-t[14],e[15]=-t[15],e),addMat4:(t,e,i)=>(i||(i=t),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i[3]=t[3]+e[3],i[4]=t[4]+e[4],i[5]=t[5]+e[5],i[6]=t[6]+e[6],i[7]=t[7]+e[7],i[8]=t[8]+e[8],i[9]=t[9]+e[9],i[10]=t[10]+e[10],i[11]=t[11]+e[11],i[12]=t[12]+e[12],i[13]=t[13]+e[13],i[14]=t[14]+e[14],i[15]=t[15]+e[15],i),addMat4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]+e,i[1]=t[1]+e,i[2]=t[2]+e,i[3]=t[3]+e,i[4]=t[4]+e,i[5]=t[5]+e,i[6]=t[6]+e,i[7]=t[7]+e,i[8]=t[8]+e,i[9]=t[9]+e,i[10]=t[10]+e,i[11]=t[11]+e,i[12]=t[12]+e,i[13]=t[13]+e,i[14]=t[14]+e,i[15]=t[15]+e,i),addScalarMat4:(t,e,i)=>M.addMat4Scalar(e,t,i),subMat4:(t,e,i)=>(i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i[3]=t[3]-e[3],i[4]=t[4]-e[4],i[5]=t[5]-e[5],i[6]=t[6]-e[6],i[7]=t[7]-e[7],i[8]=t[8]-e[8],i[9]=t[9]-e[9],i[10]=t[10]-e[10],i[11]=t[11]-e[11],i[12]=t[12]-e[12],i[13]=t[13]-e[13],i[14]=t[14]-e[14],i[15]=t[15]-e[15],i),subMat4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]-e,i[1]=t[1]-e,i[2]=t[2]-e,i[3]=t[3]-e,i[4]=t[4]-e,i[5]=t[5]-e,i[6]=t[6]-e,i[7]=t[7]-e,i[8]=t[8]-e,i[9]=t[9]-e,i[10]=t[10]-e,i[11]=t[11]-e,i[12]=t[12]-e,i[13]=t[13]-e,i[14]=t[14]-e,i[15]=t[15]-e,i),subScalarMat4:(t,e,i)=>(i||(i=e),i[0]=t-e[0],i[1]=t-e[1],i[2]=t-e[2],i[3]=t-e[3],i[4]=t-e[4],i[5]=t-e[5],i[6]=t-e[6],i[7]=t-e[7],i[8]=t-e[8],i[9]=t-e[9],i[10]=t-e[10],i[11]=t-e[11],i[12]=t-e[12],i[13]=t-e[13],i[14]=t-e[14],i[15]=t-e[15],i),mulMat4(t,e,i){i||(i=t);const s=t[0],r=t[1],o=t[2],a=t[3],n=t[4],l=t[5],h=t[6],u=t[7],c=t[8],d=t[9],p=t[10],f=t[11],_=t[12],g=t[13],m=t[14],v=t[15],P=e[0],b=e[1],y=e[2],x=e[3],M=e[4],w=e[5],E=e[6],C=e[7],A=e[8],S=e[9],D=e[10],L=e[11],R=e[12],B=e[13],T=e[14],F=e[15];return i[0]=P*s+b*n+y*c+x*_,i[1]=P*r+b*l+y*d+x*g,i[2]=P*o+b*h+y*p+x*m,i[3]=P*a+b*u+y*f+x*v,i[4]=M*s+w*n+E*c+C*_,i[5]=M*r+w*l+E*d+C*g,i[6]=M*o+w*h+E*p+C*m,i[7]=M*a+w*u+E*f+C*v,i[8]=A*s+S*n+D*c+L*_,i[9]=A*r+S*l+D*d+L*g,i[10]=A*o+S*h+D*p+L*m,i[11]=A*a+S*u+D*f+L*v,i[12]=R*s+B*n+T*c+F*_,i[13]=R*r+B*l+T*d+F*g,i[14]=R*o+B*h+T*p+F*m,i[15]=R*a+B*u+T*f+F*v,i},mulMat3(t,e,i){i||(i=new P(9));const s=t[0],r=t[3],o=t[6],a=t[1],n=t[4],l=t[7],h=t[2],u=t[5],c=t[8],d=e[0],p=e[3],f=e[6],_=e[1],g=e[4],m=e[7],v=e[2],b=e[5],y=e[8];return i[0]=s*d+r*_+o*v,i[3]=s*p+r*g+o*b,i[6]=s*f+r*m+o*y,i[1]=a*d+n*_+l*v,i[4]=a*p+n*g+l*b,i[7]=a*f+n*m+l*y,i[2]=h*d+u*_+c*v,i[5]=h*p+u*g+c*b,i[8]=h*f+u*m+c*y,i},mulMat4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3]*e,i[4]=t[4]*e,i[5]=t[5]*e,i[6]=t[6]*e,i[7]=t[7]*e,i[8]=t[8]*e,i[9]=t[9]*e,i[10]=t[10]*e,i[11]=t[11]*e,i[12]=t[12]*e,i[13]=t[13]*e,i[14]=t[14]*e,i[15]=t[15]*e,i),mulMat4v4(t,e,i=M.vec4()){const s=e[0],r=e[1],o=e[2],a=e[3];return i[0]=t[0]*s+t[4]*r+t[8]*o+t[12]*a,i[1]=t[1]*s+t[5]*r+t[9]*o+t[13]*a,i[2]=t[2]*s+t[6]*r+t[10]*o+t[14]*a,i[3]=t[3]*s+t[7]*r+t[11]*o+t[15]*a,i},transposeMat4(t,e){const i=t[4],s=t[14],r=t[8],o=t[13],a=t[12],n=t[9];if(!e||t===e){const e=t[1],l=t[2],h=t[3],u=t[6],c=t[7],d=t[11];return t[1]=i,t[2]=r,t[3]=a,t[4]=e,t[6]=n,t[7]=o,t[8]=l,t[9]=u,t[11]=s,t[12]=h,t[13]=c,t[14]=d,t}return e[0]=t[0],e[1]=i,e[2]=r,e[3]=a,e[4]=t[1],e[5]=t[5],e[6]=n,e[7]=o,e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=s,e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e},transposeMat3(t,e){if(e===t){const i=t[1],s=t[2],r=t[5];e[1]=t[3],e[2]=t[6],e[3]=i,e[5]=t[7],e[6]=s,e[7]=r}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},determinantMat4(t){const e=t[0],i=t[1],s=t[2],r=t[3],o=t[4],a=t[5],n=t[6],l=t[7],h=t[8],u=t[9],c=t[10],d=t[11],p=t[12],f=t[13],_=t[14],g=t[15];return p*u*n*r-h*f*n*r-p*a*c*r+o*f*c*r+h*a*_*r-o*u*_*r-p*u*s*l+h*f*s*l+p*i*c*l-e*f*c*l-h*i*_*l+e*u*_*l+p*a*s*d-o*f*s*d-p*i*n*d+e*f*n*d+o*i*_*d-e*a*_*d-h*a*s*g+o*u*s*g+h*i*n*g-e*u*n*g-o*i*c*g+e*a*c*g},inverseMat4(t,e){e||(e=t);const i=t[0],s=t[1],r=t[2],o=t[3],a=t[4],n=t[5],l=t[6],h=t[7],u=t[8],c=t[9],d=t[10],p=t[11],f=t[12],_=t[13],g=t[14],m=t[15],v=i*n-s*a,P=i*l-r*a,b=i*h-o*a,y=s*l-r*n,x=s*h-o*n,M=r*h-o*l,w=u*_-c*f,E=u*g-d*f,C=u*m-p*f,A=c*g-d*_,S=c*m-p*_,D=d*m-p*g,L=1/(v*D-P*S+b*A+y*C-x*E+M*w);return e[0]=(n*D-l*S+h*A)*L,e[1]=(-s*D+r*S-o*A)*L,e[2]=(_*M-g*x+m*y)*L,e[3]=(-c*M+d*x-p*y)*L,e[4]=(-a*D+l*C-h*E)*L,e[5]=(i*D-r*C+o*E)*L,e[6]=(-f*M+g*b-m*P)*L,e[7]=(u*M-d*b+p*P)*L,e[8]=(a*S-n*C+h*w)*L,e[9]=(-i*S+s*C-o*w)*L,e[10]=(f*x-_*b+m*v)*L,e[11]=(-u*x+c*b-p*v)*L,e[12]=(-a*A+n*E-l*w)*L,e[13]=(i*A-s*E+r*w)*L,e[14]=(-f*y+_*P-g*v)*L,e[15]=(u*y-c*P+d*v)*L,e},traceMat4:t=>t[0]+t[5]+t[10]+t[15],translationMat4v(t,e){const i=e||M.identityMat4();return i[12]=t[0],i[13]=t[1],i[14]=t[2],i},translationMat3v(t,e){const i=e||M.identityMat3();return i[6]=t[0],i[7]=t[1],i},translationMat4c:(()=>{const t=new P(3);return(e,i,s,r)=>(t[0]=e,t[1]=i,t[2]=s,M.translationMat4v(t,r))})(),translationMat4s:(t,e)=>M.translationMat4c(t,t,t,e),translateMat4v:(t,e)=>M.translateMat4c(t[0],t[1],t[2],e),OLDtranslateMat4c(t,e,i,s){const r=s[12];s[0]+=r*t,s[4]+=r*e,s[8]+=r*i;const o=s[13];s[1]+=o*t,s[5]+=o*e,s[9]+=o*i;const a=s[14];s[2]+=a*t,s[6]+=a*e,s[10]+=a*i;const n=s[15];return s[3]+=n*t,s[7]+=n*e,s[11]+=n*i,s},translateMat4c(t,e,i,s){const r=s[3];s[0]+=r*t,s[1]+=r*e,s[2]+=r*i;const o=s[7];s[4]+=o*t,s[5]+=o*e,s[6]+=o*i;const a=s[11];s[8]+=a*t,s[9]+=a*e,s[10]+=a*i;const n=s[15];return s[12]+=n*t,s[13]+=n*e,s[14]+=n*i,s},setMat4Translation:(t,e,i)=>(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=t[15],i),rotationMat4v(t,e,i){const s=M.normalizeVec4([e[0],e[1],e[2],0],[]),r=Math.sin(t),o=Math.cos(t),a=1-o,n=s[0],l=s[1],h=s[2];let u,c,d,p,f,_;return u=n*l,c=l*h,d=h*n,p=n*r,f=l*r,_=h*r,(i=i||M.mat4())[0]=a*n*n+o,i[1]=a*u+_,i[2]=a*d-f,i[3]=0,i[4]=a*u-_,i[5]=a*l*l+o,i[6]=a*c+p,i[7]=0,i[8]=a*d+f,i[9]=a*c-p,i[10]=a*h*h+o,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},rotationMat4c:(t,e,i,s,r)=>M.rotationMat4v(t,[e,i,s],r),scalingMat4v:(t,e=M.identityMat4())=>(e[0]=t[0],e[5]=t[1],e[10]=t[2],e),scalingMat3v:(t,e=M.identityMat3())=>(e[0]=t[0],e[4]=t[1],e),scalingMat4c:(()=>{const t=new P(3);return(e,i,s,r)=>(t[0]=e,t[1]=i,t[2]=s,M.scalingMat4v(t,r))})(),scaleMat4c:(t,e,i,s)=>(s[0]*=t,s[4]*=e,s[8]*=i,s[1]*=t,s[5]*=e,s[9]*=i,s[2]*=t,s[6]*=e,s[10]*=i,s[3]*=t,s[7]*=e,s[11]*=i,s),scaleMat4v(t,e){const i=t[0],s=t[1],r=t[2];return e[0]*=i,e[4]*=s,e[8]*=r,e[1]*=i,e[5]*=s,e[9]*=r,e[2]*=i,e[6]*=s,e[10]*=r,e[3]*=i,e[7]*=s,e[11]*=r,e},scalingMat4s:t=>M.scalingMat4c(t,t,t),rotationTranslationMat4(t,e,i=M.mat4()){const s=t[0],r=t[1],o=t[2],a=t[3],n=s+s,l=r+r,h=o+o,u=s*n,c=s*l,d=s*h,p=r*l,f=r*h,_=o*h,g=a*n,m=a*l,v=a*h;return i[0]=1-(p+_),i[1]=c+v,i[2]=d-m,i[3]=0,i[4]=c-v,i[5]=1-(u+_),i[6]=f+g,i[7]=0,i[8]=d+m,i[9]=f-g,i[10]=1-(u+p),i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1,i},mat4ToEuler(t,e,i=M.vec4()){const s=M.clamp,r=t[0],o=t[4],a=t[8],n=t[1],l=t[5],h=t[9],u=t[2],c=t[6],d=t[10];return"XYZ"===e?(i[1]=Math.asin(s(a,-1,1)),Math.abs(a)<.99999?(i[0]=Math.atan2(-h,d),i[2]=Math.atan2(-o,r)):(i[0]=Math.atan2(c,l),i[2]=0)):"YXZ"===e?(i[0]=Math.asin(-s(h,-1,1)),Math.abs(h)<.99999?(i[1]=Math.atan2(a,d),i[2]=Math.atan2(n,l)):(i[1]=Math.atan2(-u,r),i[2]=0)):"ZXY"===e?(i[0]=Math.asin(s(c,-1,1)),Math.abs(c)<.99999?(i[1]=Math.atan2(-u,d),i[2]=Math.atan2(-o,l)):(i[1]=0,i[2]=Math.atan2(n,r))):"ZYX"===e?(i[1]=Math.asin(-s(u,-1,1)),Math.abs(u)<.99999?(i[0]=Math.atan2(c,d),i[2]=Math.atan2(n,r)):(i[0]=0,i[2]=Math.atan2(-o,l))):"YZX"===e?(i[2]=Math.asin(s(n,-1,1)),Math.abs(n)<.99999?(i[0]=Math.atan2(-h,l),i[1]=Math.atan2(-u,r)):(i[0]=0,i[1]=Math.atan2(a,d))):"XZY"===e&&(i[2]=Math.asin(-s(o,-1,1)),Math.abs(o)<.99999?(i[0]=Math.atan2(c,l),i[1]=Math.atan2(a,r)):(i[0]=Math.atan2(-h,d),i[1]=0)),i},composeMat4:(t,e,i,s=M.mat4())=>(M.quaternionToRotationMat4(e,s),M.scaleMat4v(i,s),M.translateMat4v(t,s),s),decomposeMat4:(()=>{const t=new P(3),e=new P(16);return function(i,s,r,o){t[0]=i[0],t[1]=i[1],t[2]=i[2];let a=M.lenVec3(t);t[0]=i[4],t[1]=i[5],t[2]=i[6];const n=M.lenVec3(t);t[8]=i[8],t[9]=i[9],t[10]=i[10];const l=M.lenVec3(t);M.determinantMat4(i)<0&&(a=-a),s[0]=i[12],s[1]=i[13],s[2]=i[14],e.set(i);const h=1/a,u=1/n,c=1/l;return e[0]*=h,e[1]*=h,e[2]*=h,e[4]*=u,e[5]*=u,e[6]*=u,e[8]*=c,e[9]*=c,e[10]*=c,M.mat4ToQuaternion(e,r),o[0]=a,o[1]=n,o[2]=l,this}})(),getColMat4(t,e){const i=4*e;return[t[i],t[i+1],t[i+2],t[i+3]]},setRowMat4(t,e,i){t[e]=i[0],t[e+4]=i[1],t[e+8]=i[2],t[e+12]=i[3]},lookAtMat4v(t,e,i,s){s||(s=M.mat4());const r=t[0],o=t[1],a=t[2],n=i[0],l=i[1],h=i[2],u=e[0],c=e[1],d=e[2];if(r===u&&o===c&&a===d)return M.identityMat4();let p,f,_,g,m,v,P,b,y,x;return p=r-u,f=o-c,_=a-d,x=1/Math.sqrt(p*p+f*f+_*_),p*=x,f*=x,_*=x,g=l*_-h*f,m=h*p-n*_,v=n*f-l*p,x=Math.sqrt(g*g+m*m+v*v),x?(x=1/x,g*=x,m*=x,v*=x):(g=0,m=0,v=0),P=f*v-_*m,b=_*g-p*v,y=p*m-f*g,x=Math.sqrt(P*P+b*b+y*y),x?(x=1/x,P*=x,b*=x,y*=x):(P=0,b=0,y=0),s[0]=g,s[1]=P,s[2]=p,s[3]=0,s[4]=m,s[5]=b,s[6]=f,s[7]=0,s[8]=v,s[9]=y,s[10]=_,s[11]=0,s[12]=-(g*r+m*o+v*a),s[13]=-(P*r+b*o+y*a),s[14]=-(p*r+f*o+_*a),s[15]=1,s},lookAtMat4c:(t,e,i,s,r,o,a,n,l)=>M.lookAtMat4v([t,e,i],[s,r,o],[a,n,l],[]),orthoMat4c(t,e,i,s,r,o,a){a||(a=M.mat4());const n=e-t,l=s-i,h=o-r;return a[0]=2/n,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/l,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/h,a[11]=0,a[12]=-(t+e)/n,a[13]=-(s+i)/l,a[14]=-(o+r)/h,a[15]=1,a},frustumMat4v(t,e,i){i||(i=M.mat4());const s=[t[0],t[1],t[2],0],r=[e[0],e[1],e[2],0];M.addVec4(r,s,b),M.subVec4(r,s,y);const o=2*s[2],a=y[0],n=y[1],l=y[2];return i[0]=o/a,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=o/n,i[6]=0,i[7]=0,i[8]=b[0]/a,i[9]=b[1]/n,i[10]=-b[2]/l,i[11]=-1,i[12]=0,i[13]=0,i[14]=-o*r[2]/l,i[15]=0,i},frustumMat4(t,e,i,s,r,o,a){a||(a=M.mat4());const n=e-t,l=s-i,h=o-r;return a[0]=2*r/n,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*r/l,a[6]=0,a[7]=0,a[8]=(e+t)/n,a[9]=(s+i)/l,a[10]=-(o+r)/h,a[11]=-1,a[12]=0,a[13]=0,a[14]=-o*r*2/h,a[15]=0,a},perspectiveMat4(t,e,i,s,r){const o=[],a=[];return o[2]=i,a[2]=s,a[1]=o[2]*Math.tan(t/2),o[1]=-a[1],a[0]=a[1]*e,o[0]=-a[0],M.frustumMat4v(o,a,r)},compareMat4:(t,e)=>t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15],transformPoint3(t,e,i=M.vec3()){const s=e[0],r=e[1],o=e[2];return i[0]=t[0]*s+t[4]*r+t[8]*o+t[12],i[1]=t[1]*s+t[5]*r+t[9]*o+t[13],i[2]=t[2]*s+t[6]*r+t[10]*o+t[14],i},transformPoint4:(t,e,i=M.vec4())=>(i[0]=t[0]*e[0]+t[4]*e[1]+t[8]*e[2]+t[12]*e[3],i[1]=t[1]*e[0]+t[5]*e[1]+t[9]*e[2]+t[13]*e[3],i[2]=t[2]*e[0]+t[6]*e[1]+t[10]*e[2]+t[14]*e[3],i[3]=t[3]*e[0]+t[7]*e[1]+t[11]*e[2]+t[15]*e[3],i),transformPoints3(t,e,i){const s=i||[],r=e.length;let o,a,n,l;const h=t[0],u=t[1],c=t[2],d=t[3],p=t[4],f=t[5],_=t[6],g=t[7],m=t[8],v=t[9],P=t[10],b=t[11],y=t[12],x=t[13],M=t[14],w=t[15];let E;for(let t=0;t<r;++t)l=e[t],o=l[0],a=l[1],n=l[2],E=s[t]||(s[t]=[0,0,0]),E[0]=h*o+p*a+m*n+y,E[1]=u*o+f*a+v*n+x,E[2]=c*o+_*a+P*n+M,E[3]=d*o+g*a+b*n+w;return s.length=r,s},transformPositions3(t,e,i=e){let s;const r=e.length;let o,a,n;const l=t[0],h=t[1],u=t[2],c=t[3],d=t[4],p=t[5],f=t[6],_=t[7],g=t[8],m=t[9],v=t[10],P=t[11],b=t[12],y=t[13],x=t[14],M=t[15];for(s=0;s<r;s+=3)o=e[s+0],a=e[s+1],n=e[s+2],i[s+0]=l*o+d*a+g*n+b,i[s+1]=h*o+p*a+m*n+y,i[s+2]=u*o+f*a+v*n+x,i[s+3]=c*o+_*a+P*n+M;return i},transformPositions4(t,e,i=e){let s;const r=e.length;let o,a,n;const l=t[0],h=t[1],u=t[2],c=t[3],d=t[4],p=t[5],f=t[6],_=t[7],g=t[8],m=t[9],v=t[10],P=t[11],b=t[12],y=t[13],x=t[14],M=t[15];for(s=0;s<r;s+=4)o=e[s+0],a=e[s+1],n=e[s+2],i[s+0]=l*o+d*a+g*n+b,i[s+1]=h*o+p*a+m*n+y,i[s+2]=u*o+f*a+v*n+x,i[s+3]=c*o+_*a+P*n+M;return i},transformVec3(t,e,i){const s=e[0],r=e[1],o=e[2];return(i=i||this.vec3())[0]=t[0]*s+t[4]*r+t[8]*o,i[1]=t[1]*s+t[5]*r+t[9]*o,i[2]=t[2]*s+t[6]*r+t[10]*o,i},transformVec4(t,e,i){const s=e[0],r=e[1],o=e[2],a=e[3];return(i=i||M.vec4())[0]=t[0]*s+t[4]*r+t[8]*o+t[12]*a,i[1]=t[1]*s+t[5]*r+t[9]*o+t[13]*a,i[2]=t[2]*s+t[6]*r+t[10]*o+t[14]*a,i[3]=t[3]*s+t[7]*r+t[11]*o+t[15]*a,i},rotateVec3X(t,e,i,s){const r=[],o=[];return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],o[0]=r[0],o[1]=r[1]*Math.cos(i)-r[2]*Math.sin(i),o[2]=r[1]*Math.sin(i)+r[2]*Math.cos(i),s[0]=o[0]+e[0],s[1]=o[1]+e[1],s[2]=o[2]+e[2],s},rotateVec3Y(t,e,i,s){const r=[],o=[];return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],o[0]=r[2]*Math.sin(i)+r[0]*Math.cos(i),o[1]=r[1],o[2]=r[2]*Math.cos(i)-r[0]*Math.sin(i),s[0]=o[0]+e[0],s[1]=o[1]+e[1],s[2]=o[2]+e[2],s},rotateVec3Z(t,e,i,s){const r=[],o=[];return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],o[0]=r[0]*Math.cos(i)-r[1]*Math.sin(i),o[1]=r[0]*Math.sin(i)+r[1]*Math.cos(i),o[2]=r[2],s[0]=o[0]+e[0],s[1]=o[1]+e[1],s[2]=o[2]+e[2],s},projectVec4(t,e){const i=1/t[3];return(e=e||M.vec2())[0]=t[0]*i,e[1]=t[1]*i,e},unprojectVec3:(()=>{const t=new P(16),e=new P(16),i=new P(16);return function(s,r,o,a){return this.transformVec3(this.mulMat4(this.inverseMat4(r,t),this.inverseMat4(o,e),i),s,a)}})(),lerpVec3(t,e,i,s,r,o){const a=o||M.vec3(),n=(t-e)/(i-e);return a[0]=s[0]+n*(r[0]-s[0]),a[1]=s[1]+n*(r[1]-s[1]),a[2]=s[2]+n*(r[2]-s[2]),a},lerpMat4(t,e,i,s,r,o){const a=o||M.mat4(),n=(t-e)/(i-e);return a[0]=s[0]+n*(r[0]-s[0]),a[1]=s[1]+n*(r[1]-s[1]),a[2]=s[2]+n*(r[2]-s[2]),a[3]=s[3]+n*(r[3]-s[3]),a[4]=s[4]+n*(r[4]-s[4]),a[5]=s[5]+n*(r[5]-s[5]),a[6]=s[6]+n*(r[6]-s[6]),a[7]=s[7]+n*(r[7]-s[7]),a[8]=s[8]+n*(r[8]-s[8]),a[9]=s[9]+n*(r[9]-s[9]),a[10]=s[10]+n*(r[10]-s[10]),a[11]=s[11]+n*(r[11]-s[11]),a[12]=s[12]+n*(r[12]-s[12]),a[13]=s[13]+n*(r[13]-s[13]),a[14]=s[14]+n*(r[14]-s[14]),a[15]=s[15]+n*(r[15]-s[15]),a},flatten(t){const e=[];let i,s,r,o,a;for(i=0,s=t.length;i<s;i++)for(a=t[i],r=0,o=a.length;r<o;r++)e.push(a[r]);return e},identityQuaternion:(t=M.vec4())=>(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t),eulerToQuaternion(t,e,i=M.vec4()){const s=t[0]*M.DEGTORAD/2,r=t[1]*M.DEGTORAD/2,o=t[2]*M.DEGTORAD/2,a=Math.cos(s),n=Math.cos(r),l=Math.cos(o),h=Math.sin(s),u=Math.sin(r),c=Math.sin(o);return"XYZ"===e?(i[0]=h*n*l+a*u*c,i[1]=a*u*l-h*n*c,i[2]=a*n*c+h*u*l,i[3]=a*n*l-h*u*c):"YXZ"===e?(i[0]=h*n*l+a*u*c,i[1]=a*u*l-h*n*c,i[2]=a*n*c-h*u*l,i[3]=a*n*l+h*u*c):"ZXY"===e?(i[0]=h*n*l-a*u*c,i[1]=a*u*l+h*n*c,i[2]=a*n*c+h*u*l,i[3]=a*n*l-h*u*c):"ZYX"===e?(i[0]=h*n*l-a*u*c,i[1]=a*u*l+h*n*c,i[2]=a*n*c-h*u*l,i[3]=a*n*l+h*u*c):"YZX"===e?(i[0]=h*n*l+a*u*c,i[1]=a*u*l+h*n*c,i[2]=a*n*c-h*u*l,i[3]=a*n*l-h*u*c):"XZY"===e&&(i[0]=h*n*l-a*u*c,i[1]=a*u*l-h*n*c,i[2]=a*n*c+h*u*l,i[3]=a*n*l+h*u*c),i},mat4ToQuaternion(t,e=M.vec4()){const i=t[0],s=t[4],r=t[8],o=t[1],a=t[5],n=t[9],l=t[2],h=t[6],u=t[10];let c;const d=i+a+u;return d>0?(c=.5/Math.sqrt(d+1),e[3]=.25/c,e[0]=(h-n)*c,e[1]=(r-l)*c,e[2]=(o-s)*c):i>a&&i>u?(c=2*Math.sqrt(1+i-a-u),e[3]=(h-n)/c,e[0]=.25*c,e[1]=(s+o)/c,e[2]=(r+l)/c):a>u?(c=2*Math.sqrt(1+a-i-u),e[3]=(r-l)/c,e[0]=(s+o)/c,e[1]=.25*c,e[2]=(n+h)/c):(c=2*Math.sqrt(1+u-i-a),e[3]=(o-s)/c,e[0]=(r+l)/c,e[1]=(n+h)/c,e[2]=.25*c),e},vec3PairToQuaternion(t,e,i=M.vec4()){const s=Math.sqrt(M.dotVec3(t,t)*M.dotVec3(e,e));let r=s+M.dotVec3(t,e);return r<1e-8*s?(r=0,Math.abs(t[0])>Math.abs(t[2])?(i[0]=-t[1],i[1]=t[0],i[2]=0):(i[0]=0,i[1]=-t[2],i[2]=t[1])):M.cross3Vec3(t,e,i),i[3]=r,M.normalizeQuaternion(i)},angleAxisToQuaternion(t,e=M.vec4()){const i=t[3]/2,s=Math.sin(i);return e[0]=s*t[0],e[1]=s*t[1],e[2]=s*t[2],e[3]=Math.cos(i),e},quaternionToEuler:(()=>{const t=new P(16);return(e,i,s)=>(s=s||M.vec3(),M.quaternionToRotationMat4(e,t),M.mat4ToEuler(t,i,s),s)})(),mulQuaternions(t,e,i=M.vec4()){const s=t[0],r=t[1],o=t[2],a=t[3],n=e[0],l=e[1],h=e[2],u=e[3];return i[0]=a*n+s*u+r*h-o*l,i[1]=a*l+r*u+o*n-s*h,i[2]=a*h+o*u+s*l-r*n,i[3]=a*u-s*n-r*l-o*h,i},vec3ApplyQuaternion(t,e,i=M.vec3()){const s=e[0],r=e[1],o=e[2],a=t[0],n=t[1],l=t[2],h=t[3],u=h*s+n*o-l*r,c=h*r+l*s-a*o,d=h*o+a*r-n*s,p=-a*s-n*r-l*o;return i[0]=u*h+p*-a+c*-l-d*-n,i[1]=c*h+p*-n+d*-a-u*-l,i[2]=d*h+p*-l+u*-n-c*-a,i},quaternionToMat4(t,e){e=M.identityMat4(e);const i=t[0],s=t[1],r=t[2],o=t[3],a=2*i,n=2*s,l=2*r,h=a*o,u=n*o,c=l*o,d=a*i,p=n*i,f=l*i,_=n*s,g=l*s,m=l*r;return e[0]=1-(_+m),e[1]=p+c,e[2]=f-u,e[4]=p-c,e[5]=1-(d+m),e[6]=g+h,e[8]=f+u,e[9]=g-h,e[10]=1-(d+_),e},quaternionToRotationMat4(t,e){const i=t[0],s=t[1],r=t[2],o=t[3],a=i+i,n=s+s,l=r+r,h=i*a,u=i*n,c=i*l,d=s*n,p=s*l,f=r*l,_=o*a,g=o*n,m=o*l;return e[0]=1-(d+f),e[4]=u-m,e[8]=c+g,e[1]=u+m,e[5]=1-(h+f),e[9]=p-_,e[2]=c-g,e[6]=p+_,e[10]=1-(h+d),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},normalizeQuaternion(t,e=t){const i=M.lenVec4([t[0],t[1],t[2],t[3]]);return e[0]=t[0]/i,e[1]=t[1]/i,e[2]=t[2]/i,e[3]=t[3]/i,e},conjugateQuaternion:(t,e=t)=>(e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e),inverseQuaternion:(t,e)=>M.normalizeQuaternion(M.conjugateQuaternion(t,e)),quaternionToAngleAxis(t,e=M.vec4()){const i=(t=M.normalizeQuaternion(t,x))[3],s=2*Math.acos(i),r=Math.sqrt(1-i*i);return r<.001?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=t[0]/r,e[1]=t[1]/r,e[2]=t[2]/r),e[3]=s,e},AABB3:t=>new P(t||6),AABB2:t=>new P(t||4),OBB3:t=>new P(t||32),OBB2:t=>new P(t||16),Sphere3:(t,e,i,s)=>new P([t,e,i,s]),transformOBB3(t,e,i=e){let s;const r=e.length;let o,a,n;const l=t[0],h=t[1],u=t[2],c=t[3],d=t[4],p=t[5],f=t[6],_=t[7],g=t[8],m=t[9],v=t[10],P=t[11],b=t[12],y=t[13],x=t[14],M=t[15];for(s=0;s<r;s+=4)o=e[s+0],a=e[s+1],n=e[s+2],i[s+0]=l*o+d*a+g*n+b,i[s+1]=h*o+p*a+m*n+y,i[s+2]=u*o+f*a+v*n+x,i[s+3]=c*o+_*a+P*n+M;return i},containsAABB3:function(t,e){return t[0]<=e[0]&&e[3]<=t[3]&&t[1]<=e[1]&&e[4]<=t[4]&&t[2]<=e[2]&&e[5]<=t[5]},getAABB3Diag:(()=>{const t=new P(3),e=new P(3),i=new P(3);return s=>(t[0]=s[0],t[1]=s[1],t[2]=s[2],e[0]=s[3],e[1]=s[4],e[2]=s[5],M.subVec3(e,t,i),Math.abs(M.lenVec3(i)))})(),getAABB3DiagPoint:(()=>{const t=new P(3),e=new P(3),i=new P(3);return(s,r)=>{t[0]=s[0],t[1]=s[1],t[2]=s[2],e[0]=s[3],e[1]=s[4],e[2]=s[5];const o=M.subVec3(e,t,i),a=r[0]-s[0],n=s[3]-r[0],l=r[1]-s[1],h=s[4]-r[1],u=r[2]-s[2],c=s[5]-r[2];return o[0]+=a>n?a:n,o[1]+=l>h?l:h,o[2]+=u>c?u:c,Math.abs(M.lenVec3(o))}})(),getAABB3Area:t=>(t[3]-t[0])*(t[4]-t[1])*(t[5]-t[2]),getAABB3Center(t,e){const i=e||M.vec3();return i[0]=(t[0]+t[3])/2,i[1]=(t[1]+t[4])/2,i[2]=(t[2]+t[5])/2,i},getAABB2Center(t,e){const i=e||M.vec2();return i[0]=(t[2]+t[0])/2,i[1]=(t[3]+t[1])/2,i},collapseAABB3:(t=M.AABB3())=>(t[0]=M.MAX_DOUBLE,t[1]=M.MAX_DOUBLE,t[2]=M.MAX_DOUBLE,t[3]=M.MIN_DOUBLE,t[4]=M.MIN_DOUBLE,t[5]=M.MIN_DOUBLE,t),AABB3ToOBB3:(t,e=M.OBB3())=>(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=1,e[4]=t[3],e[5]=t[1],e[6]=t[2],e[7]=1,e[8]=t[3],e[9]=t[4],e[10]=t[2],e[11]=1,e[12]=t[0],e[13]=t[4],e[14]=t[2],e[15]=1,e[16]=t[0],e[17]=t[1],e[18]=t[5],e[19]=1,e[20]=t[3],e[21]=t[1],e[22]=t[5],e[23]=1,e[24]=t[3],e[25]=t[4],e[26]=t[5],e[27]=1,e[28]=t[0],e[29]=t[4],e[30]=t[5],e[31]=1,e),positions3ToAABB3:(()=>{const t=new Float32Array(3);return(e,i,s)=>{i=i||M.AABB3();let r,o,a,n=M.MAX_DOUBLE,l=M.MAX_DOUBLE,h=M.MAX_DOUBLE,u=M.MIN_DOUBLE,c=M.MIN_DOUBLE,d=M.MIN_DOUBLE;for(let i=0,p=e.length;i<p;i+=3)s?(t[0]=e[i+0],t[1]=e[i+1],t[2]=e[i+2],M.decompressPosition(t,s,t),r=t[0],o=t[1],a=t[2]):(r=e[i+0],o=e[i+1],a=e[i+2]),r<n&&(n=r),o<l&&(l=o),a<h&&(h=a),r>u&&(u=r),o>c&&(c=o),a>d&&(d=a);return i[0]=n,i[1]=l,i[2]=h,i[3]=u,i[4]=c,i[5]=d,i}})(),OBB3ToAABB3(t,e=M.AABB3()){let i,s,r,o=M.MAX_DOUBLE,a=M.MAX_DOUBLE,n=M.MAX_DOUBLE,l=M.MIN_DOUBLE,h=M.MIN_DOUBLE,u=M.MIN_DOUBLE;for(let e=0,c=t.length;e<c;e+=4)i=t[e+0],s=t[e+1],r=t[e+2],i<o&&(o=i),s<a&&(a=s),r<n&&(n=r),i>l&&(l=i),s>h&&(h=s),r>u&&(u=r);return e[0]=o,e[1]=a,e[2]=n,e[3]=l,e[4]=h,e[5]=u,e},points3ToAABB3(t,e=M.AABB3()){let i,s,r,o=M.MAX_DOUBLE,a=M.MAX_DOUBLE,n=M.MAX_DOUBLE,l=M.MIN_DOUBLE,h=M.MIN_DOUBLE,u=M.MIN_DOUBLE;for(let e=0,c=t.length;e<c;e++)i=t[e][0],s=t[e][1],r=t[e][2],i<o&&(o=i),s<a&&(a=s),r<n&&(n=r),i>l&&(l=i),s>h&&(h=s),r>u&&(u=r);return e[0]=o,e[1]=a,e[2]=n,e[3]=l,e[4]=h,e[5]=u,e},points3ToSphere3:(()=>{const t=new Float32Array(3);return(e,i)=>{i=i||M.vec4();let s,r=0,o=0,a=0;const n=e.length;for(s=0;s<n;s++)r+=e[s][0],o+=e[s][1],a+=e[s][2];i[0]=r/n,i[1]=o/n,i[2]=a/n;let l,h=0;for(s=0;s<n;s++)l=Math.abs(M.lenVec3(M.subVec3(e[s],i,t))),l>h&&(h=l);return i[3]=h,i}})(),positions3ToSphere3:(()=>{const t=new Float32Array(3),e=new Float32Array(3);return(i,s)=>{s=s||M.vec4();let r,o=0,a=0,n=0;const l=i.length;let h=0;for(r=0;r<l;r+=3)o+=i[r],a+=i[r+1],n+=i[r+2];const u=l/3;let c;for(s[0]=o/u,s[1]=a/u,s[2]=n/u,r=0;r<l;r+=3)t[0]=i[r],t[1]=i[r+1],t[2]=i[r+2],c=Math.abs(M.lenVec3(M.subVec3(t,s,e))),c>h&&(h=c);return s[3]=h,s}})(),OBB3ToSphere3:(()=>{const t=new Float32Array(3),e=new Float32Array(3);return(i,s)=>{s=s||M.vec4();let r,o=0,a=0,n=0;const l=i.length,h=l/4;for(r=0;r<l;r+=4)o+=i[r+0],a+=i[r+1],n+=i[r+2];s[0]=o/h,s[1]=a/h,s[2]=n/h;let u,c=0;for(r=0;r<l;r+=4)t[0]=i[r+0],t[1]=i[r+1],t[2]=i[r+2],u=Math.abs(M.lenVec3(M.subVec3(t,s,e))),u>c&&(c=u);return s[3]=c,s}})(),getSphere3Center:(t,e=M.vec3())=>(e[0]=t[0],e[1]=t[1],e[2]=t[2],e),getPositionsCenter(t,e=M.vec3()){let i=0,s=0,r=0;for(var o=0,a=t.length;o<a;o+=3)i+=t[o+0],s+=t[o+1],r+=t[o+2];const n=t.length/3;return e[0]=i/n,e[1]=s/n,e[2]=r/n,e},expandAABB3:(t,e)=>(t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]>e[2]&&(t[2]=e[2]),t[3]<e[3]&&(t[3]=e[3]),t[4]<e[4]&&(t[4]=e[4]),t[5]<e[5]&&(t[5]=e[5]),t),expandAABB3Point3:(t,e)=>(t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]>e[2]&&(t[2]=e[2]),t[3]<e[0]&&(t[3]=e[0]),t[4]<e[1]&&(t[4]=e[1]),t[5]<e[2]&&(t[5]=e[2]),t),expandAABB3Points3(t,e){for(var i,s,r,o=0,a=e.length;o<a;o+=3)i=e[o],s=e[o+1],r=e[o+2],t[0]>i&&(t[0]=i),t[1]>s&&(t[1]=s),t[2]>r&&(t[2]=r),t[3]<i&&(t[3]=i),t[4]<s&&(t[4]=s),t[5]<r&&(t[5]=r);return t},collapseAABB2:(t=M.AABB2())=>(t[0]=M.MAX_DOUBLE,t[1]=M.MAX_DOUBLE,t[2]=M.MIN_DOUBLE,t[3]=M.MIN_DOUBLE,t),point3AABB3Intersect:(t,e)=>t[0]>e[0]||t[3]<e[0]||t[1]>e[1]||t[4]<e[1]||t[2]>e[2]||t[5]<e[2],planeAABB3Intersect(t,e,i){let s,r;t[0]>0?(s=t[0]*i[0],r=t[0]*i[3]):(s=t[0]*i[3],r=t[0]*i[0]),t[1]>0?(s+=t[1]*i[1],r+=t[1]*i[4]):(s+=t[1]*i[4],r+=t[1]*i[1]),t[2]>0?(s+=t[2]*i[2],r+=t[2]*i[5]):(s+=t[2]*i[5],r+=t[2]*i[2]);if(s<=-e&&r<=-e)return-1;return s>=-e&&r>=-e?1:0},OBB3ToAABB2(t,e=M.AABB2()){let i,s,r,o,a=M.MAX_DOUBLE,n=M.MAX_DOUBLE,l=M.MIN_DOUBLE,h=M.MIN_DOUBLE;for(let e=0,u=t.length;e<u;e+=4)i=t[e+0],s=t[e+1],r=t[e+3]||1,o=1/r,i*=o,s*=o,i<a&&(a=i),s<n&&(n=s),i>l&&(l=i),s>h&&(h=s);return e[0]=a,e[1]=n,e[2]=l,e[3]=h,e},expandAABB2:(t,e)=>(t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]<e[2]&&(t[2]=e[2]),t[3]<e[3]&&(t[3]=e[3]),t),expandAABB2Point2:(t,e)=>(t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]<e[0]&&(t[2]=e[0]),t[3]<e[1]&&(t[3]=e[1]),t),AABB2ToCanvas(t,e,i,s=t){const r=.5*(t[0]+1),o=.5*(t[1]+1),a=.5*(t[2]+1),n=.5*(t[3]+1);return s[0]=Math.floor(r*e),s[1]=i-Math.floor(n*i),s[2]=Math.floor(a*e),s[3]=i-Math.floor(o*i),s},tangentQuadraticBezier:(t,e,i,s)=>2*(1-t)*(i-e)+2*t*(s-i),tangentQuadraticBezier3:(t,e,i,s,r)=>-3*e*(1-t)*(1-t)+3*i*(1-t)*(1-t)-6*t*i*(1-t)+6*t*s*(1-t)-3*t*t*s+3*t*t*r,tangentSpline:t=>6*t*t-6*t+(3*t*t-4*t+1)+(-6*t*t+6*t)+(3*t*t-2*t),catmullRomInterpolate(t,e,i,s,r){const o=.5*(i-t),a=.5*(s-e),n=r*r;return(2*e-2*i+o+a)*(r*n)+(-3*e+3*i-2*o-a)*n+o*r+e},b2p0(t,e){const i=1-t;return i*i*e},b2p1:(t,e)=>2*(1-t)*t*e,b2p2:(t,e)=>t*t*e,b2(t,e,i,s){return this.b2p0(t,e)+this.b2p1(t,i)+this.b2p2(t,s)},b3p0(t,e){const i=1-t;return i*i*i*e},b3p1(t,e){const i=1-t;return 3*i*i*t*e},b3p2:(t,e)=>3*(1-t)*t*t*e,b3p3:(t,e)=>t*t*t*e,b3(t,e,i,s,r){return this.b3p0(t,e)+this.b3p1(t,i)+this.b3p2(t,s)+this.b3p3(t,r)},triangleNormal(t,e,i,s=M.vec3()){const r=e[0]-t[0],o=e[1]-t[1],a=e[2]-t[2],n=i[0]-t[0],l=i[1]-t[1],h=i[2]-t[2],u=o*h-a*l,c=a*n-r*h,d=r*l-o*n,p=Math.sqrt(u*u+c*c+d*d);return 0===p?(s[0]=0,s[1]=0,s[2]=0):(s[0]=u/p,s[1]=c/p,s[2]=d/p),s},rayTriangleIntersect:(()=>{const t=new Float32Array(3),e=new Float32Array(3),i=new Float32Array(3),s=new Float32Array(3),r=new Float32Array(3);return(o,a,n,l,h,u)=>{u=u||M.vec3();const c=M.subVec3(l,n,t),d=M.subVec3(h,n,e),p=M.cross3Vec3(a,d,i),f=M.dotVec3(c,p);if(f<1e-6)return null;const _=M.subVec3(o,n,s),g=M.dotVec3(_,p);if(g<0||g>f)return null;const m=M.cross3Vec3(_,c,r),v=M.dotVec3(a,m);if(v<0||g+v>f)return null;const P=M.dotVec3(d,m)/f;return u[0]=o[0]+P*a[0],u[1]=o[1]+P*a[1],u[2]=o[2]+P*a[2],u}})(),rayPlaneIntersect:(()=>{const t=new Float32Array(3),e=new Float32Array(3),i=new Float32Array(3),s=new Float32Array(3);return(r,o,a,n,l,h)=>{h=h||M.vec3(),o=M.normalizeVec3(o,t);const u=M.subVec3(n,a,e),c=M.subVec3(l,a,i),d=M.cross3Vec3(u,c,s);M.normalizeVec3(d,d);const p=-M.dotVec3(a,d),f=-(M.dotVec3(r,d)+p)/M.dotVec3(o,d);return h[0]=r[0]+f*o[0],h[1]=r[1]+f*o[1],h[2]=r[2]+f*o[2],h}})(),cartesianToBarycentric:(()=>{const t=new Float32Array(3),e=new Float32Array(3),i=new Float32Array(3);return(s,r,o,a,n)=>{const l=M.subVec3(a,r,t),h=M.subVec3(o,r,e),u=M.subVec3(s,r,i),c=M.dotVec3(l,l),d=M.dotVec3(l,h),p=M.dotVec3(l,u),f=M.dotVec3(h,h),_=M.dotVec3(h,u),g=c*f-d*d;if(0===g)return null;const m=1/g,v=(f*p-d*_)*m,P=(c*_-d*p)*m;return n[0]=1-v-P,n[1]=P,n[2]=v,n}})(),barycentricInsideTriangle(t){const e=t[1],i=t[2];return i>=0&&e>=0&&i+e<1},barycentricToCartesian(t,e,i,s,r=M.vec3()){const o=t[0],a=t[1],n=t[2];return r[0]=e[0]*o+i[0]*a+s[0]*n,r[1]=e[1]*o+i[1]*a+s[1]*n,r[2]=e[2]*o+i[2]*a+s[2]*n,r},mergeVertices(t,e,i,s){const r={},o=[],a=[],n=e?[]:null,l=i?[]:null,h=[];let u,c,d,p;const f=1e4;let _,g,m=0;for(_=0,g=t.length;_<g;_+=3)u=t[_],c=t[_+1],d=t[_+2],p=`${Math.round(u*f)}_${Math.round(c*f)}_${Math.round(d*f)}`,r[p]===undefined&&(r[p]=a.length/3,a.push(u),a.push(c),a.push(d),e&&(n.push(e[_]),n.push(e[_+1]),n.push(e[_+2])),i&&(l.push(i[m]),l.push(i[m+1]))),o[_/3]=r[p],m+=2;for(_=0,g=s.length;_<g;_++)h[_]=o[s[_]];const v={positions:a,indices:h};return n&&(v.normals=n),l&&(v.uv=l),v},buildNormals:(()=>{const t=new Float32Array(3),e=new Float32Array(3),i=new Float32Array(3),s=new Float32Array(3),r=new Float32Array(3),o=new Float32Array(3);return(a,n,l)=>{let h,u;const c=new Array(a.length/3);let d,p,f,_,g,m,v;for(h=0,u=n.length;h<u;h+=3){d=n[h],p=n[h+1],f=n[h+2],t[0]=a[3*d],t[1]=a[3*d+1],t[2]=a[3*d+2],e[0]=a[3*p],e[1]=a[3*p+1],e[2]=a[3*p+2],i[0]=a[3*f],i[1]=a[3*f+1],i[2]=a[3*f+2],M.subVec3(e,t,s),M.subVec3(i,t,r);const l=new Float32Array(3);M.normalizeVec3(M.cross3Vec3(s,r,o),l),c[d]||(c[d]=[]),c[p]||(c[p]=[]),c[f]||(c[f]=[]),c[d].push(l),c[p].push(l),c[f].push(l)}for(l=l&&l.length===a.length?l:new Float32Array(a.length),h=0,u=c.length;h<u;h++){_=c[h].length,g=0,m=0,v=0;for(let t=0;t<_;t++)g+=c[h][t][0],m+=c[h][t][1],v+=c[h][t][2];l[3*h]=g/_,l[3*h+1]=m/_,l[3*h+2]=v/_}return l}})(),buildTangents:(()=>{const t=new Float32Array(3),e=new Float32Array(3),i=new Float32Array(3),s=new Float32Array(3),r=new Float32Array(3),o=new Float32Array(3),a=new Float32Array(3);return(n,l,h)=>{const u=new Float32Array(n.length);for(let c=0;c<l.length;c+=3){let d=l[c];const p=n.subarray(3*d,3*d+3),f=h.subarray(2*d,2*d+2);d=l[c+1];const _=n.subarray(3*d,3*d+3),g=h.subarray(2*d,2*d+2);d=l[c+2];const m=n.subarray(3*d,3*d+3),v=h.subarray(2*d,2*d+2),P=M.subVec3(_,p,t),b=M.subVec3(m,p,e),y=M.subVec2(g,f,i),x=M.subVec2(v,f,s),w=1/(y[0]*x[1]-y[1]*x[0]),E=M.mulVec3Scalar(M.subVec3(M.mulVec3Scalar(P,x[1],r),M.mulVec3Scalar(b,y[1],o),a),w,o);let C;for(let t=0;t<3;t++)C=3*l[c+t],u[C]+=E[0],u[C+1]+=E[1],u[C+2]+=E[2]}return u}})(),buildPickTriangles(t,e,i){const s=e.length,r=i?new Uint16Array(9*s):new Float32Array(9*s),o=new Uint8Array(12*s);let a,n,l,h,u,c,d=0,p=0,f=0;for(let i=0;i<s;i+=3)c=d>>24&255,u=d>>16&255,h=d>>8&255,l=255&d,n=e[i],a=3*n,r[p++]=t[a],r[p++]=t[a+1],r[p++]=t[a+2],o[f++]=l,o[f++]=h,o[f++]=u,o[f++]=c,n=e[i+1],a=3*n,r[p++]=t[a],r[p++]=t[a+1],r[p++]=t[a+2],o[f++]=l,o[f++]=h,o[f++]=u,o[f++]=c,n=e[i+2],a=3*n,r[p++]=t[a],r[p++]=t[a+1],r[p++]=t[a+2],o[f++]=l,o[f++]=h,o[f++]=u,o[f++]=c,d++;return{positions:r,colors:o}},faceToVertexNormals(t,e,i={}){const s=i.smoothNormalsAngleThreshold||20,r={},o=[],a={};let n,l,h,u,c;const d=1e4;let p,f,_,g,m,v;for(f=0,g=t.length;f<g;f+=3){p=f/3,l=t[f],h=t[f+1],u=t[f+2],c=`${Math.round(l*d)}_${Math.round(h*d)}_${Math.round(u*d)}`,r[c]===undefined?r[c]=[p]:r[c].push(p);const i=M.normalizeVec3([e[f],e[f+1],e[f+2]]);o[p]=i,n=M.vec4([i[0],i[1],i[2],1]),a[p]=n}for(c in r)if(r.hasOwnProperty(c)){const t=r[c],e=t.length;for(f=0;f<e;f++){const i=t[f];for(n=a[i],_=0;_<e;_++){if(f===_)continue;const e=t[_];m=o[i],v=o[e];Math.abs(M.angleVec3(m,v)/M.DEGTORAD)<s&&(n[0]+=v[0],n[1]+=v[1],n[2]+=v[2],n[3]+=1)}}}for(f=0,g=e.length;f<g;f+=3)n=a[f/3],e[f+0]=n[0]/n[3],e[f+1]=n[1]/n[3],e[f+2]=n[2]/n[3]},canvasPosToWorldRay:(()=>{const t=new Float32Array(16),e=new Float32Array(16),i=new Float32Array(4),s=new Float32Array(4),r=new Float32Array(4),o=new Float32Array(4);return(a,n,l,h,u,c)=>{const d=M.mulMat4(l,n,t),p=M.inverseMat4(d,e),f=a.width,_=a.height,g=(h[0]-f/2)/(f/2),m=-(h[1]-_/2)/(_/2);i[0]=g,i[1]=m,i[2]=-1,i[3]=1,M.transformVec4(p,i,s),M.mulVec4Scalar(s,1/s[3]),r[0]=g,r[1]=m,r[2]=1,r[3]=1,M.transformVec4(p,r,o),M.mulVec4Scalar(o,1/o[3]),u[0]=o[0],u[1]=o[1],u[2]=o[2],M.subVec3(o,s,c),M.normalizeVec3(c)}})(),canvasPosToLocalRay:(()=>{const t=new Float32Array(3),e=new Float32Array(3);return(i,s,r,o,a,n,l)=>{M.canvasPosToWorldRay(i,s,r,a,t,e),M.worldRayToLocalRay(o,t,e,n,l)}})(),worldRayToLocalRay:(()=>{const t=new Float32Array(16),e=new Float32Array(4),i=new Float32Array(4);return(s,r,o,a,n)=>{const l=M.inverseMat4(s,t);e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=1,M.transformVec4(l,e,i),a[0]=i[0],a[1]=i[1],a[2]=i[2],M.transformVec3(l,o,n)}})(),buildKDTree:(()=>{const t=10,e=20,i=new Float32Array;function s(r,o,a,n){const l=new Float32Array(6),h={triangles:null,left:null,right:null,leaf:!1,splitDim:0,aabb:l};let u,c;for(l[0]=l[1]=l[2]=Number.POSITIVE_INFINITY,l[3]=l[4]=l[5]=Number.NEGATIVE_INFINITY,u=0,c=r.length;u<c;++u){var d=3*r[u];for(let t=0;t<3;++t){const e=3*o[d+t];a[e]<l[0]&&(l[0]=a[e]),a[e]>l[3]&&(l[3]=a[e]),a[e+1]<l[1]&&(l[1]=a[e+1]),a[e+1]>l[4]&&(l[4]=a[e+1]),a[e+2]<l[2]&&(l[2]=a[e+2]),a[e+2]>l[5]&&(l[5]=a[e+2])}}if(r.length<e||n>t)return h.triangles=r,h.leaf=!0,h;i[0]=l[3]-l[0],i[1]=l[4]-l[1],i[2]=l[5]-l[2];let p=0;i[1]>i[p]&&(p=1),i[2]>i[p]&&(p=2),h.splitDim=p;const f=(l[p]+l[p+3])/2,_=new Array(r.length);let g=0;const m=new Array(r.length);let v=0;for(u=0,c=r.length;u<c;++u){const t=o[d=3*r[u]],e=3*o[d+1],i=3*o[d+2];a[3*t+p]<=f||a[e+p]<=f||a[i+p]<=f?_[g++]=r[u]:m[v++]=r[u]}return _.length=g,m.length=v,h.left=s(_,o,a,n+1),h.right=s(m,o,a,n+1),h}return(t,e)=>{const i=t.length/3,r=new Array(i);for(let t=0;t<i;++t)r[t]=t;return s(r,t,e,0)}})(),decompressPosition(t,e,i){i[0]=t[0]*e[0]+e[12],i[1]=t[1]*e[5]+e[13],i[2]=t[2]*e[10]+e[14]},decompressPositions(t,e,i=new Float32Array(t.length)){for(let s=0,r=t.length;s<r;s+=3)i[s+0]=t[s+0]*e[0]+e[12],i[s+1]=t[s+1]*e[5]+e[13],i[s+2]=t[s+2]*e[10]+e[14];return i},decompressUV(t,e,i){i[0]=t[0]*e[0]+e[6],i[1]=t[1]*e[4]+e[7]},decompressUVs(t,e,i=new Float32Array(t.length)){for(let s=0,r=t.length;s<r;s+=3)i[s+0]=t[s+0]*e[0]+e[6],i[s+1]=t[s+1]*e[4]+e[7];return i},octDecodeVec2(t,e){let i=t[0],s=t[1];i=(2*i+1)/255,s=(2*s+1)/255;const r=1-Math.abs(i)-Math.abs(s);r<0&&(i=(1-Math.abs(s))*(i>=0?1:-1),s=(1-Math.abs(i))*(s>=0?1:-1));const o=Math.sqrt(i*i+s*s+r*r);return e[0]=i/o,e[1]=s/o,e[2]=r/o,e},octDecodeVec2s(t,e){for(let i=0,s=0,r=t.length;i<r;i+=2){let r=t[i+0],o=t[i+1];r=(2*r+1)/255,o=(2*o+1)/255;const a=1-Math.abs(r)-Math.abs(o);a<0&&(r=(1-Math.abs(o))*(r>=0?1:-1),o=(1-Math.abs(r))*(o>=0?1:-1));const n=Math.sqrt(r*r+o*o+a*a);e[s+0]=r/n,e[s+1]=o/n,e[s+2]=a/n,s+=3}return e}};M.buildEdgeIndices=function(){const t=[],e=[],i=[],s=[],r=[];let o=0;const a=new Uint16Array(3),n=new Uint16Array(3),l=new Uint16Array(3),h=M.vec3(),u=M.vec3(),c=M.vec3(),d=M.vec3(),p=M.vec3(),f=M.vec3(),_=M.vec3();return function(g,m,v,P){!function(r,o){const a={};let n,l,h,u;const c=Math.pow(10,4);let d,p,f=0;for(d=0,p=r.length;d<p;d+=3)n=r[d],l=r[d+1],h=r[d+2],u=Math.round(n*c)+"_"+Math.round(l*c)+"_"+Math.round(h*c),a[u]===undefined&&(a[u]=f/3,t[f++]=n,t[f++]=l,t[f++]=h),e[d/3]=a[u];for(d=0,p=o.length;d<p;d++)s[d]=e[o[d]],i[s[d]]=o[d]}(g,m),function(e,i){o=0;for(let g=0,m=e;g<m;g+=3){const e=3*s[g],m=3*s[g+1],v=3*s[g+2];i?(a[0]=t[e],a[1]=t[e+1],a[2]=t[e+2],n[0]=t[m],n[1]=t[m+1],n[2]=t[m+2],l[0]=t[v],l[1]=t[v+1],l[2]=t[v+2],M.decompressPosition(a,i,h),M.decompressPosition(n,i,u),M.decompressPosition(l,i,c)):(h[0]=t[e],h[1]=t[e+1],h[2]=t[e+2],u[0]=t[m],u[1]=t[m+1],u[2]=t[m+2],c[0]=t[v],c[1]=t[v+1],c[2]=t[v+2]),M.subVec3(c,u,d),M.subVec3(h,u,p),M.cross3Vec3(d,p,f),M.normalizeVec3(f,_);const P=r[o]||(r[o]={normal:M.vec3()});P.normal[0]=_[0],P.normal[1]=_[1],P.normal[2]=_[2],o++}}(m.length,v);const b=[],y=Math.cos(M.DEGTORAD*P),x={};let w,E,C,A,S,D,L,R,B,T,F,N=!1;for(let t=0,e=m.length;t<e;t+=3){const e=t/3;for(let i=0;i<3;i++)w=s[t+i],E=s[t+(i+1)%3],C=Math.min(w,E),A=Math.max(w,E),S=C+","+A,x[S]===undefined?x[S]={index1:C,index2:A,face1:e,face2:undefined}:x[S].face2=e}for(S in x)D=x[S],D.face2!==undefined&&(L=r[D.face1].normal,R=r[D.face2].normal,B=M.dotVec3(L,R),B>y)||(T=i[D.index1],F=i[D.index2],(!N&&T>65535||F>65535)&&(N=!0),b.push(T),b.push(F));return N?new Uint32Array(b):new Uint16Array(b)}}();class w{get type(){return"Component"}get isComponent(){return!0}constructor(t=null,e={}){if(this.scene=null,"Scene"===this.type)this.scene=this,this.viewer=e.viewer;else{if("Scene"===t.type)this.scene=t;else{if(!(t instanceof w))throw"Invalid param: owner must be a Component";this.scene=t.scene}this._owner=t,this._renderer=this.scene._renderer}this._dontClear=!!e.dontClear,this._renderer=this.scene._renderer,this.meta=e.meta||{},this.id=e.id,this.destroyed=!1,this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._eventSubsNum=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this!==this.scene&&this.scene._addComponent(this),this._updateScheduled=!1,t&&t._own(this)}glRedraw(){this._renderer&&(this._renderer.imageDirty(),this.castsShadow&&this._renderer.shadowsDirty())}glResort(){this._renderer&&this._renderer.needStateSort()}get owner(){return this._owner}isType(t){return this.type===t}fire(t,e,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={},this._eventSubsNum={}),!0!==i&&(this._events[t]=e||!0);const s=this._eventSubs[t];let r;if(s)for(const i in s)s.hasOwnProperty(i)&&(r=s[i],this._eventCallDepth++,this._eventCallDepth<300?r.callback.call(r.scope,e):this.error("fire: potential stack overflow from recursive event '"+t+"' - dropping this event"),this._eventCallDepth--)}on(t,i,s){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new e),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={}),this._eventSubsNum||(this._eventSubsNum={});let r=this._eventSubs[t];r?this._eventSubsNum[t]++:(r={},this._eventSubs[t]=r,this._eventSubsNum[t]=1);const o=this._subIdMap.addItem();r[o]={callback:i,scope:s||this},this._subIdEvents[o]=t;const a=this._events[t];return a!==undefined&&i.call(s||this,a),o}off(t){if(t===undefined||null===t)return;if(!this._subIdEvents)return;const e=this._subIdEvents[t];if(e){delete this._subIdEvents[t];const i=this._eventSubs[e];i&&(delete i[t],this._eventSubsNum[e]--),this._subIdMap.removeItem(t)}}once(t,e,i){const s=this,r=this.on(t,(function(t){s.off(r),e.call(i||this,t)}),i)}hasSubs(t){return this._eventSubsNum&&this._eventSubsNum[t]>0}log(t){t="[LOG]"+this._message(t),window.console.log(t),this.scene.fire("log",t)}_message(t){return" ["+this.type+" "+n.inQuotes(this.id)+"]: "+t}warn(t){t="[WARN]"+this._message(t),window.console.warn(t),this.scene.fire("warn",t)}error(t){t="[ERROR]"+this._message(t),window.console.error(t),this.scene.fire("error",t)}_attach(t){const e=t.name;if(!e)return void this.error("Component 'name' expected");let i=t.component;const s=t.sceneDefault,r=t.sceneSingleton,o=t.type,a=t.on,l=!1!==t.recompiles;if(i&&(n.isNumeric(i)||n.isString(i))){const t=i;if(i=this.scene.components[t],!i)return void this.error("Component not found: "+n.inQuotes(t))}if(!i)if(!0===r){const t=this.scene.types[o];for(const e in t)if(t.hasOwnProperty){i=t[e];break}if(!i)return this.error("Scene has no default component for '"+e+"'"),null}else if(!0===s&&(i=this.scene[e],!i))return this.error("Scene has no default component for '"+e+"'"),null;if(i){if(i.scene.id!==this.scene.id)return void this.error("Not in same scene: "+i.type+" "+n.inQuotes(i.id));if(o&&!i.isType(o))return void this.error("Expected a "+o+" type or subtype: "+i.type+" "+n.inQuotes(i.id))}this._attachments||(this._attachments={});const h=this._attached[e];let u,c,d;if(h){if(i&&h.id===i.id)return;const t=this._attachments[h.id];for(u=t.subs,c=0,d=u.length;c<d;c++)h.off(u[c]);delete this._attached[e],delete this._attachments[h.id];const s=t.params.onDetached;s&&(n.isFunction(s)?s(h):s.scope?s.callback.call(s.scope,h):s.callback(h)),t.managingLifecycle&&h.destroy()}if(i){const s={params:t,component:i,subs:[],managingLifecycle:false};s.subs.push(i.once("destroyed",(function(){s.params.component=null,this._attach(s.params)}),this)),l&&s.subs.push(i.on("dirty",(function(){this.fire("dirty",this)}),this)),this._attached[e]=i,this._attachments[i.id]=s;const r=t.onAttached;if(r&&(n.isFunction(r)?r(i):r.scope?r.callback.call(r.scope,i):r.callback(i)),a){let t,e,r,o;for(t in a)if(a.hasOwnProperty(t)){if(e=a[t],n.isFunction(e)?(r=e,o=null):(r=e.callback,o=e.scope),!r)continue;s.subs.push(i.on(t,r,o))}}}return l&&this.fire("dirty",this),this.fire(e,i),i}_checkComponent(t,e){if(!e.isComponent){if(!n.isID(e))return void this.error("Expected a Component or ID");{const t=e;if(!(e=this.scene.components[t]))return void this.error("Component not found: "+t)}}if(t===e.type){if(e.scene.id===this.scene.id)return e;this.error("Not in same scene: "+e.type)}else this.error("Expected a "+t+" Component")}_checkComponent2(t,e){if(!e.isComponent){if(!n.isID(e))return void this.error("Expected a Component or ID");{const t=e;if(!(e=this.scene.components[t]))return void this.error("Component not found: "+t)}}if(e.scene.id===this.scene.id){for(var i=0,s=t.length;i<s;i++)if(t[i]===e.type)return e;return this.error("Expected component types: "+t),null}this.error("Not in same scene: "+e.type)}_own(t){this._ownedComponents||(this._ownedComponents={}),this._ownedComponents[t.id]||(this._ownedComponents[t.id]=t),t.once("destroyed",(()=>{delete this._ownedComponents[t.id]}),this)}_needUpdate(t){this._updateScheduled||(this._updateScheduled=!0,0===t?this._doUpdate():m.scheduleTask(this._doUpdate,this))}_doUpdate(){this._updateScheduled&&(this._updateScheduled=!1,this._update&&this._update())}_update(){}clear(){if(this._ownedComponents)for(var t in this._ownedComponents)if(this._ownedComponents.hasOwnProperty(t)){this._ownedComponents[t].destroy(),delete this._ownedComponents[t]}}destroy(){if(this.destroyed)return;let t,e,i,s,r,o;if(this.fire("destroyed",this.destroyed=!0),this._attachments)for(t in this._attachments)if(this._attachments.hasOwnProperty(t)){for(e=this._attachments[t],i=e.component,s=e.subs,r=0,o=s.length;r<o;r++)i.off(s[r]);e.managingLifecycle&&i.destroy()}if(this._ownedComponents)for(t in this._ownedComponents)this._ownedComponents.hasOwnProperty(t)&&(i=this._ownedComponents[t],i.destroy(),delete this._ownedComponents[t]);this.scene._removeComponent(this),this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this._updateScheduled=!1}}class E extends w{get type(){return"Spinner"}constructor(t,e={}){super(t,e),this._canvas=e.canvas,this._element=null,this._isCustom=!1,e.elementId&&(this._element=document.getElementById(e.elementId),this._element?this._adjustPosition():this.error("Can't find given Spinner HTML element: '"+e.elementId+"' - will automatically create default element")),this._element||this._createDefaultSpinner(),this.processes=0}_createDefaultSpinner(){this._injectDefaultCSS();const t=document.createElement("div"),e=t.style;e["z-index"]="9000",e.position="absolute",t.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',this._canvas.parentElement.appendChild(t),this._element=t,this._isCustom=!1,this._adjustPosition()}_injectDefaultCSS(){const t="xeokit-spinner-css";if(document.getElementById(t))return;const e=document.createElement("style");e.innerHTML=".sk-fading-circle {        background: transparent;        margin: 20px auto;        width: 50px;        height:50px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }",e.id=t,document.body.appendChild(e)}_adjustPosition(){if(this._isCustom)return;const t=this._canvas,e=this._element,i=e.style;i.left=t.offsetLeft+.5*t.clientWidth-.5*e.clientWidth+"px",i.top=t.offsetTop+.5*t.clientHeight-.5*e.clientHeight+"px"}set processes(t){if(t=t||0,this._processes===t)return;if(t<0)return;const e=this._processes;this._processes=t;const i=this._element;i&&(i.style.visibility=this._processes>0?"visible":"hidden"),this.fire("processes",this._processes),0===this._processes&&this._processes!==e&&this.fire("zeroProcesses",this._processes)}get processes(){return this._processes}_destroy(){this._element&&!this._isCustom&&(this._element.parentNode.removeChild(this._element),this._element=null)}}const C={WEBGL:!1,SUPPORTED_EXTENSIONS:{}},A=document.createElement("canvas");if(A){const t=A.getContext("webgl",{antialias:!0})||A.getContext("experimental-webgl",{antialias:!0});C.WEBGL=!!t,C.WEBGL&&(C.ANTIALIAS=t.getContextAttributes().antialias,t.getShaderPrecisionFormat?t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision>0?C.FS_MAX_FLOAT_PRECISION="highp":t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT).precision>0?C.FS_MAX_FLOAT_PRECISION="mediump":C.FS_MAX_FLOAT_PRECISION="lowp":C.FS_MAX_FLOAT_PRECISION="mediump",C.DEPTH_BUFFER_BITS=t.getParameter(t.DEPTH_BITS),C.MAX_TEXTURE_SIZE=t.getParameter(t.MAX_TEXTURE_SIZE),C.MAX_CUBE_MAP_SIZE=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),C.MAX_RENDERBUFFER_SIZE=t.getParameter(t.MAX_RENDERBUFFER_SIZE),C.MAX_TEXTURE_UNITS=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),C.MAX_TEXTURE_IMAGE_UNITS=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),C.MAX_VERTEX_ATTRIBS=t.getParameter(t.MAX_VERTEX_ATTRIBS),C.MAX_VERTEX_UNIFORM_VECTORS=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),C.MAX_FRAGMENT_UNIFORM_VECTORS=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),C.MAX_VARYING_VECTORS=t.getParameter(t.MAX_VARYING_VECTORS),t.getSupportedExtensions().forEach((function(t){C.SUPPORTED_EXTENSIONS[t]=!0})),C.depthTexturesSupported=C.SUPPORTED_EXTENSIONS.WEBGL_depth_texture)}const S=["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"];class D extends w{get type(){return"Canvas"}constructor(t,e={}){super(t,e),this._backgroundColor=M.vec3([e.backgroundColor?e.backgroundColor[0]:1,e.backgroundColor?e.backgroundColor[1]:1,e.backgroundColor?e.backgroundColor[2]:1]),this._backgroundColorFromAmbientLight=!!e.backgroundColorFromAmbientLight,this.canvas=e.canvas,this.gl=null,this.webgl2=!1,this.transparent=!!e.transparent,this.contextAttr=e.contextAttr||{},this.contextAttr.alpha=this.transparent,this.contextAttr.preserveDrawingBuffer=!!this.contextAttr.preserveDrawingBuffer,this.contextAttr.stencil=!1,this.contextAttr.premultipliedAlpha=!!this.contextAttr.premultipliedAlpha,this.contextAttr.antialias=!1!==this.contextAttr.antialias,this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._initWebGL(e);const s=this;this.canvas.addEventListener("webglcontextlost",this._webglcontextlostListener=function(t){console.time("webglcontextrestored"),s.scene._webglContextLost(),s.fire("webglcontextlost"),t.preventDefault()},!1),this.canvas.addEventListener("webglcontextrestored",this._webglcontextrestoredListener=function(t){s._initWebGL(),s.gl&&(s.scene._webglContextRestored(s.gl),s.fire("webglcontextrestored",s.gl),t.preventDefault()),console.timeEnd("webglcontextrestored")},!1);let r=null,o=null,a=null,n=null,l=null,h=null,u=null;this._tick=this.scene.on("tick",(function(){const t=s.canvas,e=window.innerWidth!==r||window.innerHeight!==o,c=t.clientWidth!==a||t.clientHeight!==n,d=t.offsetLeft!==l||t.offsetTop!==h,p=t.parentElement;if(e||c||d||p!==u){if(s._spinner._adjustPosition(),c||d){const e=t.clientWidth,r=t.clientHeight;if(c){let e,s=0;for(const t in m.scenes)m.scenes.hasOwnProperty(t)&&(e=m.scenes[t],s+=e.canvas.canvas.clientWidth*e.canvas.canvas.clientHeight);i.memory.pixels=s,t.width=t.clientWidth,t.height=t.clientHeight}const o=s.boundary;o[0]=t.offsetLeft,o[1]=t.offsetTop,o[2]=e,o[3]=r,s.fire("boundary",o),a=e,n=r}e&&(r=window.innerWidth,o=window.innerHeight),d&&(l=t.offsetLeft,h=t.offsetTop),u=p}})),this._spinner=new E(this.scene,{canvas:this.canvas,elementId:e.spinnerElementId})}_createCanvas(){const t="xeokit-canvas-"+M.createUUID(),e=document.getElementsByTagName("body")[0],i=document.createElement("div"),s=i.style;s.height="100%",s.width="100%",s.padding="0",s.margin="0",s.background="rgba(0,0,0,0);",s.float="left",s.left="0",s.top="0",s.position="absolute",s.opacity="1.0",s["z-index"]="-10000",i.innerHTML+='<canvas id="'+t+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',e.appendChild(i),this.canvas=document.getElementById(t)}_getElementXY(t){let e=0,i=0;for(;t;)e+=t.offsetLeft-t.scrollLeft,i+=t.offsetTop-t.scrollTop,t=t.offsetParent;return{x:e,y:i}}_initWebGL(){if(!this.gl)for(let e=0;!this.gl&&e<S.length;e++)try{this.gl=this.canvas.getContext(S[e],this.contextAttr)}catch(t){}if(this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0)),this.gl)if(this.webgl2)this.gl.hint(this.gl.FRAGMENT_SHADER_DERIVATIVE_HINT,this.gl.FASTEST);else{if(C.SUPPORTED_EXTENSIONS.OES_standard_derivatives){const t=this.gl.getExtension("OES_standard_derivatives");this.gl.hint(t.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,this.gl.FASTEST)}C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&this.gl.getExtension("EXT_frag_depth"),C.SUPPORTED_EXTENSIONS.WEBGL_depth_texture&&this.gl.getExtension("WEBGL_depth_texture")}}set backgroundColorFromAmbientLight(t){this._backgroundColorFromAmbientLight=!1!==t}get backgroundColorFromAmbientLight(){return this._backgroundColorFromAmbientLight}set backgroundColor(t){t?(this._backgroundColor[0]=t[0],this._backgroundColor[1]=t[1],this._backgroundColor[2]=t[2]):(this._backgroundColor[0]=1,this._backgroundColor[1]=1,this._backgroundColor[2]=1),this.glRedraw()}get backgroundColor(){return this._backgroundColor}getSnapshot(t){throw"Canvas#getSnapshot() has been replaced by Viewer#getSnapshot() - use that method instead."}readPixels(t,e,i,s){return this.scene._renderer.readPixels(t,e,i,s)}loseWebGLContext(){this.canvas.loseContext&&this.canvas.loseContext()}get spinner(){return this._spinner}destroy(){this.scene.off(this._tick),this._spinner._destroy(),this.canvas.removeEventListener("webglcontextlost",this._webglcontextlostListener),this.canvas.removeEventListener("webglcontextrestored",this._webglcontextrestoredListener),this.gl=null,super.destroy()}}const L=M.vec3(),R=(M.AABB3(),function(){const t=new Float32Array(16),e=new Float64Array(4),i=new Float64Array(4);return function(s,r,o=t){return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=1,M.transformVec4(s,e,i),M.setMat4Translation(s,i,o),o}}());function B(t,e,i,s){const r=M.dotVec3(e,i)+t,o=M.normalizeVec3(e,L);return M.mulVec3Scalar(o,-r,s),s}class T{constructor(t){this._scene=t,this._matPool=[],this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.reset()}reset(){this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.gl=this._scene.canvas.gl,this.lastProgramId=null,this.pbrEnabled=!1,this.withSAO=!1,this.backfaces=!1,this.frontface=!0,this.textureUnit=0,this.drawElements=0,this.drawArrays=0,this.useProgram=0,this.bindTexture=0,this.bindArray=0,this.pass=0,this.shadowViewMatrix=null,this.shadowProjMatrix=null,this.pickViewMatrix=null,this.pickProjMatrix=null,this.pickZNear=.01,this.pickZFar=5e3,this.pickInvisible=!1,this.lineWidth=1}getRTCViewMatrix(t,e){let i=this._rtcViewMats[t];return i||(i=this._getNewMat(),R(this._scene.camera.viewMatrix,e,i),this._rtcViewMats[t]=i),i}getRTCPickViewMatrix(t,e){let i=this._rtcPickViewMats[t];if(!i){i=this._getNewMat();const s=this.pickViewMatrix||this._scene.camera.viewMatrix;R(s,e,i),this._rtcPickViewMats[t]=i}return i}_getNewMat(){let t=this._matPool[this._matPoolNextFreeIndex];return t||(t=M.mat4(),this._matPool[this._matPoolNextFreeIndex]=t),this._matPoolNextFreeIndex++,t}}const F=function(){const t=document.createElement("canvas"),e=String.fromCharCode;if(!t.getContext)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};const i=!!t.getContext("2d").getImageData,s=!!t.toDataURL,r=!!window.btoa,o=function(t){let i="";const s=t.width,r=t.height;i+="BM";let o=s*r*4+54;i+=e(o%256),o=Math.floor(o/256),i+=e(o%256),o=Math.floor(o/256),i+=e(o%256),o=Math.floor(o/256),i+=e(o%256),i+=e(0,0,0,0,54,0,0,0),i+=e(40,0,0,0);let a=s;i+=e(a%256),a=Math.floor(a/256),i+=e(a%256),a=Math.floor(a/256),i+=e(a%256),a=Math.floor(a/256),i+=e(a%256);let n=r;i+=e(n%256),n=Math.floor(n/256),i+=e(n%256),n=Math.floor(n/256),i+=e(n%256),n=Math.floor(n/256),i+=e(n%256),i+=e(1,0,32,0),i+=e(0,0,0,0);let l=s*r*4;i+=e(l%256),l=Math.floor(l/256),i+=e(l%256),l=Math.floor(l/256),i+=e(l%256),l=Math.floor(l/256),i+=e(l%256),i+=e(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const h=t.data;let u,c,d,p,f="",_=r;do{for(d=s*(_-1)*4,p="",u=0;u<s;u++)c=4*u,p+=e(h[d+c+2],h[d+c+1],h[d+c],h[d+c+3]);f+=p}while(--_);return function(t){let i,s,r="";if("string"==typeof t)r=t;else for(s=t,i=0;i<s.length;i++)r+=e(s[i]);return btoa(r)}(i+f)},a=function(t){window.open(t)||(document.location.href=t)},n=function(t,e){return"data:"+e+";base64,"+t},l=function(t){const e=document.createElement("img");return e.src=t,e},h=function(t,e,i,s){if(e&&i){const r=document.createElement("canvas");r.width=e,r.height=i,r.style.width=e+"px",r.style.height=i+"px";const o=r.getContext("2d");return s?(o.save(),o.scale(1,-1),o.imageSmoothingEnabled=!0,o.drawImage(t,0,0,t.width,t.height,0,0,e,-i),o.restore()):(o.imageSmoothingEnabled=!0,o.drawImage(t,0,0,t.width,t.height,0,0,e,i)),r}return t};return{saveAsPNG:function(t,e,i,r,o){if(!s)return!1;const n="image/png",u=h(t,i,r,o).toDataURL(n);return e?l(u):(a(u),!0)},saveAsJPEG:function(t,e,i,r,o){if(!s)return!1;const n="image/jpeg",u=h(t,i,r,o).toDataURL(n);return 5==u.indexOf(n)&&(e?l(u):(a(u),!0))},saveAsBMP:function(t,e,u,c,d){if(!(s&&i&&r))return!1;const p="image/bmp",f=function(t){const e=parseInt(t.width),i=parseInt(t.height);return t.getContext("2d").getImageData(0,0,e,i)}(h(t,u,c,d)),_=o(f);return e?l(n(_,p)):(a(n(_,p)),!0)}}}();class N{constructor(t,e,i){i=i||{},this.gl=e,this.allocated=!1,this.canvas=t,this.buffer=null,this.bound=!1,this.size=i.size,this._hasDepthTexture=!!i.depthTexture}setSize(t){this.size=t}webglContextRestored(t){this.gl=t,this.buffer=null,this.allocated=!1,this.bound=!1}bind(){if(this._touch(),this.bound)return;const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0}_touch(){let t,e;const i=this.gl;if(this.size?(t=this.size[0],e=this.size[1]):(t=i.drawingBufferWidth,e=i.drawingBufferHeight),this.buffer){if(this.buffer.width===t&&this.buffer.height===e)return;i.deleteTexture(this.buffer.texture),i.deleteFramebuffer(this.buffer.framebuf),i.deleteRenderbuffer(this.buffer.renderbuf)}const s=i.createTexture();let r;i.bindTexture(i.TEXTURE_2D,s),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,i.UNSIGNED_BYTE,null),this._hasDepthTexture&&(r=i.createTexture(),i.bindTexture(i.TEXTURE_2D,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.DEPTH_COMPONENT,t,e,0,i.DEPTH_COMPONENT,i.UNSIGNED_INT,null));const o=i.createRenderbuffer();i.bindRenderbuffer(i.RENDERBUFFER,o),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,t,e);const a=i.createFramebuffer();if(i.bindFramebuffer(i.FRAMEBUFFER,a),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,s,0),this._hasDepthTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.TEXTURE_2D,r,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,o),i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,a),!i.isFramebuffer(a))throw"Invalid framebuffer";i.bindFramebuffer(i.FRAMEBUFFER,null);const n=i.checkFramebufferStatus(i.FRAMEBUFFER);switch(n){case i.FRAMEBUFFER_COMPLETE:break;case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case i.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+n}this.buffer={framebuf:a,renderbuf:o,texture:s,depthTexture:r,width:t,height:e},this.bound=!1}clear(){if(!this.bound)throw"Render buffer not bound";const t=this.gl;t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}read(t,e){const i=t,s=this.gl.drawingBufferHeight-e,r=new Uint8Array(4),o=this.gl;return o.readPixels(i,s,1,1,o.RGBA,o.UNSIGNED_BYTE,r),r}readImage(t){const e=this.gl,i=this._getImageDataCache(),s=i.pixelData,r=i.canvas,o=i.imageData,a=i.context;e.readPixels(0,0,this.buffer.width,this.buffer.height,e.RGBA,e.UNSIGNED_BYTE,s),o.data.set(s),a.putImageData(o,0,0);const n=t.width||r.width,l=t.height||r.height,h=t.format||"jpeg",u=!0;let c;switch(h){case"jpeg":c=F.saveAsJPEG(r,!0,n,l,u);break;case"png":c=F.saveAsPNG(r,!0,n,l,u);break;case"bmp":c=F.saveAsBMP(r,!0,n,l,u);break;default:console.error("Unsupported image format: '"+h+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'jpeg'"),c=F.saveAsJPEG(r,!0,n,l,u)}return c.src}_getImageDataCache(){const t=this.buffer.width,e=this.buffer.height;let i=this._imageDataCache;if(i&&(i.width===t&&i.height===e||(this._imageDataCache=null,i=null)),!i){const s=document.createElement("canvas");s.width=t,s.height=e;const r=s.getContext("2d"),o=r.createImageData(t,e);i={pixelData:new Uint8Array(t*e*4),canvas:s,context:r,imageData:o,width:t,height:e},this._imageDataCache=i}return i}unbind(){const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),this.bound=!1}getTexture(){const t=this;return this._texture||(this._texture={renderBuffer:this,bind:function(e){return!(!t.buffer||!t.buffer.texture)&&(t.gl.activeTexture(t.gl["TEXTURE"+e]),t.gl.bindTexture(t.gl.TEXTURE_2D,t.buffer.texture),!0)},unbind:function(e){t.buffer&&t.buffer.texture&&(t.gl.activeTexture(t.gl["TEXTURE"+e]),t.gl.bindTexture(t.gl.TEXTURE_2D,null))}})}hasDepthTexture(){return this._hasDepthTexture}getDepthTexture(){if(!this._hasDepthTexture)return null;const t=this;return this._depthTexture||(this._dethTexture={renderBuffer:this,bind:function(e){return!(!t.buffer||!t.buffer.depthTexture)&&(t.gl.activeTexture(t.gl["TEXTURE"+e]),t.gl.bindTexture(t.gl.TEXTURE_2D,t.buffer.depthTexture),!0)},unbind:function(e){t.buffer&&t.buffer.depthTexture&&(t.gl.activeTexture(t.gl["TEXTURE"+e]),t.gl.bindTexture(t.gl.TEXTURE_2D,null))}})}destroy(){if(this.allocated){const t=this.gl;t.deleteTexture(this.buffer.texture),t.deleteTexture(this.buffer.depthTexture),t.deleteFramebuffer(this.buffer.framebuf),t.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1}this._imageDataCache=null,this._texture=null,this._depthTexture=null}}class O{constructor(){this.entity=null,this.primitive=null,this.primIndex=-1,this._canvasPos=new Int16Array([0,0]),this._origin=new Float64Array([0,0,0]),this._direction=new Float64Array([0,0,0]),this._indices=new Int32Array(3),this._localPos=new Float64Array([0,0,0]),this._worldPos=new Float64Array([0,0,0]),this._viewPos=new Float64Array([0,0,0]),this._bary=new Float64Array([0,0,0]),this._worldNormal=new Float64Array([0,0,0]),this._uv=new Float64Array([0,0]),this.reset()}get canvasPos(){return this._gotCanvasPos?this._canvasPos:null}set canvasPos(t){t?(this._canvasPos[0]=t[0],this._canvasPos[1]=t[1],this._gotCanvasPos=!0):this._gotCanvasPos=!1}get origin(){return this._gotOrigin?this._origin:null}set origin(t){t?(this._origin[0]=t[0],this._origin[1]=t[1],this._origin[2]=t[2],this._gotOrigin=!0):this._gotOrigin=!1}get direction(){return this._gotDirection?this._direction:null}set direction(t){t?(this._direction[0]=t[0],this._direction[1]=t[1],this._direction[2]=t[2],this._gotDirection=!0):this._gotDirection=!1}get indices(){return this.entity&&this._gotIndices?this._indices:null}set indices(t){t?(this._indices[0]=t[0],this._indices[1]=t[1],this._indices[2]=t[2],this._gotIndices=!0):this._gotIndices=!1}get localPos(){return this.entity&&this._gotLocalPos?this._localPos:null}set localPos(t){t?(this._localPos[0]=t[0],this._localPos[1]=t[1],this._localPos[2]=t[2],this._gotLocalPos=!0):this._gotLocalPos=!1}get worldPos(){return this.entity&&this._gotWorldPos?this._worldPos:null}set worldPos(t){t?(this._worldPos[0]=t[0],this._worldPos[1]=t[1],this._worldPos[2]=t[2],this._gotWorldPos=!0):this._gotWorldPos=!1}get viewPos(){return this.entity&&this._gotViewPos?this._viewPos:null}set viewPos(t){t?(this._viewPos[0]=t[0],this._viewPos[1]=t[1],this._viewPos[2]=t[2],this._gotViewPos=!0):this._gotViewPos=!1}get bary(){return this.entity&&this._gotBary?this._bary:null}set bary(t){t?(this._bary[0]=t[0],this._bary[1]=t[1],this._bary[2]=t[2],this._gotBary=!0):this._gotBary=!1}get worldNormal(){return this.entity&&this._gotWorldNormal?this._worldNormal:null}set worldNormal(t){t?(this._worldNormal[0]=t[0],this._worldNormal[1]=t[1],this._worldNormal[2]=t[2],this._gotWorldNormal=!0):this._gotWorldNormal=!1}get uv(){return this.entity&&this._gotUV?this._uv:null}set uv(t){t?(this._uv[0]=t[0],this._uv[1]=t[1],this._gotUV=!0):this._gotUV=!1}reset(){this.entity=null,this.primIndex=-1,this.primitive=null,this._gotCanvasPos=!1,this._gotOrigin=!1,this._gotDirection=!1,this._gotIndices=!1,this._gotLocalPos=!1,this._gotWorldPos=!1,this._gotViewPos=!1,this._gotBary=!1,this._gotWorldNormal=!1,this._gotUV=!1}}class k{constructor(t,e,i){if(this.allocated=!1,this.compiled=!1,this.handle=t.createShader(e),this.handle){if(this.allocated=!0,t.shaderSource(this.handle,i),t.compileShader(this.handle),this.compiled=t.getShaderParameter(this.handle,t.COMPILE_STATUS),!this.compiled&&!t.isContextLost()){const e=i.split("\n"),s=[];for(let t=0;t<e.length;t++)s.push(t+1+": "+e[t]+"\n");this.errors=[],this.errors.push(""),this.errors.push(t.getShaderInfoLog(this.handle)),this.errors=this.errors.concat(s.join(""))}}else this.errors=["Failed to allocate"]}destroy(){}}class I{constructor(t,e){this.bindTexture=function(i,s){return!!i.bind(s)&&(t.uniform1i(e,s),!0)}}}class z{constructor(t,e){this._gl=t,this.location=e}bindArrayBuffer(t){t&&(t.bind(),this._gl.enableVertexAttribArray(this.location),this._gl.vertexAttribPointer(this.location,t.itemSize,t.itemType,t.normalized,t.stride,t.offset))}}const V=new e({});function U(t){const e=[];let i,s;for(let r=0,o=t.length;r<o;r++)i=t[r],s=i.indexOf("/"),s>0&&"/"===i.charAt(s+1)&&(i=i.substring(0,s)),e.push(i);return e.join("\n")}function G(t){console.error(t.join("\n"))}class X{constructor(t,e){this.id=V.addItem({}),this.source=e,this.init(t)}init(t){if(this.gl=t,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errors=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new k(t,t.VERTEX_SHADER,U(this.source.vertex)),this._fragmentShader=new k(t,t.FRAGMENT_SHADER,U(this.source.fragment)),!this._vertexShader.allocated)return this.errors=["Vertex shader failed to allocate"].concat(this._vertexShader.errors),void G(this.errors);if(!this._fragmentShader.allocated)return this.errors=["Fragment shader failed to allocate"].concat(this._fragmentShader.errors),void G(this.errors);if(this.allocated=!0,!this._vertexShader.compiled)return this.errors=["Vertex shader failed to compile"].concat(this._vertexShader.errors),void G(this.errors);if(!this._fragmentShader.compiled)return this.errors=["Fragment shader failed to compile"].concat(this._fragmentShader.errors),void G(this.errors);let e,i,s,r,o;if(this.compiled=!0,this.handle=t.createProgram(),!this.handle)return void(this.errors=["Failed to allocate program"]);if(t.attachShader(this.handle,this._vertexShader.handle),t.attachShader(this.handle,this._fragmentShader.handle),t.linkProgram(this.handle),this.linked=t.getProgramParameter(this.handle,t.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errors=[],this.errors.push(""),this.errors.push(t.getProgramInfoLog(this.handle)),this.errors.push("\nVertex shader:\n"),this.errors=this.errors.concat(this.source.vertex),this.errors.push("\nFragment shader:\n"),this.errors=this.errors.concat(this.source.fragment),void G(this.errors);const a=t.getProgramParameter(this.handle,t.ACTIVE_UNIFORMS);for(i=0;i<a;++i)s=t.getActiveUniform(this.handle,i),s&&(r=s.name,"\0"===r[r.length-1]&&(r=r.substr(0,r.length-1)),o=t.getUniformLocation(this.handle,r),s.type===t.SAMPLER_2D||s.type===t.SAMPLER_CUBE||35682===s.type?this.samplers[r]=new I(t,o):this.uniforms[r]=o);const n=t.getProgramParameter(this.handle,t.ACTIVE_ATTRIBUTES);for(i=0;i<n;i++)e=t.getActiveAttrib(this.handle,i),e&&(o=t.getAttribLocation(this.handle,e.name),this.attributes[e.name]=new z(t,o));this.allocated=!0}bind(){this.allocated&&this.gl.useProgram(this.handle)}getLocation(t){if(this.allocated)return this.uniforms[t]}getAttribute(t){if(this.allocated)return this.attributes[t]}bindTexture(t,e,i){if(!this.allocated)return!1;const s=this.samplers[t];return!!s&&s.bindTexture(e,i)}destroy(){this.allocated&&(V.removeItem(this.id),this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}class j{constructor(t,e,i,s,r,o,a,n,l){switch(this._gl=t,this.type=e,this.allocated=!1,i.constructor){case Uint8Array:this.itemType=t.UNSIGNED_BYTE,this.itemByteSize=1;break;case Int8Array:this.itemType=t.BYTE,this.itemByteSize=1;break;case Uint16Array:this.itemType=t.UNSIGNED_SHORT,this.itemByteSize=2;break;case Int16Array:this.itemType=t.SHORT,this.itemByteSize=2;break;case Uint32Array:this.itemType=t.UNSIGNED_INT,this.itemByteSize=4;break;case Int32Array:this.itemType=t.INT,this.itemByteSize=4;break;default:this.itemType=t.FLOAT,this.itemByteSize=4}this.usage=o,this.length=0,this.dataLength=s,this.numItems=0,this.itemSize=r,this.normalized=!!a,this.stride=n||0,this.offset=l||0,this._allocate(i)}_allocate(t){if(this.allocated=!1,this._handle=this._gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this._gl.bindBuffer(this.type,this._handle),this._gl.bufferData(this.type,t.length>this.dataLength?t.slice(0,this.dataLength):t,this.usage),this._gl.bindBuffer(this.type,null),this.length=t.length,this.numItems=this.length/this.itemSize,this.allocated=!0)}setData(t,e){this.allocated&&(t.length+(e||0)>this.length?(this.destroy(),this._allocate(t)):(this._gl.bindBuffer(this.type,this._handle),e||0===e?this._gl.bufferSubData(this.type,e*this.itemByteSize,t):this._gl.bufferData(this.type,t,this.usage),this._gl.bindBuffer(this.type,null)))}bind(){this.allocated&&this._gl.bindBuffer(this.type,this._handle)}unbind(){this.allocated&&this._gl.bindBuffer(this.type,null)}destroy(){this.allocated&&(this._gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)}}class W{constructor(t,e){this.scene=t,this.aabb=M.AABB3(),this.rtcCenter=M.vec3(e),this.rtcCenterHash=this.rtcCenter.join(),this.numMarkers=0,this.markers={},this.markerList=[],this.markerIndices={},this.positions=[],this.indices=[],this.positionsBuf=null,this.lenPositionsBuf=0,this.indicesBuf=null,this.sectionPlanesActive=[],this.culledBySectionPlanes=!1,this.occlusionTestList=[],this.lenOcclusionTestList=0,this.pixels=[],this.aabbDirty=!1,this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!1}addMarker(t){this.markers[t.id]=t,this.markerListDirty=!0,this.numMarkers++}markerWorldPosUpdated(t){if(!this.markers[t.id])return;const e=this.markerIndices[t.id];this.positions[3*e+0]=t.worldPos[0],this.positions[3*e+1]=t.worldPos[1],this.positions[3*e+2]=t.worldPos[2],this.positionsDirty=!0}removeMarker(t){delete this.markers[t.id],this.markerListDirty=!0,this.numMarkers--}update(){this.markerListDirty&&(this._buildMarkerList(),this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!0),this.positionsDirty&&(this._buildPositions(),this.positionsDirty=!1,this.aabbDirty=!0,this.vbosDirty=!0),this.aabbDirty&&(this._buildAABB(),this.aabbDirty=!1),this.vbosDirty&&(this._buildVBOs(),this.vbosDirty=!1),this.occlusionTestListDirty&&this._buildOcclusionTestList(),this._updateActiveSectionPlanes()}_buildMarkerList(){for(var t in this.numMarkers=0,this.markers)this.markers.hasOwnProperty(t)&&(this.markerList[this.numMarkers]=this.markers[t],this.markerIndices[t]=this.numMarkers,this.numMarkers++);this.markerList.length=this.numMarkers}_buildPositions(){let t=0;for(let e=0;e<this.numMarkers;e++)if(this.markerList[e]){const i=this.markerList[e].worldPos;this.positions[t++]=i[0],this.positions[t++]=i[1],this.positions[t++]=i[2],this.indices[e]=e}this.positions.length=3*this.numMarkers,this.indices.length=this.numMarkers}_buildAABB(){const t=this.aabb;M.collapseAABB3(t),M.expandAABB3Points3(t,this.positions);const e=this.rtcCenter;t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t[3]+=e[0],t[4]+=e[1],t[5]+=e[2]}_buildVBOs(){if(this.positionsBuf){if(this.lenPositionsBuf===this.positions.length)return void this.positionsBuf.setData(this.positions);this.positionsBuf.destroy(),this.positionsBuf=null,this.indicesBuf.destroy(),this.indicesBuf=null}const t=this.scene.canvas.gl,e=3*this.numMarkers,i=this.numMarkers;this.positionsBuf=new j(t,t.ARRAY_BUFFER,new Float32Array(this.positions),e,3,t.STATIC_DRAW),this.indicesBuf=new j(t,t.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),i,1,t.STATIC_DRAW),this.lenPositionsBuf=this.positions.length}_buildOcclusionTestList(){const t=this.scene.canvas,e=this.scene.camera.perspective.near,i=t.boundary,s=i[2],r=i[3];let o=0;this.lenOcclusionTestList=0;for(let t=0;t<this.numMarkers;t++){const i=this.markerList[t];if(i.viewPos[2]>-e){i._setVisible(!1);continue}const a=i.canvasPos,n=a[0],l=a[1];n+10<0||l+10<0||n-10>s||l-10>r?i._setVisible(!1):!i.entity||i.entity.visible?i.occludable?(this.occlusionTestList[this.lenOcclusionTestList++]=i,this.pixels[o++]=n,this.pixels[o++]=l):i._setVisible(!0):i._setVisible(!1)}}_updateActiveSectionPlanes(){const t=this.scene._sectionPlanesState.sectionPlanes,e=t.length;if(e>0)for(let i=0;i<e;i++){const e=t[i];if(e.active){const t=M.planeAABB3Intersect(e.dir,e.dist,this.aabb);if(-1===t)return void(this.culledBySectionPlanes=!0);const s=0===t;this.sectionPlanesActive[i]=s}else this.sectionPlanesActive[i]=!1}this.culledBySectionPlanes=!1}destroy(){this.markers={},this.markerList.length=0,this.positionsBuf&&this.positionsBuf.destroy(),this.indicesBuf&&this.indicesBuf.destroy()}}const H=M.vec3([1,0,0]),Y=M.vec3();class K{constructor(t){this._scene=t,this._occlusionLayers={},this._occlusionLayersList=[],this._occlusionLayersListDirty=!1,this._shaderSource=null,this._program=null,this._shaderSourceHash=null,this._shaderSourceDirty=!0,this._programDirty=!1,this._markersToOcclusionLayersMap={},this._onCameraViewMatrix=t.camera.on("viewMatrix",(()=>{this._occlusionTestListDirty=!0})),this._onCameraProjMatrix=t.camera.on("projMatrix",(()=>{this._occlusionTestListDirty=!0})),this._onCanvasBoundary=t.canvas.on("boundary",(()=>{this._occlusionTestListDirty=!0}))}addMarker(t){const e=t.rtcCenter.join();let i=this._occlusionLayers[e];i||(i=new W(this._scene,t.rtcCenter),this._occlusionLayers[i.rtcCenterHash]=i,this._occlusionLayersListDirty=!0),i.addMarker(t),this._markersToOcclusionLayersMap[t.id]=i,this._occlusionTestListDirty=!0}markerWorldPosUpdated(t){const e=this._markersToOcclusionLayersMap[t.id];if(!e)return void t.error("Marker has not been added to OcclusionTester");const i=t.rtcCenter.join();if(i!==e.rtcCenterHash){1===e.numMarkers?(e.destroy(),delete this._occlusionLayers[e.rtcCenterHash],this._occlusionLayersListDirty=!0):e.removeMarker(t);let s=this._occlusionLayers[i];s||(s=new W(this._scene,t.rtcCenter),this._occlusionLayers[i]=e,this._occlusionLayersListDirty=!0),s.addMarker(t),this._markersToOcclusionLayersMap[t.id]=s}else e.markerWorldPosUpdated(t)}removeMarker(t){const e=t.rtcCenter.join();let i=this._occlusionLayers[e];i&&(1===i.numMarkers?(i.destroy(),delete this._occlusionLayers[i.rtcCenterHash],this._occlusionLayersListDirty=!0):i.removeMarker(t),delete this._markersToOcclusionLayersMap[t.id])}get needOcclusionTest(){return this._occlusionTestListDirty}bindRenderBuf(){const t=[this._scene.canvas.canvas.id,this._scene._sectionPlanesState.getHash()].join(";");if(t!==this._shaderSourceHash&&(this._shaderSourceHash=t,this._shaderSourceDirty=!0),this._shaderSourceDirty&&(this._buildShaderSource(),this._shaderSourceDirty=!1,this._programDirty=!0),this._programDirty&&(this._buildProgram(),this._programDirty=!1,this._occlusionTestListDirty=!0),this._occlusionLayersListDirty&&(this._buildOcclusionLayersList(),this._occlusionLayersListDirty=!1),this._occlusionTestListDirty){for(let t=0,e=this._occlusionLayersList.length;t<e;t++){this._occlusionLayersList[t].occlusionTestListDirty=!0}this._occlusionTestListDirty=!1}this._readPixelBuf=this._readPixelBuf||(this._readPixelBuf=new N(this._scene.canvas.canvas,this._scene.canvas.gl)),this._readPixelBuf.bind(),this._readPixelBuf.clear()}_buildOcclusionLayersList(){let t=0;for(let e in this._occlusionLayers)this._occlusionLayers.hasOwnProperty(e)&&(this._occlusionLayersList[t++]=this._occlusionLayers[e]);this._occlusionLayersList.length=t}_buildShaderSource(){this._shaderSource={vertex:this._buildVertexShaderSource(),fragment:this._buildFragmentShaderSource()}}_buildVertexShaderSource(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// OcclusionTester vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("attribute vec3 position;"),i.push("uniform mat4 modelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&i.push("varying vec4 vWorldPosition;"),i.push("void main(void) {"),i.push("vec4 worldPosition = vec4(position, 1.0); "),i.push("   vec4 viewPosition = viewMatrix * worldPosition;"),e&&i.push("   vWorldPosition = worldPosition;"),i.push("   vec4 clipPos = projMatrix * viewPosition;"),i.push("   gl_Position = clipPos;"),i.push("   gl_PointSize = 20.0;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("}"),i}_buildFragmentShaderSource(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// OcclusionTester fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("void main(void) {"),i){s.push("  float dist = 0.0;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0); "),s.push("}"),s}_buildProgram(){this._program&&this._program.destroy();const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new X(e,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}drawMarkers(){const t=this._scene,e=t.canvas.gl,i=this._program,s=t._sectionPlanesState,r=t.camera,o=t.camera.project;if(C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&t.logarithmicDepthBufferEnabled&&e.getExtension("EXT_frag_depth"),i.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,r._project._state.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}for(let t=0,i=this._occlusionLayersList.length;t<i;t++){const i=this._occlusionLayersList[t];if(i.update(),i.culledBySectionPlanes)continue;const o=i.rtcCenter;e.uniformMatrix4fv(this._uViewMatrix,!1,R(r.viewMatrix,o));const a=s.sectionPlanes.length;if(a>0){const t=s.sectionPlanes;for(let s=0;s<a;s++){const r=this._uSectionPlanes[s],a=i.sectionPlanesActive[s];if(e.uniform1i(r.active,a?1:0),a){const i=t[s];e.uniform3fv(r.pos,B(i.dist,i.dir,o,Y)),e.uniform3fv(r.dir,i.dir)}}}this._aPosition.bindArrayBuffer(i.positionsBuf);const n=i.indicesBuf;n.bind(),e.drawElements(e.POINTS,n.numItems,n.itemType,0)}}doOcclusionTest(){{const t=255*H[0],e=255*H[1],i=255*H[2];for(let s=0,r=this._occlusionLayersList.length;s<r;s++){const r=this._occlusionLayersList[s];for(let s=0;s<r.lenOcclusionTestList;s++){const o=r.occlusionTestList[s],a=2*s,n=this._readPixelBuf.read(r.pixels[a],r.pixels[a+1]),l=n[0]===t&&n[1]===e&&n[2]===i;o._setVisible(l)}}}}unbindRenderBuf(){this._readPixelBuf.unbind()}destroy(){if(!this.destroyed){for(let t=0,e=this._occlusionLayersList.length;t<e;t++){this._occlusionLayersList[t].destroy()}this._program&&this._program.destroy(),this._scene.camera.off(this._onCameraViewMatrix),this._scene.camera.off(this._onCameraProjMatrix),this._scene.canvas.off(this._onCanvasBoundary),this.destroyed=!0}}}const $=M.vec2();class q{constructor(t){this._scene=t,this._numSamples=null,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uScale=null,this._uIntensity=null,this._uBias=null,this._uKernelRadius=null,this._uMinResolution=null,this._uRandomSeed=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null}render(t){if(this._build(),this._programError)return;this._getInverseProjectMat||(this._getInverseProjectMat=(()=>{let t=!0;this._scene.camera.on("projMatrix",(function(){t=!0}));const e=M.mat4();return()=>(t&&M.inverseMat4(s.camera.projMatrix,e),e)})());const e=this._scene.canvas.gl,i=this._program,s=this._scene,r=s.sao,o=e.drawingBufferWidth,a=e.drawingBufferHeight,n=s.camera.project._state,l=n.near,h=n.far,u=n.matrix,c=this._getInverseProjectMat(),d=Math.random(),p="perspective"===s.camera.projection;$[0]=o,$[1]=a,e.getExtension("OES_standard_derivatives"),e.viewport(0,0,o,a),e.clearColor(0,0,0,1),e.disable(e.DEPTH_TEST),e.disable(e.BLEND),e.frontFace(e.CCW),e.clear(e.COLOR_BUFFER_BIT),i.bind(),e.uniform1f(this._uCameraNear,l),e.uniform1f(this._uCameraFar,h),e.uniformMatrix4fv(this._uCameraProjectionMatrix,!1,u),e.uniformMatrix4fv(this._uCameraInverseProjectionMatrix,!1,c),e.uniform1i(this._uPerspective,p),e.uniform1f(this._uScale,r.scale*(h/5)),e.uniform1f(this._uIntensity,r.intensity),e.uniform1f(this._uBias,r.bias),e.uniform1f(this._uKernelRadius,r.kernelRadius),e.uniform1f(this._uMinResolution,r.minResolution),e.uniform2fv(this._uViewport,$),e.uniform1f(this._uRandomSeed,d);const f=C.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?t.getDepthTexture():t.getTexture();i.bindTexture(this._uDepthTexture,f,0),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),e.drawElements(e.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}_build(){let t=!1;const e=this._scene.sao;if(e.numSamples!==this._numSamples&&(this._numSamples=Math.floor(e.numSamples),t=!0),!t)return;const i=this._scene.canvas.gl;if(this._program&&(this._program.destroy(),this._program=null),this._program=new X(i,{vertex:["precision highp float;\n                    precision highp int;\n                    \n                    attribute vec3 aPosition;\n                    attribute vec2 aUV;            \n                    \n                    varying vec2 vUV;\n                    \n                    void main () {\n                        gl_Position = vec4(aPosition, 1.0);\n                        vUV = aUV;\n                    }"],fragment:[`#extension GL_OES_standard_derivatives : require              \n                precision highp float;\n                precision highp int;           \n                \n                #define NORMAL_TEXTURE 0\n                #define PI 3.14159265359\n                #define PI2 6.28318530718\n                #define EPSILON 1e-6\n                #define NUM_SAMPLES ${this._numSamples}\n                #define NUM_RINGS 4              \n            \n                varying vec2        vUV;\n            \n                uniform sampler2D   uDepthTexture;\n               \n                uniform float       uCameraNear;\n                uniform float       uCameraFar;\n                uniform mat4        uProjectMatrix;\n                uniform mat4        uInverseProjectMatrix;\n                \n                uniform bool        uPerspective;\n\n                uniform float       uScale;\n                uniform float       uIntensity;\n                uniform float       uBias;\n                uniform float       uKernelRadius;\n                uniform float       uMinResolution;\n                uniform vec2        uViewport;\n                uniform float       uRandomSeed;\n\n                float pow2( const in float x ) { return x*x; }\n                \n                highp float rand( const in vec2 uv ) {\n                    const highp float a = 12.9898, b = 78.233, c = 43758.5453;\n                    highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n                    return fract(sin(sn) * c);\n                }\n\n                vec3 packNormalToRGB( const in vec3 normal ) {\n                    return normalize( normal ) * 0.5 + 0.5;\n                }\n\n                vec3 unpackRGBToNormal( const in vec3 rgb ) {\n                    return 2.0 * rgb.xyz - 1.0;\n                }\n\n                const float packUpscale = 256. / 255.;\n                const float unpackDownScale = 255. / 256.; \n\n                const vec3 packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\n                const vec4 unPackFactors = unpackDownScale / vec4( packFactors, 1. );   \n\n                const float shiftRights = 1. / 256.;\n\n                vec4 packFloatToRGBA( const in float v ) {\n                    vec4 r = vec4( fract( v * packFactors ), v );\n                    r.yzw -= r.xyz * shiftRights; \n                    return r * packUpscale;\n                }\n\n                float unpackRGBAToFloat( const in vec4 v ) {                   \n                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unPackFactors );\n                }\n                \n                float perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n                    return ( near * far ) / ( ( far - near ) * invClipZ - far );\n                }\n\n                float orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n                    return linearClipZ * ( near - far ) - near;\n                }\n                \n                float getDepth( const in vec2 screenPosition ) {`+(C.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?"return texture2D(uDepthTexture, screenPosition).r;":"return unpackRGBAToFloat(texture2D( uDepthTexture, screenPosition));")+"}\n\n                float getViewZ( const in float depth ) {\n                     if (uPerspective) {\n                         return perspectiveDepthToViewZ( depth, uCameraNear, uCameraFar );\n                     } else {\n                        return orthographicDepthToViewZ( depth, uCameraNear, uCameraFar );\n                     }\n                }\n\n                vec3 getViewPos( const in vec2 screenPos, const in float depth, const in float viewZ ) {\n                \tfloat clipW = uProjectMatrix[2][3] * viewZ + uProjectMatrix[3][3];\n                \tvec4 clipPosition = vec4( ( vec3( screenPos, depth ) - 0.5 ) * 2.0, 1.0 );\n                \tclipPosition *= clipW; \n                \treturn ( uInverseProjectMatrix * clipPosition ).xyz;\n                }\n\n                vec3 getViewNormal( const in vec3 viewPosition, const in vec2 screenPos ) {               \n                    return normalize( cross( dFdx( viewPosition ), dFdy( viewPosition ) ) );\n                }\n\n                float scaleDividedByCameraFar;\n                float minResolutionMultipliedByCameraFar;\n\n                float getOcclusion( const in vec3 centerViewPosition, const in vec3 centerViewNormal, const in vec3 sampleViewPosition ) {\n                \tvec3 viewDelta = sampleViewPosition - centerViewPosition;\n                \tfloat viewDistance = length( viewDelta );\n                \tfloat scaledScreenDistance = scaleDividedByCameraFar * viewDistance;\n                \treturn max(0.0, (dot(centerViewNormal, viewDelta) - minResolutionMultipliedByCameraFar) / scaledScreenDistance - uBias) / (1.0 + pow2( scaledScreenDistance ) );\n                }\n\n                const float ANGLE_STEP = PI2 * float( NUM_RINGS ) / float( NUM_SAMPLES );\n                const float INV_NUM_SAMPLES = 1.0 / float( NUM_SAMPLES );\n\n                float getAmbientOcclusion( const in vec3 centerViewPosition ) {\n            \n                \tscaleDividedByCameraFar = uScale / uCameraFar;\n                \tminResolutionMultipliedByCameraFar = uMinResolution * uCameraFar;\n                \tvec3 centerViewNormal = getViewNormal( centerViewPosition, vUV );\n\n                \tfloat angle = rand( vUV + uRandomSeed ) * PI2;\n                \tvec2 radius = vec2( uKernelRadius * INV_NUM_SAMPLES ) / uViewport;\n                \tvec2 radiusStep = radius;\n\n                \tfloat occlusionSum = 0.0;\n                \tfloat weightSum = 0.0;\n\n                \tfor( int i = 0; i < NUM_SAMPLES; i ++ ) {\n                \t\tvec2 sampleUv = vUV + vec2( cos( angle ), sin( angle ) ) * radius;\n                \t\tradius += radiusStep;\n                \t\tangle += ANGLE_STEP;\n\n                \t\tfloat sampleDepth = getDepth( sampleUv );\n                \t\tif( sampleDepth >= ( 1.0 - EPSILON ) ) {\n                \t\t\tcontinue;\n                \t\t}\n\n                \t\tfloat sampleViewZ = getViewZ( sampleDepth );\n                \t\tvec3 sampleViewPosition = getViewPos( sampleUv, sampleDepth, sampleViewZ );\n                \t\tocclusionSum += getOcclusion( centerViewPosition, centerViewNormal, sampleViewPosition );\n                \t\tweightSum += 1.0;\n                \t}\n\n                \tif( weightSum == 0.0 ) discard;\n\n                \treturn occlusionSum * ( uIntensity / weightSum );\n                }\n\n                void main() {\n                \n                \tfloat centerDepth = getDepth( vUV );\n                \t\n                \tif( centerDepth >= ( 1.0 - EPSILON ) ) {\n                \t\tdiscard;\n                \t}\n\n                \tfloat centerViewZ = getViewZ( centerDepth );\n                \tvec3 viewPosition = getViewPos( vUV, centerDepth, centerViewZ );\n\n                \tfloat ambientOcclusion = getAmbientOcclusion( viewPosition );\n                \n                \tgl_FragColor = packFloatToRGBA(  1.0- ambientOcclusion );\n                }"]}),this._program.errors)return console.error(this._program.errors.join("\n")),void(this._programError=!0);const s=new Float32Array([1,1,0,1,0,0,1,0]),r=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),o=new Uint8Array([0,1,2,0,2,3]);this._positionsBuf=new j(i,i.ARRAY_BUFFER,r,r.length,3,i.STATIC_DRAW),this._uvBuf=new j(i,i.ARRAY_BUFFER,s,s.length,2,i.STATIC_DRAW),this._indicesBuf=new j(i,i.ELEMENT_ARRAY_BUFFER,o,o.length,1,i.STATIC_DRAW),this._program.bind(),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uCameraProjectionMatrix=this._program.getLocation("uProjectMatrix"),this._uCameraInverseProjectionMatrix=this._program.getLocation("uInverseProjectMatrix"),this._uPerspective=this._program.getLocation("uPerspective"),this._uScale=this._program.getLocation("uScale"),this._uIntensity=this._program.getLocation("uIntensity"),this._uBias=this._program.getLocation("uBias"),this._uKernelRadius=this._program.getLocation("uKernelRadius"),this._uMinResolution=this._program.getLocation("uMinResolution"),this._uViewport=this._program.getLocation("uViewport"),this._uRandomSeed=this._program.getLocation("uRandomSeed"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV"),this._dirty=!1}destroy(){this._program&&(this._program.destroy(),this._program=null)}}const Z=new Float32Array(st(17,[0,1])),Q=new Float32Array(st(17,[1,0])),J=new Float32Array(function(t,e){const i=[];for(let s=0;s<=t;s++)i.push(it(s,e));return i}(17,4)),tt=new Float32Array(2);class et{constructor(t){this._scene=t,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uOcclusionTexture="uOcclusionTexture",this._uViewport=null,this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uScale=null,this._uIntensity=null,this._uBias=null,this._uKernelRadius=null,this._uMinResolution=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null,this.init()}init(){const t=this._scene.canvas.gl;if(this._program=new X(t,{vertex:["precision highp float;\n                precision highp int;\n                    \n                attribute vec3 aPosition;\n                attribute vec2 aUV;\n                uniform vec2 uViewport;\n                varying vec2 vUV;\n                varying vec2 vInvSize;\n                void main () {\n                    vUV = aUV;\n                    vInvSize = 1.0 / uViewport;\n                    gl_Position = vec4(aPosition, 1.0);\n                }"],fragment:["precision highp float;\n                precision highp int;\n                    \n                #define PI 3.14159265359\n                #define PI2 6.28318530718\n                #define EPSILON 1e-6\n\n                #define KERNEL_RADIUS 16\n\n                varying vec2        vUV;\n                varying vec2        vInvSize;\n            \n                uniform sampler2D   uDepthTexture;\n                uniform sampler2D   uOcclusionTexture;              \n               \n                uniform float       uCameraNear;\n                uniform float       uCameraFar;               \n                uniform float       uDepthCutoff;\n\n                uniform vec2        uSampleOffsets[ KERNEL_RADIUS + 1 ];\n                uniform float       uSampleWeights[ KERNEL_RADIUS + 1 ];\n\n                const float         unpackDownscale = 255. / 256.; \n\n                const vec3          packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\n                const vec4          unpackFactors = unpackDownscale / vec4( packFactors, 1. );   \n\n                const float packUpscale = 256. / 255.;\n       \n                const float shiftRights = 1. / 256.;\n                \n                float unpackRGBAToFloat( const in vec4 v ) {\n                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unpackFactors );\n                }               \n\n                vec4 packFloatToRGBA( const in float v ) {\n                    vec4 r = vec4( fract( v * packFactors ), v );\n                    r.yzw -= r.xyz * shiftRights; \n                    return r * packUpscale;\n                }\n\n                float viewZToOrthographicDepth( const in float viewZ) {\n                    return ( viewZ + uCameraNear ) / ( uCameraNear - uCameraFar );\n                }\n              \n                float orthographicDepthToViewZ( const in float linearClipZ) {\n                    return linearClipZ * ( uCameraNear - uCameraFar ) - uCameraNear;\n                }\n\n                float viewZToPerspectiveDepth( const in float viewZ) {\n                    return (( uCameraNear + viewZ ) * uCameraFar ) / (( uCameraFar - uCameraNear ) * viewZ );\n                }\n                \n                float perspectiveDepthToViewZ( const in float invClipZ) {\n                    return ( uCameraNear * uCameraFar ) / ( ( uCameraFar - uCameraNear ) * invClipZ - uCameraFar );\n                }\n\n                float getDepth( const in vec2 screenPosition ) {"+(C.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?"return texture2D(uDepthTexture, screenPosition).r;":"return unpackRGBAToFloat(texture2D( uDepthTexture, screenPosition));")+"}\n\n                float getViewZ( const in float depth ) {\n                     return perspectiveDepthToViewZ( depth );\n                }\n\n                void main() {\n                \n                    float depth = getDepth( vUV );\n                    if( depth >= ( 1.0 - EPSILON ) ) {\n                        discard;\n                    }\n\n                    float centerViewZ = -getViewZ( depth );\n                    bool rBreak = false;\n                    bool lBreak = false;\n\n                    float weightSum = uSampleWeights[0];\n                    float occlusionSum = unpackRGBAToFloat(texture2D( uOcclusionTexture, vUV )) * weightSum;\n\n                    for( int i = 1; i <= KERNEL_RADIUS; i ++ ) {\n\n                        float sampleWeight = uSampleWeights[i];\n                        vec2 sampleUVOffset = uSampleOffsets[i] * vInvSize;\n\n                        vec2 sampleUV = vUV + sampleUVOffset;\n                        float viewZ = -getViewZ( getDepth( sampleUV ) );\n\n                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {\n                            rBreak = true;\n                        }\n\n                        if( ! rBreak ) {\n                            occlusionSum += unpackRGBAToFloat(texture2D( uOcclusionTexture, sampleUV )) * sampleWeight;\n                            weightSum += sampleWeight;\n                        }\n\n                        sampleUV = vUV - sampleUVOffset;\n                        viewZ = -getViewZ( getDepth( sampleUV ) );\n\n                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {\n                            lBreak = true;\n                        }\n\n                        if( ! lBreak ) {\n                            occlusionSum += unpackRGBAToFloat(texture2D( uOcclusionTexture, sampleUV )) * sampleWeight;\n                            weightSum += sampleWeight;\n                        }\n                    }\n\n                    gl_FragColor = packFloatToRGBA(occlusionSum / weightSum);\n                }"]}),this._program.errors)return console.error(this._program.errors.join("\n")),void(this._programError=!0);const e=new Float32Array([1,1,0,1,0,0,1,0]),i=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),s=new Uint8Array([0,1,2,0,2,3]);this._positionsBuf=new j(t,t.ARRAY_BUFFER,i,i.length,3,t.STATIC_DRAW),this._uvBuf=new j(t,t.ARRAY_BUFFER,e,e.length,2,t.STATIC_DRAW),this._indicesBuf=new j(t,t.ELEMENT_ARRAY_BUFFER,s,s.length,1,t.STATIC_DRAW),this._program.bind(),this._uViewport=this._program.getLocation("uViewport"),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uDepthCutoff=this._program.getLocation("uDepthCutoff"),this._uSampleOffsets=t.getUniformLocation(this._program.handle,"uSampleOffsets"),this._uSampleWeights=t.getUniformLocation(this._program.handle,"uSampleWeights"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV")}render(t,e,i){if(this._programError)return;this._getInverseProjectMat||(this._getInverseProjectMat=(()=>{let t=!0;this._scene.camera.on("projMatrix",(function(){t=!0}));const e=M.mat4();return()=>(t&&M.inverseMat4(o.camera.projMatrix,e),e)})());const s=this._scene.canvas.gl,r=this._program,o=this._scene,a=s.drawingBufferWidth,n=s.drawingBufferHeight,l=o.camera.project._state,h=l.near,u=l.far;s.viewport(0,0,a,n),s.clearColor(0,0,0,1),s.enable(s.DEPTH_TEST),s.disable(s.BLEND),s.frontFace(s.CCW),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),r.bind(),tt[0]=a,tt[1]=n,s.uniform2fv(this._uViewport,tt),s.uniform1f(this._uCameraNear,h),s.uniform1f(this._uCameraFar,u),s.uniform1f(this._uDepthCutoff,.01),0===i?s.uniform2fv(this._uSampleOffsets,Q):s.uniform2fv(this._uSampleOffsets,Z),s.uniform1fv(this._uSampleWeights,J);const c=C.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?t.getDepthTexture():t.getTexture(),d=e.getTexture();r.bindTexture(this._uDepthTexture,c,0),r.bindTexture(this._uOcclusionTexture,d,1),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),s.drawElements(s.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}destroy(){this._program.destroy()}}function it(t,e){return Math.exp(-t*t/(e*e*2))/(Math.sqrt(2*Math.PI)*e)}function st(t,e){const i=[];for(let s=0;s<=t;s++)i.push(e[0]*s),i.push(e[1]*s);return i}const rt=function(t,s){s=s||{};const r=new T(t),o=t.canvas.canvas,a=t.canvas.gl,n=!!s.transparent,l=s.alphaDepthMask,h={},u=new e({});let c={},d={},p=!0,f=!0,_=!0,g=!0;const m=new N(o,a,{depthTexture:C.SUPPORTED_EXTENSIONS.WEBGL_depth_texture}),v=new N(o,a),P=new N(o,a),b=new N(o,a),y=new N(o,a);let x=!1;const w=new q(t),E=new et(t);function A(){p&&(!function(){for(let t in c)if(c.hasOwnProperty(t)){const e=c[t],i=e.drawableMap,s=e.drawableListPreCull;let r=0;for(let t in i)i.hasOwnProperty(t)&&(s[r++]=i[t]);s.length=r}}(),p=!1,f=!0),f&&(!function(){for(let t in c)if(c.hasOwnProperty(t)){const e=c[t];e.isStateSortable&&e.drawableListPreCull.sort(e.stateSortCompare)}}(),f=!1,_=!0),_&&function(){for(let t in c)if(c.hasOwnProperty(t)){const e=c[t],i=e.drawableListPreCull,s=e.drawableList;let r=0;for(let t=0,e=i.length;t<e;t++){const e=i[t];e.rebuildRenderFlags(),e.renderFlags.culled||(s[r++]=e)}s.length=r}}()}function S(t){if(!t.castsShadow)return;const e=t.getShadowRenderBuf();if(e){e.bind(),r.reset(),r.backfaces=!0,r.frontface=!0,r.shadowViewMatrix=t.getShadowViewMatrix(),r.shadowProjMatrix=t.getShadowProjMatrix(),a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight),a.clearColor(0,0,0,1),a.enable(a.DEPTH_TEST),a.disable(a.BLEND),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);for(let t in c)if(c.hasOwnProperty(t)){const e=c[t].drawableList;for(let t=0,i=e.length;t<i;t++){const i=e[t];!1!==i.visible&&i.castsShadow&&i.drawShadow&&(i.renderFlags.colorOpaque&&i.drawShadow(r))}}e.unbind()}}this._occlusionTester=null,this.needStateSort=function(){f=!0},this.shadowsDirty=function(){g=!0},this.imageDirty=function(){_=!0},this.webglContextLost=function(){},this.webglContextRestored=function(t){b.webglContextRestored(t),y.webglContextRestored(t),m.webglContextRestored(t),v.webglContextRestored(t),P.webglContextRestored(t),w.init(),E.init(),_=!0},this.addDrawable=function(t,e){const i=e.type;if(!i)return void console.error("Renderer#addDrawable() : drawable with ID "+t+" has no 'type' - ignoring");let s=c[i];s||(s={type:e.type,count:0,isStateSortable:e.isStateSortable,stateSortCompare:e.stateSortCompare,drawableMap:{},drawableListPreCull:[],drawableList:[]},c[i]=s),s.count++,s.drawableMap[t]=e,d[t]=e,p=!0},this.removeDrawable=function(t){const e=d[t];if(!e)return void console.error("Renderer#removeDrawable() : drawable not found with ID "+t+" - ignoring");const i=e.type,s=c[i];--s.count<=0?delete c[i]:delete s.drawableMap[t],delete d[t],p=!0},this.getPickID=function(t){return u.addItem(t)},this.putPickID=function(t){u.removeItem(t)},this.clear=function(e){if(e=e||{},a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight),n)a.clearColor(1,1,1,1);else{const e=t.canvas.backgroundColorFromAmbientLight?this.lights.getAmbientColorAndIntensity():t.canvas.backgroundColor;a.clearColor(e[0],e[1],e[2],1)}a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT)},this.render=function(e){(e=e||{}).force&&(_=!0),A(),_&&(!function(e){C.SUPPORTED_EXTENSIONS.OES_element_index_uint&&(h.OES_element_index_uint=a.getExtension("OES_element_index_uint"));t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(h.EXT_frag_depth=a.getExtension("EXT_frag_depth"));C.SUPPORTED_EXTENSIONS.WEBGL_depth_texture&&(h.WEBGL_depth_texture=a.getExtension("WEBGL_depth_texture"));t.sao.possible&&function(e){const i=t.sao;m.bind(),m.clear(),function(t){r.reset(),r.pass=t.pass,a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight),a.clearColor(0,0,0,0),a.enable(a.DEPTH_TEST),a.frontFace(a.CCW),a.enable(a.CULL_FACE),a.depthMask(!0),!1!==t.clear&&a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);for(let t in c)if(c.hasOwnProperty(t)){const e=c[t].drawableList;for(let t=0,i=e.length;t<i;t++){const i=e[t];!0!==i.culled&&!1!==i.visible&&i.drawDepth&&(i.renderFlags.colorOpaque&&i.drawDepth(r))}}}(e),m.unbind(),v.bind(),v.clear(),w.render(m),v.unbind(),i.blur&&(P.bind(),P.clear(),E.render(m,v,0),P.unbind(),v.bind(),v.clear(),E.render(m,P,1),v.unbind())}(e);(function(){let e=t._lightsState.lights;for(let t=0,i=e.length;t<i;t++){const i=e[t];i.castsShadow&&S(i)}g=!1})(),D(e)}(e),i.frame.frameCount++,_=!1)};const D=function(){const e=[],s=[],o=[],h=[],u=[],d=[],p=[],f=[],_=[],g=[],m=[],P=[],b=[],y=[],x=[],M=[];return function(w){const E=t._lightsState.getAmbientColorAndIntensity();if(r.reset(),r.pass=w.pass,r.withSAO=!1,r.pbrEnabled=!!t.pbrEnabled,a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight),n)a.clearColor(0,0,0,0);else{const e=t.canvas.backgroundColorFromAmbientLight?E:t.canvas.backgroundColor;a.clearColor(e[0],e[1],e[2],1)}a.enable(a.DEPTH_TEST),a.frontFace(a.CCW),a.enable(a.CULL_FACE),a.depthMask(!0),a.lineWidth(1),r.lineWidth=1;const A=t.sao.possible;let S,D,L;r.occlusionTexture=A?v.getTexture():null;const R=Date.now();!1!==w.clear&&a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);let B=0,T=0,F=0,N=0,O=0,k=0,I=0,z=0,V=0,U=0,G=0,X=0,j=0,W=0,H=0,Y=0;for(let t in c)if(c.hasOwnProperty(t)){const i=c[t].drawableList;for(S=0,D=i.length;S<D;S++){if(L=i[S],!0===L.culled||!1===L.visible)continue;const t=L.renderFlags;t.colorOpaque&&(A&&L.saoEnabled?e[B++]=L:L.drawColorOpaque(r)),t.colorTransparent&&(o[F++]=L),t.xrayedSilhouetteTransparent&&(p[I++]=L),t.xrayedSilhouetteOpaque&&(u[O++]=L),t.highlightedSilhouetteTransparent&&(m[G++]=L),t.highlightedSilhouetteOpaque&&(_[V++]=L),t.selectedSilhouetteTransparent&&(x[H++]=L),t.selectedSilhouetteOpaque&&(b[j++]=L),t.edgesOpaque&&(s[T++]=L),t.edgesTransparent&&(h[N++]=L),t.selectedEdgesTransparent&&(M[Y++]=L),t.selectedEdgesOpaque&&(y[W++]=L),t.xrayedEdgesTransparent&&(f[z++]=L),t.xrayedEdgesOpaque&&(d[k++]=L),t.highlightedEdgesTransparent&&(P[X++]=L),t.highlightedEdgesOpaque&&(g[U++]=L)}}if(B>0)for(r.withSAO=!0,S=0;S<B;S++)e[S].drawColorOpaque(r);if(T>0)for(S=0;S<T;S++)s[S].drawEdgesColorOpaque(r);if(O>0)for(S=0;S<O;S++)u[S].drawSilhouetteXRayed(r);if(k>0)for(S=0;S<k;S++)d[S].drawEdgesXRayed(r);if(I>0||z>0||F>0||N>0){if(a.enable(a.CULL_FACE),a.enable(a.BLEND),n?(a.blendEquation(a.FUNC_ADD),a.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA)):(a.blendEquation(a.FUNC_ADD),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA)),r.backfaces=!1,l||a.depthMask(!1),z>0)for(S=0;S<z;S++)f[S].drawEdgesXRayed(r);if(I>0)for(S=0;S<I;S++)p[S].drawSilhouetteXRayed(r);if((F>0||N>0)&&a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),N>0)for(S=0;S<N;S++)L=h[S],L.drawEdgesColorTransparent(r);if(F>0)for(S=0;S<F;S++)L=o[S],L.drawColorTransparent(r);a.disable(a.BLEND),l||a.depthMask(!0)}if(V>0||U>0){if(r.lastProgramId=null,a.clear(a.DEPTH_BUFFER_BIT),U>0)for(S=0;S<U;S++)g[S].drawEdgesHighlighted(r);if(V>0)for(S=0;S<V;S++)_[S].drawSilhouetteHighlighted(r)}if(G>0||X>0||V>0){if(r.lastProgramId=null,a.clear(a.DEPTH_BUFFER_BIT),a.enable(a.CULL_FACE),a.enable(a.BLEND),n?(a.blendEquation(a.FUNC_ADD),a.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA)):a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),X>0)for(S=0;S<X;S++)P[S].drawEdgesHighlighted(r);if(G>0)for(S=0;S<G;S++)m[S].drawSilhouetteHighlighted(r);a.disable(a.BLEND)}if(j>0||W>0){if(r.lastProgramId=null,a.clear(a.DEPTH_BUFFER_BIT),W>0)for(S=0;S<W;S++)y[S].drawEdgesSelected(r);if(j>0)for(S=0;S<j;S++)b[S].drawSilhouetteSelected(r)}if(H>0||Y>0){if(r.lastProgramId=null,a.clear(a.DEPTH_BUFFER_BIT),a.enable(a.CULL_FACE),a.enable(a.BLEND),n?(a.blendEquation(a.FUNC_ADD),a.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA)):a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),Y>0)for(S=0;S<Y;S++)M[S].drawEdgesSelected(r);if(H>0)for(S=0;S<H;S++)x[S].drawSilhouetteSelected(r);a.disable(a.BLEND)}const K=Date.now(),$=i.frame;$.renderTime=(K-R)/1e3,$.drawElements=r.drawElements,$.useProgram=r.useProgram,$.bindTexture=r.bindTexture,$.bindArray=r.bindArray;const q=C.MAX_TEXTURE_UNITS;for(let t=0;t<q;t++)a.activeTexture(a.TEXTURE0+t);a.bindTexture(a.TEXTURE_CUBE_MAP,null),a.bindTexture(a.TEXTURE_2D,null);const Z=C.MAX_VERTEX_ATTRIBS;for(let t=0;t<Z;t++)a.disableVertexAttribArray(t)}}();this.pick=function(){const e=M.vec3(),i=M.mat4(),s=M.mat4(),n=M.vec3([0,1,0]),l=new O,d=M.vec2();return function(p,f=l){let _,g,m,v,P;f.reset(),A(),C.SUPPORTED_EXTENSIONS.OES_element_index_uint&&(h.OES_element_index_uint=a.getExtension("OES_element_index_uint")),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(h.EXT_frag_depth=a.getExtension("EXT_frag_depth")),C.SUPPORTED_EXTENSIONS.WEBGL_depth_texture&&(h.WEBGL_depth_texture=a.getExtension("WEBGL_depth_texture"));let y=null,x=null;if(f.pickSurface=p.pickSurface,p.canvasPos)_=p.canvasPos[0],g=p.canvasPos[1],y=t.camera.viewMatrix,x=t.camera.projMatrix,f.canvasPos=p.canvasPos;else{const r=M.frustumMat4(-1,1,-1,1,t.camera.project.near,t.camera.project.far,i);p.matrix?(y=p.matrix,x=r):(m=p.origin||M.vec3([0,0,0]),v=p.direction||M.vec3([0,0,1]),P=M.addVec3(m,v,e),y=M.lookAtMat4v(m,P,n,s),x=r,f.origin=m,f.direction=v),_=.5*o.clientWidth,g=.5*o.clientHeight}b.bind();const w=function(t,e,i,s,o){let n,l;r.reset(),r.backfaces=!0,r.frontface=!0,r.pickViewMatrix=i,r.pickProjMatrix=s,r.pickInvisible=!!o.pickInvisible,a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight),a.clearColor(0,0,0,0),a.enable(a.DEPTH_TEST),a.disable(a.CULL_FACE),a.disable(a.BLEND),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);const h=o.includeEntityIds,d=o.excludeEntityIds;for(let t in c)if(c.hasOwnProperty(t)){const e=c[t].drawableList;for(n=0,l=e.length;n<l;n++){const t=e[n];!t.drawPickMesh||!0===t.culled||!0!==o.pickInvisible&&!1===t.visible||!1===t.pickable||(h&&!h[t.id]||d&&d[t.id]||t.drawPickMesh(r))}}const p=b.read(Math.round(t),Math.round(e));let f=p[0]+256*p[1]+256*p[2]*256+256*p[3]*256*256;if(f<0)return;const _=u.items[f];return _}(_,g,y,x,p);if(!w)return b.unbind(),null;const E=w.delegatePickedEntity?w.delegatePickedEntity():w;return E?(p.pickSurface&&(w.canPickTriangle&&w.canPickTriangle()?(!function(t,e,i,s,o,n){if(!t.drawPickTriangles)return;r.reset(),r.backfaces=!0,r.frontface=!0,r.pickViewMatrix=s,r.pickProjMatrix=o,a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight),a.clearColor(0,0,0,0),a.enable(a.DEPTH_TEST),a.disable(a.CULL_FACE),a.disable(a.BLEND),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),t.drawPickTriangles(r);const l=b.read(e,i);let h=l[0]+256*l[1]+256*l[2]*256+256*l[3]*256*256;h*=3,n.primIndex=h}(w,_,g,y,x,f),w.pickTriangleSurface(y,x,f)):w.canPickWorldPos&&w.canPickWorldPos()&&(d[0]=t.camera.project.near,d[1]=t.camera.project.far,L(w,_,g,y,x,d,f),!1!==p.pickSurfaceNormal&&function(t,e,i,s,o,n,l){r.reset(),r.backfaces=!0,r.frontface=!0,r.pickViewMatrix=s,r.pickProjMatrix=o,r.pickZNear=n[0],r.pickZFar=n[1],a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight),a.clearColor(0,0,0,0),a.enable(a.DEPTH_TEST),a.disable(a.CULL_FACE),a.disable(a.BLEND),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),t.drawPickNormals(r);const h=b.read(Math.round(e),Math.round(i)),u=[h[0]/256-.5,h[1]/256-.5,h[2]/256-.5];M.normalizeVec3(u),l.worldNormal=u}(w,_,g,y,x,d,f))),b.unbind(),f.entity=E,f):null}}();const L=function(){const t=M.vec4(),e=M.vec4(),i=M.vec4(),s=M.vec4(),n=M.vec4(),l=M.mat4(),h=M.mat4(),u=M.mat4();return function(c,d,p,f,_,g,m){r.reset(),r.backfaces=!0,r.frontface=!0,r.pickViewMatrix=f,r.pickProjMatrix=_,r.pickZNear=g[0],r.pickZFar=g[1],a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight),a.clearColor(0,0,0,0),a.enable(a.DEPTH_TEST),a.disable(a.CULL_FACE),a.disable(a.BLEND),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),c.drawPickDepths(r);const v=function(t){const e=[t[0]/256,t[1]/256,t[2]/256,t[3]/256],i=[1/16777216,1/65536,1/256,1];return M.dotVec4(e,i)}(b.read(Math.round(d),Math.round(p))),P=(d-o.width/2)/(o.width/2),y=-(p-o.height/2)/(o.height/2),x=c.rtcCenter;let w;if(x){const t=R(f,x,l);w=M.mulMat4(_,t,h)}else w=M.mulMat4(_,f,h);const E=M.inverseMat4(w,u);t[0]=P,t[1]=y,t[2]=-1,t[3]=1;let C=M.transformVec4(E,t);C=M.mulVec4Scalar(C,1/C[3]),e[0]=P,e[1]=y,e[2]=1,e[3]=1;let A=M.transformVec4(E,e);A=M.mulVec4Scalar(A,1/A[3]);const S=M.subVec3(A,C,i),D=M.addVec3(C,M.mulVec4Scalar(S,v,s),n);x&&M.addVec3(D,x),m.worldPos=D}}();this.addMarker=function(e){this._occlusionTester=this._occlusionTester||new K(t),this._occlusionTester.addMarker(e),t.occlusionTestCountdown=0},this.markerWorldPosUpdated=function(t){this._occlusionTester.markerWorldPosUpdated(t)},this.removeMarker=function(t){this._occlusionTester.removeMarker(t)},this.doOcclusionTest=function(){if(this._occlusionTester&&this._occlusionTester.needOcclusionTest){A(),this._occlusionTester.bindRenderBuf(),r.reset(),r.backfaces=!0,r.frontface=!0,a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight),a.clearColor(0,0,0,0),a.enable(a.DEPTH_TEST),a.disable(a.CULL_FACE),a.disable(a.BLEND),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);for(let t in c)if(c.hasOwnProperty(t)){const e=c[t].drawableList;for(let t=0,i=e.length;t<i;t++){const i=e[t];i.drawOcclusion&&!0!==i.culled&&!1!==i.visible&&!1!==i.pickable&&i.drawOcclusion(r)}}this._occlusionTester.drawMarkers(r),this._occlusionTester.doOcclusionTest(),this._occlusionTester.unbindRenderBuf()}},this.readPixels=function(t,e,i,s){let r,o,a,n;for(y.bind(),y.clear(),this.render({force:!0,opaqueOnly:s}),o=0;o<i;o++)a=2*o,n=4*o,r=y.read(t[a],t[a+1]),e[n]=r[0],e[n+1]=r[1],e[n+2]=r[2],e[n+3]=r[3];y.unbind(),_=!0},this.beginSnapshot=function(){y.bind(),y.clear(),x=!0},this.renderSnapshot=function(){x&&(y.clear(),this.render({force:!0,opaqueOnly:!1}),_=!0)},this.readSnapshot=function(t){return y.readImage(t)},this.endSnapshot=function(){x&&(y.unbind(),x=!1)},this.destroy=function(){c={},d={},b.destroy(),y.destroy(),m.destroy(),v.destroy(),P.destroy(),w.destroy(),E.destroy(),this._occlusionTester&&this._occlusionTester.destroy()}};class ot extends w{constructor(t,e={}){super(t,e),this.KEY_BACKSPACE=8,this.KEY_TAB=9,this.KEY_ENTER=13,this.KEY_SHIFT=16,this.KEY_CTRL=17,this.KEY_ALT=18,this.KEY_PAUSE_BREAK=19,this.KEY_CAPS_LOCK=20,this.KEY_ESCAPE=27,this.KEY_PAGE_UP=33,this.KEY_PAGE_DOWN=34,this.KEY_END=35,this.KEY_HOME=36,this.KEY_LEFT_ARROW=37,this.KEY_UP_ARROW=38,this.KEY_RIGHT_ARROW=39,this.KEY_DOWN_ARROW=40,this.KEY_INSERT=45,this.KEY_DELETE=46,this.KEY_NUM_0=48,this.KEY_NUM_1=49,this.KEY_NUM_2=50,this.KEY_NUM_3=51,this.KEY_NUM_4=52,this.KEY_NUM_5=53,this.KEY_NUM_6=54,this.KEY_NUM_7=55,this.KEY_NUM_8=56,this.KEY_NUM_9=57,this.KEY_A=65,this.KEY_B=66,this.KEY_C=67,this.KEY_D=68,this.KEY_E=69,this.KEY_F=70,this.KEY_G=71,this.KEY_H=72,this.KEY_I=73,this.KEY_J=74,this.KEY_K=75,this.KEY_L=76,this.KEY_M=77,this.KEY_N=78,this.KEY_O=79,this.KEY_P=80,this.KEY_Q=81,this.KEY_R=82,this.KEY_S=83,this.KEY_T=84,this.KEY_U=85,this.KEY_V=86,this.KEY_W=87,this.KEY_X=88,this.KEY_Y=89,this.KEY_Z=90,this.KEY_LEFT_WINDOW=91,this.KEY_RIGHT_WINDOW=92,this.KEY_SELECT_KEY=93,this.KEY_NUMPAD_0=96,this.KEY_NUMPAD_1=97,this.KEY_NUMPAD_2=98,this.KEY_NUMPAD_3=99,this.KEY_NUMPAD_4=100,this.KEY_NUMPAD_5=101,this.KEY_NUMPAD_6=102,this.KEY_NUMPAD_7=103,this.KEY_NUMPAD_8=104,this.KEY_NUMPAD_9=105,this.KEY_MULTIPLY=106,this.KEY_ADD=107,this.KEY_SUBTRACT=109,this.KEY_DECIMAL_POINT=110,this.KEY_DIVIDE=111,this.KEY_F1=112,this.KEY_F2=113,this.KEY_F3=114,this.KEY_F4=115,this.KEY_F5=116,this.KEY_F6=117,this.KEY_F7=118,this.KEY_F8=119,this.KEY_F9=120,this.KEY_F10=121,this.KEY_F11=122,this.KEY_F12=123,this.KEY_NUM_LOCK=144,this.KEY_SCROLL_LOCK=145,this.KEY_SEMI_COLON=186,this.KEY_EQUAL_SIGN=187,this.KEY_COMMA=188,this.KEY_DASH=189,this.KEY_PERIOD=190,this.KEY_FORWARD_SLASH=191,this.KEY_GRAVE_ACCENT=192,this.KEY_OPEN_BRACKET=219,this.KEY_BACK_SLASH=220,this.KEY_CLOSE_BRACKET=221,this.KEY_SINGLE_QUOTE=222,this.KEY_SPACE=32,this.element=e.element,this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.keyboardEnabled=!0,this.mouseover=!1,this.mouseCanvasPos=M.vec2(),this._bindEvents()}_bindEvents(){if(!this._eventsBound){document.addEventListener("keydown",this._keyDownListener=t=>{this.enabled&&this.keyboardEnabled&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&(t.keyCode===this.KEY_CTRL?this.ctrlDown=!0:t.keyCode===this.KEY_ALT?this.altDown=!0:t.keyCode===this.KEY_SHIFT&&(this.shiftDown=!0),this.keyDown[t.keyCode]=!0,this.fire("keydown",t.keyCode,!0))},!1),document.addEventListener("keyup",this._keyUpListener=t=>{this.enabled&&this.keyboardEnabled&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&(t.keyCode===this.KEY_CTRL?this.ctrlDown=!1:t.keyCode===this.KEY_ALT?this.altDown=!1:t.keyCode===this.KEY_SHIFT&&(this.shiftDown=!1),this.keyDown[t.keyCode]=!1,this.fire("keyup",t.keyCode,!0))}),this.element.addEventListener("mouseenter",this._mouseEnterListener=t=>{this.enabled&&(this.mouseover=!0,this._getMouseCanvasPos(t),this.fire("mouseenter",this.mouseCanvasPos,!0))}),this.element.addEventListener("mouseleave",this._mouseLeaveListener=t=>{this.enabled&&(this.mouseover=!1,this._getMouseCanvasPos(t),this.fire("mouseleave",this.mouseCanvasPos,!0))}),this.element.addEventListener("mousedown",this._mouseDownListener=t=>{if(this.enabled){switch(t.which){case 1:this.mouseDownLeft=!0;break;case 2:this.mouseDownMiddle=!0;break;case 3:this.mouseDownRight=!0}this._getMouseCanvasPos(t),this.element.focus(),this.fire("mousedown",this.mouseCanvasPos,!0),this.mouseover&&t.preventDefault()}}),document.addEventListener("mouseup",this._mouseUpListener=t=>{if(this.enabled){switch(t.which){case 1:this.mouseDownLeft=!1;break;case 2:this.mouseDownMiddle=!1;break;case 3:this.mouseDownRight=!1}this.fire("mouseup",this.mouseCanvasPos,!0)}},!0),document.addEventListener("click",this._clickListener=t=>{if(this.enabled){switch(t.which){case 1:case 3:this.mouseDownLeft=!1,this.mouseDownRight=!1;break;case 2:this.mouseDownMiddle=!1}this._getMouseCanvasPos(t),this.fire("click",this.mouseCanvasPos,!0),this.mouseover&&t.preventDefault()}}),document.addEventListener("dblclick",this._dblClickListener=t=>{if(this.enabled){switch(t.which){case 1:case 3:this.mouseDownLeft=!1,this.mouseDownRight=!1;break;case 2:this.mouseDownMiddle=!1}this._getMouseCanvasPos(t),this.fire("dblclick",this.mouseCanvasPos,!0),this.mouseover&&t.preventDefault()}}),this.element.addEventListener("mousemove",this._mouseMoveListener=t=>{this.enabled&&(this._getMouseCanvasPos(t),this.fire("mousemove",this.mouseCanvasPos,!0),this.mouseover&&t.preventDefault())}),this.element.addEventListener("wheel",this._mouseWheelListener=(t,e)=>{if(!this.enabled)return;const i=Math.max(-1,Math.min(1,40*-t.deltaY));this.fire("mousewheel",i,!0)},{passive:!0});{let t,e;const i=2;this.on("mousedown",(i=>{t=i[0],e=i[1]})),this.on("mouseup",(s=>{t>=s[0]-i&&t<=s[0]+i&&e>=s[1]-i&&e<=s[1]+i&&this.fire("mouseclicked",s,!0)}))}{const t={"landscape-primary":90,"landscape-secondary":-90,"portrait-secondary":180,"portrait-primary":0};let e,i;const s=M.vec3(),r=M.vec3(),o={orientation:null,orientationAngle:0},a={orientationAngle:0,acceleration:null,accelerationIncludingGravity:r,rotationRate:M.vec3(),interval:0},n={alpha:0,beta:0,gamma:0,absolute:!1};window.OrientationChangeEvent&&window.addEventListener("orientationchange",this._orientationchangedListener=()=>{e=window.screen.orientation||window.screen.mozOrientation||window.msOrientation||null,i=e&&t[e]||0,o.orientation=e,o.orientationAngle=i,this.fire("orientationchange",o)},!1),window.DeviceMotionEvent&&window.addEventListener("devicemotion",this._deviceMotionListener=t=>{a.interval=t.interval,a.orientationAngle=i;const e=t.acceleration;e?(s[0]=e.x,s[1]=e.y,s[2]=e.z,a.acceleration=s):a.acceleration=null;const o=t.accelerationIncludingGravity;o?(r[0]=o.x,r[1]=o.y,r[2]=o.z,a.accelerationIncludingGravity=r):a.accelerationIncludingGravity=null,a.rotationRate=t.rotationRate,this.fire("devicemotion",a)},!1),window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",this._deviceOrientListener=t=>{n.gamma=t.gamma,n.beta=t.beta,n.alpha=t.alpha,n.absolute=t.absolute,this.fire("deviceorientation",n)},!1)}this._eventsBound=!0}}_unbindEvents(){this._eventsBound&&(document.removeEventListener("keydown",this._keyDownListener),document.removeEventListener("keyup",this._keyUpListener),this.element.removeEventListener("mouseenter",this._mouseEnterListener),this.element.removeEventListener("mouseleave",this._mouseLeaveListener),this.element.removeEventListener("mousedown",this._mouseDownListener),document.removeEventListener("mouseup",this._mouseDownListener),document.removeEventListener("click",this._clickListener),document.removeEventListener("dblclick",this._dblClickListener),this.element.removeEventListener("mousemove",this._mouseMoveListener),this.element.removeEventListener("wheel",this._mouseWheelListener),window.OrientationChangeEvent&&window.removeEventListener("orientationchange",this._orientationchangedListener),window.DeviceMotionEvent&&window.removeEventListener("devicemotion",this._deviceMotionListener),window.DeviceOrientationEvent&&window.removeEventListener("deviceorientation",this._deviceOrientListener),this._eventsBound=!1)}_getMouseCanvasPos(t){if(t){let e=t.target,i=0,s=0;for(;e.offsetParent;)i+=e.offsetLeft,s+=e.offsetTop,e=e.offsetParent;this.mouseCanvasPos[0]=t.pageX-i,this.mouseCanvasPos[1]=t.pageY-s}else t=window.event,this.mouseCanvasPos[0]=t.x,this.mouseCanvasPos[1]=t.y}setEnabled(t){this.enabled!==t&&this.fire("enabled",this.enabled=t)}getEnabled(){return this.enabled}setKeyboardEnabled(t){this.keyboardEnabled=t}getKeyboardEnabled(){return this.keyboardEnabled}destroy(){super.destroy(),this._unbindEvents()}}const at=new e({});class nt{constructor(t){this.id=at.addItem({});for(const e in t)t.hasOwnProperty(e)&&(this[e]=t[e])}destroy(){at.removeItem(this.id)}}class lt extends w{get type(){return"Viewport"}constructor(t,e={}){super(t,e),this._state=new nt({boundary:[0,0,100,100]}),this.boundary=e.boundary,this.autoBoundary=e.autoBoundary}set boundary(t){if(!this._autoBoundary){if(!t){const e=this.scene.canvas.boundary;t=[0,0,e[2],e[3]]}this._state.boundary=t,this.glRedraw(),this.fire("boundary",this._state.boundary)}}get boundary(){return this._state.boundary}set autoBoundary(t){(t=!!t)!==this._autoBoundary&&(this._autoBoundary=t,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",(function(t){const e=t[2],i=t[3];this._state.boundary=[0,0,e,i],this.glRedraw(),this.fire("boundary",this._state.boundary)}),this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))}get autoBoundary(){return this._autoBoundary}_getState(){return this._state}destroy(){super.destroy(),this._state.destroy()}}class ht extends w{get type(){return"Perspective"}constructor(t,e={}){super(t,e),this.camera=t,this._state=new nt({matrix:M.mat4(),inverseMatrix:M.mat4(),transposedMatrix:M.mat4(),near:.1,far:2e3}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this._fov=60,this._canvasResized=this.scene.canvas.on("boundary",this._needUpdate,this),this.fov=e.fov,this.fovAxis=e.fovAxis,this.near=e.near,this.far=e.far}_update(){const t=this.scene.viewport.boundary,e=t[2]/t[3],i=this._fovAxis;let s=this._fov;("x"===i||"min"===i&&e<1||"max"===i&&e>1)&&(s/=e),s=Math.min(s,120),M.perspectiveMat4(s*(Math.PI/180),e,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set fov(t){(t=t!==undefined&&null!==t?t:60)!==this._fov&&(this._fov=t,this._needUpdate(0),this.fire("fov",this._fov))}get fov(){return this._fov}set fovAxis(t){t=t||"min",this._fovAxis!==t&&("x"!==t&&"y"!==t&&"min"!==t&&(this.error("Unsupported value for 'fovAxis': "+t+" - defaulting to 'min'"),t="min"),this._fovAxis=t,this._needUpdate(0),this.fire("fovAxis",this._fovAxis))}get fovAxis(){return this._fovAxis}set near(t){const e=t!==undefined&&null!==t?t:.1;this._state.near!==e&&(this._state.near=e,this._needUpdate(0),this.fire("near",this._state.near))}get near(){return this._state.near}set far(t){const e=t!==undefined&&null!==t?t:2e3;this._state.far!==e&&(this._state.far=e,this._needUpdate(0),this.fire("far",this._state.far))}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(M.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(M.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(t,e,i,s,r){const o=this.scene.canvas.canvas,a=o.offsetWidth/2,n=o.offsetHeight/2;return i[0]=(t[0]-a)/a,i[1]=(t[1]-n)/n,i[2]=e,i[3]=1,M.mulMat4v4(this.inverseMatrix,i,s),M.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,M.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._canvasResized)}}class ut extends w{get type(){return"Ortho"}constructor(t,e={}){super(t,e),this.camera=t,this._state=new nt({matrix:M.mat4(),inverseMatrix:M.mat4(),transposedMatrix:M.mat4(),near:.1,far:2e3}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.scale=e.scale,this.near=e.near,this.far=e.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._needUpdate,this)}_update(){const t=this.scene,e=.5*this._scale,i=t.viewport.boundary,s=i[2],r=i[3],o=s/r;let a,n,l,h;s>r?(a=-e,n=e,l=e/o,h=-e/o):(a=-e*o,n=e*o,l=e,h=-e),M.orthoMat4c(a,n,h,l,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set scale(t){t!==undefined&&null!==t||(t=1),t<=0&&(t=.01),this._scale=t,this._needUpdate(0),this.fire("scale",this._scale)}get scale(){return this._scale}set near(t){const e=t!==undefined&&null!==t?t:.1;this._state.near!==e&&(this._state.near=e,this._needUpdate(0),this.fire("near",this._state.near))}get near(){return this._state.near}set far(t){const e=t!==undefined&&null!==t?t:2e3;this._state.far!==e&&(this._state.far=e,this._needUpdate(0),this.fire("far",this._state.far))}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(M.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(M.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(t,e,i,s,r){const o=this.scene.canvas.canvas,a=o.offsetWidth/2,n=o.offsetHeight/2;return i[0]=(t[0]-a)/a,i[1]=(t[1]-n)/n,i[2]=e,i[3]=1,M.mulMat4v4(this.inverseMatrix,i,s),M.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,M.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._onCanvasBoundary)}}class ct extends w{get type(){return"Frustum"}constructor(t,e={}){super(t,e),this.camera=t,this._state=new nt({matrix:M.mat4(),inverseMatrix:M.mat4(),transposedMatrix:M.mat4(),near:.1,far:1e4}),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.left=e.left,this.right=e.right,this.bottom=e.bottom,this.top=e.top,this.near=e.near,this.far=e.far}_update(){M.frustumMat4(this._left,this._right,this._bottom,this._top,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set left(t){this._left=t!==undefined&&null!==t?t:-1,this._needUpdate(0),this.fire("left",this._left)}get left(){return this._left}set right(t){this._right=t!==undefined&&null!==t?t:1,this._needUpdate(0),this.fire("right",this._right)}get right(){return this._right}set top(t){this._top=t!==undefined&&null!==t?t:1,this._needUpdate(0),this.fire("top",this._top)}get top(){return this._top}set bottom(t){this._bottom=t!==undefined&&null!==t?t:-1,this._needUpdate(0),this.fire("bottom",this._bottom)}get bottom(){return this._bottom}set near(t){this._state.near=t!==undefined&&null!==t?t:.1,this._needUpdate(0),this.fire("near",this._state.near)}get near(){return this._state.near}set far(t){this._state.far=t!==undefined&&null!==t?t:1e4,this._needUpdate(0),this.fire("far",this._state.far)}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(M.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(M.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(t,e,i,s,r){const o=this.scene.canvas.canvas,a=o.offsetWidth/2,n=o.offsetHeight/2;return i[0]=(t[0]-a)/a,i[1]=(t[1]-n)/n,i[2]=e,i[3]=1,M.mulMat4v4(this.inverseMatrix,i,s),M.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,M.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy(),super.destroy()}}class dt extends w{get type(){return"CustomProjection"}constructor(t,e={}){super(t,e),this.camera=t,this._state=new nt({matrix:M.mat4(),inverseMatrix:M.mat4(),transposedMatrix:M.mat4()}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!1,this.matrix=e.matrix}set matrix(t){this._state.matrix.set(t||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("far",this._state.matrix)}get matrix(){return this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(M.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(M.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(t,e,i,s,r){const o=this.scene.canvas.canvas,a=o.offsetWidth/2,n=o.offsetHeight/2;return i[0]=(t[0]-a)/a,i[1]=(t[1]-n)/n,i[2]=e,i[3]=1,M.mulMat4v4(this.inverseMatrix,i,s),M.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,M.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy()}}const pt=M.vec3(),ft=M.vec3(),_t=M.vec3(),gt=M.vec3(),mt=M.vec3(),vt=M.vec3(),Pt=M.mat4(),bt=M.mat4(),yt=M.vec3(),xt=M.vec3(),Mt=M.vec3(),wt=M.vec3();class Et extends w{get type(){return"Camera"}constructor(t,e={}){super(t,e),this._state=new nt({deviceMatrix:M.mat4(),hasDeviceMatrix:!1,matrix:M.mat4(),normalMatrix:M.mat4(),inverseMatrix:M.mat4()}),this._perspective=new ht(this),this._ortho=new ut(this),this._frustum=new ct(this),this._customProjection=new dt(this),this._project=this._perspective,this._eye=M.vec3([0,0,10]),this._look=M.vec3([0,0,0]),this._up=M.vec3([0,1,0]),this._worldUp=M.vec3([0,1,0]),this._worldRight=M.vec3([1,0,0]),this._worldForward=M.vec3([0,0,-1]),this.deviceMatrix=e.deviceMatrix,this.eye=e.eye,this.look=e.look,this.up=e.up,this.worldAxis=e.worldAxis,this.gimbalLock=e.gimbalLock,this.constrainPitch=e.constrainPitch,this.projection=e.projection,this._perspective.on("matrix",(()=>{"perspective"===this._projectionType&&this.fire("projMatrix",this._perspective.matrix)})),this._ortho.on("matrix",(()=>{"ortho"===this._projectionType&&this.fire("projMatrix",this._ortho.matrix)})),this._frustum.on("matrix",(()=>{"frustum"===this._projectionType&&this.fire("projMatrix",this._frustum.matrix)})),this._customProjection.on("matrix",(()=>{"customProjection"===this._projectionType&&this.fire("projMatrix",this._customProjection.matrix)}))}_update(){const t=this._state;let e;"ortho"===this.projection?(M.subVec3(this._eye,this._look,yt),M.normalizeVec3(yt,xt),M.mulVec3Scalar(xt,1e3,Mt),M.addVec3(this._look,Mt,wt),e=wt):e=this._eye,t.hasDeviceMatrix?(M.lookAtMat4v(e,this._look,this._up,bt),M.mulMat4(t.deviceMatrix,bt,t.matrix)):M.lookAtMat4v(e,this._look,this._up,t.matrix),M.inverseMat4(this._state.matrix,this._state.inverseMatrix),M.transposeMat4(this._state.inverseMatrix,this._state.normalMatrix),this.glRedraw(),this.fire("matrix",this._state.matrix),this.fire("viewMatrix",this._state.matrix)}orbitYaw(t){let e=M.subVec3(this._eye,this._look,pt);M.rotationMat4v(.0174532925*t,this._gimbalLock?this._worldUp:this._up,Pt),e=M.transformPoint3(Pt,e,ft),this.eye=M.addVec3(this._look,e,_t),this.up=M.transformPoint3(Pt,this._up,gt)}orbitPitch(t){if(this._constrainPitch&&(t=M.dotVec3(this._up,this._worldUp)/M.DEGTORAD)<1)return;let e=M.subVec3(this._eye,this._look,pt);const i=M.cross3Vec3(M.normalizeVec3(e,ft),M.normalizeVec3(this._up,_t));M.rotationMat4v(.0174532925*t,i,Pt),e=M.transformPoint3(Pt,e,gt),this.up=M.transformPoint3(Pt,this._up,mt),this.eye=M.addVec3(e,this._look,vt)}yaw(t){let e=M.subVec3(this._look,this._eye,pt);M.rotationMat4v(.0174532925*t,this._gimbalLock?this._worldUp:this._up,Pt),e=M.transformPoint3(Pt,e,ft),this.look=M.addVec3(e,this._eye,_t),this._gimbalLock&&(this.up=M.transformPoint3(Pt,this._up,gt))}pitch(t){if(this._constrainPitch&&(t=M.dotVec3(this._up,this._worldUp)/M.DEGTORAD)<1)return;let e=M.subVec3(this._look,this._eye,pt);const i=M.cross3Vec3(M.normalizeVec3(e,ft),M.normalizeVec3(this._up,_t));M.rotationMat4v(.0174532925*t,i,Pt),this.up=M.transformPoint3(Pt,this._up,vt),e=M.transformPoint3(Pt,e,gt),this.look=M.addVec3(e,this._eye,mt)}pan(t){const e=M.subVec3(this._eye,this._look,pt),i=[0,0,0];let s;if(0!==t[0]){const r=M.cross3Vec3(M.normalizeVec3(e,[]),M.normalizeVec3(this._up,ft));s=M.mulVec3Scalar(r,t[0]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]}0!==t[1]&&(s=M.mulVec3Scalar(M.normalizeVec3(this._up,_t),t[1]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),0!==t[2]&&(s=M.mulVec3Scalar(M.normalizeVec3(e,gt),t[2]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),this.eye=M.addVec3(this._eye,i,mt),this.look=M.addVec3(this._look,i,vt)}zoom(t){const e=M.subVec3(this._eye,this._look,pt),i=Math.abs(M.lenVec3(e,ft)),s=Math.abs(i+t);if(s<.5)return;const r=M.normalizeVec3(e,_t);this.eye=M.addVec3(this._look,M.mulVec3Scalar(r,s),gt)}set eye(t){this._eye.set(t||[0,0,10]),this._needUpdate(0),this.fire("eye",this._eye)}get eye(){return this._eye}set look(t){this._look.set(t||[0,0,0]),this._needUpdate(0),this.fire("look",this._look)}get look(){return this._look}set up(t){this._up.set(t||[0,1,0]),this._needUpdate(0),this.fire("up",this._up)}get up(){return this._up}set deviceMatrix(t){this._state.deviceMatrix.set(t||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._state.hasDeviceMatrix=!!t,this._needUpdate(0),this.fire("deviceMatrix",this._state.deviceMatrix)}get deviceMatrix(){return this._state.deviceMatrix}set worldAxis(t){t=t||[1,0,0,0,1,0,0,0,1],this._worldAxis?this._worldAxis.set(t):this._worldAxis=M.vec3(t),this._worldRight[0]=this._worldAxis[0],this._worldRight[1]=this._worldAxis[1],this._worldRight[2]=this._worldAxis[2],this._worldUp[0]=this._worldAxis[3],this._worldUp[1]=this._worldAxis[4],this._worldUp[2]=this._worldAxis[5],this._worldForward[0]=this._worldAxis[6],this._worldForward[1]=this._worldAxis[7],this._worldForward[2]=this._worldAxis[8],this.fire("worldAxis",this._worldAxis)}get worldAxis(){return this._worldAxis}get worldUp(){return this._worldUp}get xUp(){return this._worldUp[0]>this._worldUp[1]&&this._worldUp[0]>this._worldUp[2]}get yUp(){return this._worldUp[1]>this._worldUp[0]&&this._worldUp[1]>this._worldUp[2]}get zUp(){return this._worldUp[2]>this._worldUp[0]&&this._worldUp[2]>this._worldUp[1]}get worldRight(){return this._worldRight}get worldForward(){return this._worldForward}set gimbalLock(t){this._gimbalLock=!1!==t,this.fire("gimbalLock",this._gimbalLock)}get gimbalLock(){return this._gimbalLock}set constrainPitch(t){this._constrainPitch=!!t,this.fire("constrainPitch",this._constrainPitch)}get eyeLookDist(){return M.lenVec3(M.subVec3(this._look,this._eye,pt))}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get viewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get normalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get viewNormalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get inverseViewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.inverseMatrix}get projMatrix(){return this[this.projection].matrix}get perspective(){return this._perspective}get ortho(){return this._ortho}get frustum(){return this._frustum}get customProjection(){return this._customProjection}set projection(t){t=t||"perspective",this._projectionType!==t&&("perspective"===t?this._project=this._perspective:"ortho"===t?this._project=this._ortho:"frustum"===t?this._project=this._frustum:"customProjection"===t?this._project=this._customProjection:(this.error("Unsupported value for 'projection': "+t+" defaulting to 'perspective'"),this._project=this._perspective,t="perspective"),this._project._update(),this._projectionType=t,this.glRedraw(),this._update(),this.fire("dirty"),this.fire("projection",this._projectionType),this.fire("projMatrix",this._project.matrix))}get projection(){return this._projectionType}get project(){return this._project}destroy(){super.destroy(),this._state.destroy()}}class Ct extends w{get type(){return"Light"}get isLight(){return!0}constructor(t,e={}){super(t,e)}}class At extends Ct{get type(){return"DirLight"}constructor(t,e={}){super(t,e),this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0;const i=this.scene.camera,s=this.scene.canvas;this._onCameraViewMatrix=i.on("viewMatrix",(()=>{this._shadowViewMatrixDirty=!0})),this._onCameraProjMatrix=i.on("projMatrix",(()=>{this._shadowProjMatrixDirty=!0})),this._onCanvasBoundary=s.on("boundary",(()=>{this._shadowProjMatrixDirty=!0})),this._state=new nt({type:"dir",dir:M.vec3([1,1,1]),color:M.vec3([.7,.7,.8]),intensity:1,space:e.space||"view",castsShadow:!1,getShadowViewMatrix:()=>{if(this._shadowViewMatrixDirty){this._shadowViewMatrix||(this._shadowViewMatrix=M.identityMat4());const t=this.scene.camera,e=this._state.dir,i=t.look,s=[i[0]-e[0],i[1]-e[1],i[2]-e[2]],r=[0,1,0];M.lookAtMat4v(s,i,r,this._shadowViewMatrix),this._shadowViewMatrixDirty=!1}return this._shadowViewMatrix},getShadowProjMatrix:()=>(this._shadowProjMatrixDirty&&(this._shadowProjMatrix||(this._shadowProjMatrix=M.identityMat4()),M.orthoMat4c(-40,40,-40,40,-40,80,this._shadowProjMatrix),this._shadowProjMatrixDirty=!1),this._shadowProjMatrix),getShadowRenderBuf:()=>(this._shadowRenderBuf||(this._shadowRenderBuf=new N(this.scene.canvas.canvas,this.scene.canvas.gl,{size:[1024,1024]})),this._shadowRenderBuf)}),this.dir=e.dir,this.color=e.color,this.intensity=e.intensity,this.castsShadow=e.castsShadow,this.scene._lightCreated(this)}set dir(t){this._state.dir.set(t||[1,1,1]),this._shadowViewMatrixDirty=!0,this.glRedraw()}get dir(){return this._state.dir}set color(t){this._state.color.set(t||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(t){t=t!==undefined?t:1,this._state.intensity=t,this.glRedraw()}get intensity(){return this._state.intensity}set castsShadow(t){t=!!t,this._state.castsShadow!==t&&(this._state.castsShadow=t,this._shadowViewMatrixDirty=!0,this.glRedraw())}get castsShadow(){return this._state.castsShadow}destroy(){const t=this.scene.camera,e=this.scene.canvas;t.off(this._onCameraViewMatrix),t.off(this._onCameraProjMatrix),e.off(this._onCanvasBoundary),super.destroy(),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this),this.glRedraw()}}class St extends Ct{get type(){return"AmbientLight"}constructor(t,e={}){super(t,e),this._state={type:"ambient",color:M.vec3([.7,.7,.7]),intensity:1},this.color=e.color,this.intensity=e.intensity,this.scene._lightCreated(this)}set color(t){this._state.color.set(t||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(t){this._state.intensity=t!==undefined?t:1,this.glRedraw()}get intensity(){return this._state.intensity}destroy(){super.destroy(),this.scene._lightDestroyed(this)}}class Dt extends w{get type(){return"Geometry"}get isGeometry(){return!0}constructor(t,e={}){super(t,e),i.memory.meshes++}destroy(){super.destroy(),i.memory.meshes--}}var Lt=function(){const t=[],e=[],i=[],s=[],r=[];let o=0;const a=new Uint16Array(3),n=new Uint16Array(3),l=new Uint16Array(3),h=M.vec3(),u=M.vec3(),c=M.vec3(),d=M.vec3(),p=M.vec3(),f=M.vec3(),_=M.vec3();return function(g,m,v,P){!function(r,o){const a={};let n,l,h,u;const c=Math.pow(10,4);let d,p,f=0;for(d=0,p=r.length;d<p;d+=3)n=r[d],l=r[d+1],h=r[d+2],u=Math.round(n*c)+"_"+Math.round(l*c)+"_"+Math.round(h*c),a[u]===undefined&&(a[u]=f/3,t[f++]=n,t[f++]=l,t[f++]=h),e[d/3]=a[u];for(d=0,p=o.length;d<p;d++)s[d]=e[o[d]],i[s[d]]=o[d]}(g,m),function(e,i){o=0;for(let g=0,m=e;g<m;g+=3){const e=3*s[g],m=3*s[g+1],v=3*s[g+2];i?(a[0]=t[e],a[1]=t[e+1],a[2]=t[e+2],n[0]=t[m],n[1]=t[m+1],n[2]=t[m+2],l[0]=t[v],l[1]=t[v+1],l[2]=t[v+2],M.decompressPosition(a,i,h),M.decompressPosition(n,i,u),M.decompressPosition(l,i,c)):(h[0]=t[e],h[1]=t[e+1],h[2]=t[e+2],u[0]=t[m],u[1]=t[m+1],u[2]=t[m+2],c[0]=t[v],c[1]=t[v+1],c[2]=t[v+2]),M.subVec3(c,u,d),M.subVec3(h,u,p),M.cross3Vec3(d,p,f),M.normalizeVec3(f,_);const P=r[o]||(r[o]={normal:M.vec3()});P.normal[0]=_[0],P.normal[1]=_[1],P.normal[2]=_[2],o++}}(m.length,v);const b=[],y=Math.cos(M.DEGTORAD*P),x={};let w,E,C,A,S,D,L,R,B,T,F,N=!1;for(let t=0,e=m.length;t<e;t+=3){const e=t/3;for(let i=0;i<3;i++)w=s[t+i],E=s[t+(i+1)%3],C=Math.min(w,E),A=Math.max(w,E),S=C+","+A,x[S]===undefined?x[S]={index1:C,index2:A,face1:e,face2:undefined}:x[S].face2=e}for(S in x)D=x[S],D.face2!==undefined&&(L=r[D.face1].normal,R=r[D.face2].normal,B=M.dotVec3(L,R),B>y)||(T=i[D.index1],F=i[D.index2],(!N&&T>65535||F>65535)&&(N=!0),b.push(T),b.push(F));return N?new Uint32Array(b):new Uint16Array(b)}}();const Rt=function(){const t=M.mat4(),e=M.mat4();return function(i,s){s=s||M.mat4();const r=i[0],o=i[1],a=i[2],n=i[3]-r,l=i[4]-o,h=i[5]-a,u=65535;return M.identityMat4(t),M.translationMat4v(i,t),M.identityMat4(e),M.scalingMat4v([n/u,l/u,h/u],e),M.mulMat4(t,e,s),s}}();var Bt=function(){const t=M.mat4(),e=M.mat4();return function(i,s,r){const o=new Uint16Array(i.length);var a=new Float32Array([r[0]!==s[0]?65535/(r[0]-s[0]):0,r[1]!==s[1]?65535/(r[1]-s[1]):0,r[2]!==s[2]?65535/(r[2]-s[2]):0]);let n;for(n=0;n<i.length;n+=3)o[n+0]=Math.floor((i[n+0]-s[0])*a[0]),o[n+1]=Math.floor((i[n+1]-s[1])*a[1]),o[n+2]=Math.floor((i[n+2]-s[2])*a[2]);M.identityMat4(t),M.translationMat4v(s,t),M.identityMat4(e),M.scalingMat4v([(r[0]-s[0])/65535,(r[1]-s[1])/65535,(r[2]-s[2])/65535],e);return{quantized:o,decodeMatrix:M.mulMat4(t,e,M.identityMat4())}}}();var Tt=function(){const t=M.mat3(),e=M.mat3();return function(i,s,r){const o=new Uint16Array(i.length),a=new Float32Array([65535/(r[0]-s[0]),65535/(r[1]-s[1])]);let n;for(n=0;n<i.length;n+=2)o[n+0]=Math.floor((i[n+0]-s[0])*a[0]),o[n+1]=Math.floor((i[n+1]-s[1])*a[1]);M.identityMat3(t),M.translationMat3v(s,t),M.identityMat3(e),M.scalingMat3v([(r[0]-s[0])/65535,(r[1]-s[1])/65535],e);return{quantized:o,decodeMatrix:M.mulMat3(t,e,M.identityMat3())}}}();function Ft(t,e,i,s){let r=t[e]/(Math.abs(t[e])+Math.abs(t[e+1])+Math.abs(t[e+2])),o=t[e+1]/(Math.abs(t[e])+Math.abs(t[e+1])+Math.abs(t[e+2]));if(t[e+2]<0){let t=(1-Math.abs(o))*(r>=0?1:-1),e=(1-Math.abs(r))*(o>=0?1:-1);r=t,o=e}return new Int8Array([Math[i](127.5*r+(r<0?-1:0)),Math[s](127.5*o+(o<0?-1:0))])}function Nt(t){let e=t[0],i=t[1];e/=e<0?127:128,i/=i<0?127:128;const s=1-Math.abs(e)-Math.abs(i);s<0&&(e=(1-Math.abs(i))*(e>=0?1:-1),i=(1-Math.abs(e))*(i>=0?1:-1));const r=Math.sqrt(e*e+i*i+s*s);return[e/r,i/r,s/r]}function Ot(t,e,i){return t[e]*i[0]+t[e+1]*i[1]+t[e+2]*i[2]}const kt={getPositionsBounds:function(t){const e=new Float32Array(3),i=new Float32Array(3);let s,r;for(s=0;s<3;s++)e[s]=Number.MAX_VALUE,i[s]=-Number.MAX_VALUE;for(s=0;s<t.length;s+=3)for(r=0;r<3;r++)e[r]=Math.min(e[r],t[s+r]),i[r]=Math.max(i[r],t[s+r]);return{min:e,max:i}},createPositionsDecodeMatrix:Rt,compressPositions:Bt,decompressPositions:function(t,e,i=new Float32Array(t.length)){for(let s=0,r=t.length;s<r;s+=3)i[s+0]=t[s+0]*e[0]+e[12],i[s+1]=t[s+1]*e[5]+e[13],i[s+2]=t[s+2]*e[10]+e[14];return i},decompressPosition:function(t,e,i){return i[0]=t[0]*e[0]+e[12],i[1]=t[1]*e[5]+e[13],i[2]=t[2]*e[10]+e[14],i},decompressAABB:function(t,e,i=t){return i[0]=t[0]*e[0]+e[12],i[1]=t[1]*e[5]+e[13],i[2]=t[2]*e[10]+e[14],i[3]=t[3]*e[0]+e[12],i[4]=t[4]*e[5]+e[13],i[5]=t[5]*e[10]+e[14],i},getUVBounds:function(t){const e=new Float32Array(2),i=new Float32Array(2);let s,r;for(s=0;s<2;s++)e[s]=Number.MAX_VALUE,i[s]=-Number.MAX_VALUE;for(s=0;s<t.length;s+=2)for(r=0;r<2;r++)e[r]=Math.min(e[r],t[s+r]),i[r]=Math.max(i[r],t[s+r]);return{min:e,max:i}},compressUVs:Tt,decompressUVs:function(t,e,i=new Float32Array(t.length)){for(let s=0,r=t.length;s<r;s+=3)i[s+0]=t[s+0]*e[0]+e[6],i[s+1]=t[s+1]*e[4]+e[7];return i},decompressUV:function(t,e,i){i[0]=t[0]*e[0]+e[6],i[1]=t[1]*e[4]+e[7]},compressNormals:function(t){const e=new Int8Array(t.length);let i,s,r,o,a;for(let n=0;n<t.length;n+=3)r=i=Ft(t,n,"floor","floor"),s=Nt(i),o=a=Ot(t,n,s),i=Ft(t,n,"ceil","floor"),s=Nt(i),o=Ot(t,n,s),o>a&&(r=i,a=o),i=Ft(t,n,"floor","ceil"),s=Nt(i),o=Ot(t,n,s),o>a&&(r=i,a=o),i=Ft(t,n,"ceil","ceil"),s=Nt(i),o=Ot(t,n,s),o>a&&(r=i,a=o),e[n]=r[0],e[n+1]=r[1];return e},decompressNormals:function(t,e){for(let i=0,s=0,r=t.length;i<r;i+=2){let r=t[i+0],o=t[i+1];r=(2*r+1)/255,o=(2*o+1)/255;const a=1-Math.abs(r)-Math.abs(o);a<0&&(r=(1-Math.abs(o))*(r>=0?1:-1),o=(1-Math.abs(r))*(o>=0?1:-1));const n=Math.sqrt(r*r+o*o+a*a);e[s+0]=r/n,e[s+1]=o/n,e[s+2]=a/n,s+=3}return e},decompressNormal:function(t,e){let i=t[0],s=t[1];i=(2*i+1)/255,s=(2*s+1)/255;const r=1-Math.abs(i)-Math.abs(s);r<0&&(i=(1-Math.abs(s))*(i>=0?1:-1),s=(1-Math.abs(i))*(s>=0?1:-1));const o=Math.sqrt(i*i+s*s+r*r);return e[0]=i/o,e[1]=s/o,e[2]=r/o,e}},It=i.memory,zt=C.SUPPORTED_EXTENSIONS.OES_element_index_uint,Vt=zt?Uint32Array:Uint16Array,Ut=M.AABB3();class Gt extends Dt{get type(){return"ReadableGeometry"}get isReadableGeometry(){return!0}constructor(t,e={}){super(t,e),this._state=new nt({compressGeometry:!!e.compressGeometry,primitive:null,primitiveName:null,positions:null,normals:null,colors:null,uv:null,indices:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),this._numTriangles=0,this._edgeThreshold=e.edgeThreshold||10,this._edgeIndicesBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._aabbDirty=!0,this._boundingSphere=!0,this._aabb=null,this._aabbDirty=!0,this._obb=null,this._obbDirty=!0;const i=this._state,s=this.scene.canvas.gl;switch(e.primitive=e.primitive||"triangles",e.primitive){case"points":i.primitive=s.POINTS,i.primitiveName=e.primitive;break;case"lines":i.primitive=s.LINES,i.primitiveName=e.primitive;break;case"line-loop":i.primitive=s.LINE_LOOP,i.primitiveName=e.primitive;break;case"line-strip":i.primitive=s.LINE_STRIP,i.primitiveName=e.primitive;break;case"triangles":i.primitive=s.TRIANGLES,i.primitiveName=e.primitive;break;case"triangle-strip":i.primitive=s.TRIANGLE_STRIP,i.primitiveName=e.primitive;break;case"triangle-fan":i.primitive=s.TRIANGLE_FAN,i.primitiveName=e.primitive;break;default:this.error("Unsupported value for 'primitive': '"+e.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),i.primitive=s.TRIANGLES,i.primitiveName=e.primitive}if(e.positions)if(this._state.compressGeometry){const t=kt.getPositionsBounds(e.positions),s=kt.compressPositions(e.positions,t.min,t.max);i.positions=s.quantized,i.positionsDecodeMatrix=s.decodeMatrix}else i.positions=e.positions.constructor===Float32Array?e.positions:new Float32Array(e.positions);if(e.colors&&(i.colors=e.colors.constructor===Float32Array?e.colors:new Float32Array(e.colors)),e.uv)if(this._state.compressGeometry){const t=kt.getUVBounds(e.uv),s=kt.compressUVs(e.uv,t.min,t.max);i.uv=s.quantized,i.uvDecodeMatrix=s.decodeMatrix}else i.uv=e.uv.constructor===Float32Array?e.uv:new Float32Array(e.uv);if(e.normals&&(this._state.compressGeometry?i.normals=kt.compressNormals(e.normals):i.normals=e.normals.constructor===Float32Array?e.normals:new Float32Array(e.normals)),e.indices){if(!zt&&e.indices.constructor===Uint32Array)return void this.error("This WebGL implementation does not support Uint32Array");i.indices=e.indices.constructor===Uint32Array||e.indices.constructor===Uint16Array?e.indices:new Vt(e.indices),"triangles"===this._state.primitiveName&&(this._numTriangles=e.indices.length/3)}this._buildHash(),It.meshes++,this._buildVBOs()}_buildVBOs(){const t=this._state,e=this.scene.canvas.gl;if(t.indices&&(t.indicesBuf=new j(e,e.ELEMENT_ARRAY_BUFFER,t.indices,t.indices.length,1,e.STATIC_DRAW),It.indices+=t.indicesBuf.numItems),t.positions&&(t.positionsBuf=new j(e,e.ARRAY_BUFFER,t.positions,t.positions.length,3,e.STATIC_DRAW),It.positions+=t.positionsBuf.numItems),t.normals){let i=t.compressGeometry;t.normalsBuf=new j(e,e.ARRAY_BUFFER,t.normals,t.normals.length,3,e.STATIC_DRAW,i),It.normals+=t.normalsBuf.numItems}t.colors&&(t.colorsBuf=new j(e,e.ARRAY_BUFFER,t.colors,t.colors.length,4,e.STATIC_DRAW),It.colors+=t.colorsBuf.numItems),t.uv&&(t.uvBuf=new j(e,e.ARRAY_BUFFER,t.uv,t.uv.length,2,e.STATIC_DRAW),It.uvs+=t.uvBuf.numItems)}_buildHash(){const t=this._state,e=["/g"];e.push("/"+t.primitive+";"),t.positions&&e.push("p"),t.colors&&e.push("c"),(t.normals||t.autoVertexNormals)&&e.push("n"),t.uv&&e.push("u"),t.compressGeometry&&e.push("cp"),e.push(";"),t.hash=e.join("")}_getEdgeIndices(){return this._edgeIndicesBuf||this._buildEdgeIndices(),this._edgeIndicesBuf}_getPickTrianglePositions(){return this._pickTrianglePositionsBuf||this._buildPickTriangleVBOs(),this._pickTrianglePositionsBuf}_getPickTriangleColors(){return this._pickTriangleColorsBuf||this._buildPickTriangleVBOs(),this._pickTriangleColorsBuf}_buildEdgeIndices(){const t=this._state;if(!t.positions||!t.indices)return;const e=this.scene.canvas.gl,i=Lt(t.positions,t.indices,t.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new j(e,e.ELEMENT_ARRAY_BUFFER,i,i.length,1,e.STATIC_DRAW),It.indices+=this._edgeIndicesBuf.numItems}_buildPickTriangleVBOs(){const t=this._state;if(!t.positions||!t.indices)return;const e=this.scene.canvas.gl,i=M.buildPickTriangles(t.positions,t.indices,t.compressGeometry),s=i.positions,r=i.colors;this._pickTrianglePositionsBuf=new j(e,e.ARRAY_BUFFER,s,s.length,3,e.STATIC_DRAW),this._pickTriangleColorsBuf=new j(e,e.ARRAY_BUFFER,r,r.length,4,e.STATIC_DRAW,!0),It.positions+=this._pickTrianglePositionsBuf.numItems,It.colors+=this._pickTriangleColorsBuf.numItems}_buildPickVertexVBOs(){}_webglContextLost(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextLost()}_webglContextRestored(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextRestored(),this._buildVBOs(),this._edgeIndicesBuf=null,this._pickVertexPositionsBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._pickVertexPositionsBuf=null,this._pickVertexColorsBuf=null}get primitive(){return this._state.primitiveName}get compressGeometry(){return this._state.compressGeometry}get positions(){return this._state.positions?this._state.compressGeometry?(this._decompressedPositions||(this._decompressedPositions=new Float32Array(this._state.positions.length),kt.decompressPositions(this._state.positions,this._state.positionsDecodeMatrix,this._decompressedPositions)),this._decompressedPositions):this._state.positions:null}set positions(t){const e=this._state,i=e.positions;if(i)if(i.length===t.length){if(this._state.compressGeometry){const i=kt.getPositionsBounds(t),s=kt.compressPositions(t,i.min,i.max);t=s.quantized,e.positionsDecodeMatrix=s.decodeMatrix}i.set(t),e.positionsBuf&&e.positionsBuf.setData(i),this._setAABBDirty(),this.glRedraw()}else this.error("can't update geometry positions - new positions are wrong length");else this.error("can't update geometry positions - geometry has no positions")}get normals(){if(this._state.normals){if(!this._state.compressGeometry)return this._state.normals;if(!this._decompressedNormals){const t=this._state.normals.length,e=t+t/2;this._decompressedNormals=new Float32Array(e),kt.decompressNormals(this._state.normals,this._decompressedNormals)}return this._decompressedNormals}}set normals(t){if(this._state.compressGeometry)return void this.error("can't update geometry normals - quantized geometry is immutable");const e=this._state,i=e.normals;i?i.length===t.length?(i.set(t),e.normalsBuf&&e.normalsBuf.setData(i),this.glRedraw()):this.error("can't update geometry normals - new normals are wrong length"):this.error("can't update geometry normals - geometry has no normals")}get uv(){return this._state.uv?this._state.compressGeometry?(this._decompressedUV||(this._decompressedUV=new Float32Array(this._state.uv.length),kt.decompressUVs(this._state.uv,this._state.uvDecodeMatrix,this._decompressedUV)),this._decompressedUV):this._state.uv:null}set uv(t){if(this._state.compressGeometry)return void this.error("can't update geometry UVs - quantized geometry is immutable");const e=this._state,i=e.uv;i?i.length===t.length?(i.set(t),e.uvBuf&&e.uvBuf.setData(i),this.glRedraw()):this.error("can't update geometry UVs - new UVs are wrong length"):this.error("can't update geometry UVs - geometry has no UVs")}get colors(){return this._state.colors}set colors(t){if(this._state.compressGeometry)return void this.error("can't update geometry colors - quantized geometry is immutable");const e=this._state,i=e.colors;i?i.length===t.length?(i.set(t),e.colorsBuf&&e.colorsBuf.setData(i),this.glRedraw()):this.error("can't update geometry colors - new colors are wrong length"):this.error("can't update geometry colors - geometry has no colors")}get indices(){return this._state.indices}get aabb(){return this._aabbDirty&&(this._aabb||(this._aabb=M.AABB3()),M.positions3ToAABB3(this._state.positions,this._aabb,this._state.positionsDecodeMatrix),this._aabbDirty=!1),this._aabb}get obb(){return this._obbDirty&&(this._obb||(this._obb=M.OBB3()),M.positions3ToAABB3(this._state.positions,Ut,this._state.positionsDecodeMatrix),M.AABB3ToOBB3(Ut,this._obb),this._obbDirty=!1),this._obb}get numTriangles(){return this._numTriangles}_setAABBDirty(){this._aabbDirty||(this._aabbDirty=!0,this._aabbDirty=!0,this._obbDirty=!0)}_getState(){return this._state}destroy(){super.destroy();const t=this._state;t.indicesBuf&&t.indicesBuf.destroy(),t.positionsBuf&&t.positionsBuf.destroy(),t.normalsBuf&&t.normalsBuf.destroy(),t.uvBuf&&t.uvBuf.destroy(),t.colorsBuf&&t.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),this._pickTrianglePositionsBuf&&this._pickTrianglePositionsBuf.destroy(),this._pickTriangleColorsBuf&&this._pickTriangleColorsBuf.destroy(),this._pickVertexPositionsBuf&&this._pickVertexPositionsBuf.destroy(),this._pickVertexColorsBuf&&this._pickVertexColorsBuf.destroy(),t.destroy(),It.meshes--}}class Xt extends w{get type(){return"Material"}constructor(t,e={}){super(t,e),i.memory.materials++}destroy(){super.destroy(),i.memory.materials--}}const jt={opaque:0,mask:1,blend:2},Wt=["opaque","mask","blend"];class Ht extends Xt{get type(){return"PhongMaterial"}constructor(t,e={}){super(t,e),this._state=new nt({type:"PhongMaterial",ambient:M.vec3([1,1,1]),diffuse:M.vec3([1,1,1]),specular:M.vec3([1,1,1]),emissive:M.vec3([0,0,0]),alpha:null,shininess:null,reflectivity:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.ambient=e.ambient,this.diffuse=e.diffuse,this.specular=e.specular,this.emissive=e.emissive,this.alpha=e.alpha,this.shininess=e.shininess,this.reflectivity=e.reflectivity,this.lineWidth=e.lineWidth,this.pointSize=e.pointSize,e.ambientMap&&(this._ambientMap=this._checkComponent("Texture",e.ambientMap)),e.diffuseMap&&(this._diffuseMap=this._checkComponent("Texture",e.diffuseMap)),e.specularMap&&(this._specularMap=this._checkComponent("Texture",e.specularMap)),e.emissiveMap&&(this._emissiveMap=this._checkComponent("Texture",e.emissiveMap)),e.alphaMap&&(this._alphaMap=this._checkComponent("Texture",e.alphaMap)),e.reflectivityMap&&(this._reflectivityMap=this._checkComponent("Texture",e.reflectivityMap)),e.normalMap&&(this._normalMap=this._checkComponent("Texture",e.normalMap)),e.occlusionMap&&(this._occlusionMap=this._checkComponent("Texture",e.occlusionMap)),e.diffuseFresnel&&(this._diffuseFresnel=this._checkComponent("Fresnel",e.diffuseFresnel)),e.specularFresnel&&(this._specularFresnel=this._checkComponent("Fresnel",e.specularFresnel)),e.emissiveFresnel&&(this._emissiveFresnel=this._checkComponent("Fresnel",e.emissiveFresnel)),e.alphaFresnel&&(this._alphaFresnel=this._checkComponent("Fresnel",e.alphaFresnel)),e.reflectivityFresnel&&(this._reflectivityFresnel=this._checkComponent("Fresnel",e.reflectivityFresnel)),this.alphaMode=e.alphaMode,this.alphaCutoff=e.alphaCutoff,this.backfaces=e.backfaces,this.frontface=e.frontface,this._makeHash()}_makeHash(){const t=this._state,e=["/p"];this._normalMap&&(e.push("/nm"),this._normalMap.hasMatrix&&e.push("/mat")),this._ambientMap&&(e.push("/am"),this._ambientMap.hasMatrix&&e.push("/mat"),e.push("/"+this._ambientMap.encoding)),this._diffuseMap&&(e.push("/dm"),this._diffuseMap.hasMatrix&&e.push("/mat"),e.push("/"+this._diffuseMap.encoding)),this._specularMap&&(e.push("/sm"),this._specularMap.hasMatrix&&e.push("/mat")),this._emissiveMap&&(e.push("/em"),this._emissiveMap.hasMatrix&&e.push("/mat"),e.push("/"+this._emissiveMap.encoding)),this._alphaMap&&(e.push("/opm"),this._alphaMap.hasMatrix&&e.push("/mat")),this._reflectivityMap&&(e.push("/rm"),this._reflectivityMap.hasMatrix&&e.push("/mat")),this._occlusionMap&&(e.push("/ocm"),this._occlusionMap.hasMatrix&&e.push("/mat")),this._diffuseFresnel&&e.push("/df"),this._specularFresnel&&e.push("/sf"),this._emissiveFresnel&&e.push("/ef"),this._alphaFresnel&&e.push("/of"),this._reflectivityFresnel&&e.push("/rf"),e.push(";"),t.hash=e.join("")}set ambient(t){let e=this._state.ambient;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.ambient=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.2,e[1]=.2,e[2]=.2),this.glRedraw()}get ambient(){return this._state.ambient}set diffuse(t){let e=this._state.diffuse;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.diffuse=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1),this.glRedraw()}get diffuse(){return this._state.diffuse}set specular(t){let e=this._state.specular;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.specular=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1),this.glRedraw()}get specular(){return this._state.specular}set emissive(t){let e=this._state.emissive;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.emissive=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=0,e[1]=0,e[2]=0),this.glRedraw()}get emissive(){return this._state.emissive}set alpha(t){t=t!==undefined&&null!==t?t:1,this._state.alpha!==t&&(this._state.alpha=t,this.glRedraw())}get alpha(){return this._state.alpha}set shininess(t){this._state.shininess=t!==undefined?t:80,this.glRedraw()}get shininess(){return this._state.shininess}set lineWidth(t){this._state.lineWidth=t||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set pointSize(t){this._state.pointSize=t||1,this.glRedraw()}get pointSize(){return this._state.pointSize}set reflectivity(t){this._state.reflectivity=t!==undefined?t:1,this.glRedraw()}get reflectivity(){return this._state.reflectivity}get normalMap(){return this._normalMap}get ambientMap(){return this._ambientMap}get diffuseMap(){return this._diffuseMap}get specularMap(){return this._specularMap}get emissiveMap(){return this._emissiveMap}get alphaMap(){return this._alphaMap}get reflectivityMap(){return this._reflectivityMap}get occlusionMap(){return this._occlusionMap}get diffuseFresnel(){return this._diffuseFresnel}get specularFresnel(){return this._specularFresnel}get emissiveFresnel(){return this._emissiveFresnel}get alphaFresnel(){return this._alphaFresnel}get reflectivityFresnel(){return this._reflectivityFresnel}set alphaMode(t){let e=jt[t=t||"opaque"];e===undefined&&(this.error("Unsupported value for 'alphaMode': "+t+" - defaulting to 'opaque'"),e="opaque"),this._state.alphaMode!==e&&(this._state.alphaMode=e,this.glRedraw())}get alphaMode(){return Wt[this._state.alphaMode]}set alphaCutoff(t){null!==t&&t!==undefined||(t=.5),this._state.alphaCutoff!==t&&(this._state.alphaCutoff=t)}get alphaCutoff(){return this._state.alphaCutoff}set backfaces(t){t=!!t,this._state.backfaces!==t&&(this._state.backfaces=t,this.glRedraw())}get backfaces(){return this._state.backfaces}set frontface(t){t="cw"!==t,this._state.frontface!==t&&(this._state.frontface=t,this.glRedraw())}get frontface(){return this._state.frontface?"ccw":"cw"}destroy(){super.destroy(),this._state.destroy()}}const Yt={"default":{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultWhiteBG:{fill:!0,fillColor:[1,1,1],fillAlpha:.6,edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultDarkBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.5,.5,.5],edgeAlpha:.5,edgeWidth:1},phosphorous:{fill:!0,fillColor:[0,0,0],fillAlpha:.4,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:2},sunset:{fill:!0,fillColor:[.9,.9,.6],fillAlpha:.2,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:1},vectorscope:{fill:!0,fillColor:[0,0,0],fillAlpha:.7,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:2},battlezone:{fill:!0,fillColor:[0,0,0],fillAlpha:1,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:3},sepia:{fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},yellowHighlight:{fill:!0,fillColor:[1,1,0],fillAlpha:.5,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},greenSelected:{fill:!0,fillColor:[0,1,0],fillAlpha:.5,edges:!0,edgeColor:[.4577854573726654,.529411792755127,.4100345969200134],edgeAlpha:1,edgeWidth:1},gamegrid:{fill:!0,fillColor:[.2,.2,.7],fillAlpha:.9,edges:!0,edgeColor:[.4,.4,1.6],edgeAlpha:.8,edgeWidth:3}};class Kt extends Xt{get type(){return"EmphasisMaterial"}get presets(){return Yt}constructor(t,e={}){super(t,e),this._state=new nt({type:"EmphasisMaterial",fill:null,fillColor:null,fillAlpha:null,edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null,backfaces:!0}),this._preset="default",e.preset?(this.preset=e.preset,e.fill!==undefined&&(this.fill=e.fill),e.fillColor&&(this.fillColor=e.fillColor),e.fillAlpha!==undefined&&(this.fillAlpha=e.fillAlpha),e.edges!==undefined&&(this.edges=e.edges),e.edgeColor&&(this.edgeColor=e.edgeColor),e.edgeAlpha!==undefined&&(this.edgeAlpha=e.edgeAlpha),e.edgeWidth!==undefined&&(this.edgeWidth=e.edgeWidth),e.backfaces!==undefined&&(this.backfaces=e.backfaces)):(this.fill=e.fill,this.fillColor=e.fillColor,this.fillAlpha=e.fillAlpha,this.edges=e.edges,this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth,this.backfaces=e.backfaces)}set fill(t){t=!1!==t,this._state.fill!==t&&(this._state.fill=t,this.glRedraw())}get fill(){return this._state.fill}set fillColor(t){let e=this._state.fillColor;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.fillColor=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.4,e[1]=.4,e[2]=.4),this.glRedraw()}get fillColor(){return this._state.fillColor}set fillAlpha(t){t=t!==undefined&&null!==t?t:.2,this._state.fillAlpha!==t&&(this._state.fillAlpha=t,this.glRedraw())}get fillAlpha(){return this._state.fillAlpha}set edges(t){t=!1!==t,this._state.edges!==t&&(this._state.edges=t,this.glRedraw())}get edges(){return this._state.edges}set edgeColor(t){let e=this._state.edgeColor;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.edgeColor=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.2,e[1]=.2,e[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(t){t=t!==undefined&&null!==t?t:.5,this._state.edgeAlpha!==t&&(this._state.edgeAlpha=t,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(t){this._state.edgeWidth=t||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set backfaces(t){t=!!t,this._state.backfaces!==t&&(this._state.backfaces=t,this.glRedraw())}get backfaces(){return this._state.backfaces}set preset(t){if(t=t||"default",this._preset===t)return;const e=Yt[t];e?(this.fill=e.fill,this.fillColor=e.fillColor,this.fillAlpha=e.fillAlpha,this.edges=e.edges,this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth,this._preset=t):this.error("unsupported preset: '"+t+"' - supported values are "+Object.keys(Yt).join(", "))}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}const $t={"default":{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultDarkBG:{edgeColor:[.5,.5,.5],edgeAlpha:1,edgeWidth:1}};class qt extends Xt{get type(){return"EdgeMaterial"}get presets(){return $t}constructor(t,e={}){super(t,e),this._state=new nt({type:"EdgeMaterial",edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null}),this._preset="default",e.preset?(this.preset=e.preset,e.edgeColor&&(this.edgeColor=e.edgeColor),e.edgeAlpha!==undefined&&(this.edgeAlpha=e.edgeAlpha),e.edgeWidth!==undefined&&(this.edgeWidth=e.edgeWidth)):(this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth),this.edges=!1!==e.edges}set edges(t){t=!1!==t,this._state.edges!==t&&(this._state.edges=t,this.glRedraw())}get edges(){return this._state.edges}set edgeColor(t){let e=this._state.edgeColor;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.edgeColor=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.2,e[1]=.2,e[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(t){t=t!==undefined&&null!==t?t:1,this._state.edgeAlpha!==t&&(this._state.edgeAlpha=t,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(t){this._state.edgeWidth=t||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set preset(t){if(t=t||"default",this._preset===t)return;const e=$t[t];e?(this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth,this._preset=t):this.error("unsupported preset: '"+t+"' - supported values are "+Object.keys($t).join(", "))}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}const Zt={meters:{abbrev:"m"},metres:{abbrev:"m"},centimeters:{abbrev:"cm"},centimetres:{abbrev:"cm"},millimeters:{abbrev:"mm"},millimetres:{abbrev:"mm"},yards:{abbrev:"yd"},feet:{abbrev:"ft"},inches:{abbrev:"in"}};class Qt extends w{constructor(t,e={}){super(t,e),this._units="meters",this._scale=1,this._origin=M.vec3([0,0,0]),this.units=e.units,this.scale=e.scale,this.origin=e.origin}get unitsInfo(){return Zt}set units(t){t||(t="meters");Zt[t]||(this.error("Unsupported value for 'units': "+t+" defaulting to 'meters'"),t="meters"),this._units=t,this.fire("units",this._units)}get units(){return this._units}set scale(t){(t=t||1)<=0?this.error("scale value should be larger than zero"):(this._scale=t,this.fire("scale",this._scale))}get scale(){return this._scale}set origin(t){if(!t)return this._origin[0]=0,this._origin[1]=0,void(this._origin[2]=0);this._origin[0]=t[0],this._origin[1]=t[1],this._origin[2]=t[2],this.fire("origin",this._origin)}get origin(){return this._origin}worldToRealPos(t,e=M.vec3(3)){e[0]=this._origin[0]+this._scale*t[0],e[1]=this._origin[1]+this._scale*t[1],e[2]=this._origin[2]+this._scale*t[2]}realToWorldPos(t,e=M.vec3(3)){return e[0]=(t[0]-this._origin[0])/this._scale,e[1]=(t[1]-this._origin[1])/this._scale,e[2]=(t[2]-this._origin[2])/this._scale,e}}class Jt extends w{constructor(t,e={}){super(t,e);const i=navigator.userAgent.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i),s="safari"===(navigator.userAgent.match(/Edge/i)||navigator.userAgent.match(/Trident.*rv[ :]*11\./i)?"msie":i[1].toLowerCase());this._supported=!s&&C.SUPPORTED_EXTENSIONS.OES_standard_derivatives,this.enabled=e.enabled,this.kernelRadius=e.kernelRadius,this.intensity=e.intensity,this.bias=e.bias,this.scale=e.scale,this.minResolution=e.minResolution,this.numSamples=e.numSamples,this.blur=e.blur,this.blendCutoff=e.blendCutoff,this.blendFactor=e.blendFactor}get supported(){return this._supported}set enabled(t){t=!!t,this._enabled!==t&&(this._enabled=t,this.glRedraw())}get enabled(){return this._enabled}get possible(){if(!this._supported)return!1;if(!this._enabled)return!1;const t=this.scene.camera.projection;return"customProjection"!==t&&"frustum"!==t}get active(){return this._active}set kernelRadius(t){t!==undefined&&null!==t||(t=100),this._kernelRadius!==t&&(this._kernelRadius=t,this.glRedraw())}get kernelRadius(){return this._kernelRadius}set intensity(t){t!==undefined&&null!==t||(t=.15),this._intensity!==t&&(this._intensity=t,this.glRedraw())}get intensity(){return this._intensity}set bias(t){t!==undefined&&null!==t||(t=.5),this._bias!==t&&(this._bias=t,this.glRedraw())}get bias(){return this._bias}set scale(t){t!==undefined&&null!==t||(t=1),this._scale!==t&&(this._scale=t,this.glRedraw())}get scale(){return this._scale}set minResolution(t){t!==undefined&&null!==t||(t=0),this._minResolution!==t&&(this._minResolution=t,this.glRedraw())}get minResolution(){return this._minResolution}set numSamples(t){t!==undefined&&null!==t||(t=10),this._numSamples!==t&&(this._numSamples=t,this.glRedraw())}get numSamples(){return this._numSamples}set blur(t){t=!1!==t,this._blur!==t&&(this._blur=t,this.glRedraw())}get blur(){return this._blur}set blendCutoff(t){t!==undefined&&null!==t||(t=.3),this._blendCutoff!==t&&(this._blendCutoff=t,this.glRedraw())}get blendCutoff(){return this._blendCutoff}set blendFactor(t){t!==undefined&&null!==t||(t=1),this._blendFactor!==t&&(this._blendFactor=t,this.glRedraw())}get blendFactor(){return this._blendFactor}destroy(){super.destroy()}}const te={"default":{pointSize:4,roundPoints:!0,perspectivePoints:!0},square:{pointSize:4,roundPoints:!1,perspectivePoints:!0},round:{pointSize:4,roundPoints:!0,perspectivePoints:!0}};class ee extends Xt{get type(){return"PointsMaterial"}get presets(){return te}constructor(t,e={}){super(t,e),this._state=new nt({type:"PointsMaterial",pointSize:null,roundPoints:null,perspectivePoints:null,minPerspectivePointSize:null,maxPerspectivePointSize:null}),e.preset?(this.preset=e.preset,e.pointSize!==undefined&&(this.pointSize=e.pointSize),e.roundPoints!==undefined&&(this.roundPoints=e.roundPoints),e.perspectivePoints!==undefined&&(this.perspectivePoints=e.perspectivePoints),e.minPerspectivePointSize!==undefined&&(this.minPerspectivePointSize=e.minPerspectivePointSize),e.maxPerspectivePointSize!==undefined&&(this.maxPerspectivePointSize=e.minPerspectivePointSize)):(this._preset="default",this.pointSize=e.pointSize,this.roundPoints=e.roundPoints,this.perspectivePoints=e.perspectivePoints,this.minPerspectivePointSize=e.minPerspectivePointSize,this.maxPerspectivePointSize=e.maxPerspectivePointSize)}set pointSize(t){this._state.pointSize=t||2,this.glRedraw()}get pointSize(){return this._state.pointSize}set roundPoints(t){t=!1!==t,this._state.roundPoints!==t&&(this._state.roundPoints=t,this.scene._needRecompile=!0,this.glRedraw())}get roundPoints(){return this._state.roundPoints}set perspectivePoints(t){t=!1!==t,this._state.perspectivePoints!==t&&(this._state.perspectivePoints=t,this.scene._needRecompile=!0,this.glRedraw())}get perspectivePoints(){return this._state.perspectivePoints}set minPerspectivePointSize(t){this._state.minPerspectivePointSize=t||1,this.scene._needRecompile=!0,this.glRedraw()}get minPerspectivePointSize(){return this._state.minPerspectivePointSize}set maxPerspectivePointSize(t){this._state.maxPerspectivePointSize=t||6,this.scene._needRecompile=!0,this.glRedraw()}get maxPerspectivePointSize(){return this._state.maxPerspectivePointSize}set preset(t){if(t=t||"default",this._preset===t)return;const e=te[t];e?(this.pointSize=e.pointSize,this.roundPoints=e.roundPoints,this.perspectivePoints=e.perspectivePoints,this.minPerspectivePointSize=e.minPerspectivePointSize,this.maxPerspectivePointSize=e.maxPerspectivePointSize,this._preset=t):this.error("unsupported preset: '"+t+"' - supported values are "+Object.keys(te).join(", "))}get preset(){return this._preset}get hash(){return[this.pointSize,this.roundPoints,this.perspectivePoints,this.minPerspectivePointSize,this.maxPerspectivePointSize].join(";")}destroy(){super.destroy(),this._state.destroy()}}const ie={"default":{lineWidth:1},thick:{lineWidth:2},thicker:{lineWidth:4}};class se extends Xt{get type(){return"LinesMaterial"}get presets(){return ie}constructor(t,e={}){super(t,e),this._state=new nt({type:"LinesMaterial",lineWidth:null}),e.preset?(this.preset=e.preset,e.lineWidth!==undefined&&(this.lineWidth=e.lineWidth)):(this._preset="default",this.lineWidth=e.lineWidth)}set lineWidth(t){this._state.lineWidth=t||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set preset(t){if(t=t||"default",this._preset===t)return;const e=ie[t];e?(this.lineWidth=e.lineWidth,this._preset=t):this.error("unsupported preset: '"+t+"' - supported values are "+Object.keys(ie).join(", "))}get preset(){return this._preset}get hash(){return[""+this.lineWidth].join(";")}destroy(){super.destroy(),this._state.destroy()}}function re(t,e){const i={};let s,r;for(let o=0,a=e.length;o<a;o++)s=e[o],r=t.component[s],r?r.isEntity?i[s]=!0:t.warn("pick(): Component is not an Entity: "+s):t.warn("pick(): Component not found: "+s);return i}class oe extends w{get type(){return"Scene"}constructor(t,e={}){super(null,e);const i=e.canvasElement||document.getElementById(e.canvasId);if(!(i instanceof HTMLCanvasElement))throw"Mandatory config expected: valid canvasId or canvasElement";const s=!!e.transparent,r=!!e.alphaDepthMask;this._aabbDirty=!0,this.viewer=t,this.occlusionTestCountdown=0,this.loading=0,this.startTime=(new Date).getTime(),this.models={},this.objects={},this._numObjects=0,this.visibleObjects={},this._numVisibleObjects=0,this.xrayedObjects={},this._numXRayedObjects=0,this.highlightedObjects={},this._numHighlightedObjects=0,this.selectedObjects={},this._numSelectedObjects=0,this.colorizedObjects={},this._numColorizedObjects=0,this.opacityObjects={},this._numOpacityObjects=0,this.offsetObjects={},this._numOffsetObjects=0,this._modelIds=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this._opacityObjectIds=null,this._offsetObjectIds=null,this._collidables={},this._compilables={},this._needRecompile=!1,this.types={},this.components={},this.sectionPlanes={},this.lights={},this.lightMaps={},this.reflectionMaps={},this.realWorldOffset=e.realWorldOffset||new Float64Array([0,0,0]),this.canvas=new D(this,{dontClear:!0,canvas:i,spinnerElementId:e.spinnerElementId,transparent:s,webgl2:!1!==e.webgl2,contextAttr:e.contextAttr||{},backgroundColor:e.backgroundColor,backgroundColorFromAmbientLight:e.backgroundColorFromAmbientLight,premultipliedAlpha:e.premultipliedAlpha}),this.canvas.on("boundary",(()=>{this.glRedraw()})),this.canvas.on("webglContextFailed",(()=>{alert("xeokit failed to find WebGL!")})),this._renderer=new rt(this,{transparent:s,alphaDepthMask:r}),this._sectionPlanesState=new function(){this.sectionPlanes=[],this.clippingCaps=!1;let t=null;this.getHash=function(){if(t)return t;const e=this.sectionPlanes;if(0===e.length)return this.hash=";";let i;const s=[];for(let t=0,r=e.length;t<r;t++)i=e[t],s.push("cp");return s.push(";"),t=s.join(""),t},this.addSectionPlane=function(e){this.sectionPlanes.push(e),t=null},this.removeSectionPlane=function(e){for(let i=0,s=this.sectionPlanes.length;i<s;i++)if(this.sectionPlanes[i].id===e.id)return this.sectionPlanes.splice(i,1),void(t=null)}},this._lightsState=new function(){const t=M.vec4([0,0,0,0]),e=M.vec4();this.lights=[],this.reflectionMaps=[],this.lightMaps=[];let i=null,s=null;this.getHash=function(){if(i)return i;const t=[],e=this.lights;let s;for(let i=0,r=e.length;i<r;i++)s=e[i],t.push("/"),t.push(s.type),t.push("world"===s.space?"w":"v"),s.castsShadow&&t.push("sh");return this.lightMaps.length>0&&t.push("/lm"),this.reflectionMaps.length>0&&t.push("/rm"),t.push(";"),i=t.join(""),i},this.addLight=function(t){this.lights.push(t),s=null,i=null},this.removeLight=function(t){for(let e=0,r=this.lights.length;e<r;e++){if(this.lights[e].id===t.id)return this.lights.splice(e,1),s&&s.id===t.id&&(s=null),void(i=null)}},this.addReflectionMap=function(t){this.reflectionMaps.push(t),i=null},this.removeReflectionMap=function(t){for(let e=0,s=this.reflectionMaps.length;e<s;e++)if(this.reflectionMaps[e].id===t.id)return this.reflectionMaps.splice(e,1),void(i=null)},this.addLightMap=function(t){this.lightMaps.push(t),i=null},this.removeLightMap=function(t){for(let e=0,s=this.lightMaps.length;e<s;e++)if(this.lightMaps[e].id===t.id)return this.lightMaps.splice(e,1),void(i=null)},this.getAmbientColorAndIntensity=function(){if(!s)for(let t=0,e=this.lights.length;t<e;t++){const e=this.lights[t];if("ambient"===e.type){s=e;break}}if(s){const t=s.color,i=s.intensity;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=i,e}return t}},this.input=new ot(this,{dontClear:!0,element:this.canvas.canvas}),this.metrics=new Qt(this,{units:e.units,scale:e.scale,origin:e.origin}),this.sao=new Jt(this,{enabled:e.saoEnabled}),this.ticksPerRender=e.ticksPerRender,this.ticksPerOcclusionTest=e.ticksPerOcclusionTest,this.passes=e.passes,this.clearEachPass=e.clearEachPass,this.gammaInput=e.gammaInput,this.gammaOutput=e.gammaOutput,this.gammaFactor=e.gammaFactor,this._entityOffsetsEnabled=!!e.entityOffsetsEnabled,this._logarithmicDepthBufferEnabled=!!e.logarithmicDepthBufferEnabled,this._pbrEnabled=!!e.pbrEnabled,m._addScene(this),this._initDefaults(),this._viewport=new lt(this,{id:"default.viewport",autoBoundary:!0,dontClear:!0}),this._camera=new Et(this,{id:"default.camera",dontClear:!0}),new St(this,{color:[1,1,1],intensity:.7}),new At(this,{dir:[.8,-.5,-.5],color:[.67,.67,1],intensity:.7,space:"world"}),new At(this,{dir:[-.8,-1,.5],color:[1,1,.9],intensity:.9,space:"world"}),this._camera.on("dirty",(()=>{this._renderer.imageDirty()}))}_initDefaults(){let t;t=this.geometry,t=this.material,t=this.xrayMaterial,t=this.edgeMaterial,t=this.selectedMaterial,t=this.highlightMaterial}_addComponent(t){if(t.id&&this.components[t.id]&&(this.error("Component "+n.inQuotes(t.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),t.id=null),!t.id)for(window.nextID===undefined&&(window.nextID=0),t.id="__"+window.nextID++;this.components[t.id];)t.id=M.createUUID();this.components[t.id]=t;const e=t.type;let i=this.types[t.type];i||(i=this.types[e]={}),i[t.id]=t,t.compile&&(this._compilables[t.id]=t),t.isDrawable&&(this._renderer.addDrawable(t.id,t),this._collidables[t.id]=t)}_removeComponent(t){var e=t.id,i=t.type;delete this.components[e];const s=this.types[i];s&&(delete s[e],n.isEmptyObject(s)&&delete this.types[i]),t.compile&&delete this._compilables[t.id],t.isDrawable&&(this._renderer.removeDrawable(t.id),delete this._collidables[t.id])}_sectionPlaneCreated(t){this.sectionPlanes[t.id]=t,this.scene._sectionPlanesState.addSectionPlane(t._state),this.scene.fire("sectionPlaneCreated",t,!0),this._needRecompile=!0}_lightCreated(t){this.lights[t.id]=t,this.scene._lightsState.addLight(t._state),this._needRecompile=!0}_lightMapCreated(t){this.lightMaps[t.id]=t,this.scene._lightsState.addLightMap(t._state),this._needRecompile=!0}_reflectionMapCreated(t){this.reflectionMaps[t.id]=t,this.scene._lightsState.addReflectionMap(t._state),this._needRecompile=!0}_sectionPlaneDestroyed(t){delete this.sectionPlanes[t.id],this.scene._sectionPlanesState.removeSectionPlane(t._state),this.scene.fire("sectionPlaneDestroyed",t,!0),this._needRecompile=!0}_lightDestroyed(t){delete this.lights[t.id],this.scene._lightsState.removeLight(t._state),this._needRecompile=!0}_lightMapDestroyed(t){delete this.lightMaps[t.id],this.scene._lightsState.removeLightMap(t._state),this._needRecompile=!0}_reflectionMapDestroyed(t){delete this.reflectionMaps[t.id],this.scene._lightsState.removeReflectionMap(t._state),this._needRecompile=!0}_registerModel(t){this.models[t.id]=t,this._modelIds=null}_deregisterModel(t){delete this.models[t.id],this._modelIds=null}_registerObject(t){this.objects[t.id]=t,this._numObjects++,this._objectIds=null}_deregisterObject(t){delete this.objects[t.id],this._numObjects--,this._objectIds=null}_objectVisibilityUpdated(t,e=!0){t.visible?(this.visibleObjects[t.id]=t,this._numVisibleObjects++):(delete this.visibleObjects[t.id],this._numVisibleObjects--),this._visibleObjectIds=null,e&&this.fire("objectVisibility",t,!0)}_objectXRayedUpdated(t){t.xrayed?(this.xrayedObjects[t.id]=t,this._numXRayedObjects++):(delete this.xrayedObjects[t.id],this._numXRayedObjects--),this._xrayedObjectIds=null}_objectHighlightedUpdated(t){t.highlighted?(this.highlightedObjects[t.id]=t,this._numHighlightedObjects++):(delete this.highlightedObjects[t.id],this._numHighlightedObjects--),this._highlightedObjectIds=null}_objectSelectedUpdated(t){t.selected?(this.selectedObjects[t.id]=t,this._numSelectedObjects++):(delete this.selectedObjects[t.id],this._numSelectedObjects--),this._selectedObjectIds=null}_objectColorizeUpdated(t,e){e?(this.colorizedObjects[t.id]=t,this._numColorizedObjects++):(delete this.colorizedObjects[t.id],this._numColorizedObjects--),this._colorizedObjectIds=null}_objectOpacityUpdated(t,e){e?(this.opacityObjects[t.id]=t,this._numOpacityObjects++):(delete this.opacityObjects[t.id],this._numOpacityObjects--),this._opacityObjectIds=null}_objectOffsetUpdated(t,e){!e||0===e[0]&&0===e[1]&&0===e[2]?(this.offsetObjects[t.id]=t,this._numOffsetObjects++):(delete this.offsetObjects[t.id],this._numOffsetObjects--),this._offsetObjectIds=null}_webglContextLost(){this.canvas.spinner.processes++;for(const t in this.components)if(this.components.hasOwnProperty(t)){const e=this.components[t];e._webglContextLost&&e._webglContextLost()}this._renderer.webglContextLost()}_webglContextRestored(){const t=this.canvas.gl;for(const e in this.components)if(this.components.hasOwnProperty(e)){const i=this.components[e];i._webglContextRestored&&i._webglContextRestored(t)}this._renderer.webglContextRestored(t),this.canvas.spinner.processes--}get entityOffsetsEnabled(){return this._entityOffsetsEnabled}get logarithmicDepthBufferEnabled(){return this._logarithmicDepthBufferEnabled}set pbrEnabled(t){this._pbrEnabled=!!t,this.glRedraw()}get pbrEnabled(){return this._pbrEnabled}doOcclusionTest(){this._needRecompile&&(this._recompile(),this._needRecompile=!1),this._renderer.doOcclusionTest()}render(t){t&&m.runTasks();const e={sceneId:null,pass:0};this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),e.sceneId=this.id;const i=this._passes,s=this._clearEachPass;let r,o;for(r=0;r<i;r++)e.pass=r,this.fire("rendering",e,!0),o=s||0===r,this._renderer.render({pass:r,clear:o,force:t}),this.fire("rendered",e,!0);this._saveAmbientColor()}_recompile(){for(const t in this._compilables)this._compilables.hasOwnProperty(t)&&this._compilables[t].compile();this._renderer.shadowsDirty(),this.fire("compile",this,!0)}_saveAmbientColor(){const t=this.canvas;if(t.transparent||t.backgroundImage||t.backgroundColor)this._lastAmbientColor=null;else{const e=this._lightsState.getAmbientColorAndIntensity();this._lastAmbientColor&&this._lastAmbientColor[0]===e[0]&&this._lastAmbientColor[1]===e[1]&&this._lastAmbientColor[2]===e[2]&&this._lastAmbientColor[3]===e[3]||(t.backgroundColor=e,this._lastAmbientColor||(this._lastAmbientColor=M.vec4([0,0,0,1])),this._lastAmbientColor.set(e))}}get modelIds(){return this._modelIds||(this._modelIds=Object.keys(this.models)),this._modelIds}get numObjects(){return this._numObjects}get objectIds(){return this._objectIds||(this._objectIds=Object.keys(this.objects)),this._objectIds}get numVisibleObjects(){return this._numVisibleObjects}get visibleObjectIds(){return this._visibleObjectIds||(this._visibleObjectIds=Object.keys(this.visibleObjects)),this._visibleObjectIds}get numXRayedObjects(){return this._numXRayedObjects}get xrayedObjectIds(){return this._xrayedObjectIds||(this._xrayedObjectIds=Object.keys(this.xrayedObjects)),this._xrayedObjectIds}get numHighlightedObjects(){return this._numHighlightedObjects}get highlightedObjectIds(){return this._highlightedObjectIds||(this._highlightedObjectIds=Object.keys(this.highlightedObjects)),this._highlightedObjectIds}get numSelectedObjects(){return this._numSelectedObjects}get selectedObjectIds(){return this._selectedObjectIds||(this._selectedObjectIds=Object.keys(this.selectedObjects)),this._selectedObjectIds}get numColorizedObjects(){return this._numColorizedObjects}get colorizedObjectIds(){return this._colorizedObjectIds||(this._colorizedObjectIds=Object.keys(this.colorizedObjects)),this._colorizedObjectIds}get opacityObjectIds(){return this._opacityObjectIds||(this._opacityObjectIds=Object.keys(this.opacityObjects)),this._opacityObjectIds}get offsetObjectIds(){return this._offsetObjectIds||(this._offsetObjectIds=Object.keys(this.offsetObjects)),this._offsetObjectIds}set ticksPerRender(t){t===undefined||null===t?t=1:(!n.isNumeric(t)||t<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+t+"' - should be an integer greater than zero."),t=1),t!==this._ticksPerRender&&(this._ticksPerRender=t)}get ticksPerRender(){return this._ticksPerRender}set ticksPerOcclusionTest(t){t===undefined||null===t?t=20:(!n.isNumeric(t)||t<=0)&&(this.error("Unsupported value for 'ticksPerOcclusionTest': '"+t+"' - should be an integer greater than zero."),t=20),t!==this._ticksPerOcclusionTest&&(this._ticksPerOcclusionTest=t)}get ticksPerOcclusionTest(){return this._ticksPerOcclusionTest}set passes(t){t===undefined||null===t?t=1:(!n.isNumeric(t)||t<=0)&&(this.error("Unsupported value for 'passes': '"+t+"' - should be an integer greater than zero."),t=1),t!==this._passes&&(this._passes=t,this.glRedraw())}get passes(){return this._passes}set clearEachPass(t){(t=!!t)!==this._clearEachPass&&(this._clearEachPass=t,this.glRedraw())}get clearEachPass(){return this._clearEachPass}set gammaInput(t){(t=!1!==t)!==this._renderer.gammaInput&&(this._renderer.gammaInput=t,this._needRecompile=!0,this.glRedraw())}get gammaInput(){return this._renderer.gammaInput}set gammaOutput(t){(t=!!t)!==this._renderer.gammaOutput&&(this._renderer.gammaOutput=t,this._needRecompile=!0,this.glRedraw())}get gammaOutput(){return this._renderer.gammaOutput}set gammaFactor(t){(t=t===undefined||null===t?2.2:t)!==this._renderer.gammaFactor&&(this._renderer.gammaFactor=t,this.glRedraw())}get gammaFactor(){return this._renderer.gammaFactor}get geometry(){return this.components["default.geometry"]||function(t={}){let e=t.xSize||1;e<0&&(console.error("negative xSize not allowed - will invert"),e*=-1);let i=t.ySize||1;i<0&&(console.error("negative ySize not allowed - will invert"),i*=-1);let s=t.zSize||1;s<0&&(console.error("negative zSize not allowed - will invert"),s*=-1);const r=t.center,o=r?r[0]:0,a=r?r[1]:0,l=r?r[2]:0,h=-e+o,u=-i+a,c=-s+l,d=e+o,p=i+a,f=s+l;return n.apply(t,{positions:[d,p,f,h,p,f,h,u,f,d,u,f,d,p,f,d,u,f,d,u,c,d,p,c,d,p,f,d,p,c,h,p,c,h,p,f,h,p,f,h,p,c,h,u,c,h,u,f,h,u,c,d,u,c,d,u,f,h,u,f,d,u,c,h,u,c,h,p,c,d,p,c],normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],uv:[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]})}(Gt)}get material(){return this.components["default.material"]||new Ht(this,{id:"default.material",emissive:[.4,.4,.4],dontClear:!0})}get xrayMaterial(){return this.components["default.xrayMaterial"]||new Kt(this,{id:"default.xrayMaterial",preset:"sepia",dontClear:!0})}get highlightMaterial(){return this.components["default.highlightMaterial"]||new Kt(this,{id:"default.highlightMaterial",preset:"yellowHighlight",dontClear:!0})}get selectedMaterial(){return this.components["default.selectedMaterial"]||new Kt(this,{id:"default.selectedMaterial",preset:"greenSelected",dontClear:!0})}get edgeMaterial(){return this.components["default.edgeMaterial"]||new qt(this,{id:"default.edgeMaterial",preset:"default",edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1,dontClear:!0})}get pointsMaterial(){return this.components["default.pointsMaterial"]||new ee(this,{id:"default.pointsMaterial",preset:"default",dontClear:!0})}get linesMaterial(){return this.components["default.linesMaterial"]||new se(this,{id:"default.linesMaterial",preset:"default",dontClear:!0})}get viewport(){return this._viewport}get camera(){return this._camera}get center(){if(this._aabbDirty||!this._center){this._center&&this._center||(this._center=M.vec3());const t=this.aabb;this._center[0]=(t[0]+t[3])/2,this._center[1]=(t[1]+t[4])/2,this._center[2]=(t[2]+t[5])/2}return this._center}get aabb(){if(this._aabbDirty){this._aabb||(this._aabb=M.AABB3());let t,e=M.MAX_DOUBLE,i=M.MAX_DOUBLE,s=M.MAX_DOUBLE,r=M.MIN_DOUBLE,o=M.MIN_DOUBLE,a=M.MIN_DOUBLE;const n=this._collidables;let l,h=!1;for(const u in n)if(n.hasOwnProperty(u)){if(l=n[u],!1===l.collidable)continue;t=l.aabb,t[0]<e&&(e=t[0]),t[1]<i&&(i=t[1]),t[2]<s&&(s=t[2]),t[3]>r&&(r=t[3]),t[4]>o&&(o=t[4]),t[5]>a&&(a=t[5]),h=!0}h||(e=-100,i=-100,s=-100,r=100,o=100,a=100),this._aabb[0]=e,this._aabb[1]=i,this._aabb[2]=s,this._aabb[3]=r,this._aabb[4]=o,this._aabb[5]=a,this._aabbDirty=!1}return this._aabb}_setAABBDirty(){this._aabbDirty=!0,this.fire("boundary")}pick(t,e){if(0===this.canvas.boundary[2]||0===this.canvas.boundary[3])return this.error("Picking not allowed while canvas has zero width or height"),null;(t=t||{}).pickSurface=t.pickSurface||t.rayPick,t.canvasPos||t.matrix||t.origin&&t.direction||this.warn("picking without canvasPos, matrix, or ray origin and direction");const i=t.includeEntities||t.include;i&&(t.includeEntityIds=re(this,i));const s=t.excludeEntities||t.exclude;return s&&(t.excludeEntityIds=re(this,s)),this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),(e=this._renderer.pick(t,e))?(e.entity&&e.entity.fire&&e.entity.fire("picked",e),e):void 0}clear(){var t;for(const e in this.components)this.components.hasOwnProperty(e)&&((t=this.components[e])._dontClear||t.destroy())}clearLights(){const t=Object.keys(this.lights);for(let e=0,i=t.length;e<i;e++)this.lights[t[e]].destroy()}clearSectionPlanes(){const t=Object.keys(this.sectionPlanes);for(let e=0,i=t.length;e<i;e++)this.sectionPlanes[t[e]].destroy()}getAABB(t){if(t===undefined)return this.aabb;if(n.isString(t)){const e=this.objects[t];if(e&&e.aabb)return e.aabb;t=[t]}if(0===t.length)return this.aabb;let e,i=M.MAX_DOUBLE,s=M.MAX_DOUBLE,r=M.MAX_DOUBLE,o=M.MIN_DOUBLE,a=M.MIN_DOUBLE,l=M.MIN_DOUBLE;if(this.withObjects(t,(t=>{if(t.collidable){const n=t.aabb;n[0]<i&&(i=n[0]),n[1]<s&&(s=n[1]),n[2]<r&&(r=n[2]),n[3]>o&&(o=n[3]),n[4]>a&&(a=n[4]),n[5]>l&&(l=n[5]),e=!0}})),e){const t=M.AABB3();return t[0]=i,t[1]=s,t[2]=r,t[3]=o,t[4]=a,t[5]=l,t}return this.aabb}setObjectsVisible(t,e){return this.withObjects(t,(t=>{const i=t.visible!==e;return t.visible=e,i}))}setObjectsCollidable(t,e){return this.withObjects(t,(t=>{const i=t.collidable!==e;return t.collidable=e,i}))}setObjectsCulled(t,e){return this.withObjects(t,this.objects,(t=>{const i=t.culled!==e;return t.culled=e,i}))}setObjectsSelected(t,e){return this.withObjects(t,(t=>{const i=t.selected!==e;return t.selected=e,i}))}setObjectsHighlighted(t,e){return this.withObjects(t,(t=>{const i=t.highlighted!==e;return t.highlighted=e,i}))}setObjectsXRayed(t,e){return this.withObjects(t,(t=>{const i=t.xrayed!==e;return t.xrayed=e,i}))}setObjectsEdges(t,e){return this.withObjects(t,(t=>{const i=t.edges!==e;return t.edges=e,i}))}setObjectsColorized(t,e){return this.withObjects(t,(t=>{t.colorize=e}))}setObjectsOpacity(t,e){return this.withObjects(t,(t=>{const i=t.opacity!==e;return t.opacity=e,i}))}setObjectsPickable(t,e){return this.withObjects(t,(t=>{const i=t.pickable!==e;return t.pickable=e,i}))}setObjectsOffset(t,e){this.withObjects(t,(t=>{t.offset=e}))}withObjects(t,e){n.isString(t)&&(t=[t]);let i=!1;for(let s=0,r=t.length;s<r;s++){const r=t[s];let o=this.objects[r];if(o)i=e(o)||i;else{const t=this.modelIds;for(let s=0,a=t.length;s<a;s++){const a=t[s],n=M.globalizeObjectId(a,r);o=this.objects[n],o&&(i=e(o)||i)}}}return i}destroy(){super.destroy();for(const t in this.components)this.components.hasOwnProperty(t)&&this.components[t].destroy();this.canvas.gl=null,this.components=null,this.models=null,this.objects=null,this.visibleObjects=null,this.xrayedObjects=null,this.highlightedObjects=null,this.selectedObjects=null,this.colorizedObjects=null,this.opacityObjects=null,this.sectionPlanes=null,this.lights=null,this.lightMaps=null,this.reflectionMaps=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this.types=null,this.components=null,this.canvas=null,this._renderer=null,this.input=null,this._viewport=null,this._camera=null}}const ae=M.vec3(),ne=M.vec3(),le=M.vec3(),he=M.vec3(),ue=M.vec3();class ce extends w{get type(){return"CameraFlightAnimation"}constructor(t,e={}){super(t,e),this._look1=M.vec3(),this._eye1=M.vec3(),this._up1=M.vec3(),this._look2=M.vec3(),this._eye2=M.vec3(),this._up2=M.vec3(),this._orthoScale1=1,this._orthoScale2=1,this._flying=!1,this._flyEyeLookUp=!1,this._flyingEye=!1,this._flyingLook=!1,this._callback=null,this._callbackScope=null,this._time1=null,this._time2=null,this.easing=!1!==e.easing,this.duration=e.duration,this.fit=e.fit,this.fitFOV=e.fitFOV,this.trail=e.trail}flyTo(t,e,i){t=t||this.scene,this._flying&&this.stop(),this._flying=!1,this._flyingEye=!1,this._flyingLook=!1,this._flyingEyeLookUp=!1,this._callback=e,this._callbackScope=i;const s=this.scene.camera,r=!!t.projection&&t.projection!==s.projection;let o,a,l,h,u;if(this._eye1[0]=s.eye[0],this._eye1[1]=s.eye[1],this._eye1[2]=s.eye[2],this._look1[0]=s.look[0],this._look1[1]=s.look[1],this._look1[2]=s.look[2],this._up1[0]=s.up[0],this._up1[1]=s.up[1],this._up1[2]=s.up[2],this._orthoScale1=s.ortho.scale,this._orthoScale2=t.orthoScale||this._orthoScale1,t.aabb)o=t.aabb;else if(6===t.length)o=t;else if(t.eye&&t.look||t.up)a=t.eye,l=t.look,h=t.up;else if(t.eye)a=t.eye;else if(t.look)l=t.look;else{let s=t;if((n.isNumeric(s)||n.isString(s))&&(u=s,s=this.scene.components[u],!s))return this.error("Component not found: "+n.inQuotes(u)),void(e&&(i?e.call(i):e()));r||(o=s.aabb||this.scene.aabb)}const c=t.poi;if(o){if(o[3]<o[0]||o[4]<o[1]||o[5]<o[2])return;if(o[3]===o[0]&&o[4]===o[1]&&o[5]===o[2])return;o=o.slice();const e=M.getAABB3Center(o);this._look2=c||e;const i=M.subVec3(this._eye1,this._look1,ae),s=M.normalizeVec3(i),r=c?M.getAABB3DiagPoint(o,c):M.getAABB3Diag(o),a=t.fitFOV||this._fitFOV,n=Math.abs(r/Math.tan(a*M.DEGTORAD));this._orthoScale2=1.1*r,this._eye2[0]=this._look2[0]+s[0]*n,this._eye2[1]=this._look2[1]+s[1]*n,this._eye2[2]=this._look2[2]+s[2]*n,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyingEyeLookUp=!0}else(a||l||h)&&(this._flyingEyeLookUp=!!a&&!!l&&!!h,this._flyingEye=!!a&&!l,this._flyingLook=!!l&&!a,a&&(this._eye2[0]=a[0],this._eye2[1]=a[1],this._eye2[2]=a[2]),l&&(this._look2[0]=l[0],this._look2[1]=l[1],this._look2[2]=l[2]),h&&(this._up2[0]=h[0],this._up2[1]=h[1],this._up2[2]=h[2]));r?("ortho"===t.projection&&"ortho"!==s.projection&&(this._projection2="ortho",this._projMatrix1=s.projMatrix.slice(),s.ortho.scale=this._orthoScale2,this._projMatrix2=s.ortho.matrix.slice(),s.projection="customProjection"),"perspective"===t.projection&&"perspective"!==s.projection&&(this._projection2="perspective",this._projMatrix1=s.projMatrix.slice(),this._projMatrix2=s.perspective.matrix.slice(),s.projection="customProjection")):this._projection2=null,this.fire("started",t,!0),this._time1=Date.now(),this._time2=this._time1+(t.duration?1e3*t.duration:this._duration),this._flying=!0,m.scheduleTask(this._update,this)}jumpTo(t){this._jumpTo(t)}_jumpTo(t){this._flying&&this.stop();const e=this.scene.camera;var i,s,r,o,a;if(t.aabb)i=t.aabb;else if(6===t.length)i=t;else if(t.eye||t.look||t.up)r=t.eye,o=t.look,a=t.up;else{let e=t;if((n.isNumeric(e)||n.isString(e))&&(s=e,e=this.scene.components[s],!e))return void this.error("Component not found: "+n.inQuotes(s));i=e.aabb||this.scene.aabb}const l=t.poi;if(i){if(i[3]<=i[0]||i[4]<=i[1]||i[5]<=i[2])return;var h=l?M.getAABB3DiagPoint(i,l):M.getAABB3Diag(i);let s;o=l||M.getAABB3Center(i,o),this._trail?M.subVec3(e.look,o,ue):M.subVec3(e.eye,e.look,ue),M.normalizeVec3(ue);s=(t.fit!==undefined?t.fit:this._fit)?Math.abs(h/Math.tan((t.fitFOV||this._fitFOV)*M.DEGTORAD)):M.lenVec3(M.subVec3(e.eye,e.look,ae)),M.mulVec3Scalar(ue,s),e.eye=M.addVec3(o,ue,ae),e.look=o,this.scene.camera.ortho.scale=1.1*h}else(r||o||a)&&(r&&(e.eye=r),o&&(e.look=o),a&&(e.up=a));t.projection&&(e.projection=t.projection)}_update(){if(!this._flying)return;let t=(Date.now()-this._time1)/(this._time2-this._time1);const e=t>=1;t>1&&(t=1);const i=this.easing?ce._ease(t,0,1,1):t,s=this.scene.camera;if(this._flyingEye||this._flyingLook?this._flyingEye?(M.subVec3(s.eye,s.look,ue),s.eye=M.lerpVec3(i,0,1,this._eye1,this._eye2,le),s.look=M.subVec3(le,ue,ne)):this._flyingLook&&(s.look=M.lerpVec3(i,0,1,this._look1,this._look2,ne),s.up=M.lerpVec3(i,0,1,this._up1,this._up2,he)):this._flyingEyeLookUp&&(s.eye=M.lerpVec3(i,0,1,this._eye1,this._eye2,le),s.look=M.lerpVec3(i,0,1,this._look1,this._look2,ne),s.up=M.lerpVec3(i,0,1,this._up1,this._up2,he)),this._projection2){const e="ortho"===this._projection2?ce._easeOutExpo(t,0,1,1):ce._easeInCubic(t,0,1,1);s.customProjection.matrix=M.lerpMat4(e,0,1,this._projMatrix1,this._projMatrix2)}else s.ortho.scale=this._orthoScale1+t*(this._orthoScale2-this._orthoScale1);e?this.stop():m.scheduleTask(this._update,this)}static _ease(t,e,i,s){return-i*(t/=s)*(t-2)+e}static _easeInCubic(t,e,i,s){return i*(t/=s)*t*t+e}static _easeOutExpo(t,e,i,s){return i*(1-Math.pow(2,-10*t/s))+e}stop(){if(!this._flying)return;this._flying=!1,this._time1=null,this._time2=null,this._projection2&&(this.scene.camera.projection=this._projection2);const t=this._callback;t&&(this._callback=null,this._callbackScope?t.call(this._callbackScope):t()),this.fire("stopped",!0,!0)}cancel(){this._flying&&(this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))}set duration(t){this._duration=t?1e3*t:500,this.stop()}get duration(){return this._duration/1e3}set fit(t){this._fit=!1!==t}get fit(){return this._fit}set fitFOV(t){this._fitFOV=t||45}get fitFOV(){return this._fitFOV}set trail(t){this._trail=!!t}get trail(){return this._trail}destroy(){this.stop(),super.destroy()}}const de=M.vec4(),pe=M.vec4(),fe=M.vec3(),_e=M.vec3(),ge=M.vec3(),me=M.vec4(),ve=M.vec4(),Pe=M.vec4();class be{constructor(t){this._scene=t}dollyToCanvasPos(t,e,i){let s=!1;const r=this._scene.camera;if(t){const e=M.subVec3(t,r.eye,fe);s=M.lenVec3(e)<i}if("perspective"===r.projection){r.ortho.scale=r.ortho.scale-i;const s=this._unproject(e,me),o=M.subVec3(s,r.eye,Pe),a=M.mulVec3Scalar(M.normalizeVec3(o),-i,[]);if(r.eye=[r.eye[0]-a[0],r.eye[1]-a[1],r.eye[2]-a[2]],r.look=[r.look[0]-a[0],r.look[1]-a[1],r.look[2]-a[2]],t){const e=M.subVec3(t,r.eye,fe),i=M.lenVec3(e),s=M.mulVec3Scalar(M.normalizeVec3(M.subVec3(r.look,r.eye,_e)),i);r.look=[r.eye[0]+s[0],r.eye[1]+s[1],r.eye[2]+s[2]]}}else if("ortho"===r.projection){const t=this._unproject(e,me);r.ortho.scale=r.ortho.scale-i,r.ortho._update();const s=this._unproject(e,ve),o=M.subVec3(s,t,Pe),a=M.mulVec3Scalar(M.normalizeVec3(M.subVec3(r.look,r.eye,fe)),-i,_e),n=M.addVec3(o,a,ge);r.eye=[r.eye[0]-n[0],r.eye[1]-n[1],r.eye[2]-n[2]],r.look=[r.look[0]-n[0],r.look[1]-n[1],r.look[2]-n[2]]}return s}_unproject(t,e){const i=this._scene.camera,s=i.project.transposedMatrix,r=s.subarray(8,12),o=s.subarray(12),a=[0,0,-1,1],n=M.dotVec4(a,r)/M.dotVec4(a,o);return i.project.unproject(t,n,de,pe,e),e}destroy(){}}const ye=M.vec3(),xe=M.vec3(),Me=M.vec3(),we=M.vec4(),Ee=M.vec4(),Ce=M.vec4();class Ae{constructor(t,e){this._scene=t,this._configs=e,this._pivotWorldPos=M.vec3(),this._cameraOffset=M.vec3(),this._azimuth=0,this._polar=0,this._radius=0,this._pivotPosSet=!1,this._pivoting=!1,this._shown=!1,this._pivotViewPos=M.vec4(),this._pivotProjPos=M.vec4(),this._pivotCanvasPos=M.vec2(),this._cameraDirty=!0,this._onViewMatrix=this._scene.camera.on("viewMatrix",(()=>{this._cameraDirty=!0})),this._onProjMatrix=this._scene.camera.on("projMatrix",(()=>{this._cameraDirty=!0})),this._onTick=this._scene.on("tick",(()=>{this.updatePivotElement()}))}updatePivotElement(){const t=this._scene.camera,e=this._scene.canvas;if(this._pivoting&&this._cameraDirty){M.transformPoint3(t.viewMatrix,this.getPivotPos(),this._pivotViewPos),this._pivotViewPos[3]=1,M.transformPoint4(t.projMatrix,this._pivotViewPos,this._pivotProjPos);const i=e.boundary,s=i[2],r=i[3];this._pivotCanvasPos[0]=Math.floor((1+this._pivotProjPos[0]/this._pivotProjPos[3])*s/2),this._pivotCanvasPos[1]=Math.floor((1-this._pivotProjPos[1]/this._pivotProjPos[3])*r/2);const o=e.canvas.getBoundingClientRect();this._pivotElement&&(this._pivotElement.style.left=Math.floor(o.left+this._pivotCanvasPos[0])-this._pivotElement.clientWidth/2+window.scrollX+"px",this._pivotElement.style.top=Math.floor(o.top+this._pivotCanvasPos[1])-this._pivotElement.clientHeight/2+window.scrollY+"px"),this._cameraDirty=!1}}setPivotElement(t){this._pivotElement=t}startPivot(){if(this._cameraLookingDownwards())return this._pivoting=!1,!1;const t=this._scene.camera;let e=M.lookAtMat4v(t.eye,t.look,t.worldUp);M.transformPoint3(e,this.getPivotPos(),this._cameraOffset);const i=this.getPivotPos();this._cameraOffset[2]+=M.distVec3(t.eye,i),e=M.inverseMat4(e);const s=M.transformVec3(e,this._cameraOffset),r=M.vec3();if(M.subVec3(t.eye,i,r),M.addVec3(r,s),t.zUp){const t=r[1];r[1]=r[2],r[2]=t}this._radius=M.lenVec3(r),this._polar=Math.acos(r[1]/this._radius),this._azimuth=Math.atan2(r[0],r[2]),this._pivoting=!0}_cameraLookingDownwards(){const t=this._scene.camera,e=M.normalizeVec3(M.subVec3(t.look,t.eye,ye)),i=M.cross3Vec3(e,t.worldUp,xe);return M.sqLenVec3(i)<=1e-4}getPivoting(){return this._pivoting}setPivotPos(t){this._pivotWorldPos.set(t),this._pivotPosSet=!0}setCanvasPivotPos(t){const e=this._scene.camera,i=Math.abs(M.distVec3(this._scene.center,e.eye)),s=e.project.transposedMatrix,r=s.subarray(8,12),o=s.subarray(12),a=[0,0,-1,1],n=M.dotVec4(a,r)/M.dotVec4(a,o),l=we;e.project.unproject(t,n,Ee,Ce,l);const h=M.normalizeVec3(M.subVec3(l,e.eye,ye)),u=M.addVec3(e.eye,M.mulVec3Scalar(h,i,xe),Me);this.setPivotPos(u)}getPivotPos(){return this._pivotPosSet?this._pivotWorldPos:this._scene.camera.look}continuePivot(t,e){if(!this._pivoting)return;if(0===t&&0===e)return;const i=this._scene.camera;var s=-t;const r=-e;1===i.worldUp[2]&&(s=-s),this._azimuth+=.01*-s,this._polar+=.01*r,this._polar=M.clamp(this._polar,.001,Math.PI-.001);const o=[this._radius*Math.sin(this._polar)*Math.sin(this._azimuth),this._radius*Math.cos(this._polar),this._radius*Math.sin(this._polar)*Math.cos(this._azimuth)];if(1===i.worldUp[2]){const t=o[1];o[1]=o[2],o[2]=t}const a=M.lenVec3(M.subVec3(i.look,i.eye,M.vec3())),n=this.getPivotPos();M.addVec3(o,n);let l=M.lookAtMat4v(o,n,i.worldUp);l=M.inverseMat4(l);const h=M.transformVec3(l,this._cameraOffset);l[12]-=h[0],l[13]-=h[1],l[14]-=h[2];const u=[l[8],l[9],l[10]];i.eye=[l[12],l[13],l[14]],M.subVec3(i.eye,M.mulVec3Scalar(u,a),i.look),i.up=[l[4],l[5],l[6]],this.showPivot()}showPivot(){this._shown||(null!==this._hideTimeout&&(window.clearTimeout(this._hideTimeout),this._hideTimeout=null),this._pivotElement&&(this.updatePivotElement(),this._pivotElement.style.visibility="visible",this._shown=!0,this._hideTimeout=window.setTimeout((()=>{this.hidePivot()}),1e3)))}hidePivot(){this._shown&&(null!==this._hideTimeout&&(window.clearTimeout(this._hideTimeout),this._hideTimeout=null),this._pivotElement&&(this._pivotElement.style.visibility="hidden"),this._shown=!1)}endPivot(){this._pivoting=!1}destroy(){this._scene.camera.off(this._onViewMatrix),this._scene.camera.off(this._onProjMatrix),this._scene.off(this._onTick)}}class Se{constructor(t,e){this._scene=t.scene,this._cameraControl=t,this._scene.canvas.canvas.oncontextmenu=function(t){t.preventDefault()},this._configs=e,this.schedulePickEntity=!1,this.schedulePickSurface=!1,this.pickCursorPos=M.vec2(),this.picked=!1,this.pickedSurface=!1,this.pickResult=null,this._lastPickedEntityId=null,this._needFireEvents=!1}update(){if(!this._configs.pointerEnabled)return;if(!this.schedulePickEntity&&!this.schedulePickSurface)return;this.picked=!1,this.pickedSurface=!1,this._needFireEvents=!1;const t=this._cameraControl.hasSubs("hoverSurface");if(this.schedulePickSurface&&this.pickResult&&this.pickResult.worldPos){const e=this.pickResult.canvasPos;if(e[0]===this.pickCursorPos[0]&&e[1]===this.pickCursorPos[1])return this.picked=!0,this.pickedSurface=!0,this._needFireEvents=t,this.schedulePickEntity=!1,void(this.schedulePickSurface=!1)}if(this.schedulePickEntity&&this.pickResult){const t=this.pickResult.canvasPos;if(t[0]===this.pickCursorPos[0]&&t[1]===this.pickCursorPos[1])return this.picked=!0,this.pickedSurface=!1,this._needFireEvents=!1,this.schedulePickEntity=!1,void(this.schedulePickSurface=!1)}this.schedulePickSurface?(this.pickResult=this._scene.pick({pickSurface:!0,pickSurfaceNormal:!1,canvasPos:this.pickCursorPos}),this.pickResult&&(this.picked=!0,this.pickedSurface=!0,this._needFireEvents=!0)):(this.pickResult=this._scene.pick({canvasPos:this.pickCursorPos}),this.pickResult&&(this.picked=!0,this.pickedSurface=!1,this._needFireEvents=!0)),this.schedulePickEntity=!1,this.schedulePickSurface=!1}fireEvents(){if(this._needFireEvents){if(this.picked&&this.pickResult&&this.pickResult.entity){const t=this.pickResult.entity.id;this._lastPickedEntityId!==t&&(this._lastPickedEntityId!==undefined&&this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._cameraControl.fire("hoverEnter",this.pickResult,!0),this._lastPickedEntityId=t),this._cameraControl.fire("hover",this.pickResult,!0),this.pickResult.worldPos&&(this.pickedSurface=!0,this._cameraControl.fire("hoverSurface",this.pickResult,!0))}else this._lastPickedEntityId!==undefined&&(this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=undefined),this._cameraControl.fire("hoverOff",{canvasPos:this.pickCursorPos},!0);this.pickResult=null,this._needFireEvents=!1}}destroy(){}}const De=M.vec2();class Le{constructor(t,e,i,s,r){this._scene=t;const o=e.pickController;let a,n,l,h=0,u=0,c=0,d=0,p=0,f=0,_=!1;const g=M.vec3();let m=!0;const v=this._scene.canvas.canvas,P=[];function b(t=!0){v.style.cursor="move",p=0,f=0,h=s.pointerCanvasPos[0],u=s.pointerCanvasPos[1],c=s.pointerCanvasPos[0],d=s.pointerCanvasPos[1],t&&(o.pickCursorPos=s.pointerCanvasPos,o.schedulePickSurface=!0,o.update(),o.picked&&o.pickedSurface&&o.pickResult&&o.pickResult.worldPos?(_=!0,g.set(o.pickResult.worldPos)):_=!1)}document.addEventListener("keydown",this._documentKeyDownHandler=e=>{if(!i.active||!i.pointerEnabled||!t.input.keyboardEnabled)return;const s=e.keyCode;P[s]=!0}),document.addEventListener("keyup",this._documentKeyUpHandler=e=>{if(!i.active||!i.pointerEnabled||!t.input.keyboardEnabled)return;const s=e.keyCode;P[s]=!1}),v.addEventListener("mousedown",this._mouseDownHandler=e=>{if(i.active&&i.pointerEnabled)switch(e.which){case 1:P[t.input.KEY_SHIFT]||i.planView?(a=!0,b()):(a=!0,b(!1));break;case 2:n=!0,b();break;case 3:l=!0,i.panRightClick&&b()}}),document.addEventListener("mousemove",this._documentMouseMoveHandler=()=>{if(!i.active||!i.pointerEnabled)return;if(!a&&!n&&!l)return;const e=t.canvas.boundary,o=e[2]-e[0],c=e[3]-e[1],d=s.pointerCanvasPos[0],p=s.pointerCanvasPos[1];if(P[t.input.KEY_SHIFT]||i.planView||!i.panRightClick&&n||i.panRightClick&&l){const e=d-h,i=p-u,s=t.camera;if("perspective"===s.projection){const o=Math.abs(_?M.lenVec3(M.subVec3(g,t.camera.eye,[])):t.camera.eyeLookDist)*Math.tan(s.perspective.fov/2*Math.PI/180);r.panDeltaX+=1.5*e*o/c,r.panDeltaY+=1.5*i*o/c}else r.panDeltaX+=.5*s.ortho.scale*(e/c),r.panDeltaY+=.5*s.ortho.scale*(i/c)}else!a||n||l||i.planView||(i.firstPerson?(r.rotateDeltaY-=(d-h)/o*i.dragRotationRate/2,r.rotateDeltaX+=(p-u)/c*(i.dragRotationRate/4)):(r.rotateDeltaY-=(d-h)/o*(1.5*i.dragRotationRate),r.rotateDeltaX+=(p-u)/c*(1.5*i.dragRotationRate)));h=d,u=p}),v.addEventListener("mousemove",this._canvasMouseMoveHandler=t=>{i.active&&i.pointerEnabled&&s.mouseover&&(m=!0)}),document.addEventListener("mouseup",this._documentMouseUpHandler=t=>{if(i.active&&i.pointerEnabled){switch(t.which){case 1:case 2:case 3:a=!1,n=!1,l=!1}p=0,f=0}}),v.addEventListener("mouseup",this._mouseUpHandler=t=>{if(i.active&&i.pointerEnabled){if(3===t.which){!function(t,e){if(t){let i=t.target,s=0,r=0;for(;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;e[0]=t.pageX-s,e[1]=t.pageY-r}else t=window.event,e[0]=t.x,e[1]=t.y}(t,De);const i=De[0],s=De[1];Math.abs(i-c)<3&&Math.abs(s-d)<3&&e.cameraControl.fire("rightClick",{canvasPos:De,event:t},!0)}v.style.removeProperty("cursor")}}),v.addEventListener("mouseenter",this._mouseEnterHandler=()=>{i.active&&i.pointerEnabled&&(p=0,f=0)});const y=1/60;let x=null;v.addEventListener("wheel",this._mouseWheelHandler=t=>{if(!i.active||!i.pointerEnabled)return;const e=performance.now()/1e3;var o=null!==x?e-x:0;x=e,o>.05&&(o=.05),o<y&&(o=y);const a=Math.max(-1,Math.min(1,40*-t.deltaY));if(0===a)return;const n=a/Math.abs(a);r.dollyDelta+=-n*o*i.mouseWheelDollyRate,m&&(s.followPointerDirty=!0,m=!1),t.preventDefault()})}reset(){}destroy(){const t=this._scene.canvas.canvas;document.removeEventListener("keydown",this._documentKeyDownHandler),document.removeEventListener("keyup",this._documentKeyUpHandler),t.removeEventListener("mousedown",this._mouseDownHandler),document.removeEventListener("mousemove",this._documentMouseMoveHandler),t.removeEventListener("mousemove",this._canvasMouseMoveHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),t.removeEventListener("mouseup",this._mouseUpHandler),t.removeEventListener("mouseenter",this._mouseEnterHandler),t.removeEventListener("wheel",this._mouseWheelHandler)}}const Re=M.vec3(),Be=M.vec3(),Te=M.vec3(),Fe=M.vec3(),Ne=M.vec3(),Oe={eye:M.vec3(),look:M.vec3(),up:M.vec3()};class ke{constructor(t,e,i,s,r){this._scene=t;const o=e.cameraControl,a=t.camera;t.input.on("keydown",this._documentKeyDownHandler=r=>{if(!i.active||!i.pointerEnabled||!t.input.keyboardEnabled)return;if(!s.mouseover)return;const n=o._isKeyDownForAction(o.AXIS_VIEW_RIGHT),l=o._isKeyDownForAction(o.AXIS_VIEW_BACK),h=o._isKeyDownForAction(o.AXIS_VIEW_LEFT),u=o._isKeyDownForAction(o.AXIS_VIEW_FRONT),c=o._isKeyDownForAction(o.AXIS_VIEW_TOP),d=o._isKeyDownForAction(o.AXIS_VIEW_BOTTOM);if(!(n||l||h||u||c||d))return;const p=t.aabb,f=M.getAABB3Diag(p);M.getAABB3Center(p,Re);const _=Math.abs(f/Math.tan(e.cameraFlight.fitFOV*M.DEGTORAD)),g=1.1*f;Oe.orthoScale=g,n?(Oe.eye.set(M.addVec3(Re,M.mulVec3Scalar(a.worldRight,_,Be),Ne)),Oe.look.set(Re),Oe.up.set(a.worldUp)):l?(Oe.eye.set(M.addVec3(Re,M.mulVec3Scalar(a.worldForward,_,Be),Ne)),Oe.look.set(Re),Oe.up.set(a.worldUp)):h?(Oe.eye.set(M.addVec3(Re,M.mulVec3Scalar(a.worldRight,-_,Be),Ne)),Oe.look.set(Re),Oe.up.set(a.worldUp)):u?(Oe.eye.set(M.addVec3(Re,M.mulVec3Scalar(a.worldForward,-_,Be),Ne)),Oe.look.set(Re),Oe.up.set(a.worldUp)):c?(Oe.eye.set(M.addVec3(Re,M.mulVec3Scalar(a.worldUp,_,Be),Ne)),Oe.look.set(Re),Oe.up.set(M.normalizeVec3(M.mulVec3Scalar(a.worldForward,1,Te),Fe))):d&&(Oe.eye.set(M.addVec3(Re,M.mulVec3Scalar(a.worldUp,-_,Be),Ne)),Oe.look.set(Re),Oe.up.set(M.normalizeVec3(M.mulVec3Scalar(a.worldForward,-1,Te)))),!i.firstPerson&&i.followPointer&&e.pivotController.setPivotPos(Re),e.cameraFlight.duration>0?e.cameraFlight.flyTo(Oe,(()=>{e.pivotController.getPivoting()&&i.followPointer&&e.pivotController.showPivot()})):(e.cameraFlight.jumpTo(Oe),e.pivotController.getPivoting()&&i.followPointer&&e.pivotController.showPivot())})}reset(){}destroy(){document.removeEventListener("keydown",this._documentKeyDownHandler)}}class Ie{constructor(t,e,i,s,r){this._scene=t;const o=e.pickController,a=e.pivotController,n=e.cameraControl;this._clicks=0,this._timeout=null,this._lastPickedEntityId=null;let l=!1,h=!1;const u=this._scene.canvas.canvas,c=i=>{let s;i&&i.worldPos&&(s=i.worldPos);const r=i&&i.entity?i.entity.aabb:t.aabb;if(s){const i=t.camera;M.subVec3(i.eye,i.look,[]);e.cameraFlight.flyTo({aabb:r})}else e.cameraFlight.flyTo({aabb:r})};u.addEventListener("mousemove",this._canvasMouseMoveHandler=e=>{if(!i.active||!i.pointerEnabled)return;if(l||h)return;const r=n.hasSubs("hover"),a=n.hasSubs("hoverOut"),u=n.hasSubs("hoverOff"),c=n.hasSubs("hoverSurface");if(r||a||u||c)if(o.pickCursorPos=s.pointerCanvasPos,o.schedulePickEntity=!0,o.schedulePickSurface=c,o.update(),o.pickResult){const e=o.pickResult.entity.id;this._lastPickedEntityId!==e&&(this._lastPickedEntityId!==undefined&&n.fire("hoverOut",{entity:t.objects[this._lastPickedEntityId]},!0),n.fire("hoverEnter",o.pickResult,!0),this._lastPickedEntityId=e),n.fire("hover",o.pickResult,!0),o.pickResult.worldPos&&n.fire("hoverSurface",o.pickResult,!0)}else this._lastPickedEntityId!==undefined&&(n.fire("hoverOut",{entity:t.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=undefined),n.fire("hoverOff",{canvasPos:o.pickCursorPos},!0)}),u.addEventListener("mousedown",this._canvasMouseDownHandler=e=>{1===e.which&&(l=!0),3===e.which&&(h=!0);if(1===e.which&&i.active&&i.pointerEnabled&&(s.mouseDownClientX=e.clientX,s.mouseDownClientY=e.clientY,s.mouseDownCursorX=s.pointerCanvasPos[0],s.mouseDownCursorY=s.pointerCanvasPos[1],!i.firstPerson&&i.followPointer&&(o.pickCursorPos=s.pointerCanvasPos,o.schedulePickSurface=!0,o.update(),1===e.which))){const e=o.pickResult;e&&e.worldPos?(a.setPivotPos(e.worldPos),a.startPivot()):(i.smartPivot?a.setCanvasPivotPos(s.pointerCanvasPos):a.setPivotPos(t.camera.look),a.startPivot())}}),document.addEventListener("mouseup",this._documentMouseUpHandler=t=>{1===t.which&&(l=!1),3===t.which&&(h=!1)}),u.addEventListener("mouseup",this._canvasMouseUpHandler=r=>{if(!i.active||!i.pointerEnabled)return;if(!(1===r.which))return;if(a.hidePivot(),Math.abs(r.clientX-s.mouseDownClientX)>3||Math.abs(r.clientY-s.mouseDownClientY)>3)return;const l=n.hasSubs("picked"),h=n.hasSubs("pickedNothing"),u=n.hasSubs("pickedSurface"),d=n.hasSubs("doublePicked"),p=n.hasSubs("doublePickedSurface"),f=n.hasSubs("doublePickedNothing");if(!(i.doublePickFlyTo||d||p||f))return(l||h||u)&&(o.pickCursorPos=s.pointerCanvasPos,o.schedulePickEntity=!0,o.schedulePickSurface=u,o.update(),o.pickResult?(n.fire("picked",o.pickResult,!0),o.pickedSurface&&n.fire("pickedSurface",o.pickResult,!0)):n.fire("pickedNothing",{canvasPos:s.pointerCanvasPos},!0)),void(this._clicks=0);if(this._clicks++,1===this._clicks)this._timeout=setTimeout((()=>{o.pickCursorPos=s.pointerCanvasPos,o.schedulePickEntity=i.doublePickFlyTo,o.schedulePickSurface=u,o.update(),o.pickResult?(n.fire("picked",o.pickResult,!0),o.pickedSurface&&(n.fire("pickedSurface",o.pickResult,!0),!i.firstPerson&&i.followPointer&&(e.pivotController.setPivotPos(o.pickResult.worldPos),e.pivotController.startPivot()&&e.pivotController.showPivot()))):n.fire("pickedNothing",{canvasPos:s.pointerCanvasPos},!0),this._clicks=0}),250);else{if(null!==this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null),o.pickCursorPos=s.pointerCanvasPos,o.schedulePickEntity=i.doublePickFlyTo||d||p,o.schedulePickSurface=o.schedulePickEntity&&p,o.update(),o.pickResult){if(n.fire("doublePicked",o.pickResult,!0),o.pickedSurface&&n.fire("doublePickedSurface",o.pickResult,!0),i.doublePickFlyTo&&(c(o.pickResult),!i.firstPerson&&i.followPointer)){const t=o.pickResult.entity.aabb,i=M.getAABB3Center(t);e.pivotController.setPivotPos(i),e.pivotController.startPivot()&&e.pivotController.showPivot()}}else if(n.fire("doublePickedNothing",{canvasPos:s.pointerCanvasPos},!0),i.doublePickFlyTo&&(c(),!i.firstPerson&&i.followPointer)){const i=t.aabb,s=M.getAABB3Center(i);e.pivotController.setPivotPos(s),e.pivotController.startPivot()&&e.pivotController.showPivot()}this._clicks=0}},!1)}reset(){this._clicks=0,this._lastPickedEntityId=null,this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}destroy(){const t=this._scene.canvas.canvas;t.removeEventListener("mousemove",this._canvasMouseMoveHandler),t.removeEventListener("mousedown",this._canvasMouseDownHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),t.removeEventListener("mouseup",this._canvasMouseUpHandler),this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}}class ze{constructor(t,e,i,s,r){this._scene=t;const o=t.input,a=[],n=t.canvas.canvas;e.pickController;let l=!0;document.addEventListener("mousemove",this._documentMouseMoveHandler=()=>{l=!0}),document.addEventListener("keydown",this._documentKeyDownHandler=e=>{if(!i.active||!i.pointerEnabled||!t.input.keyboardEnabled)return;if(!s.mouseover)return;const r=e.keyCode;a[r]=!0,r===o.KEY_SHIFT&&(n.style.cursor="move")}),document.addEventListener("keyup",this._documentKeyUpHandler=e=>{if(!i.active||!i.pointerEnabled||!t.input.keyboardEnabled)return;if(!s.mouseover)return;const r=e.keyCode;a[r]=!1,r===o.KEY_SHIFT&&(n.style.cursor=null)}),this._onTick=t.on("tick",(n=>{if(!i.active||!i.pointerEnabled||!t.input.keyboardEnabled)return;if(!s.mouseover)return;const h=e.cameraControl,u=n.deltaTime/1e3;if(!i.planView){const t=h._isKeyDownForAction(h.ROTATE_Y_POS,a),s=h._isKeyDownForAction(h.ROTATE_Y_NEG,a),o=h._isKeyDownForAction(h.ROTATE_X_POS,a),n=h._isKeyDownForAction(h.ROTATE_X_NEG,a),l=u*i.keyboardRotationRate;(t||s||o||n)&&(!i.firstPerson&&i.followPointer&&e.pivotController.startPivot(),t?r.rotateDeltaY+=l:s&&(r.rotateDeltaY-=l),o?r.rotateDeltaX+=l:n&&(r.rotateDeltaX-=l),!i.firstPerson&&i.followPointer&&e.pivotController.startPivot())}if(!a[o.KEY_CTRL]&&!a[o.KEY_ALT]){const t=h._isKeyDownForAction(h.DOLLY_BACKWARDS,a),o=h._isKeyDownForAction(h.DOLLY_FORWARDS,a);if(t||o){const a=u*i.keyboardDollyRate;!i.firstPerson&&i.followPointer&&e.pivotController.startPivot(),o?r.dollyDelta-=a:t&&(r.dollyDelta+=a),l&&(s.followPointerDirty=!0,l=!1)}}const c=h._isKeyDownForAction(h.PAN_FORWARDS,a),d=h._isKeyDownForAction(h.PAN_BACKWARDS,a),p=h._isKeyDownForAction(h.PAN_LEFT,a),f=h._isKeyDownForAction(h.PAN_RIGHT,a),_=h._isKeyDownForAction(h.PAN_UP,a),g=h._isKeyDownForAction(h.PAN_DOWN,a),m=(a[o.KEY_ALT]?.3:1)*u*i.keyboardPanRate;(c||d||p||f||_||g)&&(!i.firstPerson&&i.followPointer&&e.pivotController.startPivot(),g?r.panDeltaY+=m:_&&(r.panDeltaY+=-m),f?r.panDeltaX+=-m:p&&(r.panDeltaX+=m),d?r.panDeltaZ+=m:c&&(r.panDeltaZ+=-m))}))}reset(){}destroy(){this._scene.off(this._onTick),document.removeEventListener("mousemove",this._documentMouseMoveHandler),document.removeEventListener("keydown",this._documentKeyDownHandler),document.removeEventListener("keyup",this._documentKeyUpHandler)}}const Ve=.001,Ue=M.vec3();class Ge{constructor(t,e,i,s,r){this._scene=t;const o=t.camera,a=e.pickController,n=e.pivotController,l=e.panController;let h=1,u=1,c=null;this._onTick=t.on("tick",(()=>{if(!i.active||!i.pointerEnabled)return;let e="default";if(Math.abs(r.dollyDelta)<Ve&&(r.dollyDelta=0),Math.abs(r.rotateDeltaX)<Ve&&(r.rotateDeltaX=0),Math.abs(r.rotateDeltaY)<Ve&&(r.rotateDeltaY=0),0===r.rotateDeltaX&&0===r.rotateDeltaY||(r.dollyDelta=0),i.followPointer&&--h<=0&&(h=1,0!==r.dollyDelta)){if(0===r.rotateDeltaY&&0===r.rotateDeltaX&&i.followPointer&&s.followPointerDirty&&(a.pickCursorPos=s.pointerCanvasPos,a.schedulePickSurface=!0,a.update(),a.pickResult&&a.pickResult.worldPos?c=a.pickResult.worldPos:(u=1,c=null),s.followPointerDirty=!1),c){const e=Math.abs(M.lenVec3(M.subVec3(c,t.camera.eye,Ue)));u=e/i.dollyProximityThreshold}u<i.dollyMinSpeed&&(u=i.dollyMinSpeed)}const d=r.dollyDelta*u;if(0===r.rotateDeltaY&&0===r.rotateDeltaX||(!i.firstPerson&&i.followPointer&&n.getPivoting()?(n.continuePivot(r.rotateDeltaY,r.rotateDeltaX),n.showPivot()):(0!==r.rotateDeltaX&&(i.firstPerson?o.pitch(-r.rotateDeltaX):o.orbitPitch(r.rotateDeltaX)),0!==r.rotateDeltaY&&(i.firstPerson?o.yaw(r.rotateDeltaY):o.orbitYaw(r.rotateDeltaY))),r.rotateDeltaX*=i.rotationInertia,r.rotateDeltaY*=i.rotationInertia,e="grabbing"),Math.abs(r.panDeltaX)<Ve&&(r.panDeltaX=0),Math.abs(r.panDeltaY)<Ve&&(r.panDeltaY=0),Math.abs(r.panDeltaZ)<Ve&&(r.panDeltaZ=0),0!==r.panDeltaX||0!==r.panDeltaY||0!==r.panDeltaZ){const t=M.vec3();let s,a;if(t[0]=r.panDeltaX,t[1]=r.panDeltaY,t[2]=r.panDeltaZ,i.constrainVertical){o.xUp?(s=o.eye[0],a=o.look[0]):o.yUp?(s=o.eye[1],a=o.look[1]):o.zUp&&(s=o.eye[2],a=o.look[2]),o.pan(t);const e=o.eye,i=o.look;o.xUp?(e[0]=s,i[0]=a):o.yUp?(e[1]=s,i[1]=a):o.zUp&&(e[2]=s,i[2]=a),o.eye=e,o.look=i}else o.pan(t);e="grabbing"}if(r.panDeltaX*=i.panInertia,r.panDeltaY*=i.panInertia,r.panDeltaZ*=i.panInertia,0!==d){if(e=d<0?"zoom-in":"zoom-out",i.firstPerson){let t,e;if(i.constrainVertical&&(o.xUp?(t=o.eye[0],e=o.look[0]):o.yUp?(t=o.eye[1],e=o.look[1]):o.zUp&&(t=o.eye[2],e=o.look[2])),i.followPointer){l.dollyToCanvasPos(c,s.pointerCanvasPos,-d)&&(s.followPointerDirty=!0)}else o.pan([0,0,d]),o.ortho.scale=o.ortho.scale-d;if(i.constrainVertical){const i=o.eye,s=o.look;o.xUp?(i[0]=t,s[0]=e):o.yUp?(i[1]=t,s[1]=e):o.zUp&&(i[2]=t,s[2]=e),o.eye=i,o.look=s}}else if(i.planView)if(i.followPointer){l.dollyToCanvasPos(c,s.pointerCanvasPos,-d)&&(s.followPointerDirty=!0)}else o.ortho.scale=o.ortho.scale+d,o.zoom(d);else if(i.followPointer){l.dollyToCanvasPos(c,s.pointerCanvasPos,-d)&&(s.followPointerDirty=!0)}else o.ortho.scale=o.ortho.scale+d,o.zoom(d);r.dollyDelta*=i.dollyInertia}a.fireEvents(),document.body.style.cursor=e}))}destroy(){this._scene.off(this._onTick)}}class Xe{constructor(t,e,i,s,r){this._scene=t;const o=this._scene.canvas.canvas;o.addEventListener("mouseenter",this._mouseEnterHandler=()=>{s.mouseover=!0}),o.addEventListener("mouseleave",this._mouseLeaveHandler=()=>{s.mouseover=!1,o.style.cursor=null}),document.addEventListener("mousemove",this._mouseMoveHandler=t=>{je(t,o,s.pointerCanvasPos)}),o.addEventListener("mousedown",this._mouseDownHandler=t=>{i.active&&i.pointerEnabled&&(je(t,o,s.pointerCanvasPos),s.mouseover=!0)}),o.addEventListener("mouseup",this._mouseUpHandler=t=>{i.active&&i.pointerEnabled})}reset(){}destroy(){const t=this._scene.canvas.canvas;document.removeEventListener("mousemove",this._mouseMoveHandler),t.removeEventListener("mouseenter",this._mouseEnterHandler),t.removeEventListener("mouseleave",this._mouseLeaveHandler),t.removeEventListener("mousedown",this._mouseDownHandler),t.removeEventListener("mouseup",this._mouseUpHandler)}}function je(t,e,i){if(t){const{x:s,y:r}=e.getBoundingClientRect();i[0]=t.clientX-s,i[1]=t.clientY-r}else t=window.event,i[0]=t.x,i[1]=t.y;return i}const We=function(t,e){if(t){let i=t.target,s=0,r=0;for(;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;e[0]=t.pageX-s,e[1]=t.pageY-r}else t=window.event,e[0]=t.x,e[1]=t.y;return e};class He{constructor(t,e,i,s,r){this._scene=t;const o=e.pickController,a=e.pivotController,n=M.vec2(),l=M.vec2(),h=M.vec2(),u=M.vec2(),c=[],d=this._scene.canvas.canvas;let p=0,f=-1,_=!1;this._onTick=t.on("tick",(()=>{_=!1})),d.addEventListener("touchstart",this._canvasTouchStartHandler=e=>{if(!i.active||!i.pointerEnabled)return;e.stopPropagation(),e.preventDefault();const r=e.touches,l=e.changedTouches;for(s.touchStartTime=Date.now(),1===r.length&&1===l.length?(f=s.touchStartTime,We(r[0],n),i.followPointer&&(o.pickCursorPos=n,o.schedulePickSurface=!0,o.update(),i.planView||(o.picked&&o.pickedSurface&&o.pickResult&&o.pickResult.worldPos?(a.setPivotPos(o.pickResult.worldPos),!i.firstPerson&&a.startPivot()&&a.showPivot()):(i.smartPivot?a.setCanvasPivotPos(s.pointerCanvasPos):a.setPivotPos(t.camera.look),!i.firstPerson&&a.startPivot()&&a.showPivot())))):f=-1;c.length<r.length;)c.push(M.vec2());for(let t=0,e=r.length;t<e;++t)We(r[t],c[t]);p=r.length}),d.addEventListener("touchmove",this._canvasTouchMoveHandler=e=>{if(!i.active||!i.pointerEnabled)return;if(e.stopPropagation(),e.preventDefault(),_)return;_=!0;const a=t.canvas.boundary,n=a[2]-a[0],d=a[3]-a[1],f=e.touches;if(e.touches.length===p){if(1===p){We(f[0],l),M.subVec2(l,c[0],u);const e=u[0],s=u[1];if(i.planView){const o=t.camera;if("perspective"===o.projection){const a=!1,n=[0,0,0],l=Math.abs(a?M.lenVec3(M.subVec3(n,t.camera.eye,[])):t.camera.eyeLookDist)*Math.tan(o.perspective.fov/2*Math.PI/180);r.panDeltaX+=e*l/d*i.touchPanRate,r.panDeltaY+=s*l/d*i.touchPanRate}else r.panDeltaX+=.5*o.ortho.scale*(e/d)*i.touchPanRate,r.panDeltaY+=.5*o.ortho.scale*(s/d)*i.touchPanRate}else r.rotateDeltaY-=e/n*(1*i.dragRotationRate),r.rotateDeltaX+=s/d*(1.5*i.dragRotationRate)}else if(2===p){const e=f[0],a=f[1];We(e,l),We(a,h);const n=M.geometricMeanVec2(c[0],c[1]),u=M.geometricMeanVec2(l,h),p=M.vec2();M.subVec2(n,u,p);const _=p[0],g=p[1],m=t.camera,v=M.distVec2([e.pageX,e.pageY],[a.pageX,a.pageY]),P=(M.distVec2(c[0],c[1])-v)*i.touchDollyRate;if(r.dollyDelta=P,Math.abs(P)<1)if("perspective"===m.projection){const e=o.pickResult?o.pickResult.worldPos:t.center,s=Math.abs(M.lenVec3(M.subVec3(e,t.camera.eye,[])))*Math.tan(m.perspective.fov/2*Math.PI/180);r.panDeltaX-=_*s/d*i.touchPanRate,r.panDeltaY-=g*s/d*i.touchPanRate}else r.panDeltaX-=.5*m.ortho.scale*(_/d)*i.touchPanRate,r.panDeltaY-=.5*m.ortho.scale*(g/d)*i.touchPanRate;s.pointerCanvasPos=u}for(let t=0;t<p;++t)We(f[t],c[t])}})}reset(){}destroy(){const t=this._scene.canvas.canvas;t.removeEventListener("touchstart",this._canvasTouchStartHandler),t.removeEventListener("touchmove",this._canvasTouchMoveHandler),this._scene.off(this._onTick)}}class Ye{constructor(t,e,i,s,r){this._scene=t;const o=e.pickController,a=(e.pivotController,e.cameraControl);let n;const l=[],h=new Float32Array(2);let u=-1,c=-1;const d=this._scene.canvas.canvas,p=i=>{let s;i&&i.worldPos&&(s=i.worldPos);const r=i?i.entity.aabb:t.aabb;if(s){const i=t.camera;M.subVec3(i.eye,i.look,[]);e.cameraFlight.flyTo({aabb:r})}else e.cameraFlight.flyTo({aabb:r})};d.addEventListener("touchstart",this._canvasTouchStartHandler=t=>{if(!i.active||!i.pointerEnabled)return;const e=t.touches,s=t.changedTouches;for(n=Date.now(),1===e.length&&1===s.length?(u=n,h[0]=e[0].pageX,h[1]=e[0].pageY):u=-1;l.length<e.length;)l.push(new Float32Array(2));for(let t=0,i=e.length;t<i;++t)l[t][0]=e[t].pageX,l[t][1]=e[t].pageY;l.length=e.length,t.stopPropagation()},{passive:!0}),d.addEventListener("touchend",this._canvasTouchEndHandler=t=>{if(!i.active||!i.pointerEnabled)return;const e=Date.now(),s=t.touches,r=t.changedTouches,n=(a.hasSubs("picked"),a.hasSubs("pickedNothing"),a.hasSubs("pickedSurface"));a.hasSubs("doublePicked"),a.hasSubs("doublePickedSurface"),a.hasSubs("doublePickedNothing");0===s.length&&1===r.length&&u>-1&&e-u<150&&(c>-1&&u-c<325?(o.pickCursorPos[0]=Math.round(r[0].clientX),o.pickCursorPos[1]=Math.round(r[0].clientY),o.schedulePickEntity=!0,o.schedulePickSurface=n,o.update(),o.pickResult?(a.fire("doublePicked",o.pickResult),o.pickedSurface&&a.fire("doublePickedSurface",o.pickResult),i.doublePickFlyTo&&p(o.pickResult)):(a.fire("doublePickedNothing"),i.doublePickFlyTo&&p()),c=-1):M.distVec2(l[0],h)<4&&(o.pickCursorPos[0]=Math.round(r[0].clientX),o.pickCursorPos[1]=Math.round(r[0].clientY),o.schedulePickEntity=!0,o.schedulePickSurface=n,o.update(),o.pickResult?(a.fire("picked",o.pickResult),o.pickedSurface&&a.fire("pickedSurface",o.pickResult)):a.fire("pickedNothing"),c=e),u=-1),l.length=s.length;for(let t=0,e=s.length;t<e;++t)l[t][0]=s[t].pageX,l[t][1]=s[t].pageY;t.stopPropagation()},{passive:!0})}reset(){}destroy(){const t=this._scene.canvas.canvas;t.removeEventListener("touchstart",this._canvasTouchStartHandler),t.removeEventListener("touchend",this._canvasTouchEndHandler)}}class Ke extends w{constructor(t,e={}){super(t,e),this.PAN_LEFT=0,this.PAN_RIGHT=1,this.PAN_UP=2,this.PAN_DOWN=3,this.PAN_FORWARDS=4,this.PAN_BACKWARDS=5,this.ROTATE_X_POS=6,this.ROTATE_X_NEG=7,this.ROTATE_Y_POS=8,this.ROTATE_Y_NEG=9,this.DOLLY_FORWARDS=10,this.DOLLY_BACKWARDS=11,this.AXIS_VIEW_RIGHT=12,this.AXIS_VIEW_BACK=13,this.AXIS_VIEW_LEFT=14,this.AXIS_VIEW_FRONT=15,this.AXIS_VIEW_TOP=16,this.AXIS_VIEW_BOTTOM=17,this._keyMap={},this.scene.canvas.canvas.oncontextmenu=t=>{t.preventDefault()},this._configs={tapInterval:150,doubleTapInterval:325,tapDistanceThreshold:4,active:!0,keyboardLayout:"qwerty",navMode:"orbit",planView:!1,firstPerson:!1,followPointer:!0,doublePickFlyTo:!0,panRightClick:!0,showPivot:!1,pointerEnabled:!0,constrainVertical:!1,smartPivot:!1,dragRotationRate:360,keyboardRotationRate:90,rotationInertia:0,keyboardPanRate:1,touchPanRate:1,panInertia:.5,keyboardDollyRate:10,mouseWheelDollyRate:100,touchDollyRate:.2,dollyInertia:0,dollyProximityThreshold:30,dollyMinSpeed:.04},this._states={pointerCanvasPos:M.vec2(),mouseover:!1,followPointerDirty:!0,mouseDownClientX:0,mouseDownClientY:0,mouseDownCursorX:0,mouseDownCursorY:0,touchStartTime:null,activeTouches:[],tapStartPos:M.vec2(),tapStartTime:-1,lastTapTime:-1},this._updates={rotateDeltaX:0,rotateDeltaY:0,panDeltaX:0,panDeltaY:0,panDeltaZ:0,dollyDelta:0};const i=this.scene;this._controllers={cameraControl:this,pickController:new Se(this,this._configs),pivotController:new Ae(i,this._configs),panController:new be(i),cameraFlight:new ce(this,{duration:.5})},this._handlers=[new Xe(this.scene,this._controllers,this._configs,this._states,this._updates),new He(this.scene,this._controllers,this._configs,this._states,this._updates),new Le(this.scene,this._controllers,this._configs,this._states,this._updates),new ke(this.scene,this._controllers,this._configs,this._states,this._updates),new Ie(this.scene,this._controllers,this._configs,this._states,this._updates),new Ye(this.scene,this._controllers,this._configs,this._states,this._updates),new ze(this.scene,this._controllers,this._configs,this._states,this._updates)],this._cameraUpdater=new Ge(this.scene,this._controllers,this._configs,this._states,this._updates),this.navMode=e.navMode,e.planView&&(this.planView=e.planView),this.constrainVertical=e.constrainVertical,e.keyboardLayout?this.keyboardLayout=e.keyboardLayout:this.keyMap=e.keyMap,this.doublePickFlyTo=e.doublePickFlyTo,this.panRightClick=e.panRightClick,this.active=e.active,this.followPointer=e.followPointer,this.rotationInertia=e.rotationInertia,this.keyboardPanRate=e.keyboardPanRate,this.touchPanRate=e.touchPanRate,this.keyboardRotationRate=e.keyboardRotationRate,this.dragRotationRate=e.dragRotationRate,this.touchDollyRate=e.touchDollyRate,this.dollyInertia=e.dollyInertia,this.dollyProximityThreshold=e.dollyProximityThreshold,this.dollyMinSpeed=e.dollyMinSpeed,this.panInertia=e.panInertia,this.pointerEnabled=!0,this.keyboardDollyRate=e.keyboardDollyRate,this.mouseWheelDollyRate=e.mouseWheelDollyRate}set keyMap(t){if(t=t||"qwerty",n.isString(t)){const e=this.scene.input,i={};switch(t){default:this.error("Unsupported value for 'keyMap': "+t+" defaulting to 'qwerty'");case"qwerty":i[this.PAN_LEFT]=[e.KEY_A],i[this.PAN_RIGHT]=[e.KEY_D],i[this.PAN_UP]=[e.KEY_Z],i[this.PAN_DOWN]=[e.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[e.KEY_W,e.KEY_ADD],i[this.DOLLY_BACKWARDS]=[e.KEY_S,e.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[e.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[e.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[e.KEY_Q,e.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[e.KEY_E,e.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[e.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[e.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[e.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[e.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[e.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[e.KEY_NUM_6];break;case"azerty":i[this.PAN_LEFT]=[e.KEY_Q],i[this.PAN_RIGHT]=[e.KEY_D],i[this.PAN_UP]=[e.KEY_W],i[this.PAN_DOWN]=[e.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[e.KEY_Z,e.KEY_ADD],i[this.DOLLY_BACKWARDS]=[e.KEY_S,e.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[e.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[e.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[e.KEY_A,e.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[e.KEY_E,e.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[e.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[e.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[e.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[e.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[e.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[e.KEY_NUM_6]}this._keyMap=i}else{const e=t;this._keyMap=e}}get keyMap(){return this._keyMap}_isKeyDownForAction(t,e){const i=this._keyMap[t];if(!i)return!1;e||(e=this.scene.input.keyDown);for(let t=0,s=i.length;t<s;t++){if(e[i[t]])return!0}return!1}set pivotElement(t){this._controllers.pivotController.setPivotElement(t)}set active(t){this._configs.active=!1!==t}get active(){return this._configs.active}set navMode(t){"firstPerson"!==(t=t||"orbit")&&"orbit"!==t&&"planView"!==t&&(this.error("Unsupported value for navMode: "+t+" - supported values are 'orbit', 'firstPerson' and 'planView' - defaulting to 'orbit'"),t="orbit"),this._configs.firstPerson="firstPerson"===t,this._configs.planView="planView"===t,(this._configs.firstPerson||this._configs.planView)&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this._configs.navMode=t}get navMode(){return this._configs.navMode}set pointerEnabled(t){this._reset(),this._configs.pointerEnabled=!!t}_reset(){for(let t=0,e=this._handlers.length;t<e;t++){const e=this._handlers[t];e.reset&&e.reset()}this._updates.panDeltaX=0,this._updates.panDeltaY=0,this._updates.rotateDeltaX=0,this._updates.rotateDeltaY=0,this._updates.dolyDelta=0}get pointerEnabled(){return this._configs.pointerEnabled}set followPointer(t){this._configs.followPointer=!1!==t}get followPointer(){return this._configs.followPointer}set pivotPos(t){this._controllers.pivotController.setPivotPos(t)}get pivotPos(){return this._controllers.pivotController.getPivotPos()}set dollyToPointer(t){this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer=t}get dollyToPointer(){return this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer}set panToPointer(t){this.warn("panToPointer property is deprecated - replaced with followPointer")}get panToPointer(){return this.warn("panToPointer property is deprecated - replaced with followPointer"),!1}set planView(t){this._configs.planView=!!t,this._configs.firstPerson=!1,this._configs.planView&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this.warn("planView property is deprecated - replaced with navMode")}get planView(){return this.warn("planView property is deprecated - replaced with navMode"),this._configs.planView}set firstPerson(t){this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson=!!t,this._configs.planView=!1,this._configs.firstPerson&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot())}get firstPerson(){return this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson}set constrainVertical(t){this._configs.constrainVertical=!!t}get constrainVertical(){return this._configs.constrainVertical}set doublePickFlyTo(t){this._configs.doublePickFlyTo=!1!==t}get doublePickFlyTo(){return this._configs.doublePickFlyTo}set panRightClick(t){this._configs.panRightClick=!1!==t}get panRightClick(){return this._configs.panRightClick}set rotationInertia(t){this._configs.rotationInertia=t!==undefined&&null!==t?t:0}get rotationInertia(){return this._configs.rotationInertia}set keyboardPanRate(t){this._configs.keyboardPanRate=null!==t&&t!==undefined?t:5}set touchPanRate(t){this._configs.touchPanRate=null!==t&&t!==undefined?t:1}get touchPanRate(){return this._configs.touchPanRate}get keyboardPanRate(){return this._configs.keyboardPanRate}set keyboardRotationRate(t){this._configs.keyboardRotationRate=null!==t&&t!==undefined?t:90}get keyboardRotationRate(){return this._configs.keyboardRotationRate}set dragRotationRate(t){this._configs.dragRotationRate=null!==t&&t!==undefined?t:360}get dragRotationRate(){return this._configs.dragRotationRate}set keyboardDollyRate(t){this._configs.keyboardDollyRate=null!==t&&t!==undefined?t:15}get keyboardDollyRate(){return this._configs.keyboardDollyRate}set touchDollyRate(t){this._configs.touchDollyRate=null!==t&&t!==undefined?t:.2}get touchDollyRate(){return this._configs.touchDollyRate}set mouseWheelDollyRate(t){this._configs.mouseWheelDollyRate=null!==t&&t!==undefined?t:100}get mouseWheelDollyRate(){return this._configs.mouseWheelDollyRate}set dollyInertia(t){this._configs.dollyInertia=t!==undefined&&null!==t?t:0}get dollyInertia(){return this._configs.dollyInertia}set dollyProximityThreshold(t){this._configs.dollyProximityThreshold=t!==undefined&&null!==t?t:35}get dollyProximityThreshold(){return this._configs.dollyProximityThreshold}set dollyMinSpeed(t){this._configs.dollyMinSpeed=t!==undefined&&null!==t?t:.04}get dollyMinSpeed(){return this._configs.dollyMinSpeed}set panInertia(t){this._configs.panInertia=t!==undefined&&null!==t?t:.5}get panInertia(){return this._configs.panInertia}set keyboardLayout(t){"qwerty"!==(t=t||"qwerty")&&"azerty"!==t&&(this.error("Unsupported value for keyboardLayout - defaulting to 'qwerty'"),t="qwerty"),this._configs.keyboardLayout=t,this.keyMap=this._configs.keyboardLayout}get keyboardLayout(){return this._configs.keyboardLayout}set smartPivot(t){this._configs.smartPivot=!1!==t}get smartPivot(){return this._configs.smartPivot}destroy(){this._destroyHandlers(),this._destroyControllers(),this._cameraUpdater.destroy(),super.destroy()}_destroyHandlers(){for(let t=0,e=this._handlers.length;t<e;t++){const e=this._handlers[t];e.destroy&&e.destroy()}}_destroyControllers(){for(let t=0,e=this._controllers.length;t<e;t++){const e=this._controllers[t];e.destroy&&e.destroy()}}}class $e{constructor(t,e,i,s,r,o,a,n,l){this.id=e,this.projectId=i,this.revisionId=s,this.author=r,this.createdAt=o,this.creatingApplication=a,this.schema=n,this.metaScene=t,this.rootMetaObject=l}getJSON(){var t=[];return function e(i){var s={id:i.id,extId:i.extId,type:i.type,name:i.name};i.parent&&(s.parent=i.parent.id),t.push(s);var r=i.children;if(r)for(var o=0,a=r.length;o<a;o++)e(r[o])}(this.rootMetaObject),{id:this.id,projectId:this.projectId,revisionId:this.revisionId,metaObjects:t}}}class qe{constructor(t,e,i,s,r,o,a,n,l){this.metaModel=t,this.id=e,this.originalSystemId=i,this.name=s,this.type=r,o&&(this.properties=o),a!==undefined&&null!==a&&(this.parent=a),n!==undefined&&null!==n&&(this.children=n),l!==undefined&&null!==l&&(this.external=l)}getObjectIDsInSubtree(){const t=[];return function e(i){if(!i)return;t.push(i.id);const s=i.children;if(s)for(var r=0,o=s.length;r<o;r++)e(s[r])}(this),t}withMetaObjectsInSubtree(t){!function e(i){if(!i)return;t(i);const s=i.children;if(s)for(var r=0,o=s.length;r<o;r++)e(s[r])}(this)}getObjectIDsInSubtreeByType(t){const e={};for(var i=0,s=t.length;i<s;i++)e[t[i]]=t[i];const r=[];return function o(t){if(!t)return;e[t.type]&&r.push(t.id);const i=t.children;if(i)for(var s=0,a=i.length;s<a;s++)o(i[s])}(this),r}getJSON(){var t={id:this.id,type:this.type,name:this.name};return this.parent&&(t.parent=this.parent.id),t}}class Ze{constructor(t,e){this.viewer=t,this.scene=e,this.metaModels={},this.metaObjects={},this.metaObjectsByType={},this._typeCounts={},this._eventSubs={}}on(t,e){let i=this._eventSubs[t];i||(i=[],this._eventSubs[t]=i),i.push(e)}fire(t,e){const i=this._eventSubs[t];if(i)for(let t=0,s=i.length;t<s;t++)i[t](e)}off(t){}createMetaModel(t,e,i={}){const s=e.projectId||"none",r=e.revisionId||"none",o=e.metaObjects,a=e.author,n=e.createdAt,l=e.creatingApplication,h=e.schema;var u;const c=new $e(this,t,s,r,a,n,l,h,null);this.metaModels[t]=c;for(let e=0,s=o.length;e<s;e++){const s=o[e],r=s.type;u;const a=i.globalizeObjectIds?M.globalizeObjectId(t,s.id):s.id,n=s.id,l=s.name,h=s.properties,d=null,p=null,f=s.external,_=new qe(c,a,n,l,r,h,d,p,f);this.metaObjects[a]=_,(this.metaObjectsByType[r]||(this.metaObjectsByType[r]={}))[a]=_,this._typeCounts[r]===undefined?this._typeCounts[r]=1:this._typeCounts[r]++}for(let e=0,s=o.length;e<s;e++){const s=o[e],r=i.globalizeObjectIds?M.globalizeObjectId(t,s.id):s.id,a=this.metaObjects[r];if(a)if(s.parent===undefined||null===s.parent)c.rootMetaObject=a;else if(s.parent){const e=i.globalizeObjectIds?M.globalizeObjectId(t,s.parent):s.parent;let r=this.metaObjects[e];r&&(a.parent=r,r.children=r.children||[],r.children.push(a))}}return this.fire("metaModelCreated",t),c}destroyMetaModel(t){const e=this.metaModels[t];e&&(this._removeMetaModel(e),this.fire("metaModelDestroyed",t))}_removeMetaModel(t){const e=this.metaObjects,i=this.metaObjectsByType;let s=t=>{delete e[t.id];const r=i[t.type];r&&r[t.id]&&(delete r[t.id],0==--this._typeCounts[t.type]&&(delete this._typeCounts[t.type],delete i[t.type]));const o=t.children;if(o)for(let t=0,e=o.length;t<e;t++){const e=o[t];s(e)}};s(t.rootMetaObject),delete this.metaModels[t.id]}getObjectIDsByType(t){const e=this.metaObjectsByType[t];return e?Object.keys(e):[]}getObjectIDsInSubtree(t,e,i){const s=[],r=this.metaObjects[t],o=e&&e.length>0?Qe(e):null,a=i&&i.length>0?Qe(i):null;return function n(t){if(!t)return;var e=!0;(a&&a[t.type]||o&&!o[t.type])&&(e=!1),e&&s.push(t.id);const i=t.children;if(i)for(var r=0,l=i.length;r<l;r++)n(i[r])}(r),s}withMetaObjectsInSubtree(t,e){const i=this.metaObjects[t];i&&i.withMetaObjectsInSubtree(e)}}function Qe(t){const e={};for(var i=0,s=t.length;i<s;i++)e[t[i]]=!0;return e}class Je{constructor(t){this.language="en",this.scene=new oe(this,{canvasId:t.canvasId,canvasElement:t.canvasElement,webgl2:!1,contextAttr:{preserveDrawingBuffer:!1!==t.preserveDrawingBuffer,premultipliedAlpha:!!t.premultipliedAlpha,antialias:!1!==t.antialias},spinnerElementId:t.spinnerElementId,transparent:!1!==t.transparent,gammaInput:!0,gammaOutput:!1,backgroundColor:t.backgroundColor,backgroundColorFromAmbientLight:t.backgroundColorFromAmbientLight,ticksPerRender:1,ticksPerOcclusionTest:20,units:t.units,scale:t.scale,origin:t.origin,saoEnabled:t.saoEnabled,alphaDepthMask:!1!==t.alphaDepthMask,entityOffsetsEnabled:!!t.entityOffsetsEnabled,logarithmicDepthBufferEnabled:!!t.logarithmicDepthBufferEnabled,pbrEnabled:!!t.pbrEnabled}),this.metaScene=new Ze(this,this.scene),this.id=t.id||this.scene.id,this.camera=this.scene.camera,this.cameraFlight=new ce(this.scene,{duration:.5}),this.cameraControl=new Ke(this.scene,{doublePickFlyTo:!0}),this._plugins=[],this._eventSubs={}}on(t,e){let i=this._eventSubs[t];i||(i=[],this._eventSubs[t]=i),i.push(e)}fire(t,e){const i=this._eventSubs[t];if(i)for(let t=0,s=i.length;t<s;t++)i[t](e)}off(t){}log(t){console.log(`[xeokit viewer ${this.id}]: ${t}`)}error(t){console.error(`[xeokit viewer ${this.id}]: ${t}`)}addPlugin(t){this._plugins.push(t)}removePlugin(t){for(let e=0,i=this._plugins.length;e<i;e++){const i=this._plugins[e];if(i===t)return i.clear&&i.clear(),void this._plugins.splice(e,1)}}sendToPlugins(t,e){for(let i=0,s=this._plugins.length;i<s;i++){const s=this._plugins[i];s.send&&s.send(t,e)}}clear(){throw'Viewer#clear() no longer implemented - use \'#sendToPlugins("clear") instead'}resetView(){throw"Viewer#resetView() no longer implemented - use CameraMemento & ObjectsMemento classes instead"}beginSnapshot(){this._snapshotBegun||(this.scene._renderer.beginSnapshot(),this._snapshotBegun=!0)}getSnapshot(t={}){const e=!this._snapshotBegun;this._snapshotBegun||this.beginSnapshot(),t.includeGizmos||this.sendToPlugins("snapshotStarting");const i=t.width!==undefined&&t.height!==undefined,s=this.scene.canvas.canvas,r=s.clientWidth,o=s.clientHeight,a=s.style.width,n=s.style.height,l=t.width?Math.floor(t.width):s.width,h=t.height?Math.floor(t.height):s.height;i&&(s.style.width=l+"px",s.style.height=h+"px"),this.scene._renderer.renderSnapshot();const u=this.scene._renderer.readSnapshot(t);return i&&(s.style.width=a,s.style.height=n,s.width=r,s.height=o,this.scene.glRedraw()),t.includeGizmos||this.sendToPlugins("snapshotFinished"),e&&this.endSnapshot(),u}endSnapshot(){this._snapshotBegun&&(this.scene._renderer.endSnapshot(),this.scene._renderer.render({force:!0}),this._snapshotBegun=!1)}destroy(){const t=this._plugins.slice();for(let e=0,i=t.length;e<i;e++){t[e].destroy()}this.scene.destroy()}}class ti{constructor(t,e,i,s,r=null,o=0){this.model=t,this.object=null,this.parent=null,this.id=e,this.pickId=this.model.scene._renderer.getPickID(this),this.aabb=M.AABB3(),this._layer=r,this._portionId=o,this._color=[i[0],i[1],i[2],s],this._colorize=[i[0],i[1],i[2],s],this._colorizing=!1,this._transparent=s<255,this.numTriangles=0,this.rtcCenter=null}_finalize(t){this._layer.initFlags(this._portionId,t,this._transparent)}_setVisible(t){this._layer.setVisible(this._portionId,t,this._transparent)}_setColor(t){this._color[0]=t[0],this._color[1]=t[1],this._color[2]=t[2],this._colorizing||this._layer.setColor(this._portionId,this._color,!1)}_setColorize(t){t?(this._colorize[0]=t[0],this._colorize[1]=t[1],this._colorize[2]=t[2],this._layer.setColor(this._portionId,this._colorize,false),this._colorizing=!0):(this._layer.setColor(this._portionId,this._color,false),this._colorizing=!1)}_setOpacity(t,e){const i=t<255,s=this._transparent!==i;this._color[3]=t,this._colorize[3]=t,this._transparent=i,this._colorizing?this._layer.setColor(this._portionId,this._colorize):this._layer.setColor(this._portionId,this._color),s&&this._layer.setTransparent(this._portionId,e,i)}_setOffset(t){this._layer.setOffset(this._portionId,t)}_setHighlighted(t){this._layer.setHighlighted(this._portionId,t,this._transparent)}_setXRayed(t){this._layer.setXRayed(this._portionId,t,this._transparent)}_setSelected(t){this._layer.setSelected(this._portionId,t,this._transparent)}_setEdges(t){this._layer.setEdges(this._portionId,t,this._transparent)}_setClippable(t){this._layer.setClippable(this._portionId,t,this._transparent)}_setCollidable(t){this._layer.setCollidable(this._portionId,t)}_setPickable(t){this._layer.setPickable(this._portionId,t,this._transparent)}_setCulled(t){this._layer.setCulled(this._portionId,t,this._transparent)}canPickTriangle(){return!1}drawPickTriangles(t,e){}pickTriangleSurface(t){}canPickWorldPos(){return!0}drawPickDepths(t){this.model.drawPickDepths(t)}drawPickNormals(t){this.model.drawPickNormals(t)}delegatePickedEntity(){return this.parent}_destroy(){this.model.scene._renderer.putPickID(this.pickId)}}const ei=1,ii=4,si=8,ri=16,oi=32,ai=256,ni=512,li=1024,hi=2048,ui=new Float32Array([0,0,0]),ci=new Uint16Array([0,0,0]);class di{constructor(t,e,i,s,r,o){this._isObject=e,this.scene=t.scene,this.model=t,this.meshes=s,this._numTriangles=0;for(var a=0,n=this.meshes.length;a<n;a++){const t=this.meshes[a];t.parent=this,this._numTriangles+=t.numTriangles}this.id=i,this.originalSystemId=M.unglobalizeObjectId(t.id,i),this._flags=r,this._aabb=o,this._offsetAABB=M.AABB3(o),this._offset=M.vec3(),this._isObject&&t.scene._registerObject(this)}get isEntity(){return!0}get isModel(){return!1}get isObject(){return this._isObject}get aabb(){return this._offsetAABB}get numTriangles(){return this._numTriangles}set visible(t){if(!!(this._flags&ei)!==t){this._flags=t?this._flags|ei:this._flags&~ei;for(let t=0,e=this.meshes.length;t<e;t++)this.meshes[t]._setVisible(this._flags);this._isObject&&this.model.scene._objectVisibilityUpdated(this),this.model.glRedraw()}}get visible(){return this._getFlag(ei)}_getFlag(t){return!!(this._flags&t)}set highlighted(t){if(!!(this._flags&ni)!==t){this._flags=t?this._flags|ni:this._flags&~ni;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setHighlighted(this._flags);this._isObject&&this.model.scene._objectHighlightedUpdated(this),this.model.glRedraw()}}get highlighted(){return this._getFlag(ni)}set xrayed(t){if(!!(this._flags&ai)!==t){this._flags=t?this._flags|ai:this._flags&~ai;for(let t=0,e=this.meshes.length;t<e;t++)this.meshes[t]._setXRayed(this._flags);this._isObject&&this.model.scene._objectXRayedUpdated(this),this.model.glRedraw()}}get xrayed(){return this._getFlag(ai)}set selected(t){if(!!(this._flags&li)!==t){this._flags=t?this._flags|li:this._flags&~li;for(let t=0,e=this.meshes.length;t<e;t++)this.meshes[t]._setSelected(this._flags);this._isObject&&this.model.scene._objectSelectedUpdated(this),this.model.glRedraw()}}get selected(){return this._getFlag(li)}set edges(t){if(!!(this._flags&hi)!==t){this._flags=t?this._flags|hi:this._flags&~hi;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setEdges(this._flags);this.model.glRedraw()}}get edges(){return this._getFlag(hi)}set culled(t){if(!!(this._flags&ii)!==t){this._flags=t?this._flags|ii:this._flags&~ii;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setCulled(this._flags);this.model.glRedraw()}}get culled(){return this._getFlag(ii)}set clippable(t){if(!!(this._flags&ri)!==t){this._flags=t?this._flags|ri:this._flags&~ri;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setClippable(this._flags);this.model.glRedraw()}}get clippable(){return this._getFlag(ri)}set collidable(t){if(!!(this._flags&oi)!==t){this._flags=t?this._flags|oi:this._flags&~oi;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setCollidable(this._flags)}}get collidable(){return this._getFlag(oi)}set pickable(t){if(!!(this._flags&si)!==t){this._flags=t?this._flags|si:this._flags&~si;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setPickable(this._flags)}}get pickable(){return this._getFlag(si)}set colorize(t){if(t){ci[0]=Math.floor(255*t[0]),ci[1]=Math.floor(255*t[1]),ci[2]=Math.floor(255*t[2]);for(let t=0,e=this.meshes.length;t<e;t++)this.meshes[t]._setColorize(ci)}else for(let t=0,e=this.meshes.length;t<e;t++)this.meshes[t]._setColorize(null);if(this._isObject){const e=!!t;this.scene._objectColorizeUpdated(this,e)}this.model.glRedraw()}get colorize(){if(0===this.meshes.length)return null;const t=this.meshes[0]._colorize;return ui[0]=t[0]/255,ui[1]=t[1]/255,ui[2]=t[2]/255,ui}set opacity(t){if(0===this.meshes.length)return;const e=null!==t&&t!==undefined,i=this.meshes[0]._colorize[3];let s=255;if(e){if(t<0?t=0:t>1&&(t=1),s=Math.floor(255*t),i===s)return}else if(s=255,i===s)return;for(let t=0,e=this.meshes.length;t<e;t++)this.meshes[t]._setOpacity(s,this._flags);this._isObject&&this.scene._objectOpacityUpdated(this,e),this.model.glRedraw()}get opacity(){return this.meshes.length>0?this.meshes[0]._colorize[3]/255:1}set offset(t){t?(this._offset[0]=t[0],this._offset[1]=t[1],this._offset[2]=t[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(let t=0,e=this.meshes.length;t<e;t++)this.meshes[t]._setOffset(this._offset);this._offsetAABB[0]=this._aabb[0]+this._offset[0],this._offsetAABB[1]=this._aabb[1]+this._offset[1],this._offsetAABB[2]=this._aabb[2]+this._offset[2],this._offsetAABB[3]=this._aabb[3]+this._offset[0],this._offsetAABB[4]=this._aabb[4]+this._offset[1],this._offsetAABB[5]=this._aabb[5]+this._offset[2],this.scene._aabbDirty=!0,this.scene._objectOffsetUpdated(this,t),this.model._aabbDirty=!0,this.model.glRedraw()}get offset(){return this._offset}set castsShadow(t){}get castsShadow(){return!1}set receivesShadow(t){}get receivesShadow(){return!1}get saoEnabled(){return this.model.saoEnabled}_finalize(){const t=this.model.scene;this._isObject&&(this.visible&&t._objectVisibilityUpdated(this),this.highlighted&&t._objectHighlightedUpdated(this),this.xrayed&&t._objectXRayedUpdated(this),this.selected&&t._objectSelectedUpdated(this));for(let t=0,e=this.meshes.length;t<e;t++)this.meshes[t]._finalize(this._flags)}_destroy(){const t=this.model.scene;this._isObject&&(t._deregisterObject(this),this.visible&&t._objectVisibilityUpdated(this,!1),this.xrayed&&t._objectXRayedUpdated(this),this.selected&&t._objectSelectedUpdated(this),this.highlighted&&t._objectHighlightedUpdated(this),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1));for(let t=0,e=this.meshes.length;t<e;t++)this.meshes[t]._destroy();t._aabbDirty=!0}}const pi=new class{constructor(){this._uint8Arrays={},this._float32Arrays={}}_clear(){this._uint8Arrays={},this._float32Arrays={}}getUInt8Array(t){let e=this._uint8Arrays[t];return e||(e=new Uint8Array(t),this._uint8Arrays[t]=e),e}getFloat32Array(t){let e=this._float32Arrays[t];return e||(e=new Float32Array(t),this._float32Arrays[t]=e),e}};let fi=0;const _i=0,gi=1,mi=2,vi=3,Pi=4,bi=5,yi=6,xi=7,Mi=8,wi=9,Ei=10,Ci=11,Ai=M.vec4(),Si=M.vec3();class Di{constructor(t,e){this._scene=t,this._withSAO=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const t=this._scene;return[t._lightsState.getHash(),t._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(t,e,i){const s=this._scene,r=s.camera,o=e.model,a=s.canvas.gl,n=e._state,l=e._state.rtcCenter;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?R(r.viewMatrix,l):r.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,r.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,o.worldNormalMatrix);const h=s._sectionPlanesState.sectionPlanes.length;if(h>0){const t=s._sectionPlanesState.sectionPlanes,i=e.layerIndex*h,r=o.renderFlags;for(let e=0;e<h;e++){const s=this._uSectionPlanes[e],o=r.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,o?1:0),o){const i=t[e];if(l){const t=B(i.dist,i.dir,l,Si);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aNormal&&this._aNormal.bindArrayBuffer(n.normalsBuf),this._aColor&&this._aColor.bindArrayBuffer(n.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._lightsState;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(let t=0,e=r.length;t<e;t++)switch(o=r[t],o.type){case"dir":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=null,this._uLightDir[t]=s.getLocation("lightDir"+t);break;case"point":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=s.getLocation("lightPos"+t),this._uLightDir[t]=null,this._uLightAttenuation[t]=s.getLocation("lightAttenuation"+t);break;case"spot":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=s.getLocation("lightPos"+t),this._uLightDir[t]=s.getLocation("lightDir"+t),this._uLightAttenuation[t]=s.getLocation("lightAttenuation"+t)}this._uSectionPlanes=[];for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aNormal=s.getAttribute("normal"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams")),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(t){const e=this._scene,i=e.canvas.gl,s=this._program,r=e._lightsState.lights,o=e.camera.project;s.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,e._lightsState.getAmbientColorAndIntensity());for(let t=0,e=r.length;t<e;t++){const e=r[t];this._uLightColor[t]&&i.uniform4f(this._uLightColor[t],e.color[0],e.color[1],e.color[2],e.intensity),this._uLightPos[t]&&(i.uniform3fv(this._uLightPos[t],e.pos),this._uLightAttenuation[t]&&i.uniform1f(this._uLightAttenuation[t],e.attenuation)),this._uLightDir[t]&&i.uniform3fv(this._uLightDir[t],e.dir)}if(this._withSAO){const s=e.sao;if(s.possible){const e=i.drawingBufferWidth,r=i.drawingBufferHeight;Ai[0]=e,Ai[1]=r,Ai[2]=s.blendCutoff,Ai[3]=s.blendFactor,i.uniform4fv(this._uSAOParams,Ai),this._program.bindTexture(this._uOcclusionTexture,t.occlusionTexture,0)}}if(e.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState,i=t._lightsState,s=e.sectionPlanes.length>0;let r;const o=[];o.push("// Triangles batching draw vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("uniform int renderPass;"),o.push("attribute vec3 position;"),o.push("attribute vec3 normal;"),o.push("attribute vec4 color;"),o.push("attribute vec4 flags;"),o.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&o.push("attribute vec3 offset;"),o.push("uniform mat4 worldMatrix;"),o.push("uniform mat4 worldNormalMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform mat4 viewNormalMatrix;"),o.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("varying float vFragDepth;")),o.push("uniform vec4 lightAmbient;");for(let t=0,e=i.lights.length;t<e;t++)r=i.lights[t],"ambient"!==r.type&&(o.push("uniform vec4 lightColor"+t+";"),"dir"===r.type&&o.push("uniform vec3 lightDir"+t+";"),"point"===r.type&&o.push("uniform vec3 lightPos"+t+";"),"spot"===r.type&&(o.push("uniform vec3 lightPos"+t+";"),o.push("uniform vec3 lightDir"+t+";")));o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),s&&(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;")),o.push("varying vec4 vColor;"),o.push("void main(void) {"),o.push("if (int(flags.x) != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),o.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),o.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),o.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),o.push("float lambertian = 1.0;");for(let t=0,e=i.lights.length;t<e;t++)if(r=i.lights[t],"ambient"!==r.type){if("dir"===r.type)"view"===r.space?o.push("viewLightDir = normalize(lightDir"+t+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);");else if("point"===r.type)"view"===r.space?o.push("viewLightDir = -normalize(lightPos"+t+" - viewPosition.xyz);"):o.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+t+", 0.0)).xyz);");else{if("spot"!==r.type)continue;"view"===r.space?o.push("viewLightDir = normalize(lightDir"+t+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);")}o.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),o.push("reflectedColor += lambertian * (lightColor"+t+".rgb * lightColor"+t+".a);")}return o.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),o.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),o.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?o.push("vFragDepth = 1.0 + clipPos.w;"):(o.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),o.push("clipPos.z *= clipPos.w;"))),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags2 = flags2;")),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Triangles batching draw fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBToFloat( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture2D(uOcclusionTexture, uv))) * blendFactor;"),s.push("   gl_FragColor            = vec4(vColor.rgb * ambient, 1.0);")):s.push("   gl_FragColor            = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Li=new Float32Array([1,1,1]),Ri=M.vec3();class Bi{constructor(t,e){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.rtcCenter;if(!this._program&&(this._allocate(),this.errors))return;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===bi){const t=r.xrayMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===vi){const t=r.highlightMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===Pi){const t=r.selectedMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else a.uniform4fv(this._uColor,Li);const h=l?R(o.viewMatrix,l):o.viewMatrix;a.uniformMatrix4fv(this._uViewMatrix,!1,h),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=B(i.dist,i.dir,l,Ri);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uColor=i.getLocation("color"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching silhouette vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform vec4 color;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState;let i,s;const r=e.sectionPlanes.length>0,o=[];if(o.push("// Triangles batching silhouette fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;")),r)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("uniform vec4 color;"),o.push("void main(void) {"),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("gl_FragColor = color;"),o.push("}"),o}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ti=M.vec3(),Fi=new Float32Array([0,0,0,1]);class Ni{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.rtcCenter;if(!this._program&&(this._allocate(e),this.errors))return;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===Ei){const t=r.xrayMaterial._state,e=t.edgeColor,i=t.edgeAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===Mi){const t=r.highlightMaterial._state,e=t.edgeColor,i=t.edgeAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===wi){const t=r.selectedMaterial._state,e=t.edgeColor,i=t.edgeAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else a.uniform4fv(this._uColor,Fi);a.uniformMatrix4fv(this._uViewMatrix,!1,l?R(o.viewMatrix,l):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const h=r._sectionPlanesState.sectionPlanes.length;if(h>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*h,o=s.renderFlags;for(let e=0;e<h;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=B(i.dist,i.dir,l,Ti);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.edgeIndicesBuf.bind(),a.drawElements(a.LINES,n.edgeIndicesBuf.numItems,n.edgeIndicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uColor=i.getLocation("color"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=this._program,s=t.camera.project;if(i.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(s.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry edges drawing vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("uniform vec4 color;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(color.r, color.g, color.b, color.a);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry edges drawing fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Oi=M.vec3();class ki{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.rtcCenter;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?R(o.viewMatrix,l):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const h=r._sectionPlanesState.sectionPlanes.length;if(h>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*h,o=s.renderFlags;for(let e=0;e<h;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=B(i.dist,i.dir,l,Oi);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.edgeIndicesBuf.bind(),a.drawElements(a.LINES,n.edgeIndicesBuf.numItems,n.edgeIndicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=this._program,s=t.camera.project;if(i.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(s.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry edges drawing vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry edges drawing fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ii=M.vec3();class zi{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.rtcCenter;this._program||this._allocate(e),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const h=t.pickViewMatrix||o.viewMatrix,u=l?R(h,l):h;if(a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,u),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,t)}const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=B(i.dist,i.dir,l,Ii);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aPickColor&&this._aPickColor.bindArrayBuffer(n.pickColorsBuf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aPickColor=i.getAttribute("pickColor"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(t){const e=this._scene.canvas.gl;this._program.bind(),e.uniform1i(this._uPickInvisible,t.pickInvisible)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry picking vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 pickColor;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vPickColor;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry picking fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec4 vPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<e.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   gl_FragColor = vPickColor; "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Vi=M.vec3();class Ui{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.rtcCenter;this._program||this._allocate(),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,t.pickInvisible);const h=t.pickViewMatrix||o.viewMatrix,u=l?R(h,l):h;if(a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),a.uniform1f(this._uPickZNear,t.pickZNear),a.uniform1f(this._uPickZFar,t.pickZFar),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(t.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,e)}const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=B(i.dist,i.dir,l,Vi);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching pick depth vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vViewPosition;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Triangles batching pick depth fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<e.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    gl_FragColor = packDepth(zNormalizedDepth); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Gi=M.vec3();class Xi{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.rtcCenter;this._program||this._allocate(e),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,t.pickInvisible),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const h=t.pickViewMatrix||o.viewMatrix,u=l?R(h,l):h;if(a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,t)}const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=B(i.dist,i.dir,l,Gi);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aNormal&&this._aNormal.bindArrayBuffer(n.normalsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aNormal=i.getAttribute("normal"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching pick normals vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec3 normal;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec3 vWorldNormal;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vec3 worldNormal =  octDecode(normal.xy); "),i.push("      vWorldNormal = worldNormal;"),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Triangles batching pick normals fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec3 vWorldNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<e.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    gl_FragColor = vec4((vWorldNormal * 0.5) + 0.5, 1.0);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const ji=M.vec3();class Wi{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.canvas.gl,a=e._state,n=r.camera,l=e._state.rtcCenter;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),o.uniform1i(this._uRenderPass,i),o.uniformMatrix4fv(this._uViewMatrix,!1,l?R(n.viewMatrix,l):n.viewMatrix),o.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const h=r._sectionPlanesState.sectionPlanes.length;if(h>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*h,a=s.renderFlags;for(let e=0;e<h;e++){const s=this._uSectionPlanes[e],r=a.sectionPlanesActivePerLayer[i+e];if(o.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=B(i.dist,i.dir,l,ji);o.uniform3fv(s.pos,t)}else o.uniform3fv(s.pos,i.pos);o.uniform3fv(s.dir,i.dir)}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aColor&&this._aColor.bindArrayBuffer(a.colorsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),o.drawElements(o.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching occlusion vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Triangles batching occlusion fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("      if (sectionPlaneActive"+t+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Hi=M.vec3();class Yi{constructor(t){this._scene=t,this._allocate(),this._hash=this._getHash()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.rtcCenter;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,l?R(o.viewMatrix,l):o.viewMatrix);const h=r._sectionPlanesState.sectionPlanes.length;if(h>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*h,o=s.renderFlags;for(let e=0;e<h;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=B(i.dist,i.dir,l,Hi);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching depth vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec2 vHighPrecisionZW;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Triangles batching depth fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("precision highp float;"),s.push("precision highp int;"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("const float   packUpScale = 256. / 255.;"),s.push("const float   unpackDownscale = 255. / 256.;"),s.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),s.push("const float   shiftRight8 = 1.0 / 256.;"),s.push("vec4 packDepthToRGBA( const in float v ) {"),s.push("    vec4 r = vec4( fract( v * packFactors ), v );"),s.push("    r.yzw -= r.xyz * shiftRight8;"),s.push("    return r * packUpScale;"),s.push("}"),s.push("varying vec2 vHighPrecisionZW;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),C.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?s.push("    gl_FragColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "):s.push("    gl_FragColor = packDepthToRGBA(fragCoordZ); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null,i.memory.programs--}}const Ki=M.vec3();class $i{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.rtcCenter;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(e)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?R(o.viewMatrix,l):o.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,s.worldNormalMatrix);const h=r._sectionPlanesState.sectionPlanes.length;if(h>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*h,o=s.renderFlags;for(let e=0;e<h;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=B(i.dist,i.dir,l,Ki);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aNormal.bindArrayBuffer(n.normalsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uWorldNormalMatrix=i.getLocation("worldNormalMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uViewNormalMatrix=i.getLocation("viewNormalMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aNormal=i.getAttribute("normal"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2&&(this._aFlags2=i.getAttribute("flags2")),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry normals vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec3 normal;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 worldNormalMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 viewNormalMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec3 vViewNormal;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition   = viewMatrix * worldPosition; "),i.push("      vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("      vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),e&&(i.push("      vWorldPosition  = worldPosition;"),i.push("      vFlags2         = flags2;")),i.push("      vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry normals fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const qi=M.vec3();class Zi{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e){const i=this._scene,s=i.canvas.gl,r=e._state;this._program||this._allocate(),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),i.logarithmicDepthBufferEnabled&&s.uniform1f(this._uZFar,i.camera.project.far),this._aPosition.bindArrayBuffer(r.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(r.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(r.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(r.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(r.offsetsBuf),r.indicesBuf.bind();const o=i._sectionPlanesState.sectionPlanes.length;if(o>0){const t=i._sectionPlanesState.sectionPlanes,r=e.layerIndex*o,a=model.renderFlags,n=e._state.rtcCenter;for(let e=0;e<o;e++){const i=this._uSectionPlanes[e],o=a.sectionPlanesActivePerLayer[r+e];if(s.uniform1i(i.active,o?1:0),o){const r=t[e];if(n){const t=B(r.dist,r.dir,n,qi);s.uniform3fv(i.pos,t)}else s.uniform3fv(i.pos,r.pos);s.uniform3fv(i.dir,r.dir)}}}s.drawElements(s.TRIANGLES,r.indicesBuf.numItems,r.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uShadowViewMatrix=s.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=s.getLocation("shadowProjMatrix"),t.logarithmicDepthBufferEnabled&&(this._uZFar=s.getLocation("zFar")),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2")}_bindProgram(t){const e=this._scene.canvas.gl;this._program.bind(),e.uniformMatrix4fv(this._uShadowViewMatrix,!1,t.shadowViewMatrix),e.uniformMatrix4fv(this._uShadowProjMatrix,!1,t.shadowProjMatrix),this._lastLightId=null}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry shadow vertex shader"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vViewPosition;"),i.push("void main(void) {"),i.push("  bool visible        = (float(flags.x) > 0.0);"),i.push("  bool transparent    = ((float(color.a) / 255.0) < 1.0);"),i.push("  if (!visible || transparent) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = shadowViewMatrix * worldPosition; "),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("      vViewPosition = viewPosition;"),i.push("      gl_Position = shadowProjMatrix * viewPosition;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,e=t.sectionPlanes.length>0,i=[];if(i.push("// Batched geometry shadow fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e){i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";")}if(i.push("varying vec4 vViewPosition;"),i.push("vec4 encodeFloat( const in float v ) {"),i.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),i.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),i.push("  vec4 comp = fract(v * bitShift);"),i.push("  comp -= comp.xxyz * bitMask;"),i.push("  return comp;"),i.push("}"),i.push("void main(void) {"),e){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<t.sectionPlanes.length;s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    gl_FragColor = encodeFloat( gl_FragCoord.z); "),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Qi=M.vec4(),Ji=M.vec3(),ts={linear:"linearToLinear",sRGB:"sRGBToLinear",gamma:"gammaToLinear"};class es{constructor(t,e){this._scene=t,this._withSAO=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const t=this._scene;return[t.gammaOutput,t._lightsState.getHash(),t._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(t,e,i){const s=this._scene,r=s.camera,o=e.model,a=s.canvas.gl,n=e._state,l=e._state.rtcCenter;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?R(r.viewMatrix,l):r.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,r.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,o.worldNormalMatrix);const h=s._sectionPlanesState.sectionPlanes.length;if(h>0){const t=s._sectionPlanesState.sectionPlanes,i=e.layerIndex*h,r=o.renderFlags;for(let e=0;e<h;e++){const s=this._uSectionPlanes[e],o=r.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,o?1:0),o){const i=t[e];if(l){const t=B(i.dist,i.dir,l,Ji);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aNormal&&this._aNormal.bindArrayBuffer(n.normalsBuf),this._aColor&&this._aColor.bindArrayBuffer(n.colorsBuf),this._aMetallicRoughness&&this._aMetallicRoughness.bindArrayBuffer(n.metallicRoughnessBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._lightsState;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uGammaFactor=s.getLocation("gammaFactor"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(let t=0,e=r.length;t<e;t++)switch(o=r[t],o.type){case"dir":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=null,this._uLightDir[t]=s.getLocation("lightDir"+t);break;case"point":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=s.getLocation("lightPos"+t),this._uLightDir[t]=null,this._uLightAttenuation[t]=s.getLocation("lightAttenuation"+t);break;case"spot":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=s.getLocation("lightPos"+t),this._uLightDir[t]=s.getLocation("lightDir"+t),this._uLightAttenuation[t]=s.getLocation("lightAttenuation"+t)}i.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),i.lightMaps.length>0&&(this._uLightMap="lightMap"),this._uSectionPlanes=[];for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aNormal=s.getAttribute("normal"),this._aColor=s.getAttribute("color"),this._aMetallicRoughness=s.getAttribute("metallicRoughness"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams")),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(t){const e=C.MAX_TEXTURE_UNITS,i=this._scene,s=i.canvas.gl,r=this._program,o=i._lightsState,a=o.lights,n=i.camera.project;r.bind(),s.uniformMatrix4fv(this._uProjMatrix,!1,n.matrix),this._uLightAmbient&&s.uniform4fv(this._uLightAmbient,i._lightsState.getAmbientColorAndIntensity());for(let t=0,e=a.length;t<e;t++){const e=a[t];this._uLightColor[t]&&s.uniform4f(this._uLightColor[t],e.color[0],e.color[1],e.color[2],e.intensity),this._uLightPos[t]&&(s.uniform3fv(this._uLightPos[t],e.pos),this._uLightAttenuation[t]&&s.uniform1f(this._uLightAttenuation[t],e.attenuation)),this._uLightDir[t]&&s.uniform3fv(this._uLightDir[t],e.dir)}if(o.reflectionMaps.length>0&&o.reflectionMaps[0].texture&&this._uReflectionMap&&(r.bindTexture(this._uReflectionMap,o.reflectionMaps[0].texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++),o.lightMaps.length>0&&o.lightMaps[0].texture&&this._uLightMap&&(r.bindTexture(this._uLightMap,o.lightMaps[0].texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++),this._withSAO){const r=i.sao;if(r.possible){const i=s.drawingBufferWidth,o=s.drawingBufferHeight;Qi[0]=i,Qi[1]=o,Qi[2]=r.blendCutoff,Qi[3]=r.blendFactor,s.uniform4fv(this._uSAOParams,Qi),this._program.bindTexture(this._uOcclusionTexture,t.occlusionTexture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++}}if(i.logarithmicDepthBufferEnabled){const t=2/(Math.log(n.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,t)}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState,i=t._lightsState,s=e.sectionPlanes.length>0,r=e.clippingCaps,o=[];return o.push("// Triangles batching quality draw vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("uniform int renderPass;"),o.push("attribute vec3 position;"),o.push("attribute vec3 normal;"),o.push("attribute vec4 color;"),o.push("attribute vec2 metallicRoughness;"),o.push("attribute vec4 flags;"),o.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&o.push("attribute vec3 offset;"),o.push("uniform mat4 worldMatrix;"),o.push("uniform mat4 worldNormalMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform mat4 viewNormalMatrix;"),o.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("varying float vFragDepth;")),o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),o.push("varying vec4 vViewPosition;"),o.push("varying vec3 vViewNormal;"),o.push("varying vec4 vColor;"),o.push("varying vec2 vMetallicRoughness;"),i.lightMaps.length>0&&o.push("varying vec3 vWorldNormal;"),s&&(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),r&&o.push("varying vec4 vClipPosition;")),o.push("void main(void) {"),o.push("if (int(flags.x) != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),o.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),o.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?o.push("vFragDepth = 1.0 + clipPos.w;"):(o.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),o.push("clipPos.z *= clipPos.w;"))),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags2 = flags2;"),r&&o.push("vClipPosition = clipPos;")),o.push("vViewPosition = viewPosition;"),o.push("vViewNormal = viewNormal;"),o.push("vColor = color;"),o.push("vMetallicRoughness = metallicRoughness;"),i.lightMaps.length>0&&o.push("vWorldNormal = worldNormal.xyz;"),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const t=this._scene,e=t.gammaOutput,i=t._sectionPlanesState,s=t._lightsState,r=i.sectionPlanes.length>0,o=i.clippingCaps,a=[];a.push("// Triangles batching quality draw fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;")),a.push("varying vec4 vViewPosition;"),a.push("varying vec3 vViewNormal;"),a.push("varying vec4 vColor;"),a.push("varying vec2 vMetallicRoughness;"),s.lightMaps.length>0&&a.push("varying vec3 vWorldNormal;"),a.push("uniform mat4 viewMatrix;"),s.reflectionMaps.length>0&&a.push("uniform samplerCube reflectionMap;"),s.lightMaps.length>0&&a.push("uniform samplerCube lightMap;"),a.push("uniform vec4 lightAmbient;");for(let t=0,e=s.lights.length;t<e;t++){const e=s.lights[t];"ambient"!==e.type&&(a.push("uniform vec4 lightColor"+t+";"),"dir"===e.type&&a.push("uniform vec3 lightDir"+t+";"),"point"===e.type&&a.push("uniform vec3 lightPos"+t+";"),"spot"===e.type&&(a.push("uniform vec3 lightPos"+t+";"),a.push("uniform vec3 lightDir"+t+";")))}if(this._withSAO&&(a.push("uniform sampler2D uOcclusionTexture;"),a.push("uniform vec4      uSAOParams;"),a.push("const float       packUpscale = 256. / 255.;"),a.push("const float       unpackDownScale = 255. / 256.;"),a.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),a.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),a.push("float unpackRGBAToDepth( const in vec4 v ) {"),a.push("    return dot( v, unPackFactors );"),a.push("}")),a.push("uniform float gammaFactor;"),a.push("vec4 linearToLinear( in vec4 value ) {"),a.push("  return value;"),a.push("}"),a.push("vec4 sRGBToLinear( in vec4 value ) {"),a.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),a.push("}"),a.push("vec4 gammaToLinear( in vec4 value) {"),a.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),a.push("}"),e&&(a.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),a.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),a.push("}")),r){a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;"),o&&a.push("varying vec4 vClipPosition;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)a.push("uniform bool sectionPlaneActive"+t+";"),a.push("uniform vec3 sectionPlanePos"+t+";"),a.push("uniform vec3 sectionPlaneDir"+t+";")}if(a.push("#define PI 3.14159265359"),a.push("#define RECIPROCAL_PI 0.31830988618"),a.push("#define RECIPROCAL_PI2 0.15915494"),a.push("#define EPSILON 1e-6"),a.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),a.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),a.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),a.push("}"),a.push("struct IncidentLight {"),a.push("   vec3 color;"),a.push("   vec3 direction;"),a.push("};"),a.push("struct ReflectedLight {"),a.push("   vec3 diffuse;"),a.push("   vec3 specular;"),a.push("};"),a.push("struct Geometry {"),a.push("   vec3 position;"),a.push("   vec3 viewNormal;"),a.push("   vec3 worldNormal;"),a.push("   vec3 viewEyeDir;"),a.push("};"),a.push("struct Material {"),a.push("   vec3    diffuseColor;"),a.push("   float   specularRoughness;"),a.push("   vec3    specularColor;"),a.push("   float   shine;"),a.push("};"),a.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),a.push("   float r = ggxRoughness + 0.0001;"),a.push("   return (2.0 / (r * r) - 2.0);"),a.push("}"),a.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),a.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),a.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),a.push("}"),s.reflectionMaps.length>0&&(a.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),a.push("   vec3 envMapColor = "+ts[s.reflectionMaps[0].encoding]+"(textureCube(reflectionMap, reflectVec, mipLevel)).rgb;"),a.push("  return envMapColor;"),a.push("}")),a.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),a.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),a.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),a.push("}"),a.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   return 1.0 / ( gl * gv );"),a.push("}"),a.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   return 0.5 / max( gv + gl, EPSILON );"),a.push("}"),a.push("float D_GGX(const in float alpha, const in float dotNH) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),a.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float alpha = ( roughness * roughness );"),a.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),a.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),a.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),a.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),a.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),a.push("   vec3  F = F_Schlick( specularColor, dotLH );"),a.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),a.push("   float D = D_GGX( alpha, dotNH );"),a.push("   return F * (G * D);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),a.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),a.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),a.push("   vec4 r = roughness * c0 + c1;"),a.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),a.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),a.push("   return specularColor * AB.x + AB.y;"),a.push("}"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&(a.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),s.lightMaps.length>0&&(a.push("   vec3 irradiance = "+ts[s.lightMaps[0].encoding]+"(textureCube(lightMap, geometry.worldNormal)).rgb;"),a.push("   irradiance *= PI;"),a.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.diffuse +=  irradiance * diffuseBRDFContrib;")),s.reflectionMaps.length>0&&(a.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),a.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),a.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),a.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),a.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),a.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),a.push("}")),a.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),a.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),a.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),a.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),a.push("}"),a.push("void main(void) {"),r){a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)a.push("if (sectionPlaneActive"+t+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),a.push("}");o?(a.push("  if (dist > (0.002 * vClipPosition.w)) {"),a.push("      discard;"),a.push("  }"),a.push("  if (dist > 0.0) { "),a.push("      gl_FragColor=vec4(1.0, 0.0, 0.0, 1.0);"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("  gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("  return;"),a.push("}")):(a.push("  if (dist > 0.0) { "),a.push("      discard;"),a.push("  }")),a.push("}")}a.push("IncidentLight  light;"),a.push("Material       material;"),a.push("Geometry       geometry;"),a.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),a.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),a.push("float alpha = float(vColor.a) / 255.0;"),a.push("vec3  diffuseColor = rgb;"),a.push("float specularF0 = 1.0;"),a.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),a.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),a.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),a.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),a.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),a.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);"),a.push("geometry.position      = vViewPosition.xyz;"),a.push("geometry.viewNormal    = -normalize(vViewNormal);"),a.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),s.lightMaps.length>0&&a.push("geometry.worldNormal   = normalize(vWorldNormal);"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&a.push("computePBRLightMapping(geometry, material, reflectedLight);");for(let t=0,e=s.lights.length;t<e;t++){const e=s.lights[t];if("ambient"!==e.type){if("dir"===e.type)"view"===e.space?a.push("light.direction =  normalize(lightDir"+t+");"):a.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);");else if("point"===e.type)"view"===e.space?a.push("light.direction =  normalize(lightPos"+t+" - vViewPosition.xyz);"):a.push("light.direction =  normalize((viewMatrix * vec4(lightPos"+t+", 0.0)).xyz);");else{if("spot"!==e.type)continue;"view"===e.space?a.push("light.direction =  normalize(lightDir"+t+");"):a.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);")}a.push("light.color =  lightColor"+t+".rgb * lightColor"+t+".a;"),a.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return a.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular);"),a.push("vec4 fragColor;"),this._withSAO?(a.push("   float viewportWidth     = uSAOParams[0];"),a.push("   float viewportHeight    = uSAOParams[1];"),a.push("   float blendCutoff       = uSAOParams[2];"),a.push("   float blendFactor       = uSAOParams[3];"),a.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),a.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture2D(uOcclusionTexture, uv))) * blendFactor;"),a.push("   fragColor               = vec4(outgoingLight.rgb * ambient, alpha);")):a.push("   fragColor            = vec4(outgoingLight.rgb, alpha);"),e&&a.push("fragColor = linearToGamma(fragColor, gammaFactor);"),a.push("gl_FragColor = fragColor;"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("}"),a}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class is{constructor(t){this._scene=t}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._colorQualityRenderer&&!this._colorQualityRenderer.getValid()&&(this._colorQualityRenderer.destroy(),this._colorQualityRenderer=null),this._colorQualityRendererWithSAO&&!this._colorQualityRendererWithSAO.getValid()&&(this._colorQualityRendererWithSAO.destroy(),this._colorQualityRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Di(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new Di(this._scene,!0)),this._colorRendererWithSAO}get colorQualityRenderer(){return this._colorQualityRenderer||(this._colorQualityRenderer=new es(this._scene,!1)),this._colorQualityRenderer}get colorQualityRendererWithSAO(){return this._colorQualityRendererWithSAO||(this._colorQualityRendererWithSAO=new es(this._scene,!0)),this._colorQualityRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Bi(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new Yi(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new $i(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new Ni(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new ki(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new zi(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new Xi(this._scene)),this._pickNormalsRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Ui(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new Wi(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new Zi(this._scene)),this._shadowRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._colorQualityRenderer&&this._colorQualityRenderer.destroy(),this._colorQualityRendererWithSAO&&this._colorQualityRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy()}}const ss={};const rs=C.SUPPORTED_EXTENSIONS.OES_element_index_uint;class os{constructor(t=5e6){rs?t>5e6&&(t=5e6):t>65530&&(t=65530),this.maxVerts=t,this.maxIndices=3*t,this.positions=[],this.colors=[],this.metallicRoughness=[],this.normals=[],this.pickColors=[],this.flags=[],this.flags2=[],this.offsets=[],this.indices=[],this.edgeIndices=[]}}const as=M.mat4(),ns=M.mat4();function ls(t,e,i){const s=t.length,r=new Uint16Array(s),o=e[0],a=e[1],n=e[2],l=e[3]-o,h=e[4]-a,u=e[5]-n,c=65525,d=c/l,p=c/h,f=c/u;for(let e=0;e<s;e+=3)r[e+0]=Math.floor((t[e+0]-o)*d),r[e+1]=Math.floor((t[e+1]-a)*p),r[e+2]=Math.floor((t[e+2]-n)*f);return M.identityMat4(as),M.translationMat4v(e,as),M.identityMat4(ns),M.scalingMat4v([l/c,h/c,u/c],ns),M.mulMat4(as,ns,i),r}function hs(t,e,i){let s=t[0]/(Math.abs(t[0])+Math.abs(t[1])+Math.abs(t[2])),r=t[1]/(Math.abs(t[0])+Math.abs(t[1])+Math.abs(t[2]));if(t[2]<0){let t=s,e=r;t=(1-Math.abs(r))*(s>=0?1:-1),e=(1-Math.abs(s))*(r>=0?1:-1),s=t,r=e}return new Int8Array([Math[e](127.5*s+(s<0?-1:0)),Math[i](127.5*r+(r<0?-1:0))])}function us(t,e,i,s){let r=t[e]/(Math.abs(t[e])+Math.abs(t[e+1])+Math.abs(t[e+2])),o=t[e+1]/(Math.abs(t[e])+Math.abs(t[e+1])+Math.abs(t[e+2]));if(t[e+2]<0){let t=(1-Math.abs(o))*(r>=0?1:-1),e=(1-Math.abs(r))*(o>=0?1:-1);r=t,o=e}return new Int8Array([Math[i](127.5*r+(r<0?-1:0)),Math[s](127.5*o+(o<0?-1:0))])}function cs(t){let e=t[0],i=t[1];e/=e<0?127:128,i/=i<0?127:128;const s=1-Math.abs(e)-Math.abs(i);s<0&&(e=(1-Math.abs(i))*(e>=0?1:-1),i=(1-Math.abs(e))*(i>=0?1:-1));const r=Math.sqrt(e*e+i*i+s*s);return[e/r,i/r,s/r]}function ds(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}const ps=M.mat4(),fs=M.mat4(),_s=M.vec4([0,0,0,1]),gs=M.vec4([0,0,0,1]),ms=M.vec4([0,0,0,1]),vs=M.OBB3();class Ps{constructor(t,e){this.sortId=(e.solid,"-solid"),this.layerIndex=e.layerIndex,this._batchingRenderers=function(t){const e=t.id;let i=ss[e];return i||(i=new is(t),ss[e]=i,i._compile(),t.on("compile",(()=>{i._compile()})),t.on("destroyed",(()=>{delete ss[e],i._destroy()}))),i}(t.scene),this.model=t,this._buffer=new os(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new nt({positionsBuf:null,offsetsBuf:null,normalsBuf:null,colorsBuf:null,metallicRoughnessBuf:null,flagsBuf:null,flags2Buf:null,indicesBuf:null,edgeIndicesBuf:null,positionsDecodeMatrix:M.mat4(),rtcCenter:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=M.collapseAABB3(),this._portions=[],this._finalized=!1,this._positionsDecodeMatrix=e.positionsDecodeMatrix,this._preCompressed=!!this._positionsDecodeMatrix,e.rtcCenter&&(this._state.rtcCenter=M.vec3(e.rtcCenter)),this.aabb=M.collapseAABB3(),this.solid=!!e.solid}canCreatePortion(t,e){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+t<3*this._buffer.maxVerts&&this._buffer.indices.length+e<this._buffer.maxIndices}createPortion(t){if(this._finalized)throw"Already finalized";const e=t.positions,i=t.normals,s=t.indices,r=t.edgeIndices,o=t.color,a=t.metallic,n=t.roughness,l=t.colors,h=t.opacity,u=t.meshMatrix,c=t.worldMatrix,d=t.worldAABB,p=t.pickColor,f=this._buffer,_=f.positions.length/3,g=e.length/3,m=e.length;if(this._preCompressed){for(let t=0,i=e.length;t<i;t++)f.positions.push(e[t]);const t=kt.getPositionsBounds(e),i=kt.decompressPosition(t.min,this._positionsDecodeMatrix,[]),s=kt.decompressPosition(t.max,this._positionsDecodeMatrix,[]);d[0]=i[0],d[1]=i[1],d[2]=i[2],d[3]=s[0],d[4]=s[1],d[5]=s[2],c&&(M.AABB3ToOBB3(d,vs),M.transformOBB3(c,vs),M.OBB3ToAABB3(vs,d))}else{const t=f.positions.length;for(let t=0,i=e.length;t<i;t++)f.positions.push(e[t]);if(u)for(let e=t,i=t+m;e<i;e+=3)_s[0]=f.positions[e+0],_s[1]=f.positions[e+1],_s[2]=f.positions[e+2],M.transformPoint4(u,_s,gs),f.positions[e+0]=gs[0],f.positions[e+1]=gs[1],f.positions[e+2]=gs[2],M.expandAABB3Point3(this._modelAABB,gs),c?(M.transformPoint4(c,gs,ms),M.expandAABB3Point3(d,ms)):M.expandAABB3Point3(d,gs);else for(let e=t,i=t+m;e<i;e+=3)_s[0]=f.positions[e+0],_s[1]=f.positions[e+1],_s[2]=f.positions[e+2],M.expandAABB3Point3(this._modelAABB,_s),c?(M.transformPoint4(c,_s,gs),M.expandAABB3Point3(d,gs)):M.expandAABB3Point3(d,_s)}if(this._state.rtcCenter){const t=this._state.rtcCenter;d[0]+=t[0],d[1]+=t[1],d[2]+=t[2],d[3]+=t[0],d[4]+=t[1],d[5]+=t[2]}if(M.expandAABB3(this.aabb,d),i)if(this._preCompressed)for(let t=0,e=i.length;t<e;t++)f.normals.push(i[t]);else{const t=ps;u?M.inverseMat4(M.transposeMat4(u,fs),t):M.identityMat4(t,t),function(t,e,i,s,r){let o,a,n,l,h,u,c=new Float32Array([0,0,0,0]),d=new Float32Array([0,0,0,0]);for(u=0;u<i;u+=3)c[0]=e[u],c[1]=e[u+1],c[2]=e[u+2],M.transformVec3(t,c,d),M.normalizeVec3(d,d),n=o=hs(d,"floor","floor"),a=cs(o),l=h=ds(d,a),o=hs(d,"ceil","floor"),a=cs(o),l=ds(d,a),l>h&&(n=o,h=l),o=hs(d,"floor","ceil"),a=cs(o),l=ds(d,a),l>h&&(n=o,h=l),o=hs(d,"ceil","ceil"),a=cs(o),l=ds(d,a),l>h&&(n=o,h=l),s[r+u+0]=n[0],s[r+u+1]=n[1],s[r+u+2]=0}(t,i,i.length,f.normals,f.normals.length)}if(l)for(let t=0,e=l.length;t<e;t+=3)f.colors.push(255*l[t]),f.colors.push(255*l[t+1]),f.colors.push(255*l[t+2]),f.colors.push(255);else if(o){const t=o[0],e=o[1],i=o[2],s=h,r=null!==a&&a!==undefined?a:0,l=null!==n&&n!==undefined?n:255;for(let o=0;o<g;o++)f.colors.push(t),f.colors.push(e),f.colors.push(i),f.colors.push(s),f.metallicRoughness.push(r),f.metallicRoughness.push(l)}if(s)for(let t=0,e=s.length;t<e;t++)f.indices.push(s[t]+_);if(r)for(let t=0,e=r.length;t<e;t++)f.edgeIndices.push(r[t]+_);{const t=f.pickColors.length;for(let e=t,i=t+4*g;e<i;e+=4)f.pickColors.push(p[0]),f.pickColors.push(p[1]),f.pickColors.push(p[2]),f.pickColors.push(p[3])}if(this.model.scene.entityOffsetsEnabled)for(let t=0;t<g;t++)f.offsets.push(0),f.offsets.push(0),f.offsets.push(0);const v=this._portions.length/2;return this._portions.push(_),this._portions.push(g),this._numPortions++,this.model.numPortions++,v}finalize(){if(this._finalized)return void this.model.error("Already finalized");const t=this._state,e=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0)if(this._preCompressed){t.positionsDecodeMatrix=this._positionsDecodeMatrix;const s=new Uint16Array(i.positions);t.positionsBuf=new j(e,e.ARRAY_BUFFER,s,i.positions.length,3,e.STATIC_DRAW)}else{const s=ls(i.positions,this._modelAABB,t.positionsDecodeMatrix);t.positionsBuf=new j(e,e.ARRAY_BUFFER,s,i.positions.length,3,e.STATIC_DRAW)}if(i.normals.length>0){const s=new Int8Array(i.normals);let r=!0;t.normalsBuf=new j(e,e.ARRAY_BUFFER,s,i.normals.length,3,e.STATIC_DRAW,r)}if(i.colors.length>0){const s=new Uint8Array(i.colors);let r=!1;t.colorsBuf=new j(e,e.ARRAY_BUFFER,s,i.colors.length,4,e.DYNAMIC_DRAW,r)}if(i.metallicRoughness.length>0){const s=new Uint8Array(i.metallicRoughness);let r=!1;t.metallicRoughnessBuf=new j(e,e.ARRAY_BUFFER,s,i.metallicRoughness.length,2,e.STATIC_DRAW,r)}if(i.colors.length>0){const s=i.colors.length,r=new Uint8Array(s),o=new Uint8Array(s);let a=!1,n=!0;t.flagsBuf=new j(e,e.ARRAY_BUFFER,r,r.length,4,e.DYNAMIC_DRAW,a),t.flags2Buf=new j(e,e.ARRAY_BUFFER,o,o.length,4,e.DYNAMIC_DRAW,n)}if(i.pickColors.length>0){const s=new Uint8Array(i.pickColors);let r=!1;t.pickColorsBuf=new j(e,e.ARRAY_BUFFER,s,i.pickColors.length,4,e.STATIC_DRAW,r)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){const s=new Float32Array(i.offsets);t.offsetsBuf=new j(e,e.ARRAY_BUFFER,s,i.offsets.length,3,e.DYNAMIC_DRAW)}const s=C.SUPPORTED_EXTENSIONS.OES_element_index_uint;if(i.indices.length>0){const r=s?new Uint32Array(i.indices):new Uint16Array(i.indices);t.indicesBuf=new j(e,e.ELEMENT_ARRAY_BUFFER,r,i.indices.length,1,e.STATIC_DRAW)}if(i.edgeIndices.length>0){const r=s?new Uint32Array(i.edgeIndices):new Uint16Array(i.edgeIndices);t.edgeIndicesBuf=new j(e,e.ELEMENT_ARRAY_BUFFER,r,i.edgeIndices.length,1,e.STATIC_DRAW)}this._buffer=null,this._finalized=!0}initFlags(t,e,i){e&ei&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&ni&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&ai&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&li&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&ri&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),e&hi&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),e&si&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),e&ii&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(t,e,i),this._setFlags2(t,e)}setVisible(t,e,i){if(!this._finalized)throw"Not finalized";e&ei?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e,i)}setHighlighted(t,e,i){if(!this._finalized)throw"Not finalized";e&ni?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e,i)}setXRayed(t,e,i){if(!this._finalized)throw"Not finalized";e&ai?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e,i)}setSelected(t,e,i){if(!this._finalized)throw"Not finalized";e&li?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e,i)}setEdges(t,e,i){if(!this._finalized)throw"Not finalized";e&hi?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(t,e,i)}setClippable(t,e){if(!this._finalized)throw"Not finalized";e&ri?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(t,e)}setCulled(t,e,i){if(!this._finalized)throw"Not finalized";e&ii?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(t,e,i)}setCollidable(t,e){if(!this._finalized)throw"Not finalized"}setPickable(t,e,i){if(!this._finalized)throw"Not finalized";e&si?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(t,e,i)}setColor(t,e){if(!this._finalized)throw"Not finalized";const i=2*t,s=4*this._portions[i],r=4*this._portions[i+1],o=this._scratchMemory.getUInt8Array(r),a=e[0],n=e[1],l=e[2],h=e[3];for(let t=0;t<r;t+=4)o[t+0]=a,o[t+1]=n,o[t+2]=l,o[t+3]=h;this._state.colorsBuf.setData(o,s,r)}setTransparent(t,e,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(t,e,i)}_setFlags(t,e,i){if(!this._finalized)throw"Not finalized";const s=2*t,r=4*this._portions[s],o=4*this._portions[s+1],a=this._scratchMemory.getUInt8Array(o),n=!!(e&ei),l=!!(e&ai),h=!!(e&ni),u=!!(e&li),c=!!(e&ii);let d,p;d=!n||c||l?_i:i?mi:gi,p=!n||c?_i:u?Pi:h?vi:l?bi:_i;let f=0;f=!n||c?_i:u?wi:h?Mi:l?Ei:!!(e&hi)?i?xi:yi:_i;let _=n&&!c&&!!(e&si)?Ci:_i;for(let t=0;t<o;t+=4)a[t+0]=d,a[t+1]=p,a[t+2]=f,a[t+3]=_;this._state.flagsBuf.setData(a,r,o)}_setFlags2(t,e){if(!this._finalized)throw"Not finalized";const i=2*t,s=4*this._portions[i],r=4*this._portions[i+1],o=this._scratchMemory.getUInt8Array(r),a=e&ri?255:0;for(let t=0;t<r;t+=4)o[t+0]=a;this._state.flags2Buf.setData(o,s,r)}setOffset(t,e){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled)return void this.model.error("Entity#offset not enabled for this Viewer");const i=2*t,s=3*this._portions[i],r=3*this._portions[i+1],o=this._scratchMemory.getFloat32Array(r),a=e[0],n=e[1],l=e[2];for(let t=0;t<r;t+=3)o[t+0]=a,o[t+1]=n,o[t+2]=l;this._state.offsetsBuf.setData(o,s,r)}drawColorOpaque(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),e.withSAO&&this.model.saoEnabled?e.pbrEnabled&&this.model.pbrEnabled?this._batchingRenderers.colorQualityRendererWithSAO&&this._batchingRenderers.colorQualityRendererWithSAO.drawLayer(e,this,gi):this._batchingRenderers.colorRendererWithSAO&&this._batchingRenderers.colorRendererWithSAO.drawLayer(e,this,gi):e.pbrEnabled&&this.model.pbrEnabled?this._batchingRenderers.colorQualityRenderer&&this._batchingRenderers.colorQualityRenderer.drawLayer(e,this,gi):this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(e,this,gi))}_updateBackfaceCull(t,e){const i=this.model.backfaces||!this.solid||t.sectioned;if(e.backfaces!==i){const t=e.gl;i?t.disable(t.CULL_FACE):t.enable(t.CULL_FACE),e.backfaces=i}}drawColorTransparent(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),e.pbrEnabled&&this.model.pbrEnabled?this._batchingRenderers.colorQualityRenderer&&this._batchingRenderers.colorQualityRenderer.drawLayer(e,this,mi):this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(e,this,mi))}drawDepth(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.depthRenderer&&this._batchingRenderers.depthRenderer.drawLayer(e,this,gi))}drawNormals(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.normalsRenderer&&this._batchingRenderers.normalsRenderer.drawLayer(e,this,gi))}drawSilhouetteXRayed(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(e,this,bi))}drawSilhouetteHighlighted(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(e,this,vi))}drawSilhouetteSelected(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(e,this,Pi))}drawEdgesColorOpaque(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._batchingRenderers.edgesColorRenderer&&this._batchingRenderers.edgesColorRenderer.drawLayer(e,this,yi)}drawEdgesColorTransparent(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&0!==this._numTransparentLayerPortions&&this._batchingRenderers.edgesColorRenderer&&this._batchingRenderers.edgesColorRenderer.drawLayer(e,this,xi)}drawEdgesHighlighted(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._batchingRenderers.edgesRenderer&&this._batchingRenderers.edgesRenderer.drawLayer(e,this,Mi)}drawEdgesSelected(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._batchingRenderers.edgesRenderer&&this._batchingRenderers.edgesRenderer.drawLayer(e,this,wi)}drawEdgesXRayed(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._batchingRenderers.edgesRenderer&&this._batchingRenderers.edgesRenderer.drawLayer(e,this,Ei)}drawOcclusion(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.occlusionRenderer&&this._batchingRenderers.occlusionRenderer.drawLayer(e,this,gi))}drawShadow(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.shadowRenderer&&this._batchingRenderers.shadowRenderer.drawLayer(e,this,gi))}drawPickMesh(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.pickMeshRenderer&&this._batchingRenderers.pickMeshRenderer.drawLayer(e,this,Ci))}drawPickDepths(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.pickDepthRenderer&&this._batchingRenderers.pickDepthRenderer.drawLayer(e,this,Ci))}drawPickNormals(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.pickNormalsRenderer&&this._batchingRenderers.pickNormalsRenderer.drawLayer(e,this,Ci))}destroy(){const t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.offsetsBuf&&(t.offsetsBuf.destroy(),t.offsetsBuf=null),t.normalsBuf&&(t.normalsBuf.destroy(),t.normalsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.metallicRoughnessBuf&&(t.metallicRoughnessBuf.destroy(),t.metallicRoughnessBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.pickColorsBuf&&(t.pickColorsBuf.destroy(),t.pickColorsBuf=null),t.indicesBuf&&(t.indicesBuf.destroy(),t.indicessBuf=null),t.edgeIndicesBuf&&(t.edgeIndicesBuf.destroy(),t.edgeIndicessBuf=null),t.destroy()}}const bs=M.vec4(),ys=M.vec3();class xs{constructor(t,e){this._scene=t,this._withSAO=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const t=this._scene;return[t._lightsState.getHash(),t._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?R(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,s.worldNormalMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=B(i.dist,i.dir,h,ys);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0.bindArrayBuffer(n.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(n.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(n.modelNormalMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aNormal.bindArrayBuffer(n.normalsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._lightsState;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(let t=0,e=r.length;t<e;t++)switch(o=r[t],o.type){case"dir":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=null,this._uLightDir[t]=s.getLocation("lightDir"+t);break;case"point":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=s.getLocation("lightPos"+t),this._uLightDir[t]=null,this._uLightAttenuation[t]=s.getLocation("lightAttenuation"+t);break;case"spot":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=s.getLocation("lightPos"+t),this._uLightDir[t]=s.getLocation("lightDir"+t),this._uLightAttenuation[t]=s.getLocation("lightAttenuation"+t)}this._uSectionPlanes=[];for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aNormal=s.getAttribute("normal"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aOffset=s.getAttribute("offset"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=s.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=s.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=s.getAttribute("modelNormalMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(t){const e=this._scene,i=e.canvas.gl,s=e._lightsState.lights,r=e.camera.project;this._program.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,e._lightsState.getAmbientColorAndIntensity());for(let t=0,e=s.length;t<e;t++){const e=s[t];this._uLightColor[t]&&i.uniform4f(this._uLightColor[t],e.color[0],e.color[1],e.color[2],e.intensity),this._uLightPos[t]&&(i.uniform3fv(this._uLightPos[t],e.pos),this._uLightAttenuation[t]&&i.uniform1f(this._uLightAttenuation[t],e.attenuation)),this._uLightDir[t]&&i.uniform3fv(this._uLightDir[t],e.dir)}if(this._withSAO){const s=e.sao;if(s.possible){const e=i.drawingBufferWidth,r=i.drawingBufferHeight;bs[0]=e,bs[1]=r,bs[2]=s.blendCutoff,bs[3]=s.blendFactor,i.uniform4fv(this._uSAOParams,bs),this._program.bindTexture(this._uOcclusionTexture,t.occlusionTexture,0)}}if(e.logarithmicDepthBufferEnabled){const t=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState,i=t._lightsState,s=e.sectionPlanes.length>0;let r,o,a;const n=[];for(n.push("// Instancing geometry drawing vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("#extension GL_EXT_frag_depth : enable"),n.push("uniform int renderPass;"),n.push("attribute vec3 position;"),n.push("attribute vec2 normal;"),n.push("attribute vec4 color;"),n.push("attribute vec4 flags;"),n.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&n.push("attribute vec3 offset;"),n.push("attribute vec4 modelMatrixCol0;"),n.push("attribute vec4 modelMatrixCol1;"),n.push("attribute vec4 modelMatrixCol2;"),n.push("attribute vec4 modelNormalMatrixCol0;"),n.push("attribute vec4 modelNormalMatrixCol1;"),n.push("attribute vec4 modelNormalMatrixCol2;"),n.push("uniform mat4 worldMatrix;"),n.push("uniform mat4 worldNormalMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 viewNormalMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("varying float vFragDepth;")),n.push("uniform vec4 lightAmbient;"),r=0,o=i.lights.length;r<o;r++)a=i.lights[r],"ambient"!==a.type&&(n.push("uniform vec4 lightColor"+r+";"),"dir"===a.type&&n.push("uniform vec3 lightDir"+r+";"),"point"===a.type&&n.push("uniform vec3 lightPos"+r+";"),"spot"===a.type&&(n.push("uniform vec3 lightPos"+r+";"),n.push("uniform vec3 lightDir"+r+";")));for(n.push("vec3 octDecode(vec2 oct) {"),n.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),n.push("    if (v.z < 0.0) {"),n.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),n.push("    }"),n.push("    return normalize(v);"),n.push("}"),s&&(n.push("varying vec4 vWorldPosition;"),n.push("varying vec4 vFlags2;")),n.push("varying vec4 vColor;"),n.push("void main(void) {"),n.push("if (int(flags.x) != renderPass) {"),n.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),n.push("} else {"),n.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),n.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&n.push("      worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition  = viewMatrix * worldPosition; "),n.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),n.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 0.0);"),n.push("vec3 viewNormal = normalize(vec4(viewNormalMatrix * worldNormal).xyz);"),n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;"),r=0,o=i.lights.length;r<o;r++)if(a=i.lights[r],"ambient"!==a.type){if("dir"===a.type)"view"===a.space?n.push("viewLightDir = normalize(lightDir"+r+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+r+", 0.0)).xyz);");else if("point"===a.type)"view"===a.space?n.push("viewLightDir = -normalize(lightPos"+r+" - viewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+r+", 0.0)).xyz);");else{if("spot"!==a.type)continue;"view"===a.space?n.push("viewLightDir = normalize(lightDir"+r+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+r+", 0.0)).xyz);")}n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+r+".rgb * lightColor"+r+".a);")}return n.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),n.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),n.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?n.push("vFragDepth = 1.0 + clipPos.w;"):(n.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),n.push("clipPos.z *= clipPos.w;"))),s&&(n.push("vWorldPosition = worldPosition;"),n.push("vFlags2 = flags2;")),n.push("gl_Position = clipPos;"),n.push("}"),n.push("}"),n}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState;const i=e.sectionPlanes.length>0,s=[];if(s.push("// Instancing geometry drawing fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBToFloat( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture2D(uOcclusionTexture, uv))) * blendFactor;"),s.push("   gl_FragColor            = vec4(vColor.rgb * ambient, 1.0);")):s.push("    gl_FragColor           = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ms=M.vec3();class ws{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(!this._program&&(this._allocate(e.model.scene),this.errors))return;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===bi){const t=r.xrayMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===vi){const t=r.highlightMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===Pi){const t=r.selectedMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else a.uniform4fv(this._uColor,M.vec3([1,1,1]));a.uniformMatrix4fv(this._uViewMatrix,!1,h?R(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=B(i.dist,i.dir,h,Ms);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uColor=s.getLocation("color"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing fill vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),i.push("uniform vec4 color;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Instancing fill fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("uniform vec4 color;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = color;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Es=M.vec3(),Cs=new Float32Array([0,0,0,1]);class As{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(!this._program&&(this._allocate(e),this.errors))return;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===Ei){const t=r.xrayMaterial._state,e=t.edgeColor,i=t.edgeAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===Mi){const t=r.highlightMaterial._state,e=t.edgeColor,i=t.edgeAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===wi){const t=r.selectedMaterial._state,e=t.edgeColor,i=t.edgeAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else a.uniform4fv(this._uColor,Cs);a.uniformMatrix4fv(this._uViewMatrix,!1,h?R(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=B(i.dist,i.dir,h,Es);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags&&(this._aFlags.bindArrayBuffer(n.flagsBuf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1)),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.edgeIndicesBuf.bind(),l.drawElementsInstancedANGLE(a.LINES,n.edgeIndicesBuf.numItems,n.edgeIndicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0),this._aFlags&&l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uColor=s.getLocation("color"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles instancing edges vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("uniform vec4 color;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(color.r, color.g, color.b, color.a);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry edges drawing fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ss=M.vec3();class Ds{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?R(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=B(i.dist,i.dir,h,Ss);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags&&(this._aFlags.bindArrayBuffer(n.flagsBuf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1)),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.edgeIndicesBuf.bind(),l.drawElementsInstancedANGLE(a.LINES,n.edgeIndicesBuf.numItems,n.edgeIndicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0),this._aFlags&&l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aColor=s.getAttribute("color"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles instancing edges vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry edges drawing fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ls=M.vec3();class Rs{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i);const u=t.pickViewMatrix||o.viewMatrix,c=h?R(u,h):u;if(a.uniformMatrix4fv(this._uViewMatrix,!1,c),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,t)}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPickColor.bindArrayBuffer(n.pickColorsBuf),l.vertexAttribDivisorANGLE(this._aPickColor.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind();const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*d,o=s.renderFlags;for(let e=0;e<d;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=B(i.dist,i.dir,h,Ls);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aPickColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uPickInvisible=s.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._uRenderPass=s.getLocation("renderPass"),this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aPickColor=s.getAttribute("pickColor"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(t){const e=this._scene.canvas.gl;this._program.bind(),e.uniform1i(this._uPickInvisible,t.pickInvisible)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry picking vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 pickColor;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vPickColor;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),e&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry picking fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = vPickColor; "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Bs=M.vec3();class Ts{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.canvas.gl,a=e._state,n=this._instanceExt,l=e._state.rtcCenter;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram());const h=r.camera;o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,t.pickInvisible);const u=t.pickViewMatrix||h.viewMatrix,c=l?R(u,l):u;if(o.uniformMatrix4fv(this._uViewMatrix,!1,c),o.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),o.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),o.uniform1f(this._uPickZNear,t.pickZNear),o.uniform1f(this._uPickZFar,t.pickZFar),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(t.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,e)}const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*d,a=s.renderFlags;for(let e=0;e<d;e++){const s=this._uSectionPlanes[e],r=a.sectionPlanesActivePerLayer[i+e];if(o.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=B(i.dist,i.dir,l,Bs);o.uniform3fv(s.pos,t)}else o.uniform3fv(s.pos,i.pos);o.uniform3fv(s.dir,i.dir)}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisorANGLE(this._aOffset.location,1)),a.indicesBuf.bind(),n.drawElementsInstancedANGLE(o.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),n.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry depth vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vViewPosition;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("  vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry depth fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    gl_FragColor = packDepth(zNormalizedDepth); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Fs=M.vec3();class Ns{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,t.pickInvisible);const u=t.pickViewMatrix||o.viewMatrix,c=h?R(u,h):u;if(a.uniformMatrix4fv(this._uViewMatrix,!1,c),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,s.worldNormalMatrix),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,t)}const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*d,o=s.renderFlags;for(let e=0;e<d;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=B(i.dist,i.dir,h,Fs);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0.bindArrayBuffer(n.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(n.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(n.modelNormalMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aNormal.bindArrayBuffer(n.normalsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aNormal=s.getAttribute("normal"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=s.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=s.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=s.getAttribute("modelNormalMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry normals vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec2 normal;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("attribute vec4 modelNormalMatrixCol0;"),i.push("attribute vec4 modelNormalMatrixCol1;"),i.push("attribute vec4 modelNormalMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec3 vWorldNormal;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),i.push("  vec3 worldNormal = vec3(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2));"),i.push("  vWorldNormal = worldNormal;"),e&&i.push("  vWorldPosition = worldPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry normals fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec3 vWorldNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    gl_FragColor = vec4((vWorldNormal * 0.5) + 0.5, 1.0);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Os=M.vec3();class ks{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?R(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=B(i.dist,i.dir,h,Os);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aColor&&(this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1)),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),this._aColor&&l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing occlusion vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&i.push("  vWorldPosition = worldPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Instancing occlusion fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Is=M.vec3();class zs{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,h?R(o.viewMatrix,h):o.viewMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=B(i.dist,i.dir,h,Is);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry depth drawing vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec2 vHighPrecisionZW;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState;let i,s;const r=e.sectionPlanes.length>0,o=[];if(o.push("// Instancing geometry depth drawing fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("precision highp float;"),o.push("precision highp int;"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;")),r)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(C.SUPPORTED_EXTENSIONS.WEBGL_depth_texture||(o.push("const float   packUpScale = 256. / 255.;"),o.push("const float   unpackDownscale = 255. / 256.;"),o.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),o.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),o.push("const float   shiftRight8 = 1.0 / 256.;"),o.push("vec4 packDepthToRGBA( const in float v ) {"),o.push("    vec4 r = vec4( fract( v * packFactors ), v );"),o.push("    r.yzw -= r.xyz * shiftRight8;"),o.push("    return r * packUpScale;"),o.push("}")),o.push("varying vec2 vHighPrecisionZW;"),o.push("void main(void) {"),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),C.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?o.push("    gl_FragColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "):o.push("    gl_FragColor = packDepthToRGBA(fragCoordZ); "),o.push("}"),o}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Vs=M.vec3();class Us{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?R(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,s.worldNormalMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=B(i.dist,i.dir,h,Vs);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aNormal.bindArrayBuffer(n.normalsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aNormal=s.getAttribute("normal"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2&&(this._aFlags2=s.getAttribute("flags2")),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry normals drawing vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec3 normal;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 worldNormalMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 viewNormalMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec3 vViewNormal;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("  vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("  vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Instancing geometry depth drawing fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Gs=M.vec3();class Xs{constructor(t){this._scene=t,this._hash=this._getHash(),this._lastLightId=null,this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e){const i=e.model,s=i.scene,r=s.canvas.gl,o=e._state,a=this._instanceExt;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e)),r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),a.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aColor.bindArrayBuffer(o.colorsBuf),a.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(o.flagsBuf),a.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),a.vertexAttribDivisorANGLE(this._aFlags2.location,1));const n=s._sectionPlanesState.sectionPlanes.length;if(n>0){const t=s._sectionPlanesState.sectionPlanes,o=e.layerIndex*n,a=i.renderFlags,l=e._state.rtcCenter;for(let e=0;e<n;e++){const i=this._uSectionPlanes[e],s=a.sectionPlanesActivePerLayer[o+e];if(r.uniform1i(i.active,s?1:0),s){const s=t[e];if(l){const t=B(s.dist,s.dir,l,Gs);r.uniform3fv(i.pos,t)}else r.uniform3fv(i.pos,s.pos);r.uniform3fv(i.dir,s.dir)}}}o.indicesBuf.bind(),a.drawElementsInstancedANGLE(r.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0,o.numInstances),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),a.vertexAttribDivisorANGLE(this._aColor.location,0),a.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&a.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&a.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uShadowViewMatrix=s.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=s.getLocation("shadowProjMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2")}_bindProgram(t,e){const i=this._scene.canvas.gl;this._program.bind(),i.uniformMatrix4fv(this._uShadowViewMatrix,!1,t.shadowViewMatrix),i.uniformMatrix4fv(this._uShadowProjMatrix,!1,t.shadowProjMatrix),this._lastLightId=null}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry shadow drawing vertex shader"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("bool visible      = (float(flags.x) > 0.0);"),i.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),i.push("if (!visible || transparent) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("  gl_Position = shadowProjMatrix * viewPosition;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Instancing geometry depth drawing fragment shader"),t.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const js=M.vec4(),Ws=M.vec3(),Hs={linear:"linearToLinear",sRGB:"sRGBToLinear",gamma:"gammaToLinear"};class Ys{constructor(t,e){this._scene=t,this._withSAO=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const t=this._scene;return[t.gammaOutput,t._lightsState.getHash(),t._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(t,e,i){const s=e.model,r=this._scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?R(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,s.worldNormalMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=B(i.dist,i.dir,h,Ws);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0.bindArrayBuffer(n.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(n.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(n.modelNormalMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aNormal.bindArrayBuffer(n.normalsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aMetallicRoughness.bindArrayBuffer(n.metallicRoughnessBuf),l.vertexAttribDivisorANGLE(this._aMetallicRoughness.location,1),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aMetallicRoughness.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._lightsState;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uGammaFactor=s.getLocation("gammaFactor"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(var a=0,n=r.length;a<n;a++)switch(o=r[a],o.type){case"dir":this._uLightColor[a]=s.getLocation("lightColor"+a),this._uLightPos[a]=null,this._uLightDir[a]=s.getLocation("lightDir"+a);break;case"point":this._uLightColor[a]=s.getLocation("lightColor"+a),this._uLightPos[a]=s.getLocation("lightPos"+a),this._uLightDir[a]=null,this._uLightAttenuation[a]=s.getLocation("lightAttenuation"+a);break;case"spot":this._uLightColor[a]=s.getLocation("lightColor"+a),this._uLightPos[a]=s.getLocation("lightPos"+a),this._uLightDir[a]=s.getLocation("lightDir"+a),this._uLightAttenuation[a]=s.getLocation("lightAttenuation"+a)}i.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),i.lightMaps.length>0&&(this._uLightMap="lightMap"),this._uSectionPlanes=[];for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aNormal=s.getAttribute("normal"),this._aColor=s.getAttribute("color"),this._aMetallicRoughness=s.getAttribute("metallicRoughness"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aOffset=s.getAttribute("offset"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=s.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=s.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=s.getAttribute("modelNormalMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(t){const e=C.MAX_TEXTURE_UNITS,i=this._scene,s=i.canvas.gl,r=i._lightsState,o=r.lights,a=i.camera.project;this._program.bind(),s.uniformMatrix4fv(this._uProjMatrix,!1,a.matrix),this._uLightAmbient&&s.uniform4fv(this._uLightAmbient,i._lightsState.getAmbientColorAndIntensity());for(let t=0,e=o.length;t<e;t++){const e=o[t];this._uLightColor[t]&&s.uniform4f(this._uLightColor[t],e.color[0],e.color[1],e.color[2],e.intensity),this._uLightPos[t]&&(s.uniform3fv(this._uLightPos[t],e.pos),this._uLightAttenuation[t]&&s.uniform1f(this._uLightAttenuation[t],e.attenuation)),this._uLightDir[t]&&s.uniform3fv(this._uLightDir[t],e.dir)}if(r.reflectionMaps.length>0&&r.reflectionMaps[0].texture&&this._uReflectionMap&&(this._program.bindTexture(this._uReflectionMap,r.reflectionMaps[0].texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++),r.lightMaps.length>0&&r.lightMaps[0].texture&&this._uLightMap&&(this._program.bindTexture(this._uLightMap,r.lightMaps[0].texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++),this._withSAO){const r=i.sao;if(r.possible){const i=s.drawingBufferWidth,o=s.drawingBufferHeight;js[0]=i,js[1]=o,js[2]=r.blendCutoff,js[3]=r.blendFactor,s.uniform4fv(this._uSAOParams,js),this._program.bindTexture(this._uOcclusionTexture,t.occlusionTexture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++}}if(i.logarithmicDepthBufferEnabled){const t=2/(Math.log(a.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,t)}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState,i=t._lightsState,s=e.sectionPlanes.length>0,r=e.clippingCaps,o=[];return o.push("// Instancing geometry quality drawing vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("uniform int renderPass;"),o.push("attribute vec3 position;"),o.push("attribute vec2 normal;"),o.push("attribute vec4 color;"),o.push("attribute vec2 metallicRoughness;"),o.push("attribute vec4 flags;"),o.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&o.push("attribute vec3 offset;"),o.push("attribute vec4 modelMatrixCol0;"),o.push("attribute vec4 modelMatrixCol1;"),o.push("attribute vec4 modelMatrixCol2;"),o.push("attribute vec4 modelNormalMatrixCol0;"),o.push("attribute vec4 modelNormalMatrixCol1;"),o.push("attribute vec4 modelNormalMatrixCol2;"),o.push("uniform mat4 worldMatrix;"),o.push("uniform mat4 worldNormalMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 viewNormalMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("varying float vFragDepth;")),o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),o.push("varying vec4 vViewPosition;"),o.push("varying vec3 vViewNormal;"),o.push("varying vec4 vColor;"),o.push("varying vec2 vMetallicRoughness;"),i.lightMaps.length>0&&o.push("varying vec3 vWorldNormal;"),s&&(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),r&&o.push("varying vec4 vClipPosition;")),o.push("void main(void) {"),o.push("if (int(flags.x) != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),o.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),o.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 0.0);"),o.push("vec3 viewNormal = vec4(viewNormalMatrix * worldNormal).xyz;"),o.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?o.push("vFragDepth = 1.0 + clipPos.w;"):(o.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),o.push("clipPos.z *= clipPos.w;"))),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags2 = flags2;"),r&&o.push("vClipPosition = clipPos;")),o.push("vViewPosition = viewPosition;"),o.push("vViewNormal = viewNormal;"),o.push("vColor = color;"),o.push("vMetallicRoughness = metallicRoughness;"),i.lightMaps.length>0&&o.push("vWorldNormal = worldNormal.xyz;"),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const t=this._scene,e=t.gammaOutput,i=t._sectionPlanesState,s=t._lightsState,r=i.sectionPlanes.length>0,o=i.clippingCaps,a=[];a.push("// Instancing geometry quality drawing fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;")),this._withSAO&&(a.push("uniform sampler2D uOcclusionTexture;"),a.push("uniform vec4      uSAOParams;"),a.push("const float       packUpscale = 256. / 255.;"),a.push("const float       unpackDownScale = 255. / 256.;"),a.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),a.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),a.push("float unpackRGBAToDepth( const in vec4 v ) {"),a.push("    return dot( v, unPackFactors );"),a.push("}")),s.reflectionMaps.length>0&&a.push("uniform samplerCube reflectionMap;"),s.lightMaps.length>0&&a.push("uniform samplerCube lightMap;"),a.push("uniform vec4 lightAmbient;");for(let t=0,e=s.lights.length;t<e;t++){const e=s.lights[t];"ambient"!==e.type&&(a.push("uniform vec4 lightColor"+t+";"),"dir"===e.type&&a.push("uniform vec3 lightDir"+t+";"),"point"===e.type&&a.push("uniform vec3 lightPos"+t+";"),"spot"===e.type&&(a.push("uniform vec3 lightPos"+t+";"),a.push("uniform vec3 lightDir"+t+";")))}if(a.push("uniform float gammaFactor;"),a.push("vec4 linearToLinear( in vec4 value ) {"),a.push("  return value;"),a.push("}"),a.push("vec4 sRGBToLinear( in vec4 value ) {"),a.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),a.push("}"),a.push("vec4 gammaToLinear( in vec4 value) {"),a.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),a.push("}"),e&&(a.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),a.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),a.push("}")),r){a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;"),o&&a.push("varying vec4 vClipPosition;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)a.push("uniform bool sectionPlaneActive"+t+";"),a.push("uniform vec3 sectionPlanePos"+t+";"),a.push("uniform vec3 sectionPlaneDir"+t+";")}if(a.push("varying vec4 vViewPosition;"),a.push("varying vec3 vViewNormal;"),a.push("varying vec4 vColor;"),a.push("varying vec2 vMetallicRoughness;"),s.lightMaps.length>0&&a.push("varying vec3 vWorldNormal;"),a.push("uniform mat4 viewMatrix;"),a.push("#define PI 3.14159265359"),a.push("#define RECIPROCAL_PI 0.31830988618"),a.push("#define RECIPROCAL_PI2 0.15915494"),a.push("#define EPSILON 1e-6"),a.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),a.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),a.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),a.push("}"),a.push("struct IncidentLight {"),a.push("   vec3 color;"),a.push("   vec3 direction;"),a.push("};"),a.push("struct ReflectedLight {"),a.push("   vec3 diffuse;"),a.push("   vec3 specular;"),a.push("};"),a.push("struct Geometry {"),a.push("   vec3 position;"),a.push("   vec3 viewNormal;"),a.push("   vec3 worldNormal;"),a.push("   vec3 viewEyeDir;"),a.push("};"),a.push("struct Material {"),a.push("   vec3    diffuseColor;"),a.push("   float   specularRoughness;"),a.push("   vec3    specularColor;"),a.push("   float   shine;"),a.push("};"),a.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),a.push("   float r = ggxRoughness + 0.0001;"),a.push("   return (2.0 / (r * r) - 2.0);"),a.push("}"),a.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),a.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),a.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),a.push("}"),s.reflectionMaps.length>0&&(a.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),a.push("   vec3 envMapColor = "+Hs[s.reflectionMaps[0].encoding]+"(textureCube(reflectionMap, reflectVec, mipLevel)).rgb;"),a.push("  return envMapColor;"),a.push("}")),a.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),a.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),a.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),a.push("}"),a.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   return 1.0 / ( gl * gv );"),a.push("}"),a.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   return 0.5 / max( gv + gl, EPSILON );"),a.push("}"),a.push("float D_GGX(const in float alpha, const in float dotNH) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),a.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float alpha = ( roughness * roughness );"),a.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),a.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),a.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),a.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),a.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),a.push("   vec3  F = F_Schlick( specularColor, dotLH );"),a.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),a.push("   float D = D_GGX( alpha, dotNH );"),a.push("   return F * (G * D);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),a.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),a.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),a.push("   vec4 r = roughness * c0 + c1;"),a.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),a.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),a.push("   return specularColor * AB.x + AB.y;"),a.push("}"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&(a.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),s.lightMaps.length>0&&(a.push("   vec3 irradiance = "+Hs[s.lightMaps[0].encoding]+"(textureCube(lightMap, geometry.worldNormal)).rgb;"),a.push("   irradiance *= PI;"),a.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),s.reflectionMaps.length>0&&(a.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),a.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),a.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),a.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),a.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),a.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),a.push("}")),a.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),a.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),a.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),a.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),a.push("}"),a.push("void main(void) {"),r){a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)a.push("if (sectionPlaneActive"+t+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),a.push("}");o?(a.push("  if (dist > (0.002 * vClipPosition.w)) {"),a.push("      discard;"),a.push("  }"),a.push("  if (dist > 0.0) { "),a.push("      gl_FragColor=vec4(1.0, 0.0, 0.0, 1.0);"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("  gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("  return;"),a.push("}")):(a.push("  if (dist > 0.0) { "),a.push("      discard;"),a.push("  }")),a.push("}")}a.push("IncidentLight  light;"),a.push("Material       material;"),a.push("Geometry       geometry;"),a.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),a.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),a.push("float alpha = float(vColor.a) / 255.0;"),a.push("vec3  diffuseColor = rgb;"),a.push("float specularF0 = 1.0;"),a.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),a.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),a.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),a.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),a.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),a.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);"),a.push("geometry.position      = vViewPosition.xyz;"),a.push("geometry.viewNormal    = -normalize(vViewNormal);"),a.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),s.lightMaps.length>0&&a.push("geometry.worldNormal   = normalize(vWorldNormal);"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&a.push("computePBRLightMapping(geometry, material, reflectedLight);");for(let t=0,e=s.lights.length;t<e;t++){const e=s.lights[t];if("ambient"!==e.type){if("dir"===e.type)"view"===e.space?a.push("light.direction = normalize(lightDir"+t+");"):a.push("light.direction = normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);");else if("point"===e.type)"view"===e.space?a.push("light.direction = normalize(lightPos"+t+" - vViewPosition.xyz);"):a.push("light.direction = normalize((viewMatrix * vec4(lightPos"+t+", 0.0)).xyz);");else{if("spot"!==e.type)continue;"view"===e.space?a.push("light.direction = normalize(lightDir"+t+");"):a.push("light.direction = normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);")}a.push("light.color =  lightColor"+t+".rgb * lightColor"+t+".a;"),a.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return a.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular);"),a.push("vec4 fragColor;"),this._withSAO?(a.push("   float viewportWidth     = uSAOParams[0];"),a.push("   float viewportHeight    = uSAOParams[1];"),a.push("   float blendCutoff       = uSAOParams[2];"),a.push("   float blendFactor       = uSAOParams[3];"),a.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),a.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture2D(uOcclusionTexture, uv))) * blendFactor;"),a.push("   fragColor            = vec4(outgoingLight.rgb * ambient, alpha);")):a.push("   fragColor            = vec4(outgoingLight.rgb, alpha);"),e&&a.push("fragColor = linearToGamma(fragColor, gammaFactor);"),a.push("gl_FragColor = fragColor;"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("}"),a}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Ks{constructor(t){this._scene=t}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._colorQualityRenderer&&!this._colorQualityRenderer.getValid()&&(this._colorQualityRenderer.destroy(),this._colorQualityRenderer=null),this._colorQualityRendererWithSAO&&!this._colorQualityRendererWithSAO.getValid()&&(this._colorQualityRendererWithSAO.destroy(),this._colorQualityRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new xs(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new xs(this._scene,!0)),this._colorRendererWithSAO}get colorQualityRenderer(){return this._colorQualityRenderer||(this._colorQualityRenderer=new Ys(this._scene,!1)),this._colorQualityRenderer}get colorQualityRendererWithSAO(){return this._colorQualityRendererWithSAO||(this._colorQualityRendererWithSAO=new Ys(this._scene,!0)),this._colorQualityRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new ws(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new zs(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new Us(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new As(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new Ds(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Rs(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new Ns(this._scene)),this._pickNormalsRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Ts(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new ks(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new Xs(this._scene)),this._shadowRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._colorQualityRenderer&&this._colorQualityRenderer.destroy(),this._colorQualityRendererWithSAO&&this._colorQualityRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy()}}const $s={};const qs=C.SUPPORTED_EXTENSIONS.OES_element_index_uint,Zs=new Uint8Array(4),Qs=M.vec4([0,0,0,1]),Js=M.vec4([0,0,0,1]),tr=M.vec4([0,0,0,1]),er=new Float32Array(3);class ir{constructor(t,e){this.sortId=(e.solid,"-solid"),this.layerIndex=e.layerIndex,this._instancingRenderers=function(t){const e=t.id;let i=$s[e];return i||(i=new Ks(t),$s[e]=i,i._compile(),t.on("compile",(()=>{i._compile()})),t.on("destroyed",(()=>{delete $s[e],i._destroy()}))),i}(t.scene),this.model=t,this._aabb=M.collapseAABB3();const i={positionsDecodeMatrix:M.mat4(),numInstances:0,obb:M.OBB3(),rtcCenter:null},s=!!e.positionsDecodeMatrix,r=this.model.scene.canvas.gl;if(e.positions)if(s){let t=!1;i.positionsBuf=new j(r,r.ARRAY_BUFFER,e.positions,e.positions.length,3,r.STATIC_DRAW,t),i.positionsDecodeMatrix.set(e.positionsDecodeMatrix);let s=M.collapseAABB3();M.expandAABB3Points3(s,e.positions),kt.decompressAABB(s,i.positionsDecodeMatrix),M.AABB3ToOBB3(s,i.obb)}else{let t=e.positions.length,s=M.collapseAABB3();M.expandAABB3Points3(s,e.positions),M.AABB3ToOBB3(s,i.obb);const o=ls(e.positions,s,i.positionsDecodeMatrix);let a=!1;i.positionsBuf=new j(r,r.ARRAY_BUFFER,o,t,3,r.STATIC_DRAW,a)}if(e.normals)if(s){const t=!0;i.normalsBuf=new j(r,r.ARRAY_BUFFER,e.normals,e.normals.length,3,r.STATIC_DRAW,t)}else{const t=function(t){const e=t.length,i=new Int8Array(e);let s,r,o,a,n;for(let l=0;l<e;l+=3)o=s=us(t,l,"floor","floor"),r=cs(s),a=n=ds(t,l),s=us(t,l,"ceil","floor"),r=cs(s),a=ds(t,l),a>n&&(o=s,n=a),s=us(t,l,"floor","ceil"),r=cs(s),a=ds(t,l),a>n&&(o=s,n=a),s=us(t,l,"ceil","ceil"),r=cs(s),a=ds(t,l),a>n&&(o=s,n=a),i[l+0]=o[0],i[l+1]=o[1],i[l+2]=0;return new Int8Array(i)}(e.normals),s=!0;i.normalsBuf=new j(r,r.ARRAY_BUFFER,t,t.length,3,r.STATIC_DRAW,s)}e.indices&&(i.indicesBuf=new j(r,r.ELEMENT_ARRAY_BUFFER,qs?new Uint32Array(e.indices):new Uint16Array(e.indices),e.indices.length,1,r.STATIC_DRAW));let o=e.edgeIndices;o||(o=Lt(e.positions,e.indices,null,e.edgeThreshold||10)),i.edgeIndicesBuf=new j(r,r.ELEMENT_ARRAY_BUFFER,qs?new Uint32Array(o):new Uint16Array(o),o.length,1,r.STATIC_DRAW),this._state=new nt(i),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.indices?e.indices.length/3:0,this._colors=[],this._metallicRoughness=[],this._pickColors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[],this._portions=[],e.rtcCenter&&(this._state.rtcCenter=M.vec3(e.rtcCenter)),this._finalized=!1,this.aabb=M.collapseAABB3(),this.solid=!!e.solid}createPortion(t){const e=t.color,i=t.metallic,s=t.roughness,r=t.opacity,o=t.meshMatrix,a=t.worldMatrix,n=t.aabb,l=t.pickColor;if(this._finalized)throw"Already finalized";const h=e[0],u=e[1],c=e[2];e[3];this._colors.push(h),this._colors.push(u),this._colors.push(c),this._colors.push(r),this._metallicRoughness.push(null!==i&&i!==undefined?i:0),this._metallicRoughness.push(null!==s&&s!==undefined?s:255),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(o[0]),this._modelMatrixCol0.push(o[4]),this._modelMatrixCol0.push(o[8]),this._modelMatrixCol0.push(o[12]),this._modelMatrixCol1.push(o[1]),this._modelMatrixCol1.push(o[5]),this._modelMatrixCol1.push(o[9]),this._modelMatrixCol1.push(o[13]),this._modelMatrixCol2.push(o[2]),this._modelMatrixCol2.push(o[6]),this._modelMatrixCol2.push(o[10]),this._modelMatrixCol2.push(o[14]);let d=M.transposeMat4(o,M.mat4()),p=M.inverseMat4(d);this._modelNormalMatrixCol0.push(p[0]),this._modelNormalMatrixCol0.push(p[4]),this._modelNormalMatrixCol0.push(p[8]),this._modelNormalMatrixCol0.push(p[12]),this._modelNormalMatrixCol1.push(p[1]),this._modelNormalMatrixCol1.push(p[5]),this._modelNormalMatrixCol1.push(p[9]),this._modelNormalMatrixCol1.push(p[13]),this._modelNormalMatrixCol2.push(p[2]),this._modelNormalMatrixCol2.push(p[6]),this._modelNormalMatrixCol2.push(p[10]),this._modelNormalMatrixCol2.push(p[14]),this._pickColors.push(l[0]),this._pickColors.push(l[1]),this._pickColors.push(l[2]),this._pickColors.push(l[3]),M.collapseAABB3(n);const f=this._state.obb,_=f.length;for(let t=0;t<_;t+=4)Qs[0]=f[t+0],Qs[1]=f[t+1],Qs[2]=f[t+2],M.transformPoint4(o,Qs,Js),a?(M.transformPoint4(a,Js,tr),M.expandAABB3Point3(n,tr)):M.expandAABB3Point3(n,Js);if(this._state.rtcCenter){const t=this._state.rtcCenter;n[0]+=t[0],n[1]+=t[1],n[2]+=t[2],n[3]+=t[0],n[4]+=t[1],n[5]+=t[2]}M.expandAABB3(this.aabb,n),this._state.numInstances++;const g=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,g}finalize(){if(this._finalized)throw"Already finalized";const t=this.model.scene.canvas.gl,e=this._colors.length,i=e;if(e>0){let e=!1;this._state.colorsBuf=new j(t,t.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,t.DYNAMIC_DRAW,e),this._colors=[]}if(this._metallicRoughness.length>0){const e=new Uint8Array(this._metallicRoughness);let i=!1;this._state.metallicRoughnessBuf=new j(t,t.ARRAY_BUFFER,e,this._metallicRoughness.length,2,t.STATIC_DRAW,i)}if(i>0){let e=!1,s=!0;this._state.flagsBuf=new j(t,t.ARRAY_BUFFER,new Uint8Array(i),i,4,t.DYNAMIC_DRAW,e),this._state.flags2Buf=new j(t,t.ARRAY_BUFFER,new Uint8Array(i),i,4,t.DYNAMIC_DRAW,s)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){const e=!1;this._state.offsetsBuf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,t.DYNAMIC_DRAW,e),this._offsets=[]}if(this._modelMatrixCol0.length>0){const e=!1;this._state.modelMatrixCol0Buf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,t.STATIC_DRAW,e),this._state.modelMatrixCol1Buf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,t.STATIC_DRAW,e),this._state.modelMatrixCol2Buf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,t.STATIC_DRAW,e),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._state.modelNormalMatrixCol0Buf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol0),this._modelNormalMatrixCol0.length,4,t.STATIC_DRAW,e),this._state.modelNormalMatrixCol1Buf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol1),this._modelNormalMatrixCol1.length,4,t.STATIC_DRAW,e),this._state.modelNormalMatrixCol2Buf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol2),this._modelNormalMatrixCol2.length,4,t.STATIC_DRAW,e),this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[]}if(this._pickColors.length>0){const e=!1;this._state.pickColorsBuf=new j(t,t.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,t.STATIC_DRAW,e),this._pickColors=[]}this._finalized=!0}initFlags(t,e,i){e&ei&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&ni&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&ai&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&li&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&ri&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),e&hi&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),e&si&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),e&ii&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(t,e,i),this._setFlags2(t,e)}setVisible(t,e,i){if(!this._finalized)throw"Not finalized";e&ei?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e,i)}setHighlighted(t,e,i){if(!this._finalized)throw"Not finalized";e&ni?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e,i)}setXRayed(t,e,i){if(!this._finalized)throw"Not finalized";e&ai?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e,i)}setSelected(t,e,i){if(!this._finalized)throw"Not finalized";e&li?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e,i)}setEdges(t,e,i){if(!this._finalized)throw"Not finalized";e&hi?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(t,e,i)}setClippable(t,e){if(!this._finalized)throw"Not finalized";e&ri?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(t,e)}setCollidable(t,e){if(!this._finalized)throw"Not finalized"}setPickable(t,e,i){if(!this._finalized)throw"Not finalized";e&si?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(t,e,i)}setCulled(t,e,i){if(!this._finalized)throw"Not finalized";e&ii?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(t,e,i)}setColor(t,e){if(!this._finalized)throw"Not finalized";Zs[0]=e[0],Zs[1]=e[1],Zs[2]=e[2],Zs[3]=e[3],this._state.colorsBuf.setData(Zs,4*t,4)}setTransparent(t,e,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(t,e,i)}_setFlags(t,e,i){if(!this._finalized)throw"Not finalized";const s=!!(e&ei),r=!!(e&ai),o=!!(e&ni),a=!!(e&li),n=!!(e&ii);let l,h;l=!s||n||r?_i:i?mi:gi,h=!s||n?_i:a?Pi:o?vi:r?bi:_i;let u=0;u=!s||n?_i:a?wi:o?Mi:r?Ei:!!(e&hi)?i?xi:yi:_i;let c=s&&!n&&!!(e&si)?Ci:_i;Zs[0]=l,Zs[1]=h,Zs[2]=u,Zs[3]=c,this._state.flagsBuf.setData(Zs,4*t,4)}_setFlags2(t,e){if(!this._finalized)throw"Not finalized";const i=e&ri?255:0;Zs[0]=i,this._state.flags2Buf.setData(Zs,4*t,4)}setOffset(t,e){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(er[0]=e[0],er[1]=e[1],er[2]=e[2],this._state.offsetsBuf.setData(er,3*t,3)):this.model.error("Entity#offset not enabled for this Viewer")}drawColorOpaque(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),e.withSAO&&this.model.saoEnabled?e.pbrEnabled&&this.model.pbrEnabled?this._instancingRenderers.colorQualityRendererWithSAO&&this._instancingRenderers.colorQualityRendererWithSAO.drawLayer(e,this,gi):this._instancingRenderers.colorRendererWithSAO&&this._instancingRenderers.colorRendererWithSAO.drawLayer(e,this,gi):e.pbrEnabled&&this.model.pbrEnabled?this._instancingRenderers.colorQualityRenderer&&this._instancingRenderers.colorQualityRenderer.drawLayer(e,this,gi):this._instancingRenderers.colorRenderer&&this._instancingRenderers.colorRenderer.drawLayer(e,this,gi))}_updateBackfaceCull(t,e){const i=this.model.backfaces||!this.solid||t.sectioned;if(e.backfaces!==i){const t=e.gl;i?t.disable(t.CULL_FACE):t.enable(t.CULL_FACE),e.backfaces=i}}drawColorTransparent(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),e.pbrEnabled&&this.model.pbrEnabled?this._instancingRenderers.colorQualityRenderer&&this._instancingRenderers.colorQualityRenderer.drawLayer(e,this,mi):this._instancingRenderers.colorRenderer&&this._instancingRenderers.colorRenderer.drawLayer(e,this,mi))}drawDepth(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.depthRenderer&&this._instancingRenderers.depthRenderer.drawLayer(e,this,gi))}drawNormals(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.normalsRenderer&&this._instancingRenderers.normalsRenderer.drawLayer(e,this,gi))}drawSilhouetteXRayed(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.silhouetteRenderer&&this._instancingRenderers.silhouetteRenderer.drawLayer(e,this,bi))}drawSilhouetteHighlighted(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.silhouetteRenderer&&this._instancingRenderers.silhouetteRenderer.drawLayer(e,this,vi))}drawSilhouetteSelected(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.silhouetteRenderer&&this._instancingRenderers.silhouetteRenderer.drawLayer(e,this,Pi))}drawEdgesColorOpaque(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._instancingRenderers.edgesColorRenderer&&this._instancingRenderers.edgesColorRenderer.drawLayer(e,this,yi)}drawEdgesColorTransparent(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._instancingRenderers.edgesColorRenderer&&this._instancingRenderers.edgesColorRenderer.drawLayer(e,this,xi)}drawEdgesXRayed(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._instancingRenderers.edgesRenderer&&this._instancingRenderers.edgesRenderer.drawLayer(e,this,Ei)}drawEdgesHighlighted(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._instancingRenderers.edgesRenderer&&this._instancingRenderers.edgesRenderer.drawLayer(e,this,Mi)}drawEdgesSelected(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._instancingRenderers.edgesRenderer&&this._instancingRenderers.edgesRenderer.drawLayer(e,this,wi)}drawOcclusion(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.occlusionRenderer&&this._instancingRenderers.occlusionRenderer.drawLayer(e,this,gi))}drawShadow(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.shadowRenderer&&this._instancingRenderers.shadowRenderer.drawLayer(e,this,gi))}drawPickMesh(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.pickMeshRenderer&&this._instancingRenderers.pickMeshRenderer.drawLayer(e,this,Ci))}drawPickDepths(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.pickDepthRenderer&&this._instancingRenderers.pickDepthRenderer.drawLayer(e,this,Ci))}drawPickNormals(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.pickNormalsRenderer&&this._instancingRenderers.pickNormalsRenderer.drawLayer(e,this,Ci))}destroy(){const t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.normalsBuf&&(t.normalsBuf.destroy(),t.normalsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.metallicRoughnessBuf&&(t.metallicRoughnessBuf.destroy(),t.metallicRoughnessBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.offsetsBuf&&(t.offsetsBuf.destroy(),t.offsetsBuf=null),t.modelMatrixCol0Buf&&(t.modelMatrixCol0Buf.destroy(),t.modelMatrixCol0Buf=null),t.modelMatrixCol1Buf&&(t.modelMatrixCol1Buf.destroy(),t.modelMatrixCol1Buf=null),t.modelMatrixCol2Buf&&(t.modelMatrixCol2Buf.destroy(),t.modelMatrixCol2Buf=null),t.modelNormalMatrixCol0Buf&&(t.modelNormalMatrixCol0Buf.destroy(),t.modelNormalMatrixCol0Buf=null),t.modelNormalMatrixCol1Buf&&(t.modelNormalMatrixCol1Buf.destroy(),t.modelNormalMatrixCol1Buf=null),t.modelNormalMatrixCol2Buf&&(t.modelNormalMatrixCol2Buf.destroy(),t.modelNormalMatrixCol2Buf=null),t.indicesBuf&&(t.indicesBuf.destroy(),t.indicessBuf=null),t.edgeIndicesBuf&&(t.edgeIndicesBuf.destroy(),t.edgeIndicessBuf=null),t.pickColorsBuf&&(t.pickColorsBuf.destroy(),t.pickColorsBuf=null),t.destroy()}}const sr=M.vec3();class rr{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=this._scene,r=s.camera,o=e.model,a=s.canvas.gl,n=e._state,l=e._state.rtcCenter;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?R(r.viewMatrix,l):r.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix),a.lineWidth(s.linesMaterial.lineWidth);const h=s._sectionPlanesState.sectionPlanes.length;if(h>0){const t=s._sectionPlanesState.sectionPlanes,i=e.layerIndex*h,r=o.renderFlags;for(let e=0;e<h;e++){const s=this._uSectionPlanes[e],o=r.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,o?1:0),o){const i=t[e];if(l){const t=B(i.dist,i.dir,l,sr);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(n.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),n.indicesBuf.bind(),a.drawElements(a.LINES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(t){const e=this._scene,i=e.canvas.gl,s=this._program,r=e.camera.project;if(s.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),e.logarithmicDepthBufferEnabled){const t=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Lines batching color vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Lines batching color fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor            = vColor;"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const or=new Float32Array([1,1,1]),ar=M.vec3();class nr{constructor(t,e){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.rtcCenter;if(!this._program&&(this._allocate(),this.errors))return;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===bi){const t=r.xrayMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===vi){const t=r.highlightMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===Pi){const t=r.selectedMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else a.uniform4fv(this._uColor,or);const h=l?R(o.viewMatrix,l):o.viewMatrix;a.uniformMatrix4fv(this._uViewMatrix,!1,h),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.lineWidth(r.linesMaterial.lineWidth);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=B(i.dist,i.dir,l,ar);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.LINES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uColor=i.getLocation("color"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Lines batching silhouette vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform vec4 color;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Lines batching silhouette fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("uniform vec4 color;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = color;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class lr{constructor(t){this._scene=t}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new rr(this._scene,!1)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new nr(this._scene)),this._silhouetteRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy()}}const hr={};const ur=C.SUPPORTED_EXTENSIONS.OES_element_index_uint;class cr{constructor(t=5e6){ur?t>5e6&&(t=5e6):t>65530&&(t=65530),this.maxVerts=t,this.maxIndices=3*t,this.positions=[],this.colors=[],this.flags=[],this.flags2=[],this.offsets=[],this.indices=[]}}const dr=M.vec4([0,0,0,1]),pr=M.vec4([0,0,0,1]),fr=M.vec4([0,0,0,1]),_r=M.OBB3();class gr{constructor(t,e){this.layerIndex=e.layerIndex,this._batchingRenderers=function(t){const e=t.id;let i=hr[e];return i||(i=new lr(t),hr[e]=i,i._compile(),t.on("compile",(()=>{i._compile()})),t.on("destroyed",(()=>{delete hr[e],i._destroy()}))),i}(t.scene),this.model=t,this._buffer=new cr(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new nt({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,flags2Buf:null,indicesBuf:null,positionsDecodeMatrix:M.mat4(),rtcCenter:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=M.collapseAABB3(),this._portions=[],this._finalized=!1,this._positionsDecodeMatrix=e.positionsDecodeMatrix,this._preCompressed=!!this._positionsDecodeMatrix,e.rtcCenter&&(this._state.rtcCenter=M.vec3(e.rtcCenter)),this.aabb=M.collapseAABB3()}canCreatePortion(t,e){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+t<3*this._buffer.maxVerts&&this._buffer.indices.length+e<this._buffer.maxIndices}createPortion(t){if(this._finalized)throw"Already finalized";const e=t.positions,i=t.indices,s=t.color,r=t.opacity,o=t.meshMatrix,a=t.worldMatrix,n=t.worldAABB,l=(t.pickColor,this._buffer),h=l.positions.length/3,u=e.length/3,c=e.length;if(this._preCompressed){for(let t=0,i=e.length;t<i;t++)l.positions.push(e[t]);const t=kt.getPositionsBounds(e),i=kt.decompressPosition(t.min,this._positionsDecodeMatrix,[]),s=kt.decompressPosition(t.max,this._positionsDecodeMatrix,[]);n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=s[0],n[4]=s[1],n[5]=s[2],a&&(M.AABB3ToOBB3(n,_r),M.transformOBB3(a,_r),M.OBB3ToAABB3(_r,n))}else{const t=l.positions.length;for(let t=0,i=e.length;t<i;t++)l.positions.push(e[t]);if(o)for(let e=t,i=t+c;e<i;e+=3)dr[0]=l.positions[e+0],dr[1]=l.positions[e+1],dr[2]=l.positions[e+2],M.transformPoint4(o,dr,pr),l.positions[e+0]=pr[0],l.positions[e+1]=pr[1],l.positions[e+2]=pr[2],M.expandAABB3Point3(this._modelAABB,pr),a?(M.transformPoint4(a,pr,fr),M.expandAABB3Point3(n,fr)):M.expandAABB3Point3(n,pr);else for(let e=t,i=t+c;e<i;e+=3)dr[0]=l.positions[e+0],dr[1]=l.positions[e+1],dr[2]=l.positions[e+2],M.expandAABB3Point3(this._modelAABB,dr),a?(M.transformPoint4(a,dr,pr),M.expandAABB3Point3(n,pr)):M.expandAABB3Point3(n,dr)}if(this._state.rtcCenter){const t=this._state.rtcCenter;n[0]+=t[0],n[1]+=t[1],n[2]+=t[2],n[3]+=t[0],n[4]+=t[1],n[5]+=t[2]}if(M.expandAABB3(this.aabb,n),s){const t=s[0],e=s[1],i=s[2],o=r;for(let s=0;s<u;s++)l.colors.push(t),l.colors.push(e),l.colors.push(i),l.colors.push(o)}if(i)for(let t=0,e=i.length;t<e;t++)l.indices.push(i[t]+h);if(this.model.scene.entityOffsetsEnabled)for(let t=0;t<u;t++)l.offsets.push(0),l.offsets.push(0),l.offsets.push(0);const d=this._portions.length/2;return this._portions.push(h),this._portions.push(u),this._numPortions++,this.model.numPortions++,d}finalize(){if(this._finalized)return void this.model.error("Already finalized");const t=this._state,e=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0)if(this._preCompressed){t.positionsDecodeMatrix=this._positionsDecodeMatrix;const s=new Uint16Array(i.positions);t.positionsBuf=new j(e,e.ARRAY_BUFFER,s,i.positions.length,3,e.STATIC_DRAW)}else{const s=ls(new Float32Array(i.positions),this._modelAABB,t.positionsDecodeMatrix);t.positionsBuf=new j(e,e.ARRAY_BUFFER,s,i.positions.length,3,e.STATIC_DRAW)}if(i.colors.length>0){const s=new Uint8Array(i.colors);let r=!1;t.colorsBuf=new j(e,e.ARRAY_BUFFER,s,i.colors.length,4,e.DYNAMIC_DRAW,r)}if(i.colors.length>0){const s=i.colors.length,r=new Uint8Array(s),o=new Uint8Array(s);let a=!1,n=!0;t.flagsBuf=new j(e,e.ARRAY_BUFFER,r,r.length,4,e.DYNAMIC_DRAW,a),t.flags2Buf=new j(e,e.ARRAY_BUFFER,o,o.length,4,e.DYNAMIC_DRAW,n)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){const s=new Float32Array(i.offsets);t.offsetsBuf=new j(e,e.ARRAY_BUFFER,s,i.offsets.length,3,e.DYNAMIC_DRAW)}const s=C.SUPPORTED_EXTENSIONS.OES_element_index_uint;if(i.indices.length>0){const r=s?new Uint32Array(i.indices):new Uint16Array(i.indices);t.indicesBuf=new j(e,e.ELEMENT_ARRAY_BUFFER,r,i.indices.length,1,e.STATIC_DRAW)}this._buffer=null,this._finalized=!0}initFlags(t,e,i){e&ei&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&ni&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&ai&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&li&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&ri&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),e&hi&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),e&si&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),e&ii&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(t,e,i),this._setFlags2(t,e)}setVisible(t,e,i){if(!this._finalized)throw"Not finalized";e&ei?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e,i)}setHighlighted(t,e,i){if(!this._finalized)throw"Not finalized";e&ni?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e,i)}setXRayed(t,e,i){if(!this._finalized)throw"Not finalized";e&ai?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e,i)}setSelected(t,e,i){if(!this._finalized)throw"Not finalized";e&li?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e,i)}setEdges(t,e,i){if(!this._finalized)throw"Not finalized";e&hi?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(t,e,i)}setClippable(t,e){if(!this._finalized)throw"Not finalized";e&ri?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(t,e)}setCulled(t,e,i){if(!this._finalized)throw"Not finalized";e&ii?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(t,e,i)}setCollidable(t,e){if(!this._finalized)throw"Not finalized"}setPickable(t,e,i){if(!this._finalized)throw"Not finalized";e&si?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(t,e,i)}setColor(t,e){if(!this._finalized)throw"Not finalized";const i=2*t,s=4*this._portions[i],r=4*this._portions[i+1],o=this._scratchMemory.getUInt8Array(r),a=e[0],n=e[1],l=e[2],h=e[3];for(let t=0;t<r;t+=4)o[t+0]=a,o[t+1]=n,o[t+2]=l,o[t+3]=h;this._state.colorsBuf.setData(o,s,r)}setTransparent(t,e,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(t,e,i)}_setFlags(t,e,i){if(!this._finalized)throw"Not finalized";const s=2*t,r=4*this._portions[s],o=4*this._portions[s+1],a=this._scratchMemory.getUInt8Array(o),n=!!(e&ei),l=!!(e&ai),h=!!(e&ii);let u,c;u=!n||h||l?_i:i?mi:gi,c=!n||h?_i:!!(e&li)?Pi:!!(e&ni)?vi:l?bi:_i;let d=n&&!h&&!!(e&si)?Ci:_i;for(let t=0;t<o;t+=4)a[t+0]=u,a[t+1]=c,a[t+2]=0,a[t+3]=d;this._state.flagsBuf.setData(a,r,o)}_setFlags2(t,e){if(!this._finalized)throw"Not finalized";const i=2*t,s=4*this._portions[i],r=4*this._portions[i+1],o=this._scratchMemory.getUInt8Array(r),a=e&ri?255:0;for(let t=0;t<r;t+=4)o[t+0]=a;this._state.flags2Buf.setData(o,s,r)}setOffset(t,e){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled)return void this.model.error("Entity#offset not enabled for this Viewer");const i=2*t,s=3*this._portions[i],r=3*this._portions[i+1],o=this._scratchMemory.getFloat32Array(r),a=e[0],n=e[1],l=e[2];for(let t=0;t<r;t+=3)o[t+0]=a,o[t+1]=n,o[t+2]=l;this._state.offsetsBuf.setData(o,s,r)}drawColorOpaque(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(e,this,gi)}drawColorTransparent(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(e,this,mi)}drawDepth(t,e){}drawNormals(t,e){}drawSilhouetteXRayed(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(e,this,bi)}drawSilhouetteHighlighted(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(e,this,vi)}drawSilhouetteSelected(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(e,this,Pi)}drawEdgesColorOpaque(t,e){}drawEdgesColorTransparent(t,e){}drawEdgesHighlighted(t,e){}drawEdgesSelected(t,e){}drawEdgesXRayed(t,e){}drawPickMesh(t){}drawPickDepths(t){}drawPickNormals(t){}drawOcclusion(t){}drawShadow(t){}destroy(){const t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.offsetsBuf&&(t.offsetsBuf.destroy(),t.offsetsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.indicesBuf&&(t.indicesBuf.destroy(),t.indicessBuf=null),t.destroy()}}const mr=M.vec3();class vr{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?R(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.lineWidth(r.linesMaterial.lineWidth);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=B(i.dist,i.dir,h,mr);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.LINES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aOffset=i.getAttribute("offset"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Lines instancing color vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),i.push("uniform vec4 lightAmbient;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0,  float(color.a) / 255.0);"),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState;let i,s;const r=e.sectionPlanes.length>0,o=[];if(o.push("// Lines instancing color fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;")),r)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("varying vec4 vColor;"),o.push("void main(void) {"),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}")}return this._withSAO?(o.push("   float viewportWidth     = uSAOParams[0];"),o.push("   float viewportHeight    = uSAOParams[1];"),o.push("   float blendCutoff       = uSAOParams[2];"),o.push("   float blendFactor       = uSAOParams[3];"),o.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),o.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture2D(uOcclusionTexture, uv))) * blendFactor;"),o.push("   gl_FragColor            = vec4(vColor.rgb * ambient, vColor.a);")):o.push("    gl_FragColor           = vColor;"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Pr=M.vec3();class br{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(!this._program&&(this._allocate(e.model.scene),this.errors))return;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===bi){const t=r.xrayMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===vi){const t=r.highlightMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===Pi){const t=r.selectedMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else a.uniform4fv(this._uColor,M.vec3([1,1,1]));a.uniformMatrix4fv(this._uViewMatrix,!1,h?R(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.lineWidth(r.linesMaterial.lineWidth);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=B(i.dist,i.dir,h,Pr);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.LINES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uColor=s.getLocation("color"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Lines instancing silhouette vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),i.push("uniform vec4 color;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Lines instancing silhouette fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("uniform vec4 color;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = color;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class yr{constructor(t){this._scene=t}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new vr(this._scene)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new br(this._scene)),this._silhouetteRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy()}}const xr={};const Mr=C.SUPPORTED_EXTENSIONS.OES_element_index_uint,wr=new Uint8Array(4),Er=M.vec4([0,0,0,1]),Cr=M.vec4([0,0,0,1]),Ar=M.vec4([0,0,0,1]),Sr=new Float32Array(3);class Dr{constructor(t,e){this.sortId="LinesInstancingLayer",this.layerIndex=e.layerIndex,this._linesInstancingRenderers=function(t){const e=t.id;let i=xr[e];return i||(i=new yr(t),xr[e]=i,i._compile(),t.on("compile",(()=>{i._compile()})),t.on("destroyed",(()=>{delete xr[e],i._destroy()}))),i}(t.scene),this.model=t,this._aabb=M.collapseAABB3();const i=t.scene.canvas.gl,s={positionsDecodeMatrix:M.mat4(),numInstances:0,obb:M.OBB3(),rtcCenter:null},r=!!e.positionsDecodeMatrix;if(e.positions)if(r){let t=!1;s.positionsBuf=new j(i,i.ARRAY_BUFFER,e.positions,e.positions.length,3,i.STATIC_DRAW,t),s.positionsDecodeMatrix.set(e.positionsDecodeMatrix);let r=M.collapseAABB3();M.expandAABB3Points3(r,e.positions),kt.decompressAABB(r,s.positionsDecodeMatrix),M.AABB3ToOBB3(r,s.obb)}else{let t=e.positions.length,r=M.collapseAABB3();M.expandAABB3Points3(r,e.positions),M.AABB3ToOBB3(r,s.obb);const o=ls(e.positions,r,s.positionsDecodeMatrix);let a=!1;s.positionsBuf=new j(i,i.ARRAY_BUFFER,o,t,3,i.STATIC_DRAW,a)}e.indices&&(s.indicesBuf=new j(i,i.ELEMENT_ARRAY_BUFFER,Mr?new Uint32Array(e.indices):new Uint16Array(e.indices),e.indices.length,1,i.STATIC_DRAW)),this._state=new nt(s),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.indices?e.indices.length/3:0,this._colors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],e.rtcCenter&&(this._state.rtcCenter=M.vec3(e.rtcCenter)),this._finalized=!1,this.aabb=M.collapseAABB3()}createPortion(t){const e=t.color,i=t.opacity,s=t.meshMatrix,r=t.worldMatrix,o=t.aabb;if(this._finalized)throw"Already finalized";const a=e[0],n=e[1],l=e[2];e[3];this._colors.push(a),this._colors.push(n),this._colors.push(l),this._colors.push(i),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(s[0]),this._modelMatrixCol0.push(s[4]),this._modelMatrixCol0.push(s[8]),this._modelMatrixCol0.push(s[12]),this._modelMatrixCol1.push(s[1]),this._modelMatrixCol1.push(s[5]),this._modelMatrixCol1.push(s[9]),this._modelMatrixCol1.push(s[13]),this._modelMatrixCol2.push(s[2]),this._modelMatrixCol2.push(s[6]),this._modelMatrixCol2.push(s[10]),this._modelMatrixCol2.push(s[14]),M.collapseAABB3(o);const h=this._state.obb,u=h.length;for(let t=0;t<u;t+=4)Er[0]=h[t+0],Er[1]=h[t+1],Er[2]=h[t+2],M.transformPoint4(s,Er,Cr),r?(M.transformPoint4(r,Cr,Ar),M.expandAABB3Point3(o,Ar)):M.expandAABB3Point3(o,Cr);if(this._state.rtcCenter){const t=this._state.rtcCenter;o[0]+=t[0],o[1]+=t[1],o[2]+=t[2],o[3]+=t[0],o[4]+=t[1],o[5]+=t[2]}M.expandAABB3(this.aabb,o),this._state.numInstances++;const c=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,c}finalize(){if(this._finalized)throw"Already finalized";const t=this.model.scene.canvas.gl,e=this._colors.length,i=e;if(e>0){let e=!1;this._state.colorsBuf=new j(t,t.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,t.DYNAMIC_DRAW,e),this._colors=[]}if(i>0){let e=!1,s=!0;this._state.flagsBuf=new j(t,t.ARRAY_BUFFER,new Uint8Array(i),i,4,t.DYNAMIC_DRAW,e),this._state.flags2Buf=new j(t,t.ARRAY_BUFFER,new Uint8Array(i),i,4,t.DYNAMIC_DRAW,s)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){const e=!1;this._state.offsetsBuf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,t.DYNAMIC_DRAW,e),this._offsets=[]}if(this._modelMatrixCol0.length>0){const e=!1;this._state.modelMatrixCol0Buf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,t.STATIC_DRAW,e),this._state.modelMatrixCol1Buf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,t.STATIC_DRAW,e),this._state.modelMatrixCol2Buf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,t.STATIC_DRAW,e),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]}this._finalized=!0}initFlags(t,e,i){e&ei&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&ni&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&ai&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&li&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&ri&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),e&hi&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),e&si&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),e&ii&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(t,e,i),this._setFlags2(t,e)}setVisible(t,e,i){if(!this._finalized)throw"Not finalized";e&ei?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e,i)}setHighlighted(t,e,i){if(!this._finalized)throw"Not finalized";e&ni?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e,i)}setXRayed(t,e,i){if(!this._finalized)throw"Not finalized";e&ai?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e,i)}setSelected(t,e,i){if(!this._finalized)throw"Not finalized";e&li?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e,i)}setEdges(t,e,i){if(!this._finalized)throw"Not finalized";e&hi?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(t,e,i)}setClippable(t,e){if(!this._finalized)throw"Not finalized";e&ri?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(t,e)}setCollidable(t,e){if(!this._finalized)throw"Not finalized"}setPickable(t,e,i){if(!this._finalized)throw"Not finalized";e&si?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(t,e,i)}setCulled(t,e,i){if(!this._finalized)throw"Not finalized";e&ii?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(t,e,i)}setColor(t,e){if(!this._finalized)throw"Not finalized";wr[0]=e[0],wr[1]=e[1],wr[2]=e[2],wr[3]=e[3],this._state.colorsBuf.setData(wr,4*t,4)}setTransparent(t,e,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(t,e,i)}_setFlags(t,e,i){if(!this._finalized)throw"Not finalized";const s=!!(e&ei),r=!!(e&ai),o=!!(e&ni),a=!!(e&li),n=!!(e&ii);let l,h;l=!s||n||r?_i:i?mi:gi,h=!s||n?_i:a?Pi:o?vi:r?bi:_i;let u=0;u=!s||n?_i:a?wi:o?Mi:r?Ei:!!(e&hi)?i?xi:yi:_i;let c=s&&!n&&!!(e&si)?Ci:_i;wr[0]=l,wr[1]=h,wr[2]=u,wr[3]=c,this._state.flagsBuf.setData(wr,4*t,4)}_setFlags2(t,e){if(!this._finalized)throw"Not finalized";const i=e&ri?255:0;wr[0]=i,this._state.flags2Buf.setData(wr,4*t,4)}setOffset(t,e){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(Sr[0]=e[0],Sr[1]=e[1],Sr[2]=e[2],this._state.offsetsBuf.setData(Sr,3*t,3)):this.model.error("Entity#offset not enabled for this Viewer")}drawColorOpaque(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._linesInstancingRenderers.colorRenderer&&this._linesInstancingRenderers.colorRenderer.drawLayer(e,this,gi)}drawColorTransparent(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._linesInstancingRenderers.colorRenderer&&this._linesInstancingRenderers.colorRenderer.drawLayer(e,this,mi)}drawDepth(t,e){}drawNormals(t,e){}drawSilhouetteXRayed(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._linesInstancingRenderers.silhouetteRenderer&&this._linesInstancingRenderers.silhouetteRenderer.drawLayer(e,this,bi)}drawSilhouetteHighlighted(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._linesInstancingRenderers.silhouetteRenderer&&this._linesInstancingRenderers.silhouetteRenderer.drawLayer(e,this,vi)}drawSilhouetteSelected(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._linesInstancingRenderers.silhouetteRenderer&&this._linesInstancingRenderers.silhouetteRenderer.drawLayer(e,this,Pi)}drawEdgesColorOpaque(t,e){}drawEdgesColorTransparent(t,e){}drawEdgesXRayed(t,e){}drawEdgesHighlighted(t,e){}drawEdgesSelected(t,e){}drawOcclusion(t,e){}drawShadow(t,e){}drawPickMesh(t,e){}drawPickDepths(t,e){}drawPickNormals(t,e){}destroy(){const t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.offsetsBuf&&(t.offsetsBuf.destroy(),t.offsetsBuf=null),t.modelMatrixCol0Buf&&(t.modelMatrixCol0Buf.destroy(),t.modelMatrixCol0Buf=null),t.modelMatrixCol1Buf&&(t.modelMatrixCol1Buf.destroy(),t.modelMatrixCol1Buf=null),t.modelMatrixCol2Buf&&(t.modelMatrixCol2Buf.destroy(),t.modelMatrixCol2Buf=null),t.indicesBuf&&(t.indicesBuf.destroy(),t.indicessBuf=null),t.destroy()}}const Lr=M.vec3();class Rr{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=this._scene,r=s.camera,o=e.model,a=s.canvas.gl,n=e._state,l=e._state.rtcCenter,h=s.pointsMaterial;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?R(r.viewMatrix,l):r.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix);const u=s._sectionPlanesState.sectionPlanes.length;if(u>0){const t=s._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,r=o.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e],o=r.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,o?1:0),o){const i=t[e];if(l){const t=B(i.dist,i.dir,l,Lr);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(n.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),a.uniform1f(this._uPointSize,h.pointSize);const c="ortho"===s.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*s.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,c),a.drawArrays(a.POINTS,0,n.positionsBuf.numItems)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader(t)),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=this._program,s=t.camera.project;if(i.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(s.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial,s=[];return s.push("// Points batching color vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),s.push("attribute vec4 color;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("varying vec4 vColor;"),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),e&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Points batching color fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vColor;"),s.push("void main(void) {"),t.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = vColor;"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Br=new Float32Array([1,1,1]),Tr=M.vec3();class Fr{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.rtcCenter,h=r.pointsMaterial._state;if(!this._program&&(this._allocate(),this.errors))return;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===bi){const t=r.xrayMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===vi){const t=r.highlightMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===Pi){const t=r.selectedMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else a.uniform4fv(this._uColor,Br);const u=l?R(o.viewMatrix,l):o.viewMatrix;a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=B(i.dist,i.dir,l,Tr);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),a.uniform1f(this._uPointSize,h.pointSize);const d="ortho"===r.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,d),a.drawArrays(a.POINTS,0,n.positionsBuf.numItems)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uColor=i.getLocation("color"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points batching silhouette vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform vec4 color;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.y) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState;let i,s;const r=e.sectionPlanes.length>0,o=[];if(o.push("// Points batching silhouette vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;")),r)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("uniform vec4 color;"),o.push("void main(void) {"),t.pointsMaterial.roundPoints&&(o.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("  float r = dot(cxy, cxy);"),o.push("  if (r > 1.0) {"),o.push("       discard;"),o.push("  }")),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("gl_FragColor = color;"),o.push("}"),o}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Nr=M.vec3();class Or{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.rtcCenter,h=r.pointsMaterial._state;this._program||this._allocate(e),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const u=t.pickViewMatrix||o.viewMatrix,c=l?R(u,l):u;if(a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,c),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,t)}const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*d,o=s.renderFlags;for(let e=0;e<d;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=B(i.dist,i.dir,l,Nr);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aPickColor&&this._aPickColor.bindArrayBuffer(n.pickColorsBuf),a.uniform1f(this._uPointSize,h.pointSize);const p="ortho"===r.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,p),a.drawArrays(a.POINTS,0,n.positionsBuf.numItems)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aPickColor=i.getAttribute("pickColor"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(t){const e=this._scene.canvas.gl;this._program.bind(),e.uniform1i(this._uPickInvisible,t.pickInvisible)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points batching pick mesh vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),s.push("attribute vec4 pickColor;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("varying vec4 vPickColor;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),e&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("gl_PointSize += 10.0;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Points batching pick mesh vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec4 vPickColor;"),s.push("void main(void) {"),t.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<e.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   gl_FragColor = vPickColor; "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const kr=M.vec3();class Ir{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.rtcCenter,h=r.pointsMaterial._state;this._program||this._allocate(),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,t.pickInvisible);const u=t.pickViewMatrix||o.viewMatrix,c=l?R(u,l):u;if(a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,c),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),a.uniform1f(this._uPickZNear,t.pickZNear),a.uniform1f(this._uPickZFar,t.pickZFar),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(t.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,e)}const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*d,o=s.renderFlags;for(let e=0;e<d;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=B(i.dist,i.dir,l,kr);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),a.uniform1f(this._uPointSize,h.pointSize);const p="ortho"===r.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,p),a.drawArrays(a.POINTS,0,n.positionsBuf.numItems)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points batched pick depth vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("varying vec4 vViewPosition;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags2 = flags2;")),s.push("vViewPosition = viewPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("gl_PointSize += 10.0;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Points batched pick depth fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("void main(void) {"),t.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    gl_FragColor = packDepth(zNormalizedDepth); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const zr=M.vec3();class Vr{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.canvas.gl,a=e._state,n=r.camera,l=e._state.rtcCenter,h=r.pointsMaterial._state;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),o.uniform1i(this._uRenderPass,i),o.uniformMatrix4fv(this._uViewMatrix,!1,l?R(n.viewMatrix,l):n.viewMatrix),o.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,a=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e],r=a.sectionPlanesActivePerLayer[i+e];if(o.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=B(i.dist,i.dir,l,zr);o.uniform3fv(s.pos,t)}else o.uniform3fv(s.pos,i.pos);o.uniform3fv(s.dir,i.dir)}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),o.uniform1f(this._uPointSize,h.pointSize);const c="ortho"===r.camera.projection?1:o.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));o.uniform1f(this._uNearPlaneHeight,c),o.drawArrays(o.POINTS,0,a.positionsBuf.numItems)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points batching occlusion vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("  gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Points batching occlusion fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("void main(void) {"),t.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("      if (sectionPlaneActive"+t+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Ur{constructor(t){this._scene=t}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Rr(this._scene)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Fr(this._scene)),this._silhouetteRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Or(this._scene)),this._pickMeshRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Ir(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new Vr(this._scene)),this._occlusionRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy()}}const Gr={};const Xr=C.SUPPORTED_EXTENSIONS.OES_element_index_uint;class jr{constructor(t=5e6){Xr?t>5e6&&(t=5e6):t>65530&&(t=65530),this.maxVerts=t,this.maxIndices=3*t,this.positions=[],this.colors=[],this.pickColors=[],this.flags=[],this.flags2=[],this.offsets=[]}}const Wr=M.vec4(),Hr=M.vec4(),Yr=M.vec4([0,0,0,1]),Kr=M.vec4([0,0,0,1]),$r=M.vec4([0,0,0,1]),qr=M.OBB3();class Zr{constructor(t,e){this.sortId="PointsBatchingLayer",this.layerIndex=e.layerIndex,this._pointsBatchingRenderers=function(t){const e=t.id;let i=Gr[e];return i||(i=new Ur(t),Gr[e]=i,i._compile(),t.on("compile",(()=>{i._compile()})),t.on("destroyed",(()=>{delete Gr[e],i._destroy()}))),i}(t.scene),this.model=t,this._buffer=new jr(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new nt({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,flags2Buf:null,positionsDecodeMatrix:M.mat4(),rtcCenter:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=M.collapseAABB3(),this._portions=[],this._finalized=!1,this._positionsDecodeMatrix=e.positionsDecodeMatrix,this._preCompressed=!!this._positionsDecodeMatrix,e.rtcCenter&&(this._state.rtcCenter=M.vec3(e.rtcCenter)),this.aabb=M.collapseAABB3()}canCreatePortion(t){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+t<3*this._buffer.maxVerts}createPortion(t){if(this._finalized)throw"Already finalized";const e=t.positions,i=t.color,s=t.colors,r=t.opacity,o=t.meshMatrix,a=t.worldMatrix,n=t.worldAABB,l=t.pickColor,h=this._buffer,u=h.positions.length/3,c=e.length/3,d=e.length;if(this._preCompressed){for(let t=0,i=e.length;t<i;t++)h.positions.push(e[t]);const t=kt.getPositionsBounds(e),i=kt.decompressPosition(t.min,this._positionsDecodeMatrix,Wr),s=kt.decompressPosition(t.max,this._positionsDecodeMatrix,Hr);n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=s[0],n[4]=s[1],n[5]=s[2],a&&(M.AABB3ToOBB3(n,qr),M.transformOBB3(a,qr),M.OBB3ToAABB3(qr,n))}else{const t=h.positions.length;for(let t=0,i=e.length;t<i;t++)h.positions.push(e[t]);if(o)for(let e=t,i=t+d;e<i;e+=3)Yr[0]=h.positions[e+0],Yr[1]=h.positions[e+1],Yr[2]=h.positions[e+2],M.transformPoint4(o,Yr,Kr),h.positions[e+0]=Kr[0],h.positions[e+1]=Kr[1],h.positions[e+2]=Kr[2],M.expandAABB3Point3(this._modelAABB,Kr),a?(M.transformPoint4(a,Kr,$r),M.expandAABB3Point3(n,$r)):M.expandAABB3Point3(n,Kr);else for(let e=t,i=t+d;e<i;e+=3)Yr[0]=h.positions[e+0],Yr[1]=h.positions[e+1],Yr[2]=h.positions[e+2],M.expandAABB3Point3(this._modelAABB,Yr),a?(M.transformPoint4(a,Yr,Kr),M.expandAABB3Point3(n,Kr)):M.expandAABB3Point3(n,Yr)}if(this._state.rtcCenter){const t=this._state.rtcCenter;n[0]+=t[0],n[1]+=t[1],n[2]+=t[2],n[3]+=t[0],n[4]+=t[1],n[5]+=t[2]}if(M.expandAABB3(this.aabb,n),s)for(let t=0,e=s.length;t<e;t+=3)h.colors.push(255*s[t]),h.colors.push(255*s[t+1]),h.colors.push(255*s[t+2]),h.colors.push(255);else if(i){const t=i[0],e=i[1],s=i[2],o=r;for(let i=0;i<c;i++)h.colors.push(t),h.colors.push(e),h.colors.push(s),h.colors.push(o)}{const t=h.pickColors.length;for(let e=t,i=t+4*c;e<i;e+=4)h.pickColors.push(l[0]),h.pickColors.push(l[1]),h.pickColors.push(l[2]),h.pickColors.push(l[3])}if(this.model.scene.entityOffsetsEnabled)for(let t=0;t<c;t++)h.offsets.push(0),h.offsets.push(0),h.offsets.push(0);const p=this._portions.length/2;return this._portions.push(u),this._portions.push(c),this._numPortions++,this.model.numPortions++,p}finalize(){if(this._finalized)return void this.model.error("Already finalized");const t=this._state,e=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0)if(this._preCompressed){t.positionsDecodeMatrix=this._positionsDecodeMatrix;const s=new Uint16Array(i.positions);t.positionsBuf=new j(e,e.ARRAY_BUFFER,s,i.positions.length,3,e.STATIC_DRAW)}else{const s=ls(new Float32Array(i.positions),this._modelAABB,t.positionsDecodeMatrix);t.positionsBuf=new j(e,e.ARRAY_BUFFER,s,i.positions.length,3,e.STATIC_DRAW)}if(i.colors.length>0){const s=new Uint8Array(i.colors);let r=!1;t.colorsBuf=new j(e,e.ARRAY_BUFFER,s,i.colors.length,4,e.DYNAMIC_DRAW,r)}if(i.colors.length>0){const s=i.colors.length,r=new Uint8Array(s),o=new Uint8Array(s);let a=!1,n=!0;t.flagsBuf=new j(e,e.ARRAY_BUFFER,r,r.length,4,e.DYNAMIC_DRAW,a),t.flags2Buf=new j(e,e.ARRAY_BUFFER,o,o.length,4,e.DYNAMIC_DRAW,n)}if(i.pickColors.length>0){const s=new Uint8Array(i.pickColors);let r=!1;t.pickColorsBuf=new j(e,e.ARRAY_BUFFER,s,i.pickColors.length,4,e.STATIC_DRAW,r)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){const s=new Float32Array(i.offsets);t.offsetsBuf=new j(e,e.ARRAY_BUFFER,s,i.offsets.length,3,e.DYNAMIC_DRAW)}this._buffer=null,this._finalized=!0}initFlags(t,e,i){e&ei&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&ni&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&ai&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&li&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&ri&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),e&si&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),e&ii&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(t,e,i),this._setFlags2(t,e)}setVisible(t,e,i){if(!this._finalized)throw"Not finalized";e&ei?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e,i)}setHighlighted(t,e,i){if(!this._finalized)throw"Not finalized";e&ni?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e,i)}setXRayed(t,e,i){if(!this._finalized)throw"Not finalized";e&ai?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e,i)}setSelected(t,e,i){if(!this._finalized)throw"Not finalized";e&li?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e,i)}setEdges(t,e,i){if(!this._finalized)throw"Not finalized"}setClippable(t,e){if(!this._finalized)throw"Not finalized";e&ri?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(t,e)}setCulled(t,e,i){if(!this._finalized)throw"Not finalized";e&ii?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(t,e,i)}setCollidable(t,e){if(!this._finalized)throw"Not finalized"}setPickable(t,e,i){if(!this._finalized)throw"Not finalized";e&si?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(t,e,i)}setColor(t,e){if(!this._finalized)throw"Not finalized";const i=2*t,s=4*this._portions[i],r=4*this._portions[i+1],o=this._scratchMemory.getUInt8Array(r),a=e[0],n=e[1],l=e[2],h=e[3];for(let t=0;t<r;t+=4)o[t+0]=a,o[t+1]=n,o[t+2]=l,o[t+3]=h;this._state.colorsBuf.setData(o,s,r)}setTransparent(t,e,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(t,e,i)}_setFlags(t,e,i){if(!this._finalized)throw"Not finalized";const s=2*t,r=4*this._portions[s],o=4*this._portions[s+1],a=this._scratchMemory.getUInt8Array(o),n=!!(e&ei),l=!!(e&ai),h=!!(e&ii);let u,c;u=!n||h||l?_i:i?mi:gi,c=!n||h?_i:!!(e&li)?Pi:!!(e&ni)?vi:l?bi:_i;let d=n&&!h&&!!(e&si)?Ci:_i;for(let t=0;t<o;t+=4)a[t+0]=u,a[t+1]=c,a[t+2]=0,a[t+3]=d;this._state.flagsBuf.setData(a,r,o)}_setFlags2(t,e){if(!this._finalized)throw"Not finalized";const i=2*t,s=4*this._portions[i],r=4*this._portions[i+1],o=this._scratchMemory.getUInt8Array(r),a=e&ri?255:0;for(let t=0;t<r;t+=4)o[t+0]=a;this._state.flags2Buf.setData(o,s,r)}setOffset(t,e){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled)return void this.model.error("Entity#offset not enabled for this Viewer");const i=2*t,s=3*this._portions[i],r=3*this._portions[i+1],o=this._scratchMemory.getFloat32Array(r),a=e[0],n=e[1],l=e[2];for(let t=0;t<r;t+=3)o[t+0]=a,o[t+1]=n,o[t+2]=l;this._state.offsetsBuf.setData(o,s,r)}drawColorOpaque(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsBatchingRenderers.colorRenderer&&this._pointsBatchingRenderers.colorRenderer.drawLayer(e,this,gi)}drawColorTransparent(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsBatchingRenderers.colorRenderer&&this._pointsBatchingRenderers.colorRenderer.drawLayer(e,this,mi)}drawDepth(t,e){}drawNormals(t,e){}drawSilhouetteXRayed(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._pointsBatchingRenderers.silhouetteRenderer&&this._pointsBatchingRenderers.silhouetteRenderer.drawLayer(e,this,bi)}drawSilhouetteHighlighted(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._pointsBatchingRenderers.silhouetteRenderer&&this._pointsBatchingRenderers.silhouetteRenderer.drawLayer(e,this,vi)}drawSilhouetteSelected(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._pointsBatchingRenderers.silhouetteRenderer&&this._pointsBatchingRenderers.silhouetteRenderer.drawLayer(e,this,Pi)}drawEdgesColorOpaque(t,e){}drawEdgesColorTransparent(t,e){}drawEdgesHighlighted(t,e){}drawEdgesSelected(t,e){}drawEdgesXRayed(t,e){}drawPickMesh(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsBatchingRenderers.pickMeshRenderer&&this._pointsBatchingRenderers.pickMeshRenderer.drawLayer(e,this,Ci)}drawPickDepths(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsBatchingRenderers.pickDepthRenderer&&this._pointsBatchingRenderers.pickDepthRenderer.drawLayer(e,this,Ci)}drawPickNormals(t,e){}drawOcclusion(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsBatchingRenderers.occlusionRenderer&&this._pointsBatchingRenderers.occlusionRenderer.drawLayer(e,this,gi)}drawShadow(t,e){}destroy(){const t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.offsetsBuf&&(t.offsetsBuf.destroy(),t.offsetsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.pickColorsBuf&&(t.pickColorsBuf.destroy(),t.pickColorsBuf=null),t.destroy()}}const Qr=M.vec3();class Jr{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter,u=r.pointsMaterial._state;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?R(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor.bindArrayBuffer(n.colorsBuf);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=B(i.dist,i.dir,h,Qr);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),a.uniform1f(this._uPointSize,u.pointSize);const d="ortho"===r.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,d),l.drawArraysInstancedANGLE(a.POINTS,0,n.positionsBuf.numItems/3,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aOffset=i.getAttribute("offset"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(t){const e=this._scene,i=e.canvas.gl,s=e.camera.project;if(this._program.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const t=2/(Math.log(s.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points instancing color vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),s.push("attribute vec4 color;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 modelMatrixCol0;"),s.push("attribute vec4 modelMatrixCol1;"),s.push("attribute vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("varying vec4 vColor;"),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),e&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Points instancing color fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vColor;"),s.push("void main(void) {"),t.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = vColor;"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const to=M.vec3();class eo{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter,u=r.pointsMaterial._state;if(!this._program&&(this._allocate(e.model.scene),this.errors))return;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===bi){const t=r.xrayMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===vi){const t=r.highlightMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===Pi){const t=r.selectedMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else a.uniform4fv(this._uColor,M.vec3([1,1,1]));a.uniformMatrix4fv(this._uViewMatrix,!1,h?R(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=B(i.dist,i.dir,h,to);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),a.uniform1f(this._uPointSize,u.pointSize);const d="ortho"===r.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,d),l.drawArraysInstancedANGLE(a.POINTS,0,n.positionsBuf.numItems,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uColor=s.getLocation("color"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points instancing silhouette vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),s.push("attribute vec4 modelMatrixCol0;"),s.push("attribute vec4 modelMatrixCol1;"),s.push("attribute vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),s.push("uniform vec4 color;"),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.y) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Points instancing silhouette fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("uniform vec4 color;"),s.push("void main(void) {"),t.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = color;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const io=M.vec3();class so{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter,u=r.pointsMaterial._state;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i);const c=t.pickViewMatrix||o.viewMatrix,d=h?R(c,h):c;if(a.uniformMatrix4fv(this._uViewMatrix,!1,d),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,t)}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPickColor.bindArrayBuffer(n.pickColorsBuf),l.vertexAttribDivisorANGLE(this._aPickColor.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),a.uniform1f(this._uPointSize,u.pointSize);const p="ortho"===r.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,p);const f=r._sectionPlanesState.sectionPlanes.length;if(f>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*f,o=s.renderFlags;for(let e=0;e<f;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=B(i.dist,i.dir,h,io);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}l.drawArraysInstancedANGLE(a.POINTS,0,n.positionsBuf.numItems,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aPickColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uPickInvisible=s.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._uRenderPass=s.getLocation("renderPass"),this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aPickColor=s.getAttribute("pickColor"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(t){const e=this._scene.canvas.gl;this._program.bind(),e.uniform1i(this._uPickInvisible,t.pickInvisible)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points instancing pick mesh vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),s.push("attribute vec4 pickColor;"),s.push("attribute vec4 modelMatrixCol0;"),s.push("attribute vec4 modelMatrixCol1;"),s.push("attribute vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("varying vec4 vPickColor;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),e&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Points instancing pick mesh fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vPickColor;"),s.push("void main(void) {"),t.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = vPickColor; "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const ro=M.vec3();class oo{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.canvas.gl,a=e._state,n=this._instanceExt,l=e._state.rtcCenter,h=r.pointsMaterial._state;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram());const u=r.camera;o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,t.pickInvisible);const c=t.pickViewMatrix||u.viewMatrix,d=l?R(c,l):c;if(o.uniformMatrix4fv(this._uViewMatrix,!1,d),o.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),o.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),o.uniform1f(this._uPickZNear,t.pickZNear),o.uniform1f(this._uPickZFar,t.pickZFar),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(t.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,e)}const p=r._sectionPlanesState.sectionPlanes.length;if(p>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*p,a=s.renderFlags;for(let e=0;e<p;e++){const s=this._uSectionPlanes[e],r=a.sectionPlanesActivePerLayer[i+e];if(o.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=B(i.dist,i.dir,l,ro);o.uniform3fv(s.pos,t)}else o.uniform3fv(s.pos,i.pos);o.uniform3fv(s.dir,i.dir)}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisorANGLE(this._aOffset.location,1)),o.uniform1f(this._uPointSize,h.pointSize);const f="ortho"===r.camera.projection?1:o.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));o.uniform1f(this._uNearPlaneHeight,f),n.drawArraysInstancedANGLE(o.POINTS,0,a.positionsBuf.numItems,a.numInstances),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),n.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points instancing pick depth vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),s.push("attribute vec4 modelMatrixCol0;"),s.push("attribute vec4 modelMatrixCol1;"),s.push("attribute vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("varying vec4 vViewPosition;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags2 = flags2;")),s.push("  vViewPosition = viewPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Points instancing pick depth fragment shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("void main(void) {"),t.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    gl_FragColor = packDepth(zNormalizedDepth); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const ao=M.vec3();class no{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter,u=r.pointsMaterial._state;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?R(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=B(i.dist,i.dir,h,ao);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aColor&&(this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1)),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),a.uniform1f(this._uPointSize,u.pointSize);const d="ortho"===r.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,d),l.drawArraysInstancedANGLE(a.POINTS,0,n.positionsBuf.numItems,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),this._aColor&&l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points instancing occlusion vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 color;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),s.push("attribute vec4 modelMatrixCol0;"),s.push("attribute vec4 modelMatrixCol1;"),s.push("attribute vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&s.push("  vWorldPosition = worldPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Points instancing occlusion vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("void main(void) {"),t.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const lo=M.vec3();class ho{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter,u=r.pointsMaterial._state;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,h?R(o.viewMatrix,h):o.viewMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=B(i.dist,i.dir,h,lo);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),a.uniform1f(this._uPointSize,u.pointSize);const d="ortho"===r.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,d),l.drawArraysInstancedANGLE(a.POINTS,0,n.positionsBuf.numItems,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points instancing depth vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),s.push("attribute vec4 modelMatrixCol0;"),s.push("attribute vec4 modelMatrixCol1;"),s.push("attribute vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState;let i,s;const r=e.sectionPlanes.length>0,o=[];if(o.push("// Points instancing depth vertex shader"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;")),r)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("const float   packUpScale = 256. / 255.;"),o.push("const float   unpackDownscale = 255. / 256.;"),o.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),o.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),o.push("const float   shiftRight8 = 1.0 / 256.;"),o.push("vec4 packDepthToRGBA( const in float v ) {"),o.push("    vec4 r = vec4( fract( v * packFactors ), v );"),o.push("    r.yzw -= r.xyz * shiftRight8;"),o.push("    return r * packUpScale;"),o.push("}"),o.push("void main(void) {"),t.pointsMaterial.roundPoints&&(o.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("  float r = dot(cxy, cxy);"),o.push("  if (r > 1.0) {"),o.push("       discard;"),o.push("  }")),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}")}return o.push("    gl_FragColor = packDepthToRGBA( gl_FragCoord.z); "),t.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const uo=M.vec3();class co{constructor(t){this._scene=t,this._hash=this._getHash(),this._lastLightId=null,this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e){const i=e.model,s=i.scene,r=s.canvas.gl,o=e._state,a=this._instanceExt;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e)),r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),a.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aColor.bindArrayBuffer(o.colorsBuf),a.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(o.flagsBuf),a.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),a.vertexAttribDivisorANGLE(this._aFlags2.location,1));const n=s._sectionPlanesState.sectionPlanes.length;if(n>0){const t=s._sectionPlanesState.sectionPlanes,o=e.layerIndex*n,a=i.renderFlags,l=e._state.rtcCenter;for(let e=0;e<n;e++){const i=this._uSectionPlanes[e],s=a.sectionPlanesActivePerLayer[o+e];if(r.uniform1i(i.active,s?1:0),s){const s=t[e];if(l){const t=B(s.dist,s.dir,l,uo);r.uniform3fv(i.pos,t)}else r.uniform3fv(i.pos,s.pos);r.uniform3fv(i.dir,s.dir)}}}r.uniform1f(this._uPointSize,10),a.drawArraysInstancedANGLE(r.POINTS,0,o.positionsBuf.numItems,o.numInstances),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),a.vertexAttribDivisorANGLE(this._aColor.location,0),a.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&a.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&a.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new X(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uShadowViewMatrix=s.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=s.getLocation("shadowProjMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uPointSize=s.getLocation("pointSize")}_bindProgram(t,e){const i=this._scene.canvas.gl;this._program.bind(),i.uniformMatrix4fv(this._uShadowViewMatrix,!1,t.shadowViewMatrix),i.uniformMatrix4fv(this._uShadowProjMatrix,!1,t.shadowProjMatrix),this._lastLightId=null}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry shadow drawing vertex shader"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform float pointSize;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("bool visible      = (float(flags.x) > 0.0);"),i.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),i.push("if (!visible || transparent) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("  gl_Position = shadowProjMatrix * viewPosition;"),i.push("}"),i.push("gl_PointSize = pointSize;"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Instancing geometry depth drawing fragment shader"),t.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("void main(void) {"),s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class po{constructor(t){this._scene=t}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Jr(this._scene,!1)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new eo(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new ho(this._scene)),this._depthRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new so(this._scene)),this._pickMeshRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new oo(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new no(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new co(this._scene)),this._shadowRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy()}}const fo={};const _o=new Uint8Array(4),go=M.vec4([0,0,0,1]),mo=M.vec4([0,0,0,1]),vo=M.vec4([0,0,0,1]),Po=new Float32Array(3);class bo{constructor(t,e){this.sortId="PointsInstancingLayer",this.layerIndex=e.layerIndex,this._pointsInstancingRenderers=function(t){const e=t.id;let i=fo[e];return i||(i=new po(t),fo[e]=i,i._compile(),t.on("compile",(()=>{i._compile()})),t.on("destroyed",(()=>{delete fo[e],i._destroy()}))),i}(t.scene),this.model=t,this._aabb=M.collapseAABB3();const i=t.scene.canvas.gl,s={positionsDecodeMatrix:M.mat4(),numInstances:0,obb:M.OBB3(),rtcCenter:null},r=!!e.positionsDecodeMatrix;if(e.positions)if(r){let t=!1;s.positionsBuf=new j(i,i.ARRAY_BUFFER,e.positions,e.positions.length,3,i.STATIC_DRAW,t),s.positionsDecodeMatrix.set(e.positionsDecodeMatrix);let r=M.collapseAABB3();M.expandAABB3Points3(r,e.positions),kt.decompressAABB(r,s.positionsDecodeMatrix),M.AABB3ToOBB3(r,s.obb)}else{let t=e.positions.length,r=M.collapseAABB3();M.expandAABB3Points3(r,e.positions),M.AABB3ToOBB3(r,s.obb);const o=ls(e.positions,r,s.positionsDecodeMatrix);let a=!1;s.positionsBuf=new j(i,i.ARRAY_BUFFER,o,t,3,i.STATIC_DRAW,a)}if(e.colors){const t=e.colors,r=new Uint8Array(t.length/3*4);for(let e=0,i=0,s=t.length;e<s;e+=3,i+=4)r[e+0]=255*t[i+0],r[i+1]=255*t[e+1],r[i+2]=255*t[e+2],r[i+3]=255;let o=!1;s.colorsBuf=new j(i,i.ARRAY_BUFFER,r,r.length,4,i.STATIC_DRAW,o)}this._state=new nt(s),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._pickColors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],e.rtcCenter&&(this._state.rtcCenter=M.vec3(e.rtcCenter)),this._finalized=!1,this.aabb=M.collapseAABB3()}createPortion(t){const e=t.meshMatrix,i=t.worldMatrix,s=t.aabb,r=t.pickColor;if(this._finalized)throw"Already finalized";this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(e[0]),this._modelMatrixCol0.push(e[4]),this._modelMatrixCol0.push(e[8]),this._modelMatrixCol0.push(e[12]),this._modelMatrixCol1.push(e[1]),this._modelMatrixCol1.push(e[5]),this._modelMatrixCol1.push(e[9]),this._modelMatrixCol1.push(e[13]),this._modelMatrixCol2.push(e[2]),this._modelMatrixCol2.push(e[6]),this._modelMatrixCol2.push(e[10]),this._modelMatrixCol2.push(e[14]),this._pickColors.push(r[0]),this._pickColors.push(r[1]),this._pickColors.push(r[2]),this._pickColors.push(r[3]),M.collapseAABB3(s);const o=this._state.obb,a=o.length;for(let t=0;t<a;t+=4)go[0]=o[t+0],go[1]=o[t+1],go[2]=o[t+2],M.transformPoint4(e,go,mo),i?(M.transformPoint4(i,mo,vo),M.expandAABB3Point3(s,vo)):M.expandAABB3Point3(s,mo);if(this._state.rtcCenter){const t=this._state.rtcCenter;s[0]+=t[0],s[1]+=t[1],s[2]+=t[2],s[3]+=t[0],s[4]+=t[1],s[5]+=t[2]}M.expandAABB3(this.aabb,s),this._state.numInstances++;const n=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,n}finalize(){if(this._finalized)throw"Already finalized";const t=this.model.scene.canvas.gl,e=this._pickColors.length;if(e>0){let i=!1,s=!0;this._state.flagsBuf=new j(t,t.ARRAY_BUFFER,new Uint8Array(e),e,4,t.DYNAMIC_DRAW,i),this._state.flags2Buf=new j(t,t.ARRAY_BUFFER,new Uint8Array(e),e,4,t.DYNAMIC_DRAW,s)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){const e=!1;this._state.offsetsBuf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,t.DYNAMIC_DRAW,e),this._offsets=[]}if(this._modelMatrixCol0.length>0){const e=!1;this._state.modelMatrixCol0Buf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,t.STATIC_DRAW,e),this._state.modelMatrixCol1Buf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,t.STATIC_DRAW,e),this._state.modelMatrixCol2Buf=new j(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,t.STATIC_DRAW,e),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]}if(this._pickColors.length>0){const e=!1;this._state.pickColorsBuf=new j(t,t.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,t.STATIC_DRAW,e),this._pickColors=[]}this._finalized=!0}initFlags(t,e,i){e&ei&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&ni&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&ai&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&li&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&ri&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),e&hi&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),e&si&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),e&ii&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(t,e,i),this._setFlags2(t,e)}setVisible(t,e,i){if(!this._finalized)throw"Not finalized";e&ei?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e,i)}setHighlighted(t,e,i){if(!this._finalized)throw"Not finalized";e&ni?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e,i)}setXRayed(t,e,i){if(!this._finalized)throw"Not finalized";e&ai?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e,i)}setSelected(t,e,i){if(!this._finalized)throw"Not finalized";e&li?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e,i)}setEdges(t,e,i){if(!this._finalized)throw"Not finalized";e&hi?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(t,e,i)}setClippable(t,e){if(!this._finalized)throw"Not finalized";e&ri?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(t,e)}setCollidable(t,e){if(!this._finalized)throw"Not finalized"}setPickable(t,e,i){if(!this._finalized)throw"Not finalized";e&si?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(t,e,i)}setCulled(t,e,i){if(!this._finalized)throw"Not finalized";e&ii?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(t,e,i)}setColor(t,e){if(!this._finalized)throw"Not finalized";_o[0]=e[0],_o[1]=e[1],_o[2]=e[2],_o[3]=e[3],this._state.colorsBuf.setData(_o,4*t,4)}setTransparent(t,e,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(t,e,i)}_setFlags(t,e,i){if(!this._finalized)throw"Not finalized";const s=!!(e&ei),r=!!(e&ai),o=!!(e&ni),a=!!(e&li),n=!!(e&ii);let l,h;l=!s||n||r?_i:i?mi:gi,h=!s||n?_i:a?Pi:o?vi:r?bi:_i;let u=0;u=!s||n?_i:a?wi:o?Mi:r?Ei:!!(e&hi)?i?xi:yi:_i;let c=s&&!n&&!!(e&si)?Ci:_i;_o[0]=l,_o[1]=h,_o[2]=u,_o[3]=c,this._state.flagsBuf.setData(_o,4*t,4)}_setFlags2(t,e){if(!this._finalized)throw"Not finalized";const i=e&ri?255:0;_o[0]=i,this._state.flags2Buf.setData(_o,4*t,4)}setOffset(t,e){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(Po[0]=e[0],Po[1]=e[1],Po[2]=e[2],this._state.offsetsBuf.setData(Po,3*t,3)):this.model.error("Entity#offset not enabled for this Viewer")}drawColorOpaque(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsInstancingRenderers.colorRenderer&&this._pointsInstancingRenderers.colorRenderer.drawLayer(e,this,gi)}drawColorTransparent(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsInstancingRenderers.colorRenderer&&this._pointsInstancingRenderers.colorRenderer.drawLayer(e,this,mi)}drawDepth(t,e){}drawNormals(t,e){}drawSilhouetteXRayed(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._pointsInstancingRenderers.silhouetteRenderer&&this._pointsInstancingRenderers.silhouetteRenderer.drawLayer(e,this,bi)}drawSilhouetteHighlighted(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._pointsInstancingRenderers.silhouetteRenderer&&this._pointsInstancingRenderers.silhouetteRenderer.drawLayer(e,this,vi)}drawSilhouetteSelected(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._pointsInstancingRenderers.silhouetteRenderer&&this._pointsInstancingRenderers.silhouetteRenderer.drawLayer(e,this,Pi)}drawEdgesColorOpaque(t,e){}drawEdgesColorTransparent(t,e){}drawEdgesHighlighted(t,e){}drawEdgesSelected(t,e){}drawEdgesXRayed(t,e){}drawOcclusion(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsInstancingRenderers.occlusionRenderer&&this._pointsInstancingRenderers.occlusionRenderer.drawLayer(e,this,gi)}drawShadow(t,e){}drawPickMesh(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsInstancingRenderers.pickMeshRenderer&&this._pointsInstancingRenderers.pickMeshRenderer.drawLayer(e,this,Ci)}drawPickDepths(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsInstancingRenderers.pickDepthRenderer&&this._pointsInstancingRenderers.pickDepthRenderer.drawLayer(e,this,Ci)}drawPickNormals(t,e){}destroy(){const t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.offsetsBuf&&(t.offsetsBuf.destroy(),t.offsetsBuf=null),t.modelMatrixCol0Buf&&(t.modelMatrixCol0Buf.destroy(),t.modelMatrixCol0Buf=null),t.modelMatrixCol1Buf&&(t.modelMatrixCol1Buf.destroy(),t.modelMatrixCol1Buf=null),t.modelMatrixCol2Buf&&(t.modelMatrixCol2Buf.destroy(),t.modelMatrixCol2Buf=null),t.pickColorsBuf&&(t.pickColorsBuf.destroy(),t.pickColorsBuf=null),t.destroy()}}class yo{constructor(){this.visibleLayers=[],this.sectionPlanesActivePerLayer=[],this.reset()}reset(){this.culled=!1,this.sectioned=!1,this.numLayers=0,this.numVisibleLayers=0,this.colorOpaque=!1,this.colorTransparent=!1,this.edgesOpaque=!1,this.edgesTransparent=!1,this.xrayedSilhouetteOpaque=!1,this.xrayedEdgesOpaque=!1,this.xrayedSilhouetteTransparent=!1,this.xrayedEdgesTransparent=!1,this.highlightedSilhouetteOpaque=!1,this.highlightedEdgesOpaque=!1,this.highlightedSilhouetteTransparent=!1,this.highlightedEdgesTransparent=!1,this.selectedSilhouetteOpaque=!1,this.selectedEdgesOpaque=!1,this.selectedSilhouetteTransparent=!1,this.selectedEdgesTransparent=!1}}const xo=C.SUPPORTED_EXTENSIONS.ANGLE_instanced_arrays,Mo=M.mat4(),wo=M.vec3([1,1,1]),Eo=M.vec3([0,0,0]),Co=M.vec3([0,0,0]),Ao=M.identityQuaternion();class So extends w{constructor(t,e={}){super(t,e),this._maxGeometryBatchSize=e.maxGeometryBatchSize,this._aabb=M.collapseAABB3(),this._aabbDirty=!1,this._layerList=[],this._nodeList=[],this._lastRTCCenter=null,this._lastDecodeMatrix=null,this._instancingLayers={},this._currentBatchingLayers={},this._scratchMemory=(fi++,pi),this._meshes={},this._nodes={},this.renderFlags=new yo,this.numGeometries=0,this.numPortions=0,this.numVisibleLayerPortions=0,this.numTransparentLayerPortions=0,this.numXRayedLayerPortions=0,this.numHighlightedLayerPortions=0,this.numSelectedLayerPortions=0,this.numEdgesLayerPortions=0,this.numPickableLayerPortions=0,this.numClippableLayerPortions=0,this.numCulledLayerPortions=0,this.numEntities=0,this._numTriangles=0,this._numLines=0,this._numPoints=0,this._edgeThreshold=e.edgeThreshold||10,this.visible=e.visible,this.culled=e.culled,this.pickable=e.pickable,this.clippable=e.clippable,this.collidable=e.collidable,this.castsShadow=e.castsShadow,this.receivesShadow=e.receivesShadow,this.xrayed=e.xrayed,this.highlighted=e.highlighted,this.selected=e.selected,this.edges=e.edges,this.colorize=e.colorize,this.opacity=e.opacity,this.backfaces=e.backfaces,this._position=new Float32Array(e.position||[0,0,0]),this._rotation=new Float32Array(e.rotation||[0,0,0]),this._quaternion=new Float32Array(e.quaternion||[0,0,0,1]),e.rotation&&M.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._scale=new Float32Array(e.scale||[1,1,1]),this._worldMatrix=M.mat4(),M.composeMat4(this._position,this._quaternion,this._scale,this._worldMatrix),this._worldNormalMatrix=M.mat4(),M.inverseMat4(this._worldMatrix,this._worldNormalMatrix),M.transposeMat4(this._worldNormalMatrix),(e.matrix||e.position||e.rotation||e.scale||e.quaternion)&&(this._viewMatrix=M.mat4(),this._viewNormalMatrix=M.mat4(),this._viewMatrixDirty=!0,this._worldMatrixNonIdentity=!0),this._opacity=1,this._colorize=[1,1,1],this._saoEnabled=!1!==e.saoEnabled,this._pbrEnabled=!!e.pbrEnabled,this._isModel=e.isModel,this._isModel&&this.scene._registerModel(this),this._onCameraViewMatrix=this.scene.camera.on("matrix",(()=>{this._viewMatrixDirty=!0}))}get isPerformanceModel(){return!0}get position(){return this._position}get rotation(){return this._rotation}get quaternion(){return this._quaternion}get scale(){return this._scale}get matrix(){return this._worldMatrix}get worldMatrix(){return this._worldMatrix}get worldNormalMatrix(){return this._worldNormalMatrix}get viewMatrix(){return this._viewMatrix?(this._viewMatrixDirty&&(M.mulMat4(this.scene.camera.viewMatrix,this._worldMatrix,this._viewMatrix),M.inverseMat4(this._viewMatrix,this._viewNormalMatrix),M.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewMatrix):this.scene.camera.viewMatrix}getPickViewMatrix(t){return this._viewMatrix?this._viewMatrix:t}get viewNormalMatrix(){return this._viewNormalMatrix?(this._viewMatrixDirty&&(M.mulMat4(this.scene.camera.viewMatrix,this._worldMatrix,this._viewMatrix),M.inverseMat4(this._viewMatrix,this._viewNormalMatrix),M.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewNormalMatrix):this.scene.camera.viewNormalMatrix}createGeometry(t){if(!xo)return void this.error("WebGL instanced arrays not supported");const e=t.id;if(e===undefined||null===e)return void this.error("Config missing: id");if(this._instancingLayers[e])return void this.error("Geometry already created: "+e);let i;const s=t.primitive;if(s!==undefined&&null!==s){switch(s){case"triangles":case"solid":i=new ir(this,n.apply({layerIndex:0,solid:!0},t)),this._numTriangles+=t.indices?Math.round(t.indices.length/3):0;break;case"surface":i=new ir(this,n.apply({layerIndex:0,solid:!1},t)),this._numTriangles+=t.indices?Math.round(t.indices.length/3):0;break;case"lines":i=new Dr(this,n.apply({layerIndex:0},t)),this._numLines+=t.indices?Math.round(t.indices.length/2):0;break;case"points":i=new bo(this,n.apply({layerIndex:0},t)),this._numPoints+=t.positions?Math.round(t.positions.length/3):0}this._instancingLayers[e]=i,this._layerList.push(i),this.numGeometries++}else this.error("Config missing: primitive")}createMesh(t){let e=t.id;if(e===undefined||null===e)return void this.error("Config missing: id");if(this._meshes[e])return void this.error("PerformanceModel already has a Mesh with this ID: "+e);const i=t.geometryId,s=i!==undefined;if(s){if(!xo)return void this.error("WebGL instanced arrays not supported");if(!this._instancingLayers[i])return void this.error("Geometry not found: "+i+" - ensure that you create it first with createGeometry()")}let r,o;const a=t.color?new Uint8Array([Math.floor(255*t.color[0]),Math.floor(255*t.color[1]),Math.floor(255*t.color[2])]):[255,255,255],n=t.opacity!==undefined&&null!==t.opacity?Math.floor(255*t.opacity):255,l=t.metallic!==undefined&&null!==t.metallic?Math.floor(255*t.metallic):0,h=t.roughness!==undefined&&null!==t.roughness?Math.floor(255*t.roughness):255,u=new ti(this,e,a,n),c=u.pickId,d=new Uint8Array([255&c,c>>8&255,c>>16&255,c>>24&255]),p=M.collapseAABB3();if(s){let e,s=this._worldMatrixNonIdentity?this._worldMatrix:null;if(t.matrix)e=t.matrix;else{const i=t.scale||wo,s=t.position||Eo,r=t.rotation||Co;M.eulerToQuaternion(r,"XYZ",Ao),e=M.composeMat4(s,Ao,i,Mo)}const c=this._instancingLayers[i];r=c,o=c.createPortion({color:a,metallic:l,roughness:h,opacity:n,meshMatrix:e,worldMatrix:s,aabb:p,pickColor:d}),M.expandAABB3(this._aabb,p);const f=Math.round(c.numIndices/3);this._numTriangles+=f,u.numTriangles=f,u.rtcCenter=c.rtcCenter}else{let e=t.primitive||"triangles";"points"!==e&&"lines"!==e&&"triangles"!==e&&"solid"!==e&&"surface"!==e&&(this.error(`Unsupported value for 'primitive': '${e}' - supported values are 'points', 'lines', 'triangles', 'solid' and 'surface'. Defaulting to 'triangles'.`),e="triangles");let i=t.positions;if(!i)return this.error("Config missing: positions (no meshIds provided, so expecting geometry arrays instead)"),null;let s=t.indices,c=t.edgeIndices;if(!t.indices&&"triangles"===e)return this.error("Config missing for triangles primitive: indices (no meshIds provided, so expecting geometry arrays instead)"),null;let f=!1;if(t.rtcCenter&&(this._lastRTCCenter?M.compareVec3(this._lastRTCCenter,t.rtcCenter)||(f=!0,this._lastRTCCenter.set(t.rtcCenter)):(f=!0,this._lastRTCCenter=M.vec3(t.rtcCenter))),t.positionsDecodeMatrix&&(this._lastDecodeMatrix?M.compareMat4(this._lastDecodeMatrix,t.positionsDecodeMatrix)||(f=!0,this._lastDecodeMatrix.set(t.positionsDecodeMatrix)):(f=!0,this._lastDecodeMatrix=M.mat4(t.positionsDecodeMatrix))),f){for(let t in this._currentBatchingLayers)this._currentBatchingLayers.hasOwnProperty(t)&&this._currentBatchingLayers[t].finalize();this._currentBatchingLayers={}}const _=this._worldMatrixNonIdentity?this._worldMatrix:null;let g;if(!t.positionsDecodeMatrix)if(t.matrix)g=t.matrix;else{const e=t.scale||wo,i=t.position||Eo,s=t.rotation||Co;M.eulerToQuaternion(s,"XYZ",Ao),g=M.composeMat4(i,Ao,e,Mo)}switch(r=this._currentBatchingLayers[e],e){case"triangles":case"solid":case"surface":r&&(r.canCreatePortion(i.length,s.length)||(r.finalize(),delete this._currentBatchingLayers[e],r=null)),r||(r=new Ps(this,{layerIndex:0,scratchMemory:this._scratchMemory,positionsDecodeMatrix:t.positionsDecodeMatrix,rtcCenter:t.rtcCenter,maxGeometryBatchSize:this._maxGeometryBatchSize,solid:"solid"===e}),this._layerList.push(r),this._currentBatchingLayers[e]=r),c||(c=Lt(i,s,null,this._edgeThreshold)),o=r.createPortion({positions:i,normals:t.normals,indices:s,edgeIndices:c,color:a,metallic:l,roughness:h,colors:t.colors,opacity:n,meshMatrix:g,worldMatrix:_,worldAABB:p,pickColor:d});const f=Math.round(s.length/3);this._numTriangles+=f,u.numTriangles=f;break;case"lines":r&&(r.canCreatePortion(i.length,s.length)||(r.finalize(),delete this._currentBatchingLayers[e],r=null)),r||(r=new gr(this,{layerIndex:0,scratchMemory:this._scratchMemory,positionsDecodeMatrix:t.positionsDecodeMatrix,rtcCenter:t.rtcCenter,maxGeometryBatchSize:this._maxGeometryBatchSize}),this._layerList.push(r),this._currentBatchingLayers[e]=r),o=r.createPortion({positions:i,indices:s,color:a,colors:t.colors,opacity:n,meshMatrix:g,worldMatrix:_,worldAABB:p,pickColor:d}),this._numLines+=Math.round(s.length/2);break;case"points":r&&(r.canCreatePortion(i.length)||(r.finalize(),delete this._currentBatchingLayers[e],r=null)),r||(r=new Zr(this,{layerIndex:0,scratchMemory:this._scratchMemory,positionsDecodeMatrix:t.positionsDecodeMatrix,rtcCenter:t.rtcCenter,maxGeometryBatchSize:this._maxGeometryBatchSize}),this._layerList.push(r),this._currentBatchingLayers[e]=r),o=r.createPortion({positions:i,color:a,colors:t.colors,opacity:n,meshMatrix:g,worldMatrix:_,worldAABB:p,pickColor:d}),this._numPoints+=Math.round(i.length/3)}M.expandAABB3(this._aabb,p),this.numGeometries++,u.rtcCenter=t.rtcCenter}u.parent=null,u._layer=r,u._portionId=o,u.aabb=p,this._meshes[e]=u}createEntity(t){let e=t.id;e===undefined?e=M.createUUID():this.scene.components[e]&&(this.error("Scene already has a Component with this ID: "+e+" - will assign random ID"),e=M.createUUID());const i=t.meshIds;if(i===undefined)return void this.error("Config missing: meshIds");let s=[];for(let t=0,e=i.length;t<e;t++){const e=i[t],r=this._meshes[e];r?r.parent?this.error("Mesh with ID "+e+" already belongs to object with ID "+r.parent.id+" - ignoring this mesh"):s.push(r):this.error("Mesh with this ID not found: "+e+" - ignoring this mesh")}let r,o=0;if(this._visible&&!1!==t.visible&&(o|=ei),this._pickable&&!1!==t.pickable&&(o|=si),this._culled&&!1!==t.culled&&(o|=ii),this._clippable&&!1!==t.clippable&&(o|=ri),this._collidable&&!1!==t.collidable&&(o|=oi),this._edges&&!1!==t.edges&&(o|=hi),this._xrayed&&!1!==t.xrayed&&(o|=ai),this._highlighted&&!1!==t.highlighted&&(o|=ni),this._selected&&!1!==t.selected&&(o|=li),1===s.length)r=s[0].aabb;else{r=M.collapseAABB3();for(let t=0,e=s.length;t<e;t++)M.expandAABB3(r,s[t].aabb)}const a=new di(this,t.isObject,e,s,o,r);return this._nodeList.push(a),this._nodes[e]=a,this.numEntities++,a}finalize(){if(!this.destroyed){for(const t in this._instancingLayers)this._instancingLayers.hasOwnProperty(t)&&this._instancingLayers[t].finalize();for(let t in this._currentBatchingLayers)this._currentBatchingLayers.hasOwnProperty(t)&&this._currentBatchingLayers[t].finalize();this._currentBatchingLayers={};for(let t=0,e=this._nodeList.length;t<e;t++){this._nodeList[t]._finalize()}this._layerList.sort(((t,e)=>t.sortId<e.sortId?-1:t.sortId>e.sortId?1:0));for(let t=0,e=this._layerList.length;t<e;t++){this._layerList[t].layerIndex=t}this.glRedraw(),this.scene._aabbDirty=!0}}set backfaces(t){t=!!t,this._backfaces=t,this.glRedraw()}get backfaces(){return this._backfaces}get entityList(){return this._nodeList}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return!1}get aabb(){return this._aabbDirty&&this._rebuildAABB(),this._aabb}_rebuildAABB(){M.collapseAABB3(this._aabb);for(let t=0,e=this._nodeList.length;t<e;t++){const e=this._nodeList[t];M.expandAABB3(this._aabb,e.aabb)}this._aabbDirty=!1}get numTriangles(){return this._numTriangles}get numLines(){return this._numLines}get numPoints(){return this._numPoints}set visible(t){t=!1!==t,this._visible=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].visible=t;this.glRedraw()}get visible(){return this.numVisibleLayerPortions>0}set xrayed(t){t=!!t,this._xrayed=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].xrayed=t;this.glRedraw()}get xrayed(){return this.numXRayedLayerPortions>0}set highlighted(t){t=!!t,this._highlighted=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].highlighted=t;this.glRedraw()}get highlighted(){return this.numHighlightedLayerPortions>0}set selected(t){t=!!t,this._selected=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].selected=t;this.glRedraw()}get selected(){return this.numSelectedLayerPortions>0}set edges(t){t=!!t,this._edges=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].edges=t;this.glRedraw()}get edges(){return this.numEdgesLayerPortions>0}set culled(t){t=!!t,this._culled=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].culled=t;this.glRedraw()}get culled(){return this._culled}set clippable(t){t=!1!==t,this._clippable=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].clippable=t;this.glRedraw()}get clippable(){return this._clippable}set collidable(t){t=!1!==t,this._collidable=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].collidable=t}get collidable(){return this._collidable}set pickable(t){t=!1!==t,this._pickable=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].pickable=t}get pickable(){return this.numPickableLayerPortions>0}set colorize(t){this._colorize=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].colorize=t}get colorize(){return this._colorize}set opacity(t){this._opacity=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].opacity=t}get opacity(){return this._opacity}set castsShadow(t){(t=!1!==t)!==this._castsShadow&&(this._castsShadow=t,this.glRedraw())}get castsShadow(){return this._castsShadow}set receivesShadow(t){(t=!1!==t)!==this._receivesShadow&&(this._receivesShadow=t,this.glRedraw())}get receivesShadow(){return this._receivesShadow}get saoEnabled(){return this._saoEnabled}get pbrEnabled(){return this._pbrEnabled}get isDrawable(){return!0}get isStateSortable(){return!1}stateSortCompare(t,e){}rebuildRenderFlags(){this.renderFlags.reset(),this._updateRenderFlagsVisibleLayers(),this.renderFlags.numLayers>0&&0===this.renderFlags.numVisibleLayers?this.renderFlags.culled=!0:this._updateRenderFlags()}_updateRenderFlagsVisibleLayers(){const t=this.renderFlags;t.numLayers=this._layerList.length,t.numVisibleLayers=0;for(let e=0,i=this._layerList.length;e<i;e++){const i=this._layerList[e];this._getActiveSectionPlanesForLayer(i)&&(t.visibleLayers[t.numVisibleLayers++]=e)}}_getActiveSectionPlanesForLayer(t){const e=this.renderFlags,i=this.scene._sectionPlanesState.sectionPlanes,s=i.length,r=t.layerIndex*s;if(s>0)for(let t=0;t<s;t++){i[t].active?(e.sectionPlanesActivePerLayer[r+t]=!0,e.sectioned=!0):e.sectionPlanesActivePerLayer[r+t]=!1}return!0}_updateRenderFlags(){if(0===this.numVisibleLayerPortions)return;if(this.numCulledLayerPortions===this.numPortions)return;const t=this.renderFlags;if(t.colorOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(t.colorTransparent=!0),this.numXRayedLayerPortions>0){const e=this.scene.xrayMaterial._state;e.fill&&(e.fillAlpha<1?t.xrayedSilhouetteTransparent=!0:t.xrayedSilhouetteOpaque=!0),e.edges&&(e.edgeAlpha<1?t.xrayedEdgesTransparent=!0:t.xrayedEdgesOpaque=!0)}if(this.numEdgesLayerPortions>0){this.scene.edgeMaterial._state.edges&&(t.edgesOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(t.edgesTransparent=!0))}if(this.numSelectedLayerPortions>0){const e=this.scene.selectedMaterial._state;e.fill&&(e.fillAlpha<1?t.selectedSilhouetteTransparent=!0:t.selectedSilhouetteOpaque=!0),e.edges&&(e.edgeAlpha<1?t.selectedEdgesTransparent=!0:t.selectedEdgesOpaque=!0)}if(this.numHighlightedLayerPortions>0){const e=this.scene.highlightMaterial._state;e.fill&&(e.fillAlpha<1?t.highlightedSilhouetteTransparent=!0:t.highlightedSilhouetteOpaque=!0),e.edges&&(e.edgeAlpha<1?t.highlightedEdgesTransparent=!0:t.highlightedEdgesOpaque=!0)}}get xrayMaterial(){return this.scene.xrayMaterial}get highlightMaterial(){return this.scene.highlightMaterial}get selectedMaterial(){return this.scene.selectedMaterial}get edgeMaterial(){return this.scene.edgeMaterial}drawColorOpaque(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawColorOpaque(e,t)}}drawColorTransparent(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawColorTransparent(e,t)}}drawDepth(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawDepth(e,t)}}drawNormals(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawNormals(e,t)}}drawSilhouetteXRayed(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawSilhouetteXRayed(e,t)}}drawSilhouetteHighlighted(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawSilhouetteHighlighted(e,t)}}drawSilhouetteSelected(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawSilhouetteSelected(e,t)}}drawEdgesColorOpaque(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawEdgesColorOpaque(e,t)}}drawEdgesColorTransparent(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawEdgesColorTransparent(e,t)}}drawEdgesXRayed(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawEdgesXRayed(e,t)}}drawEdgesHighlighted(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawEdgesHighlighted(e,t)}}drawEdgesSelected(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawEdgesSelected(e,t)}}drawOcclusion(t){if(0===this.numVisibleLayerPortions)return;const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawOcclusion(e,t)}}drawShadow(t){if(0===this.numVisibleLayerPortions)return;const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawShadow(e,t)}}drawPickMesh(t){if(0===this.numVisibleLayerPortions)return;const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawPickMesh(e,t)}}drawPickDepths(t){if(0===this.numVisibleLayerPortions)return;const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawPickDepths(e,t)}}drawPickNormals(t){if(0===this.numVisibleLayerPortions)return;const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawPickNormals(e,t)}}destroy(){for(let t in this._currentBatchingLayers)this._currentBatchingLayers.hasOwnProperty(t)&&this._currentBatchingLayers[t].destroy();this._currentBatchingLayers={},this.scene.camera.off(this._onCameraViewMatrix);for(let t=0,e=this._layerList.length;t<e;t++)this._layerList[t].destroy();for(let t=0,e=this._nodeList.length;t<e;t++)this._nodeList[t]._destroy();this.scene._aabbDirty=!0,this._isModel&&this.scene._deregisterModel(this),0!==fi&&(fi--,0===fi&&pi._clear()),super.destroy()}}const Do=M.vec4(4),Lo=M.vec4(),Ro=M.vec4(),Bo=M.vec3([1,0,0]),To=M.vec3([0,1,0]),Fo=M.vec3([0,0,1]),No=M.vec3(3),Oo=M.vec3(3),ko=M.identityMat4();class Io extends w{constructor(t,e={}){if(super(t,e),this._parentNode=null,this._children=[],this._aabb=null,this._aabbDirty=!0,this.scene._aabbDirty=!0,this._numTriangles=0,this._scale=M.vec3(),this._quaternion=M.identityQuaternion(),this._rotation=M.vec3(),this._position=M.vec3(),this._offset=M.vec3(),this._localMatrix=M.identityMat4(),this._worldMatrix=M.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,e.matrix?this.matrix=e.matrix:(this.scale=e.scale,this.position=e.position,e.quaternion||(this.rotation=e.rotation)),this._isModel=e.isModel,this._isModel&&this.scene._registerModel(this),this._isObject=e.isObject,this._isObject&&this.scene._registerObject(this),this.rtcCenter=e.rtcCenter,this.visible=e.visible,this.culled=e.culled,this.pickable=e.pickable,this.clippable=e.clippable,this.collidable=e.collidable,this.castsShadow=e.castsShadow,this.receivesShadow=e.receivesShadow,this.xrayed=e.xrayed,this.highlighted=e.highlighted,this.selected=e.selected,this.edges=e.edges,this.colorize=e.colorize,this.opacity=e.opacity,this.offset=e.offset,e.children){const t=e.children;for(let i=0,s=t.length;i<s;i++)this.addChild(t[i],e.inheritStates)}if(e.parentId){const t=this.scene.components[e.parentId];t?t.isNode?t.addChild(this):this.error("Parent is not a Node: '"+e.parentId+"'"):this.error("Parent not found: '"+e.parentId+"'")}else e.parent&&(e.parent.isNode||this.error("Parent is not a Node"),e.parent.addChild(this))}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return this._isObject}get aabb(){return this._aabbDirty&&this._updateAABB(),this._aabb}set rtcCenter(t){t?(this._rtcCenter||(this._rtcCenter=M.vec3()),this._rtcCenter.set(t)):this._rtcCenter&&(this._rtcCenter=null);for(let e=0,i=this._children.length;e<i;e++)this._children[e].rtcCenter=t}get rtcCenter(){return this._rtcCenter}get numTriangles(){return this._numTriangles}set visible(t){t=!1!==t,this._visible=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].visible=t;this._isObject&&this.scene._objectVisibilityUpdated(this,t)}get visible(){return this._visible}set xrayed(t){t=!!t,this._xrayed=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].xrayed=t;this._isObject&&this.scene._objectXRayedUpdated(this,t)}get xrayed(){return this._xrayed}set highlighted(t){t=!!t,this._highlighted=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].highlighted=t;this._isObject&&this.scene._objectHighlightedUpdated(this,t)}get highlighted(){return this._highlighted}set selected(t){t=!!t,this._selected=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].selected=t;this._isObject&&this.scene._objectSelectedUpdated(this,t)}get selected(){return this._selected}set edges(t){t=!!t,this._edges=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].edges=t}get edges(){return this._edges}set culled(t){t=!!t,this._culled=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].culled=t}get culled(){return this._culled}set clippable(t){t=!1!==t,this._clippable=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].clippable=t}get clippable(){return this._clippable}set collidable(t){t=!1!==t,this._collidable=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].collidable=t}get collidable(){return this._collidable}set pickable(t){t=!1!==t,this._pickable=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].pickable=t}get pickable(){return this._pickable}set colorize(t){let e=this._colorize;e||(e=this._colorize=new Float32Array(4),e[3]=1),t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1);for(let t=0,i=this._children.length;t<i;t++)this._children[t].colorize=e;if(this._isObject){const e=!!t;this.scene._objectColorizeUpdated(this,e)}}get colorize(){return this._colorize.slice(0,3)}set opacity(t){let e=this._colorize;e||(e=this._colorize=new Float32Array(4),e[0]=1,e[1]=1,e[2]=1),e[3]=null!==t&&t!==undefined?t:1;for(let e=0,i=this._children.length;e<i;e++)this._children[e].opacity=t;if(this._isObject){const e=null!==t&&t!==undefined;this.scene._objectOpacityUpdated(this,e)}}get opacity(){return this._colorize[3]}set castsShadow(t){t=!!t,this._castsShadow=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].castsShadow=t}get castsShadow(){return this._castsShadow}set receivesShadow(t){t=!!t,this._receivesShadow=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].receivesShadow=t}get receivesShadow(){return this._receivesShadow}get saoEnabled(){return!1}set offset(t){t?(this._offset[0]=t[0],this._offset[1]=t[1],this._offset[2]=t[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(let t=0,e=this._children.length;t<e;t++)this._children[t].offset=this._offset;this._isObject&&this.scene._objectOffsetUpdated(this,t)}get offset(){return this._offset}get isNode(){return!0}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}_setWorldMatrixDirty(){this._worldMatrixDirty=!0;for(let t=0,e=this._children.length;t<e;t++)this._children[t]._setWorldMatrixDirty()}_buildWorldMatrix(){const t=this.matrix;if(this._parentNode)M.mulMat4(this._parentNode.worldMatrix,t,this._worldMatrix);else for(let e=0,i=t.length;e<i;e++)this._worldMatrix[e]=t[e];this._worldMatrixDirty=!1}_setSubtreeAABBsDirty(t){if(t._aabbDirty=!0,t._children)for(let e=0,i=t._children.length;e<i;e++)this._setSubtreeAABBsDirty(t._children[e])}_setAABBDirty(){if(this._setSubtreeAABBsDirty(this),this.collidable)for(let t=this;t;t=t._parentNode)t._aabbDirty=!0}_updateAABB(){if(this.scene._aabbDirty=!0,this._aabb||(this._aabb=M.AABB3()),this._buildAABB)this._buildAABB(this.worldMatrix,this._aabb);else{let t;M.collapseAABB3(this._aabb);for(let e=0,i=this._children.length;e<i;e++)t=this._children[e],t.collidable&&M.expandAABB3(this._aabb,t.aabb)}this._aabbDirty=!1}addChild(t,e){if(n.isNumeric(t)||n.isString(t)){const e=t;if(!(t=this.scene.component[e]))return void this.warn("Component not found: "+n.inQuotes(e));if(!t.isNode&&!t.isMesh)return void this.error("Not a Node or Mesh: "+e)}else{if(!t.isNode&&!t.isMesh)return void this.error("Not a Node or Mesh: "+t.id);if(t._parentNode){if(t._parentNode.id===this.id)return void this.warn("Already a child: "+t.id);t._parentNode.removeChild(t)}}t.id;if(t.scene.id===this.scene.id)return this._children.push(t),t._parentNode=this,e&&(t.visible=this.visible,t.culled=this.culled,t.xrayed=this.xrayed,t.highlited=this.highlighted,t.selected=this.selected,t.edges=this.edges,t.clippable=this.clippable,t.pickable=this.pickable,t.collidable=this.collidable,t.castsShadow=this.castsShadow,t.receivesShadow=this.receivesShadow,t.colorize=this.colorize,t.opacity=this.opacity,t.offset=this.offset),t._setWorldMatrixDirty(),t._setAABBDirty(),this._numTriangles+=t.numTriangles,t;this.error("Child not in same Scene: "+t.id)}removeChild(t){for(let e=0,i=this._children.length;e<i;e++)if(this._children[e].id===t.id)return t._parentNode=null,this._children=this._children.splice(e,1),t._setWorldMatrixDirty(),t._setAABBDirty(),this._setAABBDirty(),void(this._numTriangles-=t.numTriangles)}removeChildren(){let t;for(let e=0,i=this._children.length;e<i;e++)t=this._children[e],t._parentNode=null,t._setWorldMatrixDirty(),t._setAABBDirty(),this._numTriangles-=t.numTriangles;this._children=[],this._setAABBDirty()}get numChildren(){return this._children.length}get children(){return this._children}set parent(t){if(n.isNumeric(t)||n.isString(t)){const e=t;if(!(t=this.scene.components[e]))return void this.warn("Node not found: "+n.inQuotes(e));if(!t.isNode)return void this.error("Not a Node: "+t.id)}t.scene.id===this.scene.id?this._parentNode&&this._parentNode.id===t.id?this.warn("Already a child of Node: "+t.id):t.addChild(this):this.error("Node not in same Scene: "+t.id)}get parent(){return this._parentNode}set position(t){this._position.set(t||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get position(){return this._position}set rotation(t){this._rotation.set(t||[0,0,0]),M.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get rotation(){return this._rotation}set quaternion(t){this._quaternion.set(t||[0,0,0,1]),M.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get quaternion(){return this._quaternion}set scale(t){this._scale.set(t||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get scale(){return this._scale}set matrix(t){this._localMatrix||(this._localMatrix=M.identityMat4()),this._localMatrix.set(t||ko),M.decomposeMat4(this._localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get matrix(){return this._localMatrixDirty&&(this._localMatrix||(this._localMatrix=M.identityMat4()),M.composeMat4(this._position,this._quaternion,this._scale,this._localMatrix),this._localMatrixDirty=!1),this._localMatrix}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}rotate(t,e){return Do[0]=t[0],Do[1]=t[1],Do[2]=t[2],Do[3]=e*M.DEGTORAD,M.angleAxisToQuaternion(Do,Lo),M.mulQuaternions(this.quaternion,Lo,Ro),this.quaternion=Ro,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}rotateOnWorldAxis(t,e){return Do[0]=t[0],Do[1]=t[1],Do[2]=t[2],Do[3]=e*M.DEGTORAD,M.angleAxisToQuaternion(Do,Lo),M.mulQuaternions(Lo,this.quaternion,Lo),this}rotateX(t){return this.rotate(Bo,t)}rotateY(t){return this.rotate(To,t)}rotateZ(t){return this.rotate(Fo,t)}translate(t,e){return M.vec3ApplyQuaternion(this.quaternion,t,No),M.mulVec3Scalar(No,e,Oo),M.addVec3(this.position,Oo,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}translateX(t){return this.translate(Bo,t)}translateY(t){return this.translate(To,t)}translateZ(t){return this.translate(Fo,t)}get type(){return"Node"}destroy(){if(super.destroy(),this._parentNode&&this._parentNode.removeChild(this),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this._children.length){const t=this._children.splice();let e;for(let i=0,s=t.length;i<s;i++)e=t[i],e.destroy()}this._children=[],this._setAABBDirty(),this.scene._aabbDirty=!0}}class zo{constructor(t,e,i){this.id=i&&i.id?i.id:t,this.viewer=e,this._eventSubs={},e.addPlugin(this)}on(t,e){let i=this._eventSubs[t];i||(i=[],this._eventSubs[t]=i),i.push(e)}fire(t,e){const i=this._eventSubs[t];if(i)for(let t=0,s=i.length;t<s;t++)i[t](e)}log(t){console.log(`[xeokit plugin ${this.id}]: ${t}`)}warn(t){console.warn(`[xeokit plugin ${this.id}]: ${t}`)}error(t){console.error(`[xeokit plugin ${this.id}]: ${t}`)}send(t,e){}destroy(){this.viewer.removePlugin(this)}}const Vo=function(t){"LambertMaterial"===t._material._state.type?(this.vertex=function(t){const e=t.scene,i=t.scene._sectionPlanesState,s=t.scene._lightsState,r=t._geometry._state,o=t._state.billboard,a=t._state.stationary,n=i.sectionPlanes.length>0,l=!!r.compressGeometry,h=[];h.push("// Lambertian drawing vertex shader"),e.logarithmicDepthBufferEnabled&&h.push("#extension GL_EXT_frag_depth : enable");h.push("attribute vec3 position;"),h.push("uniform mat4 modelMatrix;"),h.push("uniform mat4 viewMatrix;"),h.push("uniform mat4 projMatrix;"),h.push("uniform vec4 colorize;"),h.push("uniform vec3 offset;"),l&&h.push("uniform mat4 positionsDecodeMatrix;");e.logarithmicDepthBufferEnabled&&(h.push("uniform float logDepthBufFC;"),h.push("varying float vFragDepth;"));n&&h.push("varying vec4 vWorldPosition;");if(h.push("uniform vec4 lightAmbient;"),h.push("uniform vec4 materialColor;"),h.push("uniform vec3 materialEmissive;"),r.normalsBuf){h.push("attribute vec3 normal;"),h.push("uniform mat4 modelNormalMatrix;"),h.push("uniform mat4 viewNormalMatrix;");for(let t=0,e=s.lights.length;t<e;t++){const e=s.lights[t];"ambient"!==e.type&&(h.push("uniform vec4 lightColor"+t+";"),"dir"===e.type&&h.push("uniform vec3 lightDir"+t+";"),"point"===e.type&&h.push("uniform vec3 lightPos"+t+";"),"spot"===e.type&&(h.push("uniform vec3 lightPos"+t+";"),h.push("uniform vec3 lightDir"+t+";")))}l&&(h.push("vec3 octDecode(vec2 oct) {"),h.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),h.push("    if (v.z < 0.0) {"),h.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),h.push("    }"),h.push("    return normalize(v);"),h.push("}"))}h.push("varying vec4 vColor;"),"points"===r.primitiveName&&h.push("uniform float pointSize;");"spherical"!==o&&"cylindrical"!==o||(h.push("void billboard(inout mat4 mat) {"),h.push("   mat[0][0] = 1.0;"),h.push("   mat[0][1] = 0.0;"),h.push("   mat[0][2] = 0.0;"),"spherical"===o&&(h.push("   mat[1][0] = 0.0;"),h.push("   mat[1][1] = 1.0;"),h.push("   mat[1][2] = 0.0;")),h.push("   mat[2][0] = 0.0;"),h.push("   mat[2][1] = 0.0;"),h.push("   mat[2][2] =1.0;"),h.push("}"));h.push("void main(void) {"),h.push("vec4 localPosition = vec4(position, 1.0); "),h.push("vec4 worldPosition;"),l&&h.push("localPosition = positionsDecodeMatrix * localPosition;");r.normalsBuf&&(l?h.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):h.push("vec4 localNormal = vec4(normal, 0.0); "),h.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),h.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));h.push("mat4 viewMatrix2 = viewMatrix;"),h.push("mat4 modelMatrix2 = modelMatrix;"),a&&h.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===o||"cylindrical"===o?(h.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),h.push("billboard(modelMatrix2);"),h.push("billboard(viewMatrix2);"),h.push("billboard(modelViewMatrix);"),r.normalsBuf&&(h.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),h.push("billboard(modelNormalMatrix2);"),h.push("billboard(viewNormalMatrix2);"),h.push("billboard(modelViewNormalMatrix);")),h.push("worldPosition = modelMatrix2 * localPosition;"),h.push("worldPosition.xyz = worldPosition.xyz + offset;"),h.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(h.push("worldPosition = modelMatrix2 * localPosition;"),h.push("worldPosition.xyz = worldPosition.xyz + offset;"),h.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));r.normalsBuf&&h.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(h.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),h.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),h.push("float lambertian = 1.0;"),r.normalsBuf)for(let t=0,e=s.lights.length;t<e;t++){const e=s.lights[t];if("ambient"!==e.type){if("dir"===e.type)"view"===e.space?h.push("viewLightDir = normalize(lightDir"+t+");"):h.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+t+", 0.0)).xyz);");else if("point"===e.type)"view"===e.space?h.push("viewLightDir = -normalize(lightPos"+t+" - viewPosition.xyz);"):h.push("viewLightDir = -normalize((viewMatrix2 * vec4(lightPos"+t+", 0.0)).xyz);");else{if("spot"!==e.type)continue;"view"===e.space?h.push("viewLightDir = normalize(lightDir"+t+");"):h.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+t+", 0.0)).xyz);")}h.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),h.push("reflectedColor += lambertian * (lightColor"+t+".rgb * lightColor"+t+".a);")}}h.push("vColor = vec4((lightAmbient.rgb * lightAmbient.a * materialColor.rgb) + materialEmissive.rgb + (reflectedColor * materialColor.rgb), materialColor.a) * colorize;"),n&&h.push("vWorldPosition = worldPosition;");"points"===r.primitiveName&&h.push("gl_PointSize = pointSize;");h.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&h.push("vFragDepth = 1.0 + clipPos.w;");return h.push("gl_Position = clipPos;"),h.push("}"),h}(t),this.fragment=function(t){const e=t.scene,i=e._sectionPlanesState,s=(t._material._state,t._geometry._state),r=i.sectionPlanes.length>0,o=!1,a=e.gammaOutput,n=[];n.push("// Lambertian drawing fragment shader"),e.logarithmicDepthBufferEnabled&&n.push("#extension GL_EXT_frag_depth : enable");n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("varying float vFragDepth;"));if(r){n.push("varying vec4 vWorldPosition;"),n.push("uniform bool clippable;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)n.push("uniform bool sectionPlaneActive"+t+";"),n.push("uniform vec3 sectionPlanePos"+t+";"),n.push("uniform vec3 sectionPlaneDir"+t+";")}n.push("varying vec4 vColor;"),a&&(n.push("uniform float gammaFactor;"),n.push("    vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("    return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}"));if(n.push("void main(void) {"),r){n.push("if (clippable) {"),n.push("  float dist = 0.0;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)n.push("if (sectionPlaneActive"+t+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { discard; }"),o&&(n.push("  if (gl_FrontFacing == false) {"),n.push("     gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);"),n.push("     return;"),n.push("  }")),n.push("}")}"points"===s.primitiveName&&(n.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),n.push("float r = dot(cxy, cxy);"),n.push("if (r > 1.0) {"),n.push("   discard;"),n.push("}"));e.logarithmicDepthBufferEnabled&&n.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");a?n.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):n.push("gl_FragColor = vColor;");return n.push("}"),n}(t)):(this.vertex=function(t){const e=t.scene,i=t._material,s=t._state,r=e._sectionPlanesState,o=t._geometry._state,a=e._lightsState;let n;const l=s.billboard,h=s.stationary,u=function(t){if(!t._geometry._state.uvBuf)return!1;const e=t._material;return!!(e._ambientMap||e._occlusionMap||e._baseColorMap||e._diffuseMap||e._alphaMap||e._specularMap||e._glossinessMap||e._specularGlossinessMap||e._emissiveMap||e._metallicMap||e._roughnessMap||e._metallicRoughnessMap||e._reflectivityMap||e._normalMap)}(t),c=Xo(t),d=r.sectionPlanes.length>0,p=Go(t),f=!!o.compressGeometry,_=[];_.push("// Drawing vertex shader"),c&&i._normalMap&&_.push("#extension GL_OES_standard_derivatives : enable");e.logarithmicDepthBufferEnabled&&_.push("#extension GL_EXT_frag_depth : enable");_.push("attribute  vec3 position;"),f&&_.push("uniform mat4 positionsDecodeMatrix;");_.push("uniform  mat4 modelMatrix;"),_.push("uniform  mat4 viewMatrix;"),_.push("uniform  mat4 projMatrix;"),_.push("varying  vec3 vViewPosition;"),_.push("uniform  vec3 offset;"),d&&_.push("varying vec4 vWorldPosition;");e.logarithmicDepthBufferEnabled&&(_.push("uniform float logDepthBufFC;"),_.push("varying float vFragDepth;"));a.lightMaps.length>0&&_.push("varying    vec3 vWorldNormal;");if(c){_.push("attribute  vec3 normal;"),_.push("uniform    mat4 modelNormalMatrix;"),_.push("uniform    mat4 viewNormalMatrix;"),_.push("varying    vec3 vViewNormal;");for(let t=0,e=a.lights.length;t<e;t++)n=a.lights[t],"ambient"!==n.type&&("dir"===n.type&&_.push("uniform vec3 lightDir"+t+";"),"point"===n.type&&_.push("uniform vec3 lightPos"+t+";"),"spot"===n.type&&(_.push("uniform vec3 lightPos"+t+";"),_.push("uniform vec3 lightDir"+t+";")),"dir"===n.type&&"view"===n.space||_.push("varying vec4 vViewLightReverseDirAndDist"+t+";"));f&&(_.push("vec3 octDecode(vec2 oct) {"),_.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),_.push("    if (v.z < 0.0) {"),_.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),_.push("    }"),_.push("    return normalize(v);"),_.push("}"))}u&&(_.push("attribute vec2 uv;"),_.push("varying vec2 vUV;"),f&&_.push("uniform mat3 uvDecodeMatrix;"));o.colors&&(_.push("attribute vec4 color;"),_.push("varying vec4 vColor;"));"points"===o.primitiveName&&_.push("uniform float pointSize;");"spherical"!==l&&"cylindrical"!==l||(_.push("void billboard(inout mat4 mat) {"),_.push("   mat[0][0] = 1.0;"),_.push("   mat[0][1] = 0.0;"),_.push("   mat[0][2] = 0.0;"),"spherical"===l&&(_.push("   mat[1][0] = 0.0;"),_.push("   mat[1][1] = 1.0;"),_.push("   mat[1][2] = 0.0;")),_.push("   mat[2][0] = 0.0;"),_.push("   mat[2][1] = 0.0;"),_.push("   mat[2][2] =1.0;"),_.push("}"));if(p){_.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);");for(let t=0,e=a.lights.length;t<e;t++)a.lights[t].castsShadow&&(_.push("uniform mat4 shadowViewMatrix"+t+";"),_.push("uniform mat4 shadowProjMatrix"+t+";"),_.push("varying vec4 vShadowPosFromLight"+t+";"))}_.push("void main(void) {"),_.push("vec4 localPosition = vec4(position, 1.0); "),_.push("vec4 worldPosition;"),f&&_.push("localPosition = positionsDecodeMatrix * localPosition;");c&&(f?_.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):_.push("vec4 localNormal = vec4(normal, 0.0); "),_.push("mat4 modelNormalMatrix2    = modelNormalMatrix;"),_.push("mat4 viewNormalMatrix2     = viewNormalMatrix;"));_.push("mat4 viewMatrix2           = viewMatrix;"),_.push("mat4 modelMatrix2          = modelMatrix;"),h&&_.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===l||"cylindrical"===l?(_.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),_.push("billboard(modelMatrix2);"),_.push("billboard(viewMatrix2);"),_.push("billboard(modelViewMatrix);"),c&&(_.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),_.push("billboard(modelNormalMatrix2);"),_.push("billboard(viewNormalMatrix2);"),_.push("billboard(modelViewNormalMatrix);")),_.push("worldPosition = modelMatrix2 * localPosition;"),_.push("worldPosition.xyz = worldPosition.xyz + offset;"),_.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(_.push("worldPosition = modelMatrix2 * localPosition;"),_.push("worldPosition.xyz = worldPosition.xyz + offset;"),_.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));if(c){_.push("vec3 worldNormal = (modelNormalMatrix2 * localNormal).xyz; "),a.lightMaps.length>0&&_.push("vWorldNormal = worldNormal;"),_.push("vViewNormal = normalize((viewNormalMatrix2 * vec4(worldNormal, 1.0)).xyz);"),_.push("vec3 tmpVec3;"),_.push("float lightDist;");for(let t=0,e=a.lights.length;t<e;t++)n=a.lights[t],"ambient"!==n.type&&("dir"===n.type&&"world"===n.space&&(_.push("tmpVec3 = vec3(viewMatrix2 * vec4(lightDir"+t+", 0.0) ).xyz;"),_.push("vViewLightReverseDirAndDist"+t+" = vec4(-tmpVec3, 0.0);")),"point"===n.type&&("world"===n.space?(_.push("tmpVec3 = (viewMatrix2 * vec4(lightPos"+t+", 1.0)).xyz - viewPosition.xyz;"),_.push("lightDist = abs(length(tmpVec3));")):(_.push("tmpVec3 = lightPos"+t+".xyz - viewPosition.xyz;"),_.push("lightDist = abs(length(tmpVec3));")),_.push("vViewLightReverseDirAndDist"+t+" = vec4(tmpVec3, lightDist);")))}u&&(f?_.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"):_.push("vUV = uv;"));o.colors&&_.push("vColor = color;");"points"===o.primitiveName&&_.push("gl_PointSize = pointSize;");d&&_.push("vWorldPosition = worldPosition;");_.push("   vViewPosition = viewPosition.xyz;"),_.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&_.push("vFragDepth = 1.0 + clipPos.w;");if(_.push("gl_Position = clipPos;"),p){_.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),_.push("vec4 tempx; ");for(let t=0,e=a.lights.length;t<e;t++)a.lights[t].castsShadow&&_.push("vShadowPosFromLight"+t+" = texUnitConverter * shadowProjMatrix"+t+" * (shadowViewMatrix"+t+" * worldPosition); ")}return _.push("}"),_}(t),this.fragment=function(t){const e=t.scene,i=(e.canvas.gl,t._material),s=t._geometry._state,r=t.scene._sectionPlanesState,o=t.scene._lightsState,a=t._material._state,n=r.sectionPlanes.length>0,l=Xo(t),h=s.uvBuf,u=!1,c="PhongMaterial"===a.type,d="MetallicMaterial"===a.type,p="SpecularMaterial"===a.type,f=Go(t),_=(e.gammaInput,e.gammaOutput);const g=[];g.push("// Drawing fragment shader"),e.logarithmicDepthBufferEnabled&&g.push("#extension GL_EXT_frag_depth : enable");l&&i._normalMap&&g.push("#extension GL_OES_standard_derivatives : enable");g.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),g.push("precision highp float;"),g.push("precision highp int;"),g.push("#else"),g.push("precision mediump float;"),g.push("precision mediump int;"),g.push("#endif"),e.logarithmicDepthBufferEnabled&&(g.push("uniform float logDepthBufFC;"),g.push("varying float vFragDepth;"));f&&(g.push("float unpackDepth (vec4 color) {"),g.push("  const vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0 * 256.0), 1.0/(256.0*256.0*256.0));"),g.push("  return dot(color, bitShift);"),g.push("}"));g.push("uniform float gammaFactor;"),g.push("vec4 linearToLinear( in vec4 value ) {"),g.push("  return value;"),g.push("}"),g.push("vec4 sRGBToLinear( in vec4 value ) {"),g.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),g.push("}"),g.push("vec4 gammaToLinear( in vec4 value) {"),g.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),g.push("}"),_&&(g.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),g.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),g.push("}"));if(n){g.push("varying vec4 vWorldPosition;"),g.push("uniform bool clippable;");for(var m=0;m<r.sectionPlanes.length;m++)g.push("uniform bool sectionPlaneActive"+m+";"),g.push("uniform vec3 sectionPlanePos"+m+";"),g.push("uniform vec3 sectionPlaneDir"+m+";")}l&&(o.lightMaps.length>0&&(g.push("uniform samplerCube lightMap;"),g.push("uniform mat4 viewNormalMatrix;")),o.reflectionMaps.length>0&&g.push("uniform samplerCube reflectionMap;"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&g.push("uniform mat4 viewMatrix;"),g.push("#define PI 3.14159265359"),g.push("#define RECIPROCAL_PI 0.31830988618"),g.push("#define RECIPROCAL_PI2 0.15915494"),g.push("#define EPSILON 1e-6"),g.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),g.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),g.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),g.push("}"),g.push("struct IncidentLight {"),g.push("   vec3 color;"),g.push("   vec3 direction;"),g.push("};"),g.push("struct ReflectedLight {"),g.push("   vec3 diffuse;"),g.push("   vec3 specular;"),g.push("};"),g.push("struct Geometry {"),g.push("   vec3 position;"),g.push("   vec3 viewNormal;"),g.push("   vec3 worldNormal;"),g.push("   vec3 viewEyeDir;"),g.push("};"),g.push("struct Material {"),g.push("   vec3    diffuseColor;"),g.push("   float   specularRoughness;"),g.push("   vec3    specularColor;"),g.push("   float   shine;"),g.push("};"),c&&((o.lightMaps.length>0||o.reflectionMaps.length>0)&&(g.push("void computePhongLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(g.push("   vec3 irradiance = "+Uo[o.lightMaps[0].encoding]+"(textureCube(lightMap, geometry.worldNormal)).rgb;"),g.push("   irradiance *= PI;"),g.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),g.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(g.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),g.push("   vec3 radiance               = textureCube(reflectionMap, reflectVec).rgb * 0.2;"),g.push("   radiance *= PI;"),g.push("   reflectedLight.specular     += radiance;")),g.push("}")),g.push("void computePhongLighting(const in IncidentLight directLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),g.push("   float dotNL     = saturate(dot(geometry.viewNormal, directLight.direction));"),g.push("   vec3 irradiance = dotNL * directLight.color * PI;"),g.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),g.push("   reflectedLight.specular += directLight.color * material.specularColor * pow(max(dot(reflect(-directLight.direction, -geometry.viewNormal), geometry.viewEyeDir), 0.0), material.shine);"),g.push("}")),(d||p)&&(g.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),g.push("   float r = ggxRoughness + 0.0001;"),g.push("   return (2.0 / (r * r) - 2.0);"),g.push("}"),g.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),g.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),g.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),g.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),g.push("}"),o.reflectionMaps.length>0&&(g.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),g.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),g.push("   vec3 envMapColor = "+Uo[o.reflectionMaps[0].encoding]+"(textureCube(reflectionMap, reflectVec, mipLevel)).rgb;"),g.push("  return envMapColor;"),g.push("}")),g.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),g.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),g.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),g.push("}"),g.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),g.push("   float a2 = ( alpha * alpha );"),g.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),g.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),g.push("   return 1.0 / ( gl * gv );"),g.push("}"),g.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),g.push("   float a2 = ( alpha * alpha );"),g.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),g.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),g.push("   return 0.5 / max( gv + gl, EPSILON );"),g.push("}"),g.push("float D_GGX(const in float alpha, const in float dotNH) {"),g.push("   float a2 = ( alpha * alpha );"),g.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),g.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),g.push("}"),g.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),g.push("   float alpha = ( roughness * roughness );"),g.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),g.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),g.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),g.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),g.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),g.push("   vec3  F = F_Schlick( specularColor, dotLH );"),g.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),g.push("   float D = D_GGX( alpha, dotNH );"),g.push("   return F * (G * D);"),g.push("}"),g.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),g.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),g.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),g.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),g.push("   vec4 r = roughness * c0 + c1;"),g.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),g.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),g.push("   return specularColor * AB.x + AB.y;"),g.push("}"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&(g.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(g.push("   vec3 irradiance = sRGBToLinear(textureCube(lightMap, geometry.worldNormal)).rgb;"),g.push("   irradiance *= PI;"),g.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),g.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(g.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),g.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),g.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),g.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),g.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),g.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),g.push("}")),g.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),g.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),g.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),g.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),g.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),g.push("}")));g.push("varying vec3 vViewPosition;"),s.colors&&g.push("varying vec4 vColor;");h&&(l&&i._normalMap||i._ambientMap||i._baseColorMap||i._diffuseMap||i._emissiveMap||i._metallicMap||i._roughnessMap||i._metallicRoughnessMap||i._specularMap||i._glossinessMap||i._specularGlossinessMap||i._occlusionMap||i._alphaMap)&&g.push("varying vec2 vUV;");l&&(o.lightMaps.length>0&&g.push("varying vec3 vWorldNormal;"),g.push("varying vec3 vViewNormal;"));a.ambient&&g.push("uniform vec3 materialAmbient;");a.baseColor&&g.push("uniform vec3 materialBaseColor;");a.alpha!==undefined&&null!==a.alpha&&g.push("uniform vec4 materialAlphaModeCutoff;");a.emissive&&g.push("uniform vec3 materialEmissive;");a.diffuse&&g.push("uniform vec3 materialDiffuse;");a.glossiness!==undefined&&null!==a.glossiness&&g.push("uniform float materialGlossiness;");a.shininess!==undefined&&null!==a.shininess&&g.push("uniform float materialShininess;");a.specular&&g.push("uniform vec3 materialSpecular;");a.metallic!==undefined&&null!==a.metallic&&g.push("uniform float materialMetallic;");a.roughness!==undefined&&null!==a.roughness&&g.push("uniform float materialRoughness;");a.specularF0!==undefined&&null!==a.specularF0&&g.push("uniform float materialSpecularF0;");h&&i._ambientMap&&(g.push("uniform sampler2D ambientMap;"),i._ambientMap._state.matrix&&g.push("uniform mat4 ambientMapMatrix;"));h&&i._baseColorMap&&(g.push("uniform sampler2D baseColorMap;"),i._baseColorMap._state.matrix&&g.push("uniform mat4 baseColorMapMatrix;"));h&&i._diffuseMap&&(g.push("uniform sampler2D diffuseMap;"),i._diffuseMap._state.matrix&&g.push("uniform mat4 diffuseMapMatrix;"));h&&i._emissiveMap&&(g.push("uniform sampler2D emissiveMap;"),i._emissiveMap._state.matrix&&g.push("uniform mat4 emissiveMapMatrix;"));l&&h&&i._metallicMap&&(g.push("uniform sampler2D metallicMap;"),i._metallicMap._state.matrix&&g.push("uniform mat4 metallicMapMatrix;"));l&&h&&i._roughnessMap&&(g.push("uniform sampler2D roughnessMap;"),i._roughnessMap._state.matrix&&g.push("uniform mat4 roughnessMapMatrix;"));l&&h&&i._metallicRoughnessMap&&(g.push("uniform sampler2D metallicRoughnessMap;"),i._metallicRoughnessMap._state.matrix&&g.push("uniform mat4 metallicRoughnessMapMatrix;"));l&&i._normalMap&&(g.push("uniform sampler2D normalMap;"),i._normalMap._state.matrix&&g.push("uniform mat4 normalMapMatrix;"),g.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),g.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),g.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),g.push("      vec2 st0 = dFdx( uv.st );"),g.push("      vec2 st1 = dFdy( uv.st );"),g.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),g.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),g.push("      vec3 N = normalize( surf_norm );"),g.push("      vec3 mapN = texture2D( normalMap, uv ).xyz * 2.0 - 1.0;"),g.push("      mat3 tsn = mat3( S, T, N );"),g.push("      return normalize( tsn * mapN );"),g.push("}"));h&&i._occlusionMap&&(g.push("uniform sampler2D occlusionMap;"),i._occlusionMap._state.matrix&&g.push("uniform mat4 occlusionMapMatrix;"));h&&i._alphaMap&&(g.push("uniform sampler2D alphaMap;"),i._alphaMap._state.matrix&&g.push("uniform mat4 alphaMapMatrix;"));l&&h&&i._specularMap&&(g.push("uniform sampler2D specularMap;"),i._specularMap._state.matrix&&g.push("uniform mat4 specularMapMatrix;"));l&&h&&i._glossinessMap&&(g.push("uniform sampler2D glossinessMap;"),i._glossinessMap._state.matrix&&g.push("uniform mat4 glossinessMapMatrix;"));l&&h&&i._specularGlossinessMap&&(g.push("uniform sampler2D materialSpecularGlossinessMap;"),i._specularGlossinessMap._state.matrix&&g.push("uniform mat4 materialSpecularGlossinessMapMatrix;"));l&&(i._diffuseFresnel||i._specularFresnel||i._alphaFresnel||i._emissiveFresnel||i._reflectivityFresnel)&&(g.push("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),g.push("    float fr = abs(dot(eyeDir, normal));"),g.push("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),g.push("    return pow(finalFr, power);"),g.push("}"),i._diffuseFresnel&&(g.push("uniform float  diffuseFresnelCenterBias;"),g.push("uniform float  diffuseFresnelEdgeBias;"),g.push("uniform float  diffuseFresnelPower;"),g.push("uniform vec3   diffuseFresnelCenterColor;"),g.push("uniform vec3   diffuseFresnelEdgeColor;")),i._specularFresnel&&(g.push("uniform float  specularFresnelCenterBias;"),g.push("uniform float  specularFresnelEdgeBias;"),g.push("uniform float  specularFresnelPower;"),g.push("uniform vec3   specularFresnelCenterColor;"),g.push("uniform vec3   specularFresnelEdgeColor;")),i._alphaFresnel&&(g.push("uniform float  alphaFresnelCenterBias;"),g.push("uniform float  alphaFresnelEdgeBias;"),g.push("uniform float  alphaFresnelPower;"),g.push("uniform vec3   alphaFresnelCenterColor;"),g.push("uniform vec3   alphaFresnelEdgeColor;")),i._reflectivityFresnel&&(g.push("uniform float  materialSpecularF0FresnelCenterBias;"),g.push("uniform float  materialSpecularF0FresnelEdgeBias;"),g.push("uniform float  materialSpecularF0FresnelPower;"),g.push("uniform vec3   materialSpecularF0FresnelCenterColor;"),g.push("uniform vec3   materialSpecularF0FresnelEdgeColor;")),i._emissiveFresnel&&(g.push("uniform float  emissiveFresnelCenterBias;"),g.push("uniform float  emissiveFresnelEdgeBias;"),g.push("uniform float  emissiveFresnelPower;"),g.push("uniform vec3   emissiveFresnelCenterColor;"),g.push("uniform vec3   emissiveFresnelEdgeColor;")));if(g.push("uniform vec4   lightAmbient;"),l)for(let t=0,e=o.lights.length;t<e;t++){const e=o.lights[t];"ambient"!==e.type&&(g.push("uniform vec4 lightColor"+t+";"),"point"===e.type&&g.push("uniform vec3 lightAttenuation"+t+";"),"dir"===e.type&&"view"===e.space&&g.push("uniform vec3 lightDir"+t+";"),"point"===e.type&&"view"===e.space?g.push("uniform vec3 lightPos"+t+";"):g.push("varying vec4 vViewLightReverseDirAndDist"+t+";"))}if(f)for(let t=0,e=o.lights.length;t<e;t++)o.lights[t].castsShadow&&(g.push("varying vec4 vShadowPosFromLight"+t+";"),g.push("uniform sampler2D shadowMap"+t+";"));if(g.push("uniform vec4 colorize;"),g.push("void main(void) {"),n){g.push("if (clippable) {"),g.push("  float dist = 0.0;");for(m=0;m<r.sectionPlanes.length;m++)g.push("if (sectionPlaneActive"+m+") {"),g.push("   dist += clamp(dot(-sectionPlaneDir"+m+".xyz, vWorldPosition.xyz - sectionPlanePos"+m+".xyz), 0.0, 1000.0);"),g.push("}");g.push("  if (dist > 0.0) { discard; }"),u&&(g.push("  if (gl_FrontFacing == false) {"),g.push("     gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);"),g.push("     return;"),g.push("  }")),g.push("}")}"points"===s.primitiveName&&(g.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),g.push("float r = dot(cxy, cxy);"),g.push("if (r > 1.0) {"),g.push("   discard;"),g.push("}"));g.push("float occlusion = 1.0;"),a.ambient?g.push("vec3 ambientColor = materialAmbient;"):g.push("vec3 ambientColor = vec3(1.0, 1.0, 1.0);");a.diffuse?g.push("vec3 diffuseColor = materialDiffuse;"):a.baseColor?g.push("vec3 diffuseColor = materialBaseColor;"):g.push("vec3 diffuseColor = vec3(1.0, 1.0, 1.0);");s.colors&&g.push("diffuseColor *= vColor.rgb;");a.emissive?g.push("vec3 emissiveColor = materialEmissive;"):g.push("vec3  emissiveColor = vec3(0.0, 0.0, 0.0);");a.specular?g.push("vec3 specular = materialSpecular;"):g.push("vec3 specular = vec3(1.0, 1.0, 1.0);");a.alpha!==undefined?g.push("float alpha = materialAlphaModeCutoff[0];"):g.push("float alpha = 1.0;");s.colors&&g.push("alpha *= vColor.a;");a.glossiness!==undefined?g.push("float glossiness = materialGlossiness;"):g.push("float glossiness = 1.0;");a.metallic!==undefined?g.push("float metallic = materialMetallic;"):g.push("float metallic = 1.0;");a.roughness!==undefined?g.push("float roughness = materialRoughness;"):g.push("float roughness = 1.0;");a.specularF0!==undefined?g.push("float specularF0 = materialSpecularF0;"):g.push("float specularF0 = 1.0;");h&&(l&&i._normalMap||i._ambientMap||i._baseColorMap||i._diffuseMap||i._occlusionMap||i._emissiveMap||i._metallicMap||i._roughnessMap||i._metallicRoughnessMap||i._specularMap||i._glossinessMap||i._specularGlossinessMap||i._alphaMap)&&(g.push("vec4 texturePos = vec4(vUV.s, vUV.t, 1.0, 1.0);"),g.push("vec2 textureCoord;"));h&&i._ambientMap&&(i._ambientMap._state.matrix?g.push("textureCoord = (ambientMapMatrix * texturePos).xy;"):g.push("textureCoord = texturePos.xy;"),g.push("vec4 ambientTexel = texture2D(ambientMap, textureCoord).rgb;"),g.push("ambientTexel = "+Uo[i._ambientMap._state.encoding]+"(ambientTexel);"),g.push("ambientColor *= ambientTexel.rgb;"));h&&i._diffuseMap&&(i._diffuseMap._state.matrix?g.push("textureCoord = (diffuseMapMatrix * texturePos).xy;"):g.push("textureCoord = texturePos.xy;"),g.push("vec4 diffuseTexel = texture2D(diffuseMap, textureCoord);"),g.push("diffuseTexel = "+Uo[i._diffuseMap._state.encoding]+"(diffuseTexel);"),g.push("diffuseColor *= diffuseTexel.rgb;"),g.push("alpha *= diffuseTexel.a;"));h&&i._baseColorMap&&(i._baseColorMap._state.matrix?g.push("textureCoord = (baseColorMapMatrix * texturePos).xy;"):g.push("textureCoord = texturePos.xy;"),g.push("vec4 baseColorTexel = texture2D(baseColorMap, textureCoord);"),g.push("baseColorTexel = "+Uo[i._baseColorMap._state.encoding]+"(baseColorTexel);"),g.push("diffuseColor *= baseColorTexel.rgb;"),g.push("alpha *= baseColorTexel.a;"));h&&i._emissiveMap&&(i._emissiveMap._state.matrix?g.push("textureCoord = (emissiveMapMatrix * texturePos).xy;"):g.push("textureCoord = texturePos.xy;"),g.push("vec4 emissiveTexel = texture2D(emissiveMap, textureCoord);"),g.push("emissiveTexel = "+Uo[i._emissiveMap._state.encoding]+"(emissiveTexel);"),g.push("emissiveColor = emissiveTexel.rgb;"));h&&i._alphaMap&&(i._alphaMap._state.matrix?g.push("textureCoord = (alphaMapMatrix * texturePos).xy;"):g.push("textureCoord = texturePos.xy;"),g.push("alpha *= texture2D(alphaMap, textureCoord).r;"));h&&i._occlusionMap&&(i._occlusionMap._state.matrix?g.push("textureCoord = (occlusionMapMatrix * texturePos).xy;"):g.push("textureCoord = texturePos.xy;"),g.push("occlusion *= texture2D(occlusionMap, textureCoord).r;"));if(l&&(o.lights.length>0||o.lightMaps.length>0||o.reflectionMaps.length>0)){h&&i._normalMap?(i._normalMap._state.matrix?g.push("textureCoord = (normalMapMatrix * texturePos).xy;"):g.push("textureCoord = texturePos.xy;"),g.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition, normalize(vViewNormal), textureCoord );")):g.push("vec3 viewNormal = normalize(vViewNormal);"),h&&i._specularMap&&(i._specularMap._state.matrix?g.push("textureCoord = (specularMapMatrix * texturePos).xy;"):g.push("textureCoord = texturePos.xy;"),g.push("specular *= texture2D(specularMap, textureCoord).rgb;")),h&&i._glossinessMap&&(i._glossinessMap._state.matrix?g.push("textureCoord = (glossinessMapMatrix * texturePos).xy;"):g.push("textureCoord = texturePos.xy;"),g.push("glossiness *= texture2D(glossinessMap, textureCoord).r;")),h&&i._specularGlossinessMap&&(i._specularGlossinessMap._state.matrix?g.push("textureCoord = (materialSpecularGlossinessMapMatrix * texturePos).xy;"):g.push("textureCoord = texturePos.xy;"),g.push("vec4 specGlossRGB = texture2D(materialSpecularGlossinessMap, textureCoord).rgba;"),g.push("specular *= specGlossRGB.rgb;"),g.push("glossiness *= specGlossRGB.a;")),h&&i._metallicMap&&(i._metallicMap._state.matrix?g.push("textureCoord = (metallicMapMatrix * texturePos).xy;"):g.push("textureCoord = texturePos.xy;"),g.push("metallic *= texture2D(metallicMap, textureCoord).r;")),h&&i._roughnessMap&&(i._roughnessMap._state.matrix?g.push("textureCoord = (roughnessMapMatrix * texturePos).xy;"):g.push("textureCoord = texturePos.xy;"),g.push("roughness *= texture2D(roughnessMap, textureCoord).r;")),h&&i._metallicRoughnessMap&&(i._metallicRoughnessMap._state.matrix?g.push("textureCoord = (metallicRoughnessMapMatrix * texturePos).xy;"):g.push("textureCoord = texturePos.xy;"),g.push("vec3 metalRoughRGB = texture2D(metallicRoughnessMap, textureCoord).rgb;"),g.push("metallic *= metalRoughRGB.b;"),g.push("roughness *= metalRoughRGB.g;")),g.push("vec3 viewEyeDir = normalize(-vViewPosition);"),i._diffuseFresnel&&(g.push("float diffuseFresnel = fresnel(viewEyeDir, viewNormal, diffuseFresnelEdgeBias, diffuseFresnelCenterBias, diffuseFresnelPower);"),g.push("diffuseColor *= mix(diffuseFresnelEdgeColor, diffuseFresnelCenterColor, diffuseFresnel);")),i._specularFresnel&&(g.push("float specularFresnel = fresnel(viewEyeDir, viewNormal, specularFresnelEdgeBias, specularFresnelCenterBias, specularFresnelPower);"),g.push("specular *= mix(specularFresnelEdgeColor, specularFresnelCenterColor, specularFresnel);")),i._alphaFresnel&&(g.push("float alphaFresnel = fresnel(viewEyeDir, viewNormal, alphaFresnelEdgeBias, alphaFresnelCenterBias, alphaFresnelPower);"),g.push("alpha *= mix(alphaFresnelEdgeColor.r, alphaFresnelCenterColor.r, alphaFresnel);")),i._emissiveFresnel&&(g.push("float emissiveFresnel = fresnel(viewEyeDir, viewNormal, emissiveFresnelEdgeBias, emissiveFresnelCenterBias, emissiveFresnelPower);"),g.push("emissiveColor *= mix(emissiveFresnelEdgeColor, emissiveFresnelCenterColor, emissiveFresnel);")),g.push("if (materialAlphaModeCutoff[1] == 1.0 && alpha < materialAlphaModeCutoff[2]) {"),g.push("   discard;"),g.push("}"),g.push("IncidentLight  light;"),g.push("Material       material;"),g.push("Geometry       geometry;"),g.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),g.push("vec3           viewLightDir;"),c&&(g.push("material.diffuseColor      = diffuseColor;"),g.push("material.specularColor     = specular;"),g.push("material.shine             = materialShininess;")),p&&(g.push("float oneMinusSpecularStrength = 1.0 - max(max(specular.r, specular.g ),specular.b);"),g.push("material.diffuseColor      = diffuseColor * oneMinusSpecularStrength;"),g.push("material.specularRoughness = clamp( 1.0 - glossiness, 0.04, 1.0 );"),g.push("material.specularColor     = specular;")),d&&(g.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),g.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),g.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),g.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);")),g.push("geometry.position      = vViewPosition;"),o.lightMaps.length>0&&g.push("geometry.worldNormal   = normalize(vWorldNormal);"),g.push("geometry.viewNormal    = viewNormal;"),g.push("geometry.viewEyeDir    = viewEyeDir;"),c&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&g.push("computePhongLightMapping(geometry, material, reflectedLight);"),(p||d)&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&g.push("computePBRLightMapping(geometry, material, reflectedLight);"),g.push("float shadow = 1.0;"),g.push("float shadowAcneRemover = 0.007;"),g.push("vec3 fragmentDepth;"),g.push("float texelSize = 1.0 / 1024.0;"),g.push("float amountInLight = 0.0;"),g.push("vec3 shadowCoord;"),g.push("vec4 rgbaDepth;"),g.push("float depth;");for(let t=0,e=o.lights.length;t<e;t++){const e=o.lights[t];"ambient"!==e.type&&("dir"===e.type&&"view"===e.space?g.push("viewLightDir = -normalize(lightDir"+t+");"):"point"===e.type&&"view"===e.space?g.push("viewLightDir = normalize(lightPos"+t+" - vViewPosition);"):g.push("viewLightDir = normalize(vViewLightReverseDirAndDist"+t+".xyz);"),f&&e.castsShadow?(g.push("shadow = 0.0;"),g.push("fragmentDepth = vShadowPosFromLight"+t+".xyz;"),g.push("fragmentDepth.z -= shadowAcneRemover;"),g.push("for (int x = -3; x <= 3; x++) {"),g.push("  for (int y = -3; y <= 3; y++) {"),g.push("      float texelDepth = unpackDepth(texture2D(shadowMap"+t+", fragmentDepth.xy + vec2(x, y) * texelSize));"),g.push("      if (fragmentDepth.z < texelDepth) {"),g.push("          shadow += 1.0;"),g.push("      }"),g.push("  }"),g.push("}"),g.push("shadow = shadow / 9.0;"),g.push("light.color =  lightColor"+t+".rgb * (lightColor"+t+".a * shadow);")):g.push("light.color =  lightColor"+t+".rgb * (lightColor"+t+".a );"),g.push("light.direction = viewLightDir;"),c&&g.push("computePhongLighting(light, geometry, material, reflectedLight);"),(p||d)&&g.push("computePBRLighting(light, geometry, material, reflectedLight);"))}c?g.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * diffuseColor) + ((occlusion * (( reflectedLight.diffuse + reflectedLight.specular)))) + emissiveColor;"):g.push("vec3 outgoingLight = (occlusion * (reflectedLight.diffuse)) + (occlusion * reflectedLight.specular) + emissiveColor;")}else g.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),g.push("vec3 outgoingLight = emissiveColor + ambientColor;");g.push("gl_FragColor = vec4(outgoingLight, alpha) * colorize;"),_&&g.push("gl_FragColor = linearToGamma(gl_FragColor, gammaFactor);");e.logarithmicDepthBufferEnabled&&g.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");return g.push("}"),g}(t))},Uo={linear:"linearToLinear",sRGB:"sRGBToLinear",gamma:"gammaToLinear"};function Go(t){if(!t.receivesShadow)return!1;const e=t.scene._lightsState.lights;if(!e||0===e.length)return!1;for(let t=0,i=e.length;t<i;t++)if(e[t].castsShadow)return!0;return!1}function Xo(t){const e=t._geometry._state.primitiveName;return!(!t._geometry._state.autoVertexNormals&&!t._geometry._state.normalsBuf||"triangles"!==e&&"triangle-strip"!==e&&"triangle-fan"!==e)}const jo=M.vec3(),Wo=new e({}),Ho=function(t,e){this.id=Wo.addItem({}),this._hash=t,this._scene=e.scene,this._useCount=0,this._shaderSource=new Vo(e),this._allocate(e)},Yo={};Ho.get=function(t){const e=t.scene,s=[e.canvas.canvas.id,(e.gammaInput?"gi;":";")+(e.gammaOutput?"go":""),e._lightsState.getHash(),e._sectionPlanesState.getHash(),t._geometry._state.hash,t._material._state.hash,t._state.drawHash].join(";");let r=Yo[s];if(!r){if(r=new Ho(s,t),r.errors)return console.log(r.errors.join("\n")),null;Yo[s]=r,i.memory.programs++}return r._useCount++,r},Ho.prototype.put=function(){0==--this._useCount&&(Wo.removeItem(this.id),this._program&&this._program.destroy(),delete Yo[this._hash],i.memory.programs--)},Ho.prototype.webglContextRestored=function(){this._program=null},Ho.prototype.drawMesh=function(t,e){this._program||this._allocate(e);const i=C.MAX_TEXTURE_UNITS,s=e.scene,r=e._material,o=s.canvas.gl,a=this._program,n=e._state,l=e._material._state,h=e._geometry._state,u=s.camera,c=e.rtcCenter;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),o.uniformMatrix4fv(this._uViewMatrix,!1,c?t.getRTCViewMatrix(n.rtcCenterHash,c):u.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,u.viewNormalMatrix),n.clippable){const t=s._sectionPlanesState.sectionPlanes.length;if(t>0){const i=s._sectionPlanesState.sectionPlanes,r=e.renderFlags;for(let e=0;e<t;e++){const t=this._uSectionPlanes[e],s=r.sectionPlanesActivePerLayer[e];if(o.uniform1i(t.active,s?1:0),s){const s=i[e];o.uniform3fv(t.pos,c?B(s.dist,s.dir,c,jo):s.pos),o.uniform3fv(t.dir,s.dir)}}}}if(l.id!==this._lastMaterialId){t.textureUnit=this._baseTextureUnit;const e=l.backfaces;t.backfaces!==e&&(e?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),t.backfaces=e);const s=l.frontface;switch(t.frontface!==s&&(s?o.frontFace(o.CCW):o.frontFace(o.CW),t.frontface=s),t.lineWidth!==l.lineWidth&&(o.lineWidth(l.lineWidth),t.lineWidth=l.lineWidth),this._uPointSize&&o.uniform1f(this._uPointSize,l.pointSize),l.type){case"LambertMaterial":this._uMaterialAmbient&&o.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialColor&&o.uniform4f(this._uMaterialColor,l.color[0],l.color[1],l.color[2],l.alpha),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive);break;case"PhongMaterial":this._uMaterialShininess&&o.uniform1f(this._uMaterialShininess,l.shininess),this._uMaterialAmbient&&o.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialDiffuse&&o.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&o.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0),r._ambientMap&&r._ambientMap._state.texture&&this._uMaterialAmbientMap&&(a.bindTexture(this._uMaterialAmbientMap,r._ambientMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uMaterialAmbientMapMatrix&&o.uniformMatrix4fv(this._uMaterialAmbientMapMatrix,!1,r._ambientMap._state.matrix)),r._diffuseMap&&r._diffuseMap._state.texture&&this._uDiffuseMap&&(a.bindTexture(this._uDiffuseMap,r._diffuseMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uDiffuseMapMatrix&&o.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,r._diffuseMap._state.matrix)),r._specularMap&&r._specularMap._state.texture&&this._uSpecularMap&&(a.bindTexture(this._uSpecularMap,r._specularMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uSpecularMapMatrix&&o.uniformMatrix4fv(this._uSpecularMapMatrix,!1,r._specularMap._state.matrix)),r._emissiveMap&&r._emissiveMap._state.texture&&this._uEmissiveMap&&(a.bindTexture(this._uEmissiveMap,r._emissiveMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,r._emissiveMap._state.matrix)),r._alphaMap&&r._alphaMap._state.texture&&this._uAlphaMap&&(a.bindTexture(this._uAlphaMap,r._alphaMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,r._alphaMap._state.matrix)),r._reflectivityMap&&r._reflectivityMap._state.texture&&this._uReflectivityMap&&(a.bindTexture(this._uReflectivityMap,r._reflectivityMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,this._uReflectivityMapMatrix&&o.uniformMatrix4fv(this._uReflectivityMapMatrix,!1,r._reflectivityMap._state.matrix)),r._normalMap&&r._normalMap._state.texture&&this._uNormalMap&&(a.bindTexture(this._uNormalMap,r._normalMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,r._normalMap._state.matrix)),r._occlusionMap&&r._occlusionMap._state.texture&&this._uOcclusionMap&&(a.bindTexture(this._uOcclusionMap,r._occlusionMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,r._occlusionMap._state.matrix)),r._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&o.uniform1f(this._uDiffuseFresnelEdgeBias,r._diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&o.uniform1f(this._uDiffuseFresnelCenterBias,r._diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&o.uniform3fv(this._uDiffuseFresnelEdgeColor,r._diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&o.uniform3fv(this._uDiffuseFresnelCenterColor,r._diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&o.uniform1f(this._uDiffuseFresnelPower,r._diffuseFresnel.power)),r._specularFresnel&&(this._uSpecularFresnelEdgeBias&&o.uniform1f(this._uSpecularFresnelEdgeBias,r._specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&o.uniform1f(this._uSpecularFresnelCenterBias,r._specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&o.uniform3fv(this._uSpecularFresnelEdgeColor,r._specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&o.uniform3fv(this._uSpecularFresnelCenterColor,r._specularFresnel.centerColor),this._uSpecularFresnelPower&&o.uniform1f(this._uSpecularFresnelPower,r._specularFresnel.power)),r._alphaFresnel&&(this._uAlphaFresnelEdgeBias&&o.uniform1f(this._uAlphaFresnelEdgeBias,r._alphaFresnel.edgeBias),this._uAlphaFresnelCenterBias&&o.uniform1f(this._uAlphaFresnelCenterBias,r._alphaFresnel.centerBias),this._uAlphaFresnelEdgeColor&&o.uniform3fv(this._uAlphaFresnelEdgeColor,r._alphaFresnel.edgeColor),this._uAlphaFresnelCenterColor&&o.uniform3fv(this._uAlphaFresnelCenterColor,r._alphaFresnel.centerColor),this._uAlphaFresnelPower&&o.uniform1f(this._uAlphaFresnelPower,r._alphaFresnel.power)),r._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&o.uniform1f(this._uReflectivityFresnelEdgeBias,r._reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&o.uniform1f(this._uReflectivityFresnelCenterBias,r._reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&o.uniform3fv(this._uReflectivityFresnelEdgeColor,r._reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&o.uniform3fv(this._uReflectivityFresnelCenterColor,r._reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&o.uniform1f(this._uReflectivityFresnelPower,r._reflectivityFresnel.power)),r._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&o.uniform1f(this._uEmissiveFresnelEdgeBias,r._emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&o.uniform1f(this._uEmissiveFresnelCenterBias,r._emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&o.uniform3fv(this._uEmissiveFresnelEdgeColor,r._emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&o.uniform3fv(this._uEmissiveFresnelCenterColor,r._emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&o.uniform1f(this._uEmissiveFresnelPower,r._emissiveFresnel.power));break;case"MetallicMaterial":this._uBaseColor&&o.uniform3fv(this._uBaseColor,l.baseColor),this._uMaterialMetallic&&o.uniform1f(this._uMaterialMetallic,l.metallic),this._uMaterialRoughness&&o.uniform1f(this._uMaterialRoughness,l.roughness),this._uMaterialSpecularF0&&o.uniform1f(this._uMaterialSpecularF0,l.specularF0),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);const e=r._baseColorMap;e&&e._state.texture&&this._uBaseColorMap&&(a.bindTexture(this._uBaseColorMap,e._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uBaseColorMapMatrix&&o.uniformMatrix4fv(this._uBaseColorMapMatrix,!1,e._state.matrix));const s=r._metallicMap;s&&s._state.texture&&this._uMetallicMap&&(a.bindTexture(this._uMetallicMap,s._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uMetallicMapMatrix&&o.uniformMatrix4fv(this._uMetallicMapMatrix,!1,s._state.matrix));const n=r._roughnessMap;n&&n._state.texture&&this._uRoughnessMap&&(a.bindTexture(this._uRoughnessMap,n._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uRoughnessMapMatrix&&o.uniformMatrix4fv(this._uRoughnessMapMatrix,!1,n._state.matrix));const h=r._metallicRoughnessMap;h&&h._state.texture&&this._uMetallicRoughnessMap&&(a.bindTexture(this._uMetallicRoughnessMap,h._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uMetallicRoughnessMapMatrix&&o.uniformMatrix4fv(this._uMetallicRoughnessMapMatrix,!1,h._state.matrix)),(d=r._emissiveMap)&&d._state.texture&&this._uEmissiveMap&&(a.bindTexture(this._uEmissiveMap,d._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,d._state.matrix)),(p=r._occlusionMap)&&r._occlusionMap._state.texture&&this._uOcclusionMap&&(a.bindTexture(this._uOcclusionMap,p._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,p._state.matrix)),(f=r._alphaMap)&&f._state.texture&&this._uAlphaMap&&(a.bindTexture(this._uAlphaMap,f._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,f._state.matrix)),(_=r._normalMap)&&_._state.texture&&this._uNormalMap&&(a.bindTexture(this._uNormalMap,_._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,_._state.matrix));break;case"SpecularMaterial":this._uMaterialDiffuse&&o.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&o.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialGlossiness&&o.uniform1f(this._uMaterialGlossiness,l.glossiness),this._uMaterialReflectivity&&o.uniform1f(this._uMaterialReflectivity,l.reflectivity),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);const u=r._diffuseMap;u&&u._state.texture&&this._uDiffuseMap&&(a.bindTexture(this._uDiffuseMap,u._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uDiffuseMapMatrix&&o.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,u._state.matrix));const c=r._specularMap;c&&c._state.texture&&this._uSpecularMap&&(a.bindTexture(this._uSpecularMap,c._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uSpecularMapMatrix&&o.uniformMatrix4fv(this._uSpecularMapMatrix,!1,c._state.matrix));const g=r._glossinessMap;g&&g._state.texture&&this._uGlossinessMap&&(a.bindTexture(this._uGlossinessMap,g._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uGlossinessMapMatrix&&o.uniformMatrix4fv(this._uGlossinessMapMatrix,!1,g._state.matrix));const m=r._specularGlossinessMap;var d,p,f,_;m&&m._state.texture&&this._uSpecularGlossinessMap&&(a.bindTexture(this._uSpecularGlossinessMap,m._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uSpecularGlossinessMapMatrix&&o.uniformMatrix4fv(this._uSpecularGlossinessMapMatrix,!1,m._state.matrix)),(d=r._emissiveMap)&&d._state.texture&&this._uEmissiveMap&&(a.bindTexture(this._uEmissiveMap,d._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,d._state.matrix)),(p=r._occlusionMap)&&p._state.texture&&this._uOcclusionMap&&(a.bindTexture(this._uOcclusionMap,p._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,p._state.matrix)),(f=r._alphaMap)&&f._state.texture&&this._uAlphaMap&&(a.bindTexture(this._uAlphaMap,f._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,f._state.matrix)),(_=r._normalMap)&&_._state.texture&&this._uNormalMap&&(a.bindTexture(this._uNormalMap,_._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,_._state.matrix))}this._lastMaterialId=l.id}if(o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,e.worldMatrix),this._uModelNormalMatrix&&o.uniformMatrix4fv(this._uModelNormalMatrix,o.FALSE,e.worldNormalMatrix),this._uClippable&&o.uniform1i(this._uClippable,n.clippable),this._uColorize){const t=n.colorize,e=this._lastColorize;e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]||(o.uniform4fv(this._uColorize,t),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3])}o.uniform3fv(this._uOffset,n.offset),h.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._uUVDecodeMatrix&&o.uniformMatrix3fv(this._uUVDecodeMatrix,!1,h.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(h.positionsBuf),t.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(h.normalsBuf),t.bindArray++),this._aUV&&(this._aUV.bindArrayBuffer(h.uvBuf),t.bindArray++),this._aColor&&(this._aColor.bindArrayBuffer(h.colorsBuf),t.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(h.flagsBuf),t.bindArray++),h.indicesBuf&&(h.indicesBuf.bind(),t.bindArray++),this._lastGeometryId=h.id),h.indicesBuf?(o.drawElements(h.primitive,h.indicesBuf.numItems,h.indicesBuf.itemType,0),t.drawElements++):h.positions&&(o.drawArrays(o.TRIANGLES,0,h.positions.numItems),t.drawArrays++)},Ho.prototype._allocate=function(t){const e=t.scene,i=e.canvas.gl,s=t._material,r=e._lightsState,o=e._sectionPlanesState,a=t._material._state;if(this._program=new X(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const n=this._program;this._uPositionsDecodeMatrix=n.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=n.getLocation("uvDecodeMatrix"),this._uModelMatrix=n.getLocation("modelMatrix"),this._uModelNormalMatrix=n.getLocation("modelNormalMatrix"),this._uViewMatrix=n.getLocation("viewMatrix"),this._uViewNormalMatrix=n.getLocation("viewNormalMatrix"),this._uProjMatrix=n.getLocation("projMatrix"),this._uGammaFactor=n.getLocation("gammaFactor"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[],this._uShadowViewMatrix=[],this._uShadowProjMatrix=[],e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=n.getLocation("logDepthBufFC"));const l=r.lights;let h;for(var u=0,c=l.length;u<c;u++){switch(h=l[u],h.type){case"ambient":this._uLightAmbient[u]=n.getLocation("lightAmbient");break;case"dir":this._uLightColor[u]=n.getLocation("lightColor"+u),this._uLightPos[u]=null,this._uLightDir[u]=n.getLocation("lightDir"+u);break;case"point":this._uLightColor[u]=n.getLocation("lightColor"+u),this._uLightPos[u]=n.getLocation("lightPos"+u),this._uLightDir[u]=null,this._uLightAttenuation[u]=n.getLocation("lightAttenuation"+u);break;case"spot":this._uLightColor[u]=n.getLocation("lightColor"+u),this._uLightPos[u]=n.getLocation("lightPos"+u),this._uLightDir[u]=n.getLocation("lightDir"+u),this._uLightAttenuation[u]=n.getLocation("lightAttenuation"+u)}h.castsShadow&&(this._uShadowViewMatrix[u]=n.getLocation("shadowViewMatrix"+u),this._uShadowProjMatrix[u]=n.getLocation("shadowProjMatrix"+u))}r.lightMaps.length>0&&(this._uLightMap="lightMap"),r.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),this._uSectionPlanes=[];for(u=0,c=o.sectionPlanes.length;u<c;u++)this._uSectionPlanes.push({active:n.getLocation("sectionPlaneActive"+u),pos:n.getLocation("sectionPlanePos"+u),dir:n.getLocation("sectionPlaneDir"+u)});switch(this._uPointSize=n.getLocation("pointSize"),a.type){case"LambertMaterial":this._uMaterialColor=n.getLocation("materialColor"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff");break;case"PhongMaterial":this._uMaterialAmbient=n.getLocation("materialAmbient"),this._uMaterialDiffuse=n.getLocation("materialDiffuse"),this._uMaterialSpecular=n.getLocation("materialSpecular"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff"),this._uMaterialShininess=n.getLocation("materialShininess"),s._ambientMap&&(this._uMaterialAmbientMap="ambientMap",this._uMaterialAmbientMapMatrix=n.getLocation("ambientMapMatrix")),s._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=n.getLocation("diffuseMapMatrix")),s._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=n.getLocation("specularMapMatrix")),s._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=n.getLocation("emissiveMapMatrix")),s._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=n.getLocation("alphaMapMatrix")),s._reflectivityMap&&(this._uReflectivityMap="reflectivityMap",this._uReflectivityMapMatrix=n.getLocation("reflectivityMapMatrix")),s._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=n.getLocation("normalMapMatrix")),s._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=n.getLocation("occlusionMapMatrix")),s._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=n.getLocation("diffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=n.getLocation("diffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=n.getLocation("diffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=n.getLocation("diffuseFresnelCenterColor"),this._uDiffuseFresnelPower=n.getLocation("diffuseFresnelPower")),s._specularFresnel&&(this._uSpecularFresnelEdgeBias=n.getLocation("specularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=n.getLocation("specularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=n.getLocation("specularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=n.getLocation("specularFresnelCenterColor"),this._uSpecularFresnelPower=n.getLocation("specularFresnelPower")),s._alphaFresnel&&(this._uAlphaFresnelEdgeBias=n.getLocation("alphaFresnelEdgeBias"),this._uAlphaFresnelCenterBias=n.getLocation("alphaFresnelCenterBias"),this._uAlphaFresnelEdgeColor=n.getLocation("alphaFresnelEdgeColor"),this._uAlphaFresnelCenterColor=n.getLocation("alphaFresnelCenterColor"),this._uAlphaFresnelPower=n.getLocation("alphaFresnelPower")),s._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=n.getLocation("reflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=n.getLocation("reflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=n.getLocation("reflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=n.getLocation("reflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=n.getLocation("reflectivityFresnelPower")),s._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=n.getLocation("emissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=n.getLocation("emissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=n.getLocation("emissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=n.getLocation("emissiveFresnelCenterColor"),this._uEmissiveFresnelPower=n.getLocation("emissiveFresnelPower"));break;case"MetallicMaterial":this._uBaseColor=n.getLocation("materialBaseColor"),this._uMaterialMetallic=n.getLocation("materialMetallic"),this._uMaterialRoughness=n.getLocation("materialRoughness"),this._uMaterialSpecularF0=n.getLocation("materialSpecularF0"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff"),s._baseColorMap&&(this._uBaseColorMap="baseColorMap",this._uBaseColorMapMatrix=n.getLocation("baseColorMapMatrix")),s._metallicMap&&(this._uMetallicMap="metallicMap",this._uMetallicMapMatrix=n.getLocation("metallicMapMatrix")),s._roughnessMap&&(this._uRoughnessMap="roughnessMap",this._uRoughnessMapMatrix=n.getLocation("roughnessMapMatrix")),s._metallicRoughnessMap&&(this._uMetallicRoughnessMap="metallicRoughnessMap",this._uMetallicRoughnessMapMatrix=n.getLocation("metallicRoughnessMapMatrix")),s._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=n.getLocation("emissiveMapMatrix")),s._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=n.getLocation("occlusionMapMatrix")),s._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=n.getLocation("alphaMapMatrix")),s._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=n.getLocation("normalMapMatrix"));break;case"SpecularMaterial":this._uMaterialDiffuse=n.getLocation("materialDiffuse"),this._uMaterialSpecular=n.getLocation("materialSpecular"),this._uMaterialGlossiness=n.getLocation("materialGlossiness"),this._uMaterialReflectivity=n.getLocation("reflectivityFresnel"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff"),s._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=n.getLocation("diffuseMapMatrix")),s._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=n.getLocation("specularMapMatrix")),s._glossinessMap&&(this._uGlossinessMap="glossinessMap",this._uGlossinessMapMatrix=n.getLocation("glossinessMapMatrix")),s._specularGlossinessMap&&(this._uSpecularGlossinessMap="materialSpecularGlossinessMap",this._uSpecularGlossinessMapMatrix=n.getLocation("materialSpecularGlossinessMapMatrix")),s._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=n.getLocation("emissiveMapMatrix")),s._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=n.getLocation("occlusionMapMatrix")),s._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=n.getLocation("alphaMapMatrix")),s._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=n.getLocation("normalMapMatrix"))}this._aPosition=n.getAttribute("position"),this._aNormal=n.getAttribute("normal"),this._aUV=n.getAttribute("uv"),this._aColor=n.getAttribute("color"),this._aFlags=n.getAttribute("flags"),this._uClippable=n.getLocation("clippable"),this._uColorize=n.getLocation("colorize"),this._uOffset=n.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize=new Float32Array(4),this._baseTextureUnit=0},Ho.prototype._bindProgram=function(t){const e=C.MAX_TEXTURE_UNITS,i=this._scene,s=i.canvas.gl,r=i._lightsState,o=i.camera.project;let a;const n=this._program;if(n.bind(),t.useProgram++,t.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize[0]=-1,this._lastColorize[1]=-1,this._lastColorize[2]=-1,this._lastColorize[3]=-1,s.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),i.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,t)}for(var l=0,h=r.lights.length;l<h;l++)if(a=r.lights[l],this._uLightAmbient[l])s.uniform4f(this._uLightAmbient[l],a.color[0],a.color[1],a.color[2],a.intensity);else if(this._uLightColor[l]&&s.uniform4f(this._uLightColor[l],a.color[0],a.color[1],a.color[2],a.intensity),this._uLightPos[l]&&(s.uniform3fv(this._uLightPos[l],a.pos),this._uLightAttenuation[l]&&s.uniform1f(this._uLightAttenuation[l],a.attenuation)),this._uLightDir[l]&&s.uniform3fv(this._uLightDir[l],a.dir),a.castsShadow){this._uShadowViewMatrix[l]&&s.uniformMatrix4fv(this._uShadowViewMatrix[l],!1,a.getShadowViewMatrix()),this._uShadowProjMatrix[l]&&s.uniformMatrix4fv(this._uShadowProjMatrix[l],!1,a.getShadowProjMatrix());const i=a.getShadowRenderBuf();i&&(n.bindTexture("shadowMap"+l,i.getTexture(),t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++)}r.lightMaps.length>0&&r.lightMaps[0].texture&&this._uLightMap&&(n.bindTexture(this._uLightMap,r.lightMaps[0].texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++),r.reflectionMaps.length>0&&r.reflectionMaps[0].texture&&this._uReflectionMap&&(n.bindTexture(this._uReflectionMap,r.reflectionMaps[0].texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++),this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor),this._baseTextureUnit=t.textureUnit};class Ko{constructor(t){this.vertex=function(t){const e=t.scene,i=e._lightsState,s=function(t){const e=t._geometry._state.primitiveName;if((t._geometry._state.autoVertexNormals||t._geometry._state.normalsBuf)&&("triangles"===e||"triangle-strip"===e||"triangle-fan"===e))return!0;return!1}(t),r=e._sectionPlanesState.sectionPlanes.length>0,o=!!t._geometry._state.compressGeometry,a=t._state.billboard,n=t._state.stationary,l=[];l.push("// EmphasisFillShaderSource vertex shader"),e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&l.push("#extension GL_EXT_frag_depth : enable");l.push("attribute vec3 position;"),l.push("uniform mat4 modelMatrix;"),l.push("uniform mat4 viewMatrix;"),l.push("uniform mat4 projMatrix;"),l.push("uniform vec4 colorize;"),l.push("uniform vec3 offset;"),o&&l.push("uniform mat4 positionsDecodeMatrix;");e.logarithmicDepthBufferEnabled&&(l.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&l.push("varying float vFragDepth;"));r&&l.push("varying vec4 vWorldPosition;");if(l.push("uniform vec4   lightAmbient;"),l.push("uniform vec4   fillColor;"),s){l.push("attribute vec3 normal;"),l.push("uniform mat4 modelNormalMatrix;"),l.push("uniform mat4 viewNormalMatrix;");for(let t=0,e=i.lights.length;t<e;t++){const e=i.lights[t];"ambient"!==e.type&&(l.push("uniform vec4 lightColor"+t+";"),"dir"===e.type&&l.push("uniform vec3 lightDir"+t+";"),"point"===e.type&&l.push("uniform vec3 lightPos"+t+";"),"spot"===e.type&&l.push("uniform vec3 lightPos"+t+";"))}o&&(l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"))}l.push("varying vec4 vColor;"),("spherical"===a||"cylindrical"===a)&&(l.push("void billboard(inout mat4 mat) {"),l.push("   mat[0][0] = 1.0;"),l.push("   mat[0][1] = 0.0;"),l.push("   mat[0][2] = 0.0;"),"spherical"===a&&(l.push("   mat[1][0] = 0.0;"),l.push("   mat[1][1] = 1.0;"),l.push("   mat[1][2] = 0.0;")),l.push("   mat[2][0] = 0.0;"),l.push("   mat[2][1] = 0.0;"),l.push("   mat[2][2] =1.0;"),l.push("}"));l.push("void main(void) {"),l.push("vec4 localPosition = vec4(position, 1.0); "),l.push("vec4 worldPosition;"),o&&l.push("localPosition = positionsDecodeMatrix * localPosition;");s&&(o?l.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):l.push("vec4 localNormal = vec4(normal, 0.0); "),l.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),l.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));l.push("mat4 viewMatrix2 = viewMatrix;"),l.push("mat4 modelMatrix2 = modelMatrix;"),n&&l.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===a||"cylindrical"===a?(l.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),l.push("billboard(modelMatrix2);"),l.push("billboard(viewMatrix2);"),l.push("billboard(modelViewMatrix);"),s&&(l.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),l.push("billboard(modelNormalMatrix2);"),l.push("billboard(viewNormalMatrix2);"),l.push("billboard(modelViewNormalMatrix);")),l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("worldPosition.xyz = worldPosition.xyz + offset;"),l.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));s&&l.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),s)for(let t=0,e=i.lights.length;t<e;t++){const e=i.lights[t];if("ambient"!==e.type){if("dir"===e.type)"view"===e.space?l.push("viewLightDir = normalize(lightDir"+t+");"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+t+", 0.0)).xyz);");else{if("point"!==e.type)continue;"view"===e.space?l.push("viewLightDir = normalize(lightPos"+t+" - viewPosition.xyz);"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+t+", 0.0)).xyz);")}l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+t+".rgb * lightColor"+t+".a);")}}l.push("vColor = vec4(reflectedColor * fillColor.rgb, fillColor.a);"),r&&l.push("vWorldPosition = worldPosition;");"points"===t._geometry._state.primitiveName&&l.push("gl_PointSize = pointSize;");l.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?l.push("vFragDepth = 1.0 + clipPos.w;"):(l.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),l.push("clipPos.z *= clipPos.w;")));return l.push("gl_Position = clipPos;"),l.push("}"),l}(t),this.fragment=function(t){const e=t.scene,i=t.scene._sectionPlanesState,s=t.scene.gammaOutput,r=i.sectionPlanes.length>0,o=[];o.push("// Lambertian drawing fragment shader"),e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable");o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;"));s&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}"));if(r){o.push("varying vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)o.push("uniform bool sectionPlaneActive"+t+";"),o.push("uniform vec3 sectionPlanePos"+t+";"),o.push("uniform vec3 sectionPlaneDir"+t+";")}if(o.push("varying vec4 vColor;"),o.push("void main(void) {"),r){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)o.push("if (sectionPlaneActive"+t+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}"points"===t._geometry._state.primitiveName&&(o.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("float r = dot(cxy, cxy);"),o.push("if (r > 1.0) {"),o.push("   discard;"),o.push("}"));e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");s?o.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):o.push("gl_FragColor = vColor;");return o.push("}"),o}(t)}}const $o=new e({}),qo=M.vec3(),Zo=function(t,e){this.id=$o.addItem({}),this._hash=t,this._scene=e.scene,this._useCount=0,this._shaderSource=new Ko(e),this._allocate(e)},Qo={};Zo.get=function(t){const e=[t.scene.id,t.scene.gammaOutput?"go":"",t.scene._sectionPlanesState.getHash(),t._geometry._state.normalsBuf?"n":"",t._geometry._state.compressGeometry?"cp":"",t._state.hash].join(";");let s=Qo[e];return s||(s=new Zo(e,t),Qo[e]=s,i.memory.programs++),s._useCount++,s},Zo.prototype.put=function(){0==--this._useCount&&($o.removeItem(this.id),this._program&&this._program.destroy(),delete Qo[this._hash],i.memory.programs--)},Zo.prototype.webglContextRestored=function(){this._program=null},Zo.prototype.drawMesh=function(t,e,i){this._program||this._allocate(e);const s=this._scene,r=s.camera,o=s.canvas.gl,a=0===i?e._xrayMaterial._state:1===i?e._highlightMaterial._state:e._selectedMaterial._state,n=e._state,l=e._geometry._state,h=e.rtcCenter;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),o.uniformMatrix4fv(this._uViewMatrix,!1,h?t.getRTCViewMatrix(n.rtcCenterHash,h):r.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,r.viewNormalMatrix),n.clippable){const t=s._sectionPlanesState.sectionPlanes.length;if(t>0){const i=s._sectionPlanesState.sectionPlanes,r=e.renderFlags;for(let e=0;e<t;e++){const t=this._uSectionPlanes[e],s=r.sectionPlanesActivePerLayer[e];if(o.uniform1i(t.active,s?1:0),s){const s=i[e];o.uniform3fv(t.pos,h?B(s.dist,s.dir,h,qo):s.pos),o.uniform3fv(t.dir,s.dir)}}}}if(a.id!==this._lastMaterialId){const e=a.fillColor,i=a.backfaces;t.backfaces!==i&&(i?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),t.backfaces=i),o.uniform4f(this._uFillColor,e[0],e[1],e[2],a.fillAlpha),this._lastMaterialId=a.id}o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,e.worldMatrix),this._uModelNormalMatrix&&o.uniformMatrix4fv(this._uModelNormalMatrix,o.FALSE,e.worldNormalMatrix),this._uClippable&&o.uniform1i(this._uClippable,n.clippable),o.uniform3fv(this._uOffset,n.offset),l.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._uUVDecodeMatrix&&o.uniformMatrix3fv(this._uUVDecodeMatrix,!1,l.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(l.positionsBuf),t.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(l.normalsBuf),t.bindArray++),l.indicesBuf?(l.indicesBuf.bind(),t.bindArray++):l.positionsBuf,this._lastGeometryId=l.id),l.indicesBuf?(o.drawElements(l.primitive,l.indicesBuf.numItems,l.indicesBuf.itemType,0),t.drawElements++):l.positionsBuf&&(o.drawArrays(o.TRIANGLES,0,l.positionsBuf.numItems),t.drawArrays++)},Zo.prototype._allocate=function(t){const e=t.scene,i=e._lightsState,s=e._sectionPlanesState,r=e.canvas.gl;if(this._program=new X(r,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const o=this._program;this._uPositionsDecodeMatrix=o.getLocation("positionsDecodeMatrix"),this._uModelMatrix=o.getLocation("modelMatrix"),this._uModelNormalMatrix=o.getLocation("modelNormalMatrix"),this._uViewMatrix=o.getLocation("viewMatrix"),this._uViewNormalMatrix=o.getLocation("viewNormalMatrix"),this._uProjMatrix=o.getLocation("projMatrix"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(let t=0,e=i.lights.length;t<e;t++){switch(i.lights[t].type){case"ambient":this._uLightAmbient[t]=o.getLocation("lightAmbient");break;case"dir":this._uLightColor[t]=o.getLocation("lightColor"+t),this._uLightPos[t]=null,this._uLightDir[t]=o.getLocation("lightDir"+t);break;case"point":this._uLightColor[t]=o.getLocation("lightColor"+t),this._uLightPos[t]=o.getLocation("lightPos"+t),this._uLightDir[t]=null,this._uLightAttenuation[t]=o.getLocation("lightAttenuation"+t)}}this._uSectionPlanes=[];for(let t=0,e=s.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:o.getLocation("sectionPlaneActive"+t),pos:o.getLocation("sectionPlanePos"+t),dir:o.getLocation("sectionPlaneDir"+t)});this._uFillColor=o.getLocation("fillColor"),this._aPosition=o.getAttribute("position"),this._aNormal=o.getAttribute("normal"),this._uClippable=o.getLocation("clippable"),this._uGammaFactor=o.getLocation("gammaFactor"),this._uOffset=o.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=o.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},Zo.prototype._bindProgram=function(t){const e=this._scene,i=e.canvas.gl,s=e._lightsState,r=e.camera,o=r.project;if(this._program.bind(),t.useProgram++,t.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastIndicesBufId=null,i.uniformMatrix4fv(this._uViewNormalMatrix,!1,r.normalMatrix),i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),e.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,t)}for(let t=0,e=s.lights.length;t<e;t++){const e=s.lights[t];this._uLightAmbient[t]?i.uniform4f(this._uLightAmbient[t],e.color[0],e.color[1],e.color[2],e.intensity):(this._uLightColor[t]&&i.uniform4f(this._uLightColor[t],e.color[0],e.color[1],e.color[2],e.intensity),this._uLightPos[t]&&(i.uniform3fv(this._uLightPos[t],e.pos),this._uLightAttenuation[t]&&i.uniform1f(this._uLightAttenuation[t],e.attenuation)),this._uLightDir[t]&&i.uniform3fv(this._uLightDir[t],e.dir))}this._uGammaFactor&&i.uniform1f(this._uGammaFactor,e.gammaFactor)};class Jo{constructor(t){this.vertex=function(t){const e=t.scene,i=e._sectionPlanesState.sectionPlanes.length>0,s=!!t._geometry._state.compressGeometry,r=t._state.billboard,o=t._state.stationary,a=[];a.push("// Edges drawing vertex shader"),e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable");a.push("attribute vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform vec4 edgeColor;"),a.push("uniform vec3 offset;"),s&&a.push("uniform mat4 positionsDecodeMatrix;");e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("varying float vFragDepth;"));i&&a.push("varying vec4 vWorldPosition;");a.push("varying vec4 vColor;"),("spherical"===r||"cylindrical"===r)&&(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),"spherical"===r&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}"));a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),a.push("vec4 worldPosition;"),s&&a.push("localPosition = positionsDecodeMatrix * localPosition;");a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),o&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===r||"cylindrical"===r?(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"),a.push("billboard(modelViewMatrix);"),a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));a.push("vColor = edgeColor;"),i&&a.push("vWorldPosition = worldPosition;");a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?a.push("vFragDepth = 1.0 + clipPos.w;"):(a.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),a.push("clipPos.z *= clipPos.w;")));return a.push("gl_Position = clipPos;"),a.push("}"),a}(t),this.fragment=function(t){const e=t.scene,i=t.scene._sectionPlanesState,s=t.scene.gammaOutput,r=i.sectionPlanes.length>0,o=[];o.push("// Edges drawing fragment shader"),e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable");o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;"));s&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}"));if(r){o.push("varying vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)o.push("uniform bool sectionPlaneActive"+t+";"),o.push("uniform vec3 sectionPlanePos"+t+";"),o.push("uniform vec3 sectionPlaneDir"+t+";")}if(o.push("varying vec4 vColor;"),o.push("void main(void) {"),r){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)o.push("if (sectionPlaneActive"+t+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");s?o.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):o.push("gl_FragColor = vColor;");return o.push("}"),o}(t)}}const ta=new e({}),ea=M.vec3(),ia=function(t,e){this.id=ta.addItem({}),this._hash=t,this._scene=e.scene,this._useCount=0,this._shaderSource=new Jo(e),this._allocate(e)},sa={};ia.get=function(t){const e=[t.scene.id,t.scene.gammaOutput?"go":"",t.scene._sectionPlanesState.getHash(),t._geometry._state.compressGeometry?"cp":"",t._state.hash].join(";");let s=sa[e];return s||(s=new ia(e,t),sa[e]=s,i.memory.programs++),s._useCount++,s},ia.prototype.put=function(){0==--this._useCount&&(ta.removeItem(this.id),this._program&&this._program.destroy(),delete sa[this._hash],i.memory.programs--)},ia.prototype.webglContextRestored=function(){this._program=null},ia.prototype.drawMesh=function(t,e,i){this._program||this._allocate(e);const s=this._scene,r=s.camera,o=s.canvas.gl;let a;const n=e._state,l=e._geometry,h=l._state,u=e.rtcCenter;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),o.uniformMatrix4fv(this._uViewMatrix,!1,u?t.getRTCViewMatrix(n.rtcCenterHash,u):r.viewMatrix),n.clippable){const t=s._sectionPlanesState.sectionPlanes.length;if(t>0){const i=s._sectionPlanesState.sectionPlanes,r=e.renderFlags;for(let e=0;e<t;e++){const t=this._uSectionPlanes[e],s=r.sectionPlanesActivePerLayer[e];if(o.uniform1i(t.active,s?1:0),s){const s=i[e];o.uniform3fv(t.pos,u?B(s.dist,s.dir,u,ea):s.pos),o.uniform3fv(t.dir,s.dir)}}}}switch(i){case 0:a=e._xrayMaterial._state;break;case 1:a=e._highlightMaterial._state;break;case 2:a=e._selectedMaterial._state;break;default:a=e._edgeMaterial._state}if(a.id!==this._lastMaterialId){const e=a.backfaces;if(t.backfaces!==e&&(e?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),t.backfaces=e),t.lineWidth!==a.edgeWidth&&(o.lineWidth(a.edgeWidth),t.lineWidth=a.edgeWidth),this._uEdgeColor){const t=a.edgeColor,e=a.edgeAlpha;o.uniform4f(this._uEdgeColor,t[0],t[1],t[2],e)}this._lastMaterialId=a.id}let c;o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,e.worldMatrix),this._uClippable&&o.uniform1i(this._uClippable,n.clippable),o.uniform3fv(this._uOffset,n.offset),h.primitive===o.TRIANGLES?c=l._getEdgeIndices():h.primitive===o.LINES&&(c=h.indicesBuf),c&&(h.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(h.positionsBuf,h.compressGeometry?o.UNSIGNED_SHORT:o.FLOAT),t.bindArray++),c.bind(),t.bindArray++,this._lastGeometryId=h.id),o.drawElements(o.LINES,c.numItems,c.itemType,0),t.drawElements++)},ia.prototype._allocate=function(t){const e=t.scene,i=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new X(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=s.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+t),pos:r.getLocation("sectionPlanePos"+t),dir:r.getLocation("sectionPlaneDir"+t)});this._uEdgeColor=r.getLocation("edgeColor"),this._aPosition=r.getAttribute("position"),this._uClippable=r.getLocation("clippable"),this._uGammaFactor=r.getLocation("gammaFactor"),this._uOffset=r.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},ia.prototype._bindProgram=function(t){const e=this._program,i=this._scene,s=i.canvas.gl,r=i.camera.project;if(e.bind(),t.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),i.logarithmicDepthBufferEnabled){const t=2/(Math.log(r.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,t)}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor)};class ra{constructor(t){this.vertex=function(t){const e=t.scene,i=e._sectionPlanesState.sectionPlanes.length>0,s=!!t._geometry._state.compressGeometry,r=t._state.billboard,o=t._state.stationary,a=[];a.push("// Mesh picking vertex shader"),e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable");a.push("attribute vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("varying vec4 vViewPosition;"),a.push("uniform vec3 offset;"),s&&a.push("uniform mat4 positionsDecodeMatrix;");i&&a.push("varying vec4 vWorldPosition;");e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("varying float vFragDepth;"));"spherical"!==r&&"cylindrical"!==r||(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),"spherical"===r&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}"));a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),s&&a.push("localPosition = positionsDecodeMatrix * localPosition;");a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),o&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"!==r&&"cylindrical"!==r||(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"));a.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),a.push("   worldPosition.xyz = worldPosition.xyz + offset;"),a.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),i&&a.push("   vWorldPosition = worldPosition;");a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?a.push("vFragDepth = 1.0 + clipPos.w;"):(a.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),a.push("clipPos.z *= clipPos.w;")));return a.push("gl_Position = clipPos;"),a.push("}"),a}(t),this.fragment=function(t){const e=t.scene,i=e._sectionPlanesState,s=i.sectionPlanes.length>0,r=[];r.push("// Mesh picking fragment shader"),e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable");r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;"));if(r.push("uniform vec4 pickColor;"),s){r.push("uniform bool clippable;"),r.push("varying vec4 vWorldPosition;");for(var o=0;o<i.sectionPlanes.length;o++)r.push("uniform bool sectionPlaneActive"+o+";"),r.push("uniform vec3 sectionPlanePos"+o+";"),r.push("uniform vec3 sectionPlaneDir"+o+";")}if(r.push("void main(void) {"),s){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(o=0;o<i.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");return r.push("   gl_FragColor = pickColor; "),r.push("}"),r}(t)}}const oa=M.vec3(),aa=function(t,e){this._hash=t,this._shaderSource=new ra(e),this._scene=e.scene,this._useCount=0,this._allocate(e)},na={};aa.get=function(t){const e=[t.scene.canvas.canvas.id,t.scene._sectionPlanesState.getHash(),t._geometry._state.hash,t._state.hash].join(";");let s=na[e];if(!s){if(s=new aa(e,t),s.errors)return console.log(s.errors.join("\n")),null;na[e]=s,i.memory.programs++}return s._useCount++,s},aa.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete na[this._hash],i.memory.programs--)},aa.prototype.webglContextRestored=function(){this._program=null},aa.prototype.drawMesh=function(t,e){this._program||this._allocate(e);const i=this._scene,s=i.canvas.gl,r=e._state,o=e._material._state,a=e._geometry._state,n=e.rtcCenter;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),s.uniformMatrix4fv(this._uViewMatrix,!1,n?t.getRTCPickViewMatrix(r.rtcCenterHash,n):t.pickViewMatrix),r.clippable){const t=i._sectionPlanesState.sectionPlanes.length;if(t>0){const r=i._sectionPlanesState.sectionPlanes,o=e.renderFlags;for(let e=0;e<t;e++){const t=this._uSectionPlanes[e],i=o.sectionPlanesActivePerLayer[e];if(s.uniform1i(t.active,i?1:0),i){const i=r[e];s.uniform3fv(t.pos,n?B(i.dist,i.dir,n,oa):i.pos),s.uniform3fv(t.dir,i.dir)}}}}if(o.id!==this._lastMaterialId){const e=o.backfaces;t.backfaces!==e&&(e?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),t.backfaces=e);const i=o.frontface;t.frontface!==i&&(i?s.frontFace(s.CCW):s.frontFace(s.CW),t.frontface=i),this._lastMaterialId=o.id}s.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),s.uniformMatrix4fv(this._uModelMatrix,!1,e.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,e._state.clippable),s.uniform3fv(this._uOffset,e._state.offset),a.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(a.positionsBuf,a.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT),t.bindArray++),a.indicesBuf&&(a.indicesBuf.bind(),t.bindArray++),this._lastGeometryId=a.id);var l=e._state.pickID;const h=l>>24&255,u=l>>16&255,c=l>>8&255,d=255&l;s.uniform4f(this._uPickColor,d/255,c/255,u/255,h/255),a.indicesBuf?(s.drawElements(a.primitive,a.indicesBuf.numItems,a.indicesBuf.itemType,0),t.drawElements++):a.positions&&s.drawArrays(s.TRIANGLES,0,a.positions.numItems)},aa.prototype._allocate=function(t){const e=t.scene,i=e.canvas.gl;if(this._program=new X(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uPickColor=s.getLocation("pickColor"),this._uOffset=s.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastGeometryId=null},aa.prototype._bindProgram=function(t){const e=this._scene,i=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.useProgram++,e.logarithmicDepthBufferEnabled){const t=2/(Math.log(s.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,t)}this._lastMaterialId=null,this._lastGeometryId=null};class la{constructor(t){this.vertex=function(t){const e=t.scene,i=e._sectionPlanesState.sectionPlanes.length>0,s=!!t._geometry._state.compressGeometry,r=(t._state.billboard,t._state.stationary,[]);r.push("// Surface picking vertex shader"),e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable");r.push("attribute vec3 position;"),r.push("attribute vec4 color;"),r.push("uniform mat4 modelMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform vec3 offset;"),i&&(r.push("uniform bool clippable;"),r.push("varying vec4 vWorldPosition;"));e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;"));r.push("varying vec4 vColor;"),s&&r.push("uniform mat4 positionsDecodeMatrix;");r.push("void main(void) {"),r.push("vec4 localPosition = vec4(position, 1.0); "),s&&r.push("localPosition = positionsDecodeMatrix * localPosition;");r.push("   vec4 worldPosition = modelMatrix * localPosition; "),r.push("   worldPosition.xyz = worldPosition.xyz + offset;"),r.push("   vec4 viewPosition = viewMatrix * worldPosition;"),i&&r.push("   vWorldPosition = worldPosition;");r.push("   vColor = color;"),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;")));return r.push("gl_Position = clipPos;"),r.push("}"),r}(t),this.fragment=function(t){const e=t.scene,i=e._sectionPlanesState,s=i.sectionPlanes.length>0,r=[];r.push("// Surface picking fragment shader"),e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable");r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),r.push("varying vec4 vColor;"),e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;"));if(s){r.push("uniform bool clippable;"),r.push("varying vec4 vWorldPosition;");for(let t=0;t<i.sectionPlanes.length;t++)r.push("uniform bool sectionPlaneActive"+t+";"),r.push("uniform vec3 sectionPlanePos"+t+";"),r.push("uniform vec3 sectionPlaneDir"+t+";")}if(r.push("void main(void) {"),s){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(let t=0;t<i.sectionPlanes.length;t++)r.push("if (sectionPlaneActive"+t+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");return r.push("   gl_FragColor = vColor;"),r.push("}"),r}(t)}}const ha=M.vec3(),ua=function(t,e){this._hash=t,this._scene=e.scene,this._useCount=0,this._shaderSource=new la(e),this._allocate(e)},ca={};ua.get=function(t){const e=[t.scene.canvas.canvas.id,t.scene._sectionPlanesState.getHash(),t._geometry._state.compressGeometry?"cp":"",t._state.hash].join(";");let s=ca[e];if(!s){if(s=new ua(e,t),s.errors)return console.log(s.errors.join("\n")),null;ca[e]=s,i.memory.programs++}return s._useCount++,s},ua.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete ca[this._hash],i.memory.programs--)},ua.prototype.webglContextRestored=function(){this._program=null},ua.prototype.drawMesh=function(t,e){this._program||this._allocate(e);const i=this._scene,s=i.canvas.gl,r=e._state,o=e._material._state,a=e._geometry,n=e._geometry._state,l=e.rtcCenter,h=o.backfaces,u=o.frontface,c=i.camera.project,d=a._getPickTrianglePositions(),p=a._getPickTriangleColors();if(this._program.bind(),t.useProgram++,i.logarithmicDepthBufferEnabled){const t=2/(Math.log(c.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,t)}if(s.uniformMatrix4fv(this._uViewMatrix,!1,l?t.getRTCPickViewMatrix(r.rtcCenterHash,l):t.pickViewMatrix),r.clippable){const t=i._sectionPlanesState.sectionPlanes.length;if(t>0){const r=i._sectionPlanesState.sectionPlanes,o=e.renderFlags;for(let e=0;e<t;e++){const t=this._uSectionPlanes[e],i=o.sectionPlanesActivePerLayer[e];if(s.uniform1i(t.active,i?1:0),i){const i=r[e];s.uniform3fv(t.pos,l?B(i.dist,i.dir,l,ha):i.pos),s.uniform3fv(t.dir,i.dir)}}}}s.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),i.logarithmicDepthBufferEnabled&&s.uniform1f(this._uZFar,i.camera.project.far),t.backfaces!==h&&(h?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),t.backfaces=h),t.frontface!==u&&(u?s.frontFace(s.CCW):s.frontFace(s.CW),t.frontface=u),s.uniformMatrix4fv(this._uModelMatrix,!1,e.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,e._state.clippable),s.uniform3fv(this._uOffset,e._state.offset),this._uPositionsDecodeMatrix?(s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(d,n.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT)):this._aPosition.bindArrayBuffer(d),p.bind(),s.enableVertexAttribArray(this._aColor.location),s.vertexAttribPointer(this._aColor.location,p.itemSize,p.itemType,!0,0,0),s.drawArrays(n.primitive,0,d.numItems/3)},ua.prototype._allocate=function(t){const e=t.scene,i=e.canvas.gl;if(this._program=new X(i,this._shaderSource),this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aColor=s.getAttribute("color"),this._uClippable=s.getLocation("clippable"),this._uOffset=s.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))};class da{constructor(t){this.vertex=function(t){const e=t.scene,i=e._sectionPlanesState.sectionPlanes.length>0,s=!!t._geometry._state.compressGeometry,r=t._state.billboard,o=t._state.stationary,a=[];a.push("// Mesh occlusion vertex shader"),e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable");a.push("attribute vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform vec3 offset;"),s&&a.push("uniform mat4 positionsDecodeMatrix;");i&&a.push("varying vec4 vWorldPosition;");e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("varying float vFragDepth;"));"spherical"!==r&&"cylindrical"!==r||(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),"spherical"===r&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}"));a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),s&&a.push("localPosition = positionsDecodeMatrix * localPosition;");a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),o&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"!==r&&"cylindrical"!==r||(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"));a.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),a.push("   worldPosition.xyz = worldPosition.xyz + offset;"),a.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),i&&a.push("   vWorldPosition = worldPosition;");a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(C.SUPPORTED_EXTENSIONS.EXT_frag_depth?a.push("vFragDepth = 1.0 + clipPos.w;"):(a.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),a.push("clipPos.z *= clipPos.w;")));return a.push("gl_Position = clipPos;"),a.push("}"),a}(t),this.fragment=function(t){const e=t.scene,i=e._sectionPlanesState,s=i.sectionPlanes.length>0,r=[];r.push("// Mesh occlusion fragment shader"),e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable");r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;"));if(s){r.push("uniform bool clippable;"),r.push("varying vec4 vWorldPosition;");for(var o=0;o<i.sectionPlanes.length;o++)r.push("uniform bool sectionPlaneActive"+o+";"),r.push("uniform vec3 sectionPlanePos"+o+";"),r.push("uniform vec3 sectionPlaneDir"+o+";")}if(r.push("void main(void) {"),s){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(o=0;o<i.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}r.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),e.logarithmicDepthBufferEnabled&&C.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");return r.push("}"),r}(t)}}const pa=M.vec3(),fa=function(t,e){this._hash=t,this._shaderSource=new da(e),this._scene=e.scene,this._useCount=0,this._allocate(e)},_a={};fa.get=function(t){const e=[t.scene.canvas.canvas.id,t.scene._sectionPlanesState.getHash(),t._geometry._state.hash,t._state.hash].join(";");let s=_a[e];if(!s){if(s=new fa(e,t),s.errors)return console.log(s.errors.join("\n")),null;_a[e]=s,i.memory.programs++}return s._useCount++,s},fa.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete _a[this._hash],i.memory.programs--)},fa.prototype.webglContextRestored=function(){this._program=null},fa.prototype.drawMesh=function(t,e){this._program||this._allocate(e);const i=this._scene,s=i.canvas.gl,r=e._material._state,o=e._state,a=e._geometry._state,n=e.rtcCenter;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),r.id!==this._lastMaterialId){const e=r.backfaces;t.backfaces!==e&&(e?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),t.backfaces=e);const i=r.frontface;t.frontface!==i&&(i?s.frontFace(s.CCW):s.frontFace(s.CW),t.frontface=i),this._lastMaterialId=r.id}const l=i.camera;if(s.uniformMatrix4fv(this._uViewMatrix,!1,n?t.getRTCViewMatrix(o.rtcCenterHash,n):l.viewMatrix),o.clippable){const t=i._sectionPlanesState.sectionPlanes.length;if(t>0){const r=i._sectionPlanesState.sectionPlanes,o=e.renderFlags;for(let e=0;e<t;e++){const t=this._uSectionPlanes[e],i=o.sectionPlanesActivePerLayer[e];if(s.uniform1i(t.active,i?1:0),i){const i=r[e];s.uniform3fv(t.pos,n?B(i.dist,i.dir,n,pa):i.pos),s.uniform3fv(t.dir,i.dir)}}}}s.uniformMatrix4fv(this._uProjMatrix,!1,l._project._state.matrix),s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,e.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,e._state.clippable),s.uniform3fv(this._uOffset,e._state.offset),a.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(a.positionsBuf,a.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT),t.bindArray++),a.indicesBuf&&(a.indicesBuf.bind(),t.bindArray++),this._lastGeometryId=a.id),a.indicesBuf?(s.drawElements(a.primitive,a.indicesBuf.numItems,a.indicesBuf.itemType,0),t.drawElements++):a.positions&&s.drawArrays(s.TRIANGLES,0,a.positions.numItems)},fa.prototype._allocate=function(t){const e=t.scene,i=e.canvas.gl;if(this._program=new X(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uOffset=s.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},fa.prototype._bindProgram=function(t){const e=this._scene,i=e.camera.project,s=e.canvas.gl;if(this._program.bind(),t.useProgram++,s.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,t)}this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};class ga{constructor(t){this.vertex=function(t){const e=t.scene,i=e._sectionPlanesState.sectionPlanes.length>0,s=!!t._geometry._state.compressGeometry,r=[];r.push("// Mesh shadow vertex shader"),r.push("attribute vec3 position;"),r.push("uniform mat4 modelMatrix;"),r.push("uniform mat4 shadowViewMatrix;"),r.push("uniform mat4 shadowProjMatrix;"),r.push("uniform vec3 offset;"),s&&r.push("uniform mat4 positionsDecodeMatrix;");i&&r.push("varying vec4 vWorldPosition;");r.push("void main(void) {"),r.push("vec4 localPosition = vec4(position, 1.0); "),r.push("vec4 worldPosition;"),s&&r.push("localPosition = positionsDecodeMatrix * localPosition;");r.push("worldPosition = modelMatrix * localPosition;"),r.push("worldPosition.xyz = worldPosition.xyz + offset;"),r.push("vec4 viewPosition  = shadowViewMatrix * worldPosition; "),i&&r.push("vWorldPosition = worldPosition;");return r.push("   gl_Position = shadowProjMatrix * viewPosition;"),r.push("}"),r}(t),this.fragment=function(t){const e=t.scene,i=(e.canvas.gl,e._sectionPlanesState),s=i.sectionPlanes.length>0,r=[];if(r.push("// Mesh shadow fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),s){r.push("uniform bool clippable;"),r.push("varying vec4 vWorldPosition;");for(var o=0;o<i.sectionPlanes.length;o++)r.push("uniform bool sectionPlaneActive"+o+";"),r.push("uniform vec3 sectionPlanePos"+o+";"),r.push("uniform vec3 sectionPlaneDir"+o+";")}if(r.push("vec4 encodeFloat( const in float depth ) {"),r.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),r.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),r.push("  vec4 comp = fract(depth * bitShift);"),r.push("  comp -= comp.xxyz * bitMask;"),r.push("  return comp;"),r.push("}"),r.push("void main(void) {"),s){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(o=0;o<i.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return r.push("gl_FragColor = encodeFloat(gl_FragCoord.z);"),r.push("}"),r}(t)}}const ma=function(t,e){this._hash=t,this._shaderSource=new ga(e),this._scene=e.scene,this._useCount=0,this._allocate(e)},va={};ma.get=function(t){const e=t.scene,s=[e.canvas.canvas.id,e._sectionPlanesState.getHash(),t._geometry._state.hash,t._state.hash].join(";");let r=va[s];if(!r){if(r=new ma(s,t),r.errors)return console.log(r.errors.join("\n")),null;va[s]=r,i.memory.programs++}return r._useCount++,r},ma.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete va[this._hash],i.memory.programs--)},ma.prototype.webglContextRestored=function(){this._program=null},ma.prototype.drawMesh=function(t,e){this._program||this._allocate(e);const i=this._scene.canvas.gl,s=e._material._state,r=e._geometry._state;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),s.id!==this._lastMaterialId){const e=s.backfaces;t.backfaces!==e&&(e?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),t.backfaces=e);const r=s.frontface;t.frontface!==r&&(r?i.frontFace(i.CCW):i.frontFace(i.CW),t.frontface=r),t.lineWidth!==s.lineWidth&&(i.lineWidth(s.lineWidth),t.lineWidth=s.lineWidth),this._uPointSize&&i.uniform1i(this._uPointSize,s.pointSize),this._lastMaterialId=s.id}if(i.uniformMatrix4fv(this._uModelMatrix,i.FALSE,e.worldMatrix),r.combineGeometry){const s=e.vertexBufs;s.id!==this._lastVertexBufsId&&(s.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(s.positionsBuf,s.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),t.bindArray++),this._lastVertexBufsId=s.id)}this._uClippable&&i.uniform1i(this._uClippable,e._state.clippable),i.uniform3fv(this._uOffset,e._state.offset),r.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,r.positionsDecodeMatrix),r.combineGeometry?r.indicesBufCombined&&(r.indicesBufCombined.bind(),t.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(r.positionsBuf,r.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),t.bindArray++),r.indicesBuf&&(r.indicesBuf.bind(),t.bindArray++)),this._lastGeometryId=r.id),r.combineGeometry?r.indicesBufCombined&&(i.drawElements(r.primitive,r.indicesBufCombined.numItems,r.indicesBufCombined.itemType,0),t.drawElements++):r.indicesBuf?(i.drawElements(r.primitive,r.indicesBuf.numItems,r.indicesBuf.itemType,0),t.drawElements++):r.positions&&(i.drawArrays(i.TRIANGLES,0,r.positions.numItems),t.drawArrays++)},ma.prototype._allocate=function(t){const e=t.scene,i=e.canvas.gl;if(this._program=new X(i,this._shaderSource),this._scene=e,this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uShadowViewMatrix=s.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=s.getLocation("shadowProjMatrix"),this._uSectionPlanes={};for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uOffset=s.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},ma.prototype._bindProgram=function(t){this._program||this._allocate(mesh);const e=this._scene,i=e.canvas.gl,s=e._sectionPlanesState;if(this._program.bind(),t.useProgram++,i.uniformMatrix4fv(this._uShadowViewMatrix,!1,t.shadowViewMatrix),i.uniformMatrix4fv(this._uShadowProjMatrix,!1,t.shadowProjMatrix),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.sectionPlanes.length>0){let t,e,r,o,a;for(let n=0,l=this._uSectionPlanes.length;n<l;n++)t=this._uSectionPlanes[n],e=t.active,r=s.sectionPlanes[n],e&&i.uniform1i(e,r.active),o=t.pos,o&&i.uniform3fv(t.pos,r.pos),a=t.dir,a&&i.uniform3fv(t.dir,r.dir)}};const Pa=M.OBB3(),ba=M.vec4(),ya=M.vec4(),xa=M.vec4(),Ma=M.vec3([1,0,0]),wa=M.vec3([0,1,0]),Ea=M.vec3([0,0,1]),Ca=M.vec3(3),Aa=M.vec3(3),Sa=M.identityMat4();class Da extends w{get type(){return"Mesh"}constructor(t,e={}){if(super(t,e),this.originalSystemId=e.originalSystemId||this.id,this.renderFlags=new yo,this._state=new nt({visible:!0,culled:!1,pickable:null,clippable:null,collidable:null,castsShadow:null,receivesShadow:null,xrayed:!1,highlighted:!1,selected:!1,edges:!1,stationary:!!e.stationary,billboard:this._checkBillboard(e.billboard),layer:null,colorize:null,pickID:this.scene._renderer.getPickID(this),drawHash:"",pickHash:"",offset:M.vec3(),rtcCenter:null,rtcCenterHash:null}),this._drawRenderer=null,this._shadowRenderer=null,this._emphasisFillRenderer=null,this._emphasisEdgesRenderer=null,this._pickMeshRenderer=null,this._pickTriangleRenderer=null,this._occlusionRenderer=null,this._geometry=e.geometry?this._checkComponent2(["ReadableGeometry","VBOGeometry"],e.geometry):this.scene.geometry,this._material=e.material?this._checkComponent2(["PhongMaterial","MetallicMaterial","SpecularMaterial","LambertMaterial"],e.material):this.scene.material,this._xrayMaterial=e.xrayMaterial?this._checkComponent("EmphasisMaterial",e.xrayMaterial):this.scene.xrayMaterial,this._highlightMaterial=e.highlightMaterial?this._checkComponent("EmphasisMaterial",e.highlightMaterial):this.scene.highlightMaterial,this._selectedMaterial=e.selectedMaterial?this._checkComponent("EmphasisMaterial",e.selectedMaterial):this.scene.selectedMaterial,this._edgeMaterial=e.edgeMaterial?this._checkComponent("EdgeMaterial",e.edgeMaterial):this.scene.edgeMaterial,this._parentNode=null,this._aabb=null,this._aabbDirty=!0,this._numTriangles=this._geometry?this._geometry.numTriangles:0,this.scene._aabbDirty=!0,this._scale=M.vec3(),this._quaternion=M.identityQuaternion(),this._rotation=M.vec3(),this._position=M.vec3(),this._worldMatrix=M.identityMat4(),this._worldNormalMatrix=M.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0,e.rtcCenter&&(this._state.rtcCenter=M.vec3(e.rtcCenter),this._state.rtcCenterHash=e.rtcCenter.join()),e.matrix?this.matrix=e.matrix:(this.scale=e.scale,this.position=e.position,e.quaternion||(this.rotation=e.rotation)),this._isObject=e.isObject,this._isObject&&this.scene._registerObject(this),this._isModel=e.isModel,this._isModel&&this.scene._registerModel(this),this.visible=e.visible,this.culled=e.culled,this.pickable=e.pickable,this.clippable=e.clippable,this.collidable=e.collidable,this.castsShadow=e.castsShadow,this.receivesShadow=e.receivesShadow,this.xrayed=e.xrayed,this.highlighted=e.highlighted,this.selected=e.selected,this.edges=e.edges,this.layer=e.layer,this.colorize=e.colorize,this.opacity=e.opacity,this.offset=e.offset,e.parentId){const t=this.scene.components[e.parentId];t?t.isNode?t.addChild(this):this.error("Parent is not a Node: '"+e.parentId+"'"):this.error("Parent not found: '"+e.parentId+"'"),this._parentNode=t}else e.parent&&(e.parent.isNode||this.error("Parent is not a Node"),e.parent.addChild(this),this._parentNode=e.parent);this.compile()}get isMesh(){return!0}get parent(){return this._parentNode}_checkBillboard(t){return"spherical"!==(t=t||"none")&&"cylindrical"!==t&&"none"!==t&&(this.error("Unsupported value for 'billboard': "+t+" - accepted values are 'spherical', 'cylindrical' and 'none' - defaulting to 'none'."),t="none"),t}compile(){const t=this._makeDrawHash();this._state.drawHash!==t&&(this._state.drawHash=t,this._putDrawRenderers(),this._drawRenderer=Ho.get(this),this._emphasisFillRenderer=Zo.get(this),this._emphasisEdgesRenderer=ia.get(this));const e=this._makePickHash();this._state.pickHash!==e&&(this._state.pickHash=e,this._putPickRenderers(),this._pickMeshRenderer=aa.get(this));const i=this._makeOcclusionHash();this._state.occlusionHash!==i&&(this._state.occlusionHash=i,this._putOcclusionRenderer(),this._occlusionRenderer=fa.get(this))}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}_setWorldMatrixDirty(){this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0}_buildWorldMatrix(){const t=this.matrix;if(this._parentNode)M.mulMat4(this._parentNode.worldMatrix,t,this._worldMatrix);else for(let e=0,i=t.length;e<i;e++)this._worldMatrix[e]=t[e];this._worldMatrixDirty=!1}_buildWorldNormalMatrix(){this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldNormalMatrix||(this._worldNormalMatrix=M.mat4()),M.transposeMat4(this._worldMatrix,this._worldNormalMatrix),M.inverseMat4(this._worldNormalMatrix),this._worldNormalMatrixDirty=!1}_setAABBDirty(){if(this.collidable)for(let t=this;t;t=t._parentNode)t._aabbDirty=!0}_updateAABB(){this.scene._aabbDirty=!0,this._aabb||(this._aabb=M.AABB3()),this._buildAABB(this.worldMatrix,this._aabb),this._aabbDirty=!1}_webglContextRestored(){this._drawRenderer&&this._drawRenderer.webglContextRestored(),this._shadowRenderer&&this._shadowRenderer.webglContextRestored(),this._emphasisFillRenderer&&this._emphasisFillRenderer.webglContextRestored(),this._emphasisEdgesRenderer&&this._emphasisEdgesRenderer.webglContextRestored(),this._pickMeshRenderer&&this._pickMeshRenderer.webglContextRestored(),this._pickTriangleRenderer&&this._pickMeshRenderer.webglContextRestored(),this._occlusionRenderer&&this._occlusionRenderer.webglContextRestored()}_makeDrawHash(){const t=this.scene,e=[t.canvas.canvas.id,(t.gammaInput?"gi;":";")+(t.gammaOutput?"go":""),t._lightsState.getHash(),t._sectionPlanesState.getHash()],i=this._state;return i.stationary&&e.push("/s"),"none"===i.billboard?e.push("/n"):"spherical"===i.billboard?e.push("/s"):"cylindrical"===i.billboard&&e.push("/c"),i.receivesShadow&&e.push("/rs"),e.push(";"),e.join("")}_makePickHash(){const t=this.scene,e=[t.canvas.canvas.id,t._sectionPlanesState.getHash()],i=this._state;return i.stationary&&e.push("/s"),"none"===i.billboard?e.push("/n"):"spherical"===i.billboard?e.push("/s"):"cylindrical"===i.billboard&&e.push("/c"),e.push(";"),e.join("")}_makeOcclusionHash(){const t=this.scene,e=[t.canvas.canvas.id,t._sectionPlanesState.getHash()],i=this._state;return i.stationary&&e.push("/s"),"none"===i.billboard?e.push("/n"):"spherical"===i.billboard?e.push("/s"):"cylindrical"===i.billboard&&e.push("/c"),e.push(";"),e.join("")}_buildAABB(t,e){M.transformOBB3(t,this._geometry.obb,Pa),M.OBB3ToAABB3(Pa,e);const i=this._state.offset;if(e[0]+=i[0],e[1]+=i[1],e[2]+=i[2],e[3]+=i[0],e[4]+=i[1],e[5]+=i[2],this._state.rtcCenter){const t=this._state.rtcCenter;e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[0],e[4]+=t[1],e[5]+=t[2]}}get geometry(){return this._geometry}get material(){return this._material}set position(t){this._position.set(t||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get position(){return this._position}set rotation(t){this._rotation.set(t||[0,0,0]),M.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get rotation(){return this._rotation}set quaternion(t){this._quaternion.set(t||[0,0,0,1]),M.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get quaternion(){return this._quaternion}set scale(t){this._scale.set(t||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get scale(){return this._scale}set matrix(t){this.__localMatrix||(this.__localMatrix=M.identityMat4()),this.__localMatrix.set(t||Sa),M.decomposeMat4(this.__localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get matrix(){return this._localMatrixDirty&&(this.__localMatrix||(this.__localMatrix=M.identityMat4()),M.composeMat4(this._position,this._quaternion,this._scale,this.__localMatrix),this._localMatrixDirty=!1),this.__localMatrix}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}get worldNormalMatrix(){return this._worldNormalMatrixDirty&&this._buildWorldNormalMatrix(),this._worldNormalMatrix}rotate(t,e){return ba[0]=t[0],ba[1]=t[1],ba[2]=t[2],ba[3]=e*M.DEGTORAD,M.angleAxisToQuaternion(ba,ya),M.mulQuaternions(this.quaternion,ya,xa),this.quaternion=xa,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}rotateOnWorldAxis(t,e){return ba[0]=t[0],ba[1]=t[1],ba[2]=t[2],ba[3]=e*M.DEGTORAD,M.angleAxisToQuaternion(ba,ya),M.mulQuaternions(ya,this.quaternion,ya),this}rotateX(t){return this.rotate(Ma,t)}rotateY(t){return this.rotate(wa,t)}rotateZ(t){return this.rotate(Ea,t)}translate(t,e){return M.vec3ApplyQuaternion(this.quaternion,t,Ca),M.mulVec3Scalar(Ca,e,Aa),M.addVec3(this.position,Aa,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}translateX(t){return this.translate(Ma,t)}translateY(t){return this.translate(wa,t)}translateZ(t){return this.translate(Ea,t)}_putDrawRenderers(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._shadowRenderer&&(this._shadowRenderer.put(),this._shadowRenderer=null),this._emphasisFillRenderer&&(this._emphasisFillRenderer.put(),this._emphasisFillRenderer=null),this._emphasisEdgesRenderer&&(this._emphasisEdgesRenderer.put(),this._emphasisEdgesRenderer=null)}_putPickRenderers(){this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickTriangleRenderer&&(this._pickTriangleRenderer.put(),this._pickTriangleRenderer=null)}_putOcclusionRenderer(){this._occlusionRenderer&&(this._occlusionRenderer.put(),this._occlusionRenderer=null)}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return this._isObject}get aabb(){return this._aabbDirty&&this._updateAABB(),this._aabb}set rtcCenter(t){t?(this._state.rtcCenter||(this._state.rtcCenter=M.vec3()),this._state.rtcCenter.set(t),this._state.rtcCenterHash=t.join(),this._setAABBDirty(),this.scene._aabbDirty=!0):this._state.rtcCenter&&(this._state.rtcCenter=null,this._state.rtcCenterHash=null,this._setAABBDirty(),this.scene._aabbDirty=!0)}get rtcCenter(){return this._state.rtcCenter}get numTriangles(){return this._numTriangles}set visible(t){t=!1!==t,this._state.visible=t,this._isObject&&this.scene._objectVisibilityUpdated(this),this.glRedraw()}get visible(){return this._state.visible}set xrayed(t){t=!!t,this._state.xrayed!==t&&(this._state.xrayed=t,this._isObject&&this.scene._objectXRayedUpdated(this),this.glRedraw())}get xrayed(){return this._state.xrayed}set highlighted(t){(t=!!t)!==this._state.highlighted&&(this._state.highlighted=t,this._isObject&&this.scene._objectHighlightedUpdated(this),this.glRedraw())}get highlighted(){return this._state.highlighted}set selected(t){(t=!!t)!==this._state.selected&&(this._state.selected=t,this._isObject&&this.scene._objectSelectedUpdated(this),this.glRedraw())}get selected(){return this._state.selected}set edges(t){(t=!!t)!==this._state.edges&&(this._state.edges=t,this.glRedraw())}get edges(){return this._state.edges}set culled(t){this._state.culled=!!t,this.glRedraw()}get culled(){return this._state.culled}set clippable(t){t=!1!==t,this._state.clippable!==t&&(this._state.clippable=t,this.glRedraw())}get clippable(){return this._state.clippable}set collidable(t){(t=!1!==t)!==this._state.collidable&&(this._state.collidable=t,this._setAABBDirty(),this.scene._aabbDirty=!0)}get collidable(){return this._state.collidable}set pickable(t){t=!1!==t,this._state.pickable!==t&&(this._state.pickable=t)}get pickable(){return this._state.pickable}set castsShadow(t){(t=!1!==t)!==this._state.castsShadow&&(this._state.castsShadow=t,this.glRedraw())}get castsShadow(){return this._state.castsShadow}set receivesShadow(t){(t=!1!==t)!==this._state.receivesShadow&&(this._state.receivesShadow=t,this._state.hash=t?"/mod/rs;":"/mod;",this.fire("dirty",this))}get receivesShadow(){return this._state.receivesShadow}get saoEnabled(){return!1}set colorize(t){let e=this._state.colorize;e||(e=this._state.colorize=new Float32Array(4),e[3]=1),t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1);const i=!!t;this.scene._objectColorizeUpdated(this,i),this.glRedraw()}get colorize(){return this._state.colorize}set opacity(t){let e=this._state.colorize;e||(e=this._state.colorize=new Float32Array(4),e[0]=1,e[1]=1,e[2]=1);const i=null!==t&&t!==undefined;e[3]=i?t:1,this.scene._objectOpacityUpdated(this,i),this.glRedraw()}get opacity(){return this._state.colorize[3]}get transparent(){return 2===this._material.alphaMode||this._state.colorize[3]<1}set layer(t){t=t||0,(t=Math.round(t))!==this._state.layer&&(this._state.layer=t,this._renderer.needStateSort())}get layer(){return this._state.layer}get stationary(){return this._state.stationary}get billboard(){return this._state.billboard}set offset(t){this._state.offset.set(t||[0,0,0]),this._setAABBDirty(),this.glRedraw()}get offset(){return this._state.offset}get isDrawable(){return!0}get isStateSortable(){return!0}stateSortCompare(t,e){return t._state.layer-e._state.layer||t._drawRenderer.id-e._drawRenderer.id||t._material._state.id-e._material._state.id||t._geometry._state.id-e._geometry._state.id}rebuildRenderFlags(){this.renderFlags.reset(),this._getActiveSectionPlanes()?(this.renderFlags.numLayers=1,this.renderFlags.numVisibleLayers=1,this.renderFlags.visibleLayers[0]=0,this._updateRenderFlags()):this.renderFlags.culled=!0}_updateRenderFlags(){const t=this.renderFlags,e=this._state;if(e.xrayed){const e=this._xrayMaterial._state;e.fill&&(e.fillAlpha<1?t.xrayedSilhouetteTransparent=!0:t.xrayedSilhouetteOpaque=!0),e.edges&&(e.edgeAlpha<1?t.xrayedEdgesTransparent=!0:t.xrayedEdgesOpaque=!0)}else{if(this._material._state.alpha<1||e.colorize[3]<1?t.colorTransparent=!0:t.colorOpaque=!0,e.edges){this._edgeMaterial._state.alpha<1?t.edgesTransparent=!0:t.edgesOpaque=!0}if(e.selected){const e=this._selectedMaterial._state;e.fill&&(e.fillAlpha<1?t.selectedSilhouetteTransparent=!0:t.selectedSilhouetteOpaque=!0),e.edges&&(e.edgeAlpha<1?t.selectedEdgesTransparent=!0:t.selectedEdgesOpaque=!0)}else if(e.highlighted){const e=this._highlightMaterial._state;e.fill&&(e.fillAlpha<1?t.highlightedSilhouetteTransparent=!0:t.highlightedSilhouetteOpaque=!0),e.edges&&(e.edgeAlpha<1?t.highlightedEdgesTransparent=!0:t.highlightedEdgesOpaque=!0)}}}_getActiveSectionPlanes(){if(this._state.clippable){const t=this.scene._sectionPlanesState.sectionPlanes,e=t.length;if(e>0)for(let i=0;i<e;i++){const e=t[i],s=this.renderFlags;if(e.active)if(this._state.rtcCenter){const t=M.planeAABB3Intersect(e.dir,e.dist,this.aabb);if(-1===t)return!1;const r=0===t;s.sectionPlanesActivePerLayer[i]=r}else s.sectionPlanesActivePerLayer[i]=!0;else s.sectionPlanesActivePerLayer[i]=!1}}return!0}get xrayMaterial(){return this._xrayMaterial}get highlightMaterial(){return this._highlightMaterial}get selectedMaterial(){return this._selectedMaterial}get edgeMaterial(){return this._edgeMaterial}drawColorOpaque(t){(this._drawRenderer||(this._drawRenderer=Ho.get(this)))&&this._drawRenderer.drawMesh(t,this)}drawColorTransparent(t){(this._drawRenderer||(this._drawRenderer=Ho.get(this)))&&this._drawRenderer.drawMesh(t,this)}drawSilhouetteXRayed(t){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Zo.get(this)))&&this._emphasisFillRenderer.drawMesh(t,this,0)}drawSilhouetteHighlighted(t){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Zo.get(this)))&&this._emphasisFillRenderer.drawMesh(t,this,1)}drawSilhouetteSelected(t){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Zo.get(this)))&&this._emphasisFillRenderer.drawMesh(t,this,2)}drawEdgesColorOpaque(t){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=ia.get(this)))&&this._emphasisEdgesRenderer.drawMesh(t,this,3)}drawEdgesColorTransparent(t){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=ia.get(this)))&&this._emphasisEdgesRenderer.drawMesh(t,this,3)}drawEdgesXRayed(t){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=ia.get(this)))&&this._emphasisEdgesRenderer.drawMesh(t,this,0)}drawEdgesHighlighted(t){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=ia.get(this)))&&this._emphasisEdgesRenderer.drawMesh(t,this,1)}drawEdgesSelected(t){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=ia.get(this)))&&this._emphasisEdgesRenderer.drawMesh(t,this,2)}drawOcclusion(t){(this._occlusionRenderer||(this._occlusionRenderer=fa.get(this)))&&this._occlusionRenderer.drawMesh(t,this)}drawShadow(t){(this._shadowRenderer||(this._shadowRenderer=ma.get(this)))&&this._shadowRenderer.drawMesh(t,this)}drawPickMesh(t){(this._pickMeshRenderer||(this._pickMeshRenderer=aa.get(this)))&&this._pickMeshRenderer.drawMesh(t,this)}canPickTriangle(){return this._geometry.isReadableGeometry}drawPickTriangles(t){(this._pickTriangleRenderer||(this._pickTriangleRenderer=ua.get(this)))&&this._pickTriangleRenderer.drawMesh(t,this)}pickTriangleSurface(t,e,i){La(this,t,e,i)}drawPickVertices(t){}delegatePickedEntity(){return this}destroy(){super.destroy(),this._putDrawRenderers(),this._putPickRenderers(),this._putOcclusionRenderer(),this.scene._renderer.putPickID(this._state.pickID),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this.glRedraw()}}const La=function(){const t=M.vec3(),e=M.vec3(),i=M.vec3(),s=M.vec3(),r=M.vec3(),o=M.vec3(),a=M.vec4(),n=M.vec3(),l=M.vec3(),h=M.vec3(),u=M.vec3(),c=M.vec3(),d=M.vec3(),p=M.vec3(),f=M.vec3(),_=M.vec3(),g=M.vec4(),m=M.vec4(),v=M.vec4(),P=M.vec3(),b=M.vec3(),y=M.vec3(),x=M.vec3(),w=M.vec3(),E=M.vec3(),C=M.vec3(),A=M.vec3(),S=M.vec3(),D=M.vec3(),L=M.vec3();return function(R,B,T,F){var N=F.primIndex;if(N!==undefined&&null!==N&&N>-1){const z=R.geometry._state,V=R.scene,U=V.camera,G=V.canvas;if("triangles"===z.primitiveName){F.primitive="triangle";const V=N,X=z.indices,j=z.positions;let W,H,Y,K;if(X){var O=X[V+0],k=X[V+1],I=X[V+2];o[0]=O,o[1]=k,o[2]=I,F.indices=o,W=3*O,H=3*k,Y=3*I}else W=3*V,H=W+3,Y=H+3;if(i[0]=j[W+0],i[1]=j[W+1],i[2]=j[W+2],s[0]=j[H+0],s[1]=j[H+1],s[2]=j[H+2],r[0]=j[Y+0],r[1]=j[Y+1],r[2]=j[Y+2],z.compressGeometry){const t=z.positionsDecodeMatrix;t&&(kt.decompressPosition(i,t,i),kt.decompressPosition(s,t,s),kt.decompressPosition(r,t,r))}F.canvasPos?(K=F.canvasPos,M.canvasPosToLocalRay(G.canvas,B,T,R.worldMatrix,K,t,e)):F.origin&&F.direction&&M.worldRayToLocalRay(R.worldMatrix,F.origin,F.direction,t,e),M.normalizeVec3(e),M.rayPlaneIntersect(t,e,i,s,r,a),F.localPos=a,F.position=a,g[0]=a[0],g[1]=a[1],g[2]=a[2],g[3]=1,M.transformVec4(R.worldMatrix,g,m),n[0]=m[0],n[1]=m[1],n[2]=m[2],F.worldPos=n,M.transformVec4(U.matrix,m,v),l[0]=v[0],l[1]=v[1],l[2]=v[2],F.viewPos=l,M.cartesianToBarycentric(a,i,s,r,h),F.bary=h;const $=z.normals;if($){if(z.compressGeometry){const t=3*O,e=3*k,i=3*I;kt.decompressNormal($.subarray(t,t+2),u),kt.decompressNormal($.subarray(e,e+2),c),kt.decompressNormal($.subarray(i,i+2),d)}else u[0]=$[W],u[1]=$[W+1],u[2]=$[W+2],c[0]=$[H],c[1]=$[H+1],c[2]=$[H+2],d[0]=$[Y],d[1]=$[Y+1],d[2]=$[Y+2];const t=M.addVec3(M.addVec3(M.mulVec3Scalar(u,h[0],P),M.mulVec3Scalar(c,h[1],b),y),M.mulVec3Scalar(d,h[2],x),w);F.worldNormal=M.normalizeVec3(M.transformVec3(R.worldNormalMatrix,t,E))}const q=z.uv;if(q){if(p[0]=q[2*O],p[1]=q[2*O+1],f[0]=q[2*k],f[1]=q[2*k+1],_[0]=q[2*I],_[1]=q[2*I+1],z.compressGeometry){const t=z.uvDecodeMatrix;t&&(kt.decompressUV(p,t,p),kt.decompressUV(f,t,f),kt.decompressUV(_,t,_))}F.uv=M.addVec3(M.addVec3(M.mulVec2Scalar(p,h[0],C),M.mulVec2Scalar(f,h[1],A),S),M.mulVec2Scalar(_,h[2],D),L)}}}}}(),Ra=i.memory,Ba=C.SUPPORTED_EXTENSIONS.OES_element_index_uint,Ta=Ba?Uint32Array:Uint16Array,Fa=M.AABB3();class Na extends Dt{get type(){return"VBOGeometry"}get isVBOGeometry(){return!0}constructor(t,e={}){super(t,e),this._state=new nt({compressGeometry:!0,primitive:null,primitiveName:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),this._numTriangles=0,this._edgeThreshold=e.edgeThreshold||10,this._aabb=null,this._obb=M.OBB3();const i=this._state,s=this.scene.canvas.gl;switch(e.primitive=e.primitive||"triangles",e.primitive){case"points":i.primitive=s.POINTS,i.primitiveName=e.primitive;break;case"lines":i.primitive=s.LINES,i.primitiveName=e.primitive;break;case"line-loop":i.primitive=s.LINE_LOOP,i.primitiveName=e.primitive;break;case"line-strip":i.primitive=s.LINE_STRIP,i.primitiveName=e.primitive;break;case"triangles":i.primitive=s.TRIANGLES,i.primitiveName=e.primitive;break;case"triangle-strip":i.primitive=s.TRIANGLE_STRIP,i.primitiveName=e.primitive;break;case"triangle-fan":i.primitive=s.TRIANGLE_FAN,i.primitiveName=e.primitive;break;default:this.error("Unsupported value for 'primitive': '"+e.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),i.primitive=s.TRIANGLES,i.primitiveName=e.primitive}if(e.positions)if(e.indices){var r;if(e.positionsDecodeMatrix);else{const t=kt.getPositionsBounds(e.positions),o=kt.compressPositions(e.positions,t.min,t.max);r=o.quantized,i.positionsDecodeMatrix=o.decodeMatrix,i.positionsBuf=new j(s,s.ARRAY_BUFFER,r,r.length,3,s.STATIC_DRAW),Ra.positions+=i.positionsBuf.numItems,M.positions3ToAABB3(e.positions,this._aabb),M.positions3ToAABB3(r,Fa,i.positionsDecodeMatrix),M.AABB3ToOBB3(Fa,this._obb)}if(e.colors){const t=e.colors.constructor===Float32Array?e.colors:new Float32Array(e.colors);i.colorsBuf=new j(s,s.ARRAY_BUFFER,t,t.length,4,s.STATIC_DRAW),Ra.colors+=i.colorsBuf.numItems}if(e.uv){const t=kt.getUVBounds(e.uv),r=kt.compressUVs(e.uv,t.min,t.max),o=r.quantized;i.uvDecodeMatrix=r.decodeMatrix,i.uvBuf=new j(s,s.ARRAY_BUFFER,o,o.length,2,s.STATIC_DRAW),Ra.uvs+=i.uvBuf.numItems}if(e.normals){const t=kt.compressNormals(e.normals);let r=i.compressGeometry;i.normalsBuf=new j(s,s.ARRAY_BUFFER,t,t.length,3,s.STATIC_DRAW,r),Ra.normals+=i.normalsBuf.numItems}if(Ba||e.indices.constructor!==Uint32Array){{const t=e.indices.constructor===Uint32Array||e.indices.constructor===Uint16Array?e.indices:new Ta(e.indices);i.indicesBuf=new j(s,s.ELEMENT_ARRAY_BUFFER,t,t.length,1,s.STATIC_DRAW),Ra.indices+=i.indicesBuf.numItems;const o=Lt(r,t,i.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new j(s,s.ELEMENT_ARRAY_BUFFER,o,o.length,1,s.STATIC_DRAW),"triangles"===this._state.primitiveName&&(this._numTriangles=e.indices.length/3)}this._buildHash(),Ra.meshes++}else this.error("This WebGL implementation does not support Uint32Array")}else this.error("Config expected: indices");else this.error("Config expected: positions")}_buildHash(){const t=this._state,e=["/g"];e.push("/"+t.primitive+";"),t.positionsBuf&&e.push("p"),t.colorsBuf&&e.push("c"),(t.normalsBuf||t.autoVertexNormals)&&e.push("n"),t.uvBuf&&e.push("u"),e.push("cp"),e.push(";"),t.hash=e.join("")}_getEdgeIndices(){return this._edgeIndicesBuf}get primitive(){return this._state.primitiveName}get aabb(){return this._aabb}get obb(){return this._obb}get numTriangles(){return this._numTriangles}_getState(){return this._state}destroy(){super.destroy();const t=this._state;t.indicesBuf&&t.indicesBuf.destroy(),t.positionsBuf&&t.positionsBuf.destroy(),t.normalsBuf&&t.normalsBuf.destroy(),t.uvBuf&&t.uvBuf.destroy(),t.colorsBuf&&t.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),t.destroy(),Ra.meshes--}}const Oa={opaque:0,mask:1,blend:2},ka=["opaque","mask","blend"];class Ia extends Xt{get type(){return"MetallicMaterial"}constructor(t,e={}){super(t,e),this._state=new nt({type:"MetallicMaterial",baseColor:M.vec4([1,1,1]),emissive:M.vec4([0,0,0]),metallic:null,roughness:null,specularF0:null,alpha:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.baseColor=e.baseColor,this.metallic=e.metallic,this.roughness=e.roughness,this.specularF0=e.specularF0,this.emissive=e.emissive,this.alpha=e.alpha,e.baseColorMap&&(this._baseColorMap=this._checkComponent("Texture",e.baseColorMap)),e.metallicMap&&(this._metallicMap=this._checkComponent("Texture",e.metallicMap)),e.roughnessMap&&(this._roughnessMap=this._checkComponent("Texture",e.roughnessMap)),e.metallicRoughnessMap&&(this._metallicRoughnessMap=this._checkComponent("Texture",e.metallicRoughnessMap)),e.emissiveMap&&(this._emissiveMap=this._checkComponent("Texture",e.emissiveMap)),e.occlusionMap&&(this._occlusionMap=this._checkComponent("Texture",e.occlusionMap)),e.alphaMap&&(this._alphaMap=this._checkComponent("Texture",e.alphaMap)),e.normalMap&&(this._normalMap=this._checkComponent("Texture",e.normalMap)),this.alphaMode=e.alphaMode,this.alphaCutoff=e.alphaCutoff,this.backfaces=e.backfaces,this.frontface=e.frontface,this.lineWidth=e.lineWidth,this.pointSize=e.pointSize,this._makeHash()}_makeHash(){const t=this._state,e=["/met"];this._baseColorMap&&(e.push("/bm"),this._baseColorMap._state.hasMatrix&&e.push("/mat"),e.push("/"+this._baseColorMap._state.encoding)),this._metallicMap&&(e.push("/mm"),this._metallicMap._state.hasMatrix&&e.push("/mat")),this._roughnessMap&&(e.push("/rm"),this._roughnessMap._state.hasMatrix&&e.push("/mat")),this._metallicRoughnessMap&&(e.push("/mrm"),this._metallicRoughnessMap._state.hasMatrix&&e.push("/mat")),this._emissiveMap&&(e.push("/em"),this._emissiveMap._state.hasMatrix&&e.push("/mat")),this._occlusionMap&&(e.push("/ocm"),this._occlusionMap._state.hasMatrix&&e.push("/mat")),this._alphaMap&&(e.push("/am"),this._alphaMap._state.hasMatrix&&e.push("/mat")),this._normalMap&&(e.push("/nm"),this._normalMap._state.hasMatrix&&e.push("/mat")),e.push(";"),t.hash=e.join("")}set baseColor(t){let e=this._state.baseColor;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.baseColor=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1),this.glRedraw()}get baseColor(){return this._state.baseColor}get baseColorMap(){return this._baseColorMap}set metallic(t){t=t!==undefined&&null!==t?t:1,this._state.metallic!==t&&(this._state.metallic=t,this.glRedraw())}get metallic(){return this._state.metallic}get metallicMap(){return this._attached.metallicMap}set roughness(t){t=t!==undefined&&null!==t?t:1,this._state.roughness!==t&&(this._state.roughness=t,this.glRedraw())}get roughness(){return this._state.roughness}get roughnessMap(){return this._attached.roughnessMap}get metallicRoughnessMap(){return this._attached.metallicRoughnessMap}set specularF0(t){t=t!==undefined&&null!==t?t:0,this._state.specularF0!==t&&(this._state.specularF0=t,this.glRedraw())}get specularF0(){return this._state.specularF0}set emissive(t){let e=this._state.emissive;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.emissive=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=0,e[1]=0,e[2]=0),this.glRedraw()}get emissive(){return this._state.emissive}get emissiveMap(){return this._attached.emissiveMap}get occlusionMap(){return this._attached.occlusionMap}set alpha(t){t=t!==undefined&&null!==t?t:1,this._state.alpha!==t&&(this._state.alpha=t,this.glRedraw())}get alpha(){return this._state.alpha}get alphaMap(){return this._attached.alphaMap}get normalMap(){return this._attached.normalMap}set alphaMode(t){let e=Oa[t=t||"opaque"];e===undefined&&(this.error("Unsupported value for 'alphaMode': "+t+" defaulting to 'opaque'"),e="opaque"),this._state.alphaMode!==e&&(this._state.alphaMode=e,this.glRedraw())}get alphaMode(){return ka[this._state.alphaMode]}set alphaCutoff(t){null!==t&&t!==undefined||(t=.5),this._state.alphaCutoff!==t&&(this._state.alphaCutoff=t)}get alphaCutoff(){return this._state.alphaCutoff}set backfaces(t){t=!!t,this._state.backfaces!==t&&(this._state.backfaces=t,this.glRedraw())}get backfaces(){return this._state.backfaces}set frontface(t){t="cw"!==t,this._state.frontface!==t&&(this._state.frontface=t,this.glRedraw())}get frontface(){return this._state.frontface?"ccw":"cw"}set lineWidth(t){this._state.lineWidth=t||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set pointSize(t){this._state.pointSize=t||1,this.glRedraw()}get pointSize(){return this._state.pointSize}destroy(){super.destroy(),this._state.destroy()}}const za={opaque:0,mask:1,blend:2},Va=["opaque","mask","blend"];class Ua extends Xt{get type(){return"SpecularMaterial"}constructor(t,e={}){super(t,e),this._state=new nt({type:"SpecularMaterial",diffuse:M.vec3([1,1,1]),emissive:M.vec3([0,0,0]),specular:M.vec3([1,1,1]),glossiness:null,specularF0:null,alpha:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.diffuse=e.diffuse,this.specular=e.specular,this.glossiness=e.glossiness,this.specularF0=e.specularF0,this.emissive=e.emissive,this.alpha=e.alpha,e.diffuseMap&&(this._diffuseMap=this._checkComponent("Texture",e.diffuseMap)),e.emissiveMap&&(this._emissiveMap=this._checkComponent("Texture",e.emissiveMap)),e.specularMap&&(this._specularMap=this._checkComponent("Texture",e.specularMap)),e.glossinessMap&&(this._glossinessMap=this._checkComponent("Texture",e.glossinessMap)),e.specularGlossinessMap&&(this._specularGlossinessMap=this._checkComponent("Texture",e.specularGlossinessMap)),e.occlusionMap&&(this._occlusionMap=this._checkComponent("Texture",e.occlusionMap)),e.alphaMap&&(this._alphaMap=this._checkComponent("Texture",e.alphaMap)),e.normalMap&&(this._normalMap=this._checkComponent("Texture",e.normalMap)),this.alphaMode=e.alphaMode,this.alphaCutoff=e.alphaCutoff,this.backfaces=e.backfaces,this.frontface=e.frontface,this.lineWidth=e.lineWidth,this.pointSize=e.pointSize,this._makeHash()}_makeHash(){const t=this._state,e=["/spe"];this._diffuseMap&&(e.push("/dm"),this._diffuseMap.hasMatrix&&e.push("/mat"),e.push("/"+this._diffuseMap.encoding)),this._emissiveMap&&(e.push("/em"),this._emissiveMap.hasMatrix&&e.push("/mat")),this._glossinessMap&&(e.push("/gm"),this._glossinessMap.hasMatrix&&e.push("/mat")),this._specularMap&&(e.push("/sm"),this._specularMap.hasMatrix&&e.push("/mat")),this._specularGlossinessMap&&(e.push("/sgm"),this._specularGlossinessMap.hasMatrix&&e.push("/mat")),this._occlusionMap&&(e.push("/ocm"),this._occlusionMap.hasMatrix&&e.push("/mat")),this._normalMap&&(e.push("/nm"),this._normalMap.hasMatrix&&e.push("/mat")),this._alphaMap&&(e.push("/opm"),this._alphaMap.hasMatrix&&e.push("/mat")),e.push(";"),t.hash=e.join("")}set diffuse(t){let e=this._state.diffuse;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.diffuse=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1),this.glRedraw()}get diffuse(){return this._state.diffuse}get diffuseMap(){return this._diffuseMap}set specular(t){let e=this._state.specular;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.specular=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1),this.glRedraw()}get specular(){return this._state.specular}get specularMap(){return this._specularMap}get specularGlossinessMap(){return this._specularGlossinessMap}set glossiness(t){t=t!==undefined&&null!==t?t:1,this._state.glossiness!==t&&(this._state.glossiness=t,this.glRedraw())}get glossiness(){return this._state.glossiness}get glossinessMap(){return this._glossinessMap}set specularF0(t){t=t!==undefined&&null!==t?t:0,this._state.specularF0!==t&&(this._state.specularF0=t,this.glRedraw())}get specularF0(){return this._state.specularF0}set emissive(t){let e=this._state.emissive;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.emissive=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=0,e[1]=0,e[2]=0),this.glRedraw()}get emissive(){return this._state.emissive}get emissiveMap(){return this._emissiveMap}set alpha(t){t=t!==undefined&&null!==t?t:1,this._state.alpha!==t&&(this._state.alpha=t,this.glRedraw())}get alpha(){return this._state.alpha}get alphaMap(){return this._alphaMap}get normalMap(){return this._normalMap}get occlusionMap(){return this._occlusionMap}set alphaMode(t){let e=za[t=t||"opaque"];e===undefined&&(this.error("Unsupported value for 'alphaMode': "+t+" defaulting to 'opaque'"),e="opaque"),this._state.alphaMode!==e&&(this._state.alphaMode=e,this.glRedraw())}get alphaMode(){return Va[this._state.alphaMode]}set alphaCutoff(t){null!==t&&t!==undefined||(t=.5),this._state.alphaCutoff!==t&&(this._state.alphaCutoff=t)}get alphaCutoff(){return this._state.alphaCutoff}set backfaces(t){t=!!t,this._state.backfaces!==t&&(this._state.backfaces=t,this.glRedraw())}get backfaces(){return this._state.backfaces}set frontface(t){t="cw"!==t,this._state.frontface!==t&&(this._state.frontface=t,this.glRedraw())}get frontface(){return this._state.frontface?"ccw":"cw"}set lineWidth(t){this._state.lineWidth=t||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set pointSize(t){this._state.pointSize=t||1,this.glRedraw()}get pointSize(){return this._state.pointSize}destroy(){super.destroy(),this._state.destroy()}}const Ga={funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipmapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipmapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipmapLinear:"NEAREST_MIPMAP_LINEAR",linearMipmapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"};function Xa(t,e,i){if(e===undefined)return i;const s=Ga[e];return s===undefined?i:t[s]}const ja=new Uint8Array([0,0,0,1]);class Wa{constructor(t,e){this.gl=t,this.target=e||t.TEXTURE_2D,this.texture=t.createTexture(),this.setPreloadColor([0,0,0,0]),this.allocated=!0}setPreloadColor(t){t?(ja[0]=Math.floor(255*t[0]),ja[1]=Math.floor(255*t[1]),ja[2]=Math.floor(255*t[2]),ja[3]=Math.floor(255*(t[3]!==undefined?t[3]:1))):(ja[0]=0,ja[1]=0,ja[2]=0,ja[3]=255);const e=this.gl;if(e.bindTexture(this.target,this.texture),e.texParameteri(this.target,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(this.target,e.TEXTURE_MIN_FILTER,e.NEAREST),this.target===e.TEXTURE_CUBE_MAP){const t=[e.TEXTURE_CUBE_MAP_POSITIVE_X,e.TEXTURE_CUBE_MAP_NEGATIVE_X,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.TEXTURE_CUBE_MAP_POSITIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let i=0,s=t.length;i<s;i++)e.texImage2D(t[i],0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,ja)}else e.texImage2D(this.target,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,ja);e.bindTexture(this.target,null)}setTarget(t){this.target=t||this.gl.TEXTURE_2D}setImage(t,e){const i=this.gl;if(i.bindTexture(this.target,this.texture),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,e.flipY),this.target===i.TEXTURE_CUBE_MAP){if(n.isArray(t)){const e=t,s=[i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let t=0,r=s.length;t<r;t++)i.texImage2D(s[t],0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e[t])}}else i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t);i.bindTexture(this.target,null)}setProps(t){const e=this.gl;if(e.bindTexture(this.target,this.texture),t.minFilter){const i=Xa(e,t.minFilter);i&&(e.texParameteri(this.target,e.TEXTURE_MIN_FILTER,i),i!==e.NEAREST_MIPMAP_NEAREST&&i!==e.LINEAR_MIPMAP_NEAREST&&i!==e.NEAREST_MIPMAP_LINEAR&&i!==e.LINEAR_MIPMAP_LINEAR||e.generateMipmap(this.target))}if(t.magFilter){const i=Xa(e,t.magFilter);i&&e.texParameteri(this.target,e.TEXTURE_MAG_FILTER,i)}if(t.wrapS){const i=Xa(e,t.wrapS);i&&e.texParameteri(this.target,e.TEXTURE_WRAP_S,i)}if(t.wrapT){const i=Xa(e,t.wrapT);i&&e.texParameteri(this.target,e.TEXTURE_WRAP_T,i)}e.bindTexture(this.target,null)}bind(t){if(this.allocated){if(this.texture){const e=this.gl;return e.activeTexture(e["TEXTURE"+t]),e.bindTexture(this.target,this.texture),!0}return!1}}unbind(t){if(this.allocated&&this.texture){const e=this.gl;e.activeTexture(e["TEXTURE"+t]),e.bindTexture(this.target,null)}}destroy(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)}}function Ha(t){if(!Ya(t.width)||!Ya(t.height)){const e=document.createElement("canvas");e.width=Ka(t.width),e.height=Ka(t.height);e.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,e.width,e.height),t=e}return t}function Ya(t){return 0==(t&t-1)}function Ka(t){--t;for(let e=1;e<32;e<<=1)t|=t>>e;return t+1}class $a extends w{get type(){return"Texture"}constructor(t,e={}){super(t,e),this._state=new nt({texture:new Wa(this.scene.canvas.gl),matrix:M.identityMat4(),hasMatrix:e.translate&&(0!==e.translate[0]||0!==e.translate[1])||!!e.rotate||e.scale&&(0!==e.scale[0]||0!==e.scale[1]),minFilter:this._checkMinFilter(e.minFilter),magFilter:this._checkMagFilter(e.magFilter),wrapS:this._checkWrapS(e.wrapS),wrapT:this._checkWrapT(e.wrapT),flipY:this._checkFlipY(e.flipY),encoding:this._checkEncoding(e.encoding)}),this._src=null,this._image=null,this._translate=M.vec2([0,0]),this._scale=M.vec2([1,1]),this._rotate=M.vec2([0,0]),this._matrixDirty=!1,this.translate=e.translate,this.scale=e.scale,this.rotate=e.rotate,e.src?this.src=e.src:e.image&&(this.image=e.image),i.memory.textures++}_checkMinFilter(t){return"linear"!==(t=t||"linearMipmapLinear")&&"linearMipmapNearest"!==t&&"linearMipmapLinear"!==t&&"nearestMipmapLinear"!==t&&"nearestMipmapNearest"!==t&&(this.error("Unsupported value for 'minFilter': '"+t+"' - supported values are 'linear', 'linearMipmapNearest', 'nearestMipmapNearest', 'nearestMipmapLinear' and 'linearMipmapLinear'. Defaulting to 'linearMipmapLinear'."),t="linearMipmapLinear"),t}_checkMagFilter(t){return"linear"!==(t=t||"linear")&&"nearest"!==t&&(this.error("Unsupported value for 'magFilter': '"+t+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),t="linear"),t}_checkFilter(t){return"linear"!==(t=t||"linear")&&"nearest"!==t&&(this.error("Unsupported value for 'magFilter': '"+t+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),t="linear"),t}_checkWrapS(t){return"clampToEdge"!==(t=t||"repeat")&&"mirroredRepeat"!==t&&"repeat"!==t&&(this.error("Unsupported value for 'wrapS': '"+t+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),t="repeat"),t}_checkWrapT(t){return"clampToEdge"!==(t=t||"repeat")&&"mirroredRepeat"!==t&&"repeat"!==t&&(this.error("Unsupported value for 'wrapT': '"+t+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),t="repeat"),t}_checkFlipY(t){return!!t}_checkEncoding(t){return"linear"!==(t=t||"linear")&&"sRGB"!==t&&"gamma"!==t&&(this.error("Unsupported value for 'encoding': '"+t+"' - supported values are 'linear', 'sRGB', 'gamma'. Defaulting to 'linear'."),t="linear"),t}_webglContextRestored(){this._state.texture=new Wa(this.scene.canvas.gl),this._image?this.image=this._image:this._src&&(this.src=this._src)}_update(){const t=this._state;if(this._matrixDirty){let e,i;0===this._translate[0]&&0===this._translate[1]||(e=M.translationMat4v([this._translate[0],this._translate[1],0],this._state.matrix)),1===this._scale[0]&&1===this._scale[1]||(i=M.scalingMat4v([this._scale[0],this._scale[1],1]),e=e?M.mulMat4(e,i):i),0!==this._rotate&&(i=M.rotationMat4v(.0174532925*this._rotate,[0,0,1]),e=e?M.mulMat4(e,i):i),e&&(t.matrix=e),this._matrixDirty=!1}this.glRedraw()}set image(t){this._image=Ha(t),this._image.crossOrigin="Anonymous",this._state.texture.setImage(this._image,this._state),this._state.texture.setProps(this._state),this._src=null,this.glRedraw()}get image(){return this._image}set src(t){this.scene.loading++,this.scene.canvas.spinner.processes++;const e=this;let i=new Image;i.onload=function(){i=Ha(i),e._state.texture.setImage(i,e._state),e._state.texture.setProps(e._state),e.scene.loading--,e.glRedraw(),e.scene.canvas.spinner.processes--},i.src=t,this._src=t,this._image=null}get src(){return this._src}set translate(t){this._translate.set(t||[0,0]),this._matrixDirty=!0,this._needUpdate()}get translate(){return this._translate}set scale(t){this._scale.set(t||[1,1]),this._matrixDirty=!0,this._needUpdate()}get scale(){return this._scale}set rotate(t){t=t||0,this._rotate!==t&&(this._rotate=t,this._matrixDirty=!0,this._needUpdate())}get rotate(){return this._rotate}get minFilter(){return this._state.minFilter}get magFilter(){return this._state.magFilter}get wrapS(){return this._state.wrapS}get wrapT(){return this._state.wrapT}get flipY(){return this._state.flipY}get encoding(){return this._state.encoding}destroy(){super.destroy(),this._state.texture&&this._state.texture.destroy(),this._state.destroy(),i.memory.textures--}}class qa{constructor(t){t=t||{}}load(t,e,i,s,r,o){s=s||{};var a=e.scene.canvas.spinner;a.processes++,Za(t,e,i,s,(function(){a.processes--,m.scheduleTask((function(){e.scene.fire("modelLoaded",e.id),e.fire("loaded",!0,!1)})),r&&r()}),(function(t){a.processes--,e.error(t),o&&o(t),e.fire("error",t)}))}parse(t,e,i,s,r,o){s=s||{};var a=e.scene.canvas.spinner;a.processes++,Qa(t,i,"",s,e,(function(){a.processes--,e.scene.fire("modelLoaded",e.id),e.fire("loaded",!0,!1),r&&r()}),(function(t){a.processes--,e.error(t),e.fire("error",t),o&&o(t)}))}}var Za=function(t,e,i,s,r,o){t.dataSource.getGLTF(i,(function(a){s.basePath=function(t){var e=t.lastIndexOf("/");return 0!==e?t.substring(0,e+1):""}(i),Qa(t,a,i,s,e,r,o)}),o)},Qa=function(){const t={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},e={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};return function(t,e,n,c,d,p){d.clear();var f={src:n,loadBuffer:c.loadBuffer,basePath:c.basePath,prioritizeGLTFNode:c.prioritizeGLTFNode,handleGLTFNode:c.handleGLTFNode,ignoreMaterials:!!c.ignoreMaterials,edgeThreshold:c.edgeThreshold,readableGeometry:!!c.readableGeometry,json:e,scene:d.scene,plugin:t,modelNode:d,modelNodeProps:{visible:d.visible,culled:d.culled,xrayed:d.xrayed,highlighted:d.highlighted,selected:d.selected,outlined:d.outlined,clippable:d.clippable,pickable:d.pickable,collidable:d.collidable,castsShadow:d.castsShadow,receivesShadow:d.receivesShadow,colorize:d.colorize,opacity:d.opacity,edges:d.edges}};d.scene.loading++,function(t,e){var s=t.json.buffers;if(s)for(var r=s.length,o=0,a=s.length;o<a;o++)i(t,s[o],(function(){0==--r&&e()}),(function(i){t.plugin.error(i),0==--r&&e()}));else e()}(f,(function(){!function(t){var e=t.json.bufferViews;if(e)for(var i=0,r=e.length;i<r;i++)s(t,e[i])}(f),function(t){var e=t.json.accessors;if(e)for(var i=0,s=e.length;i<s;i++)r(t,e[i])}(f),function(t){var e=t.json.textures;if(e)for(var i=0,s=e.length;i<s;i++)o(t,e[i])}(f),function(t){var e,i,s=t.json.materials;if(s)for(var r=0,o=s.length;r<o;r++)i=a(t,e=s[r]),e._material=i}(f),function(t){var e=t.json.meshes;if(e)for(var i=0,s=e.length;i<s;i++)l(t,e[i])}(f),function(t){var e=t.json,i=e.scene||0,s=e.scenes[i];if(!s)return void u(t,"glTF has no default scene");!function(t,e){var i=e.nodes;if(!i)return;for(var s,r=t.json,o=0,a=i.length;o<a;o++)(s=r.nodes[i[o]])?h(t,s,null,null):u(t,"Node not found: "+o)}(t,s)}(f),d.scene.loading--,p()}))};function i(t,e,i,s){var r=e.uri;r?t.plugin.dataSource.getArrayBuffer(t.src,r,(function(t){e._buffer=t,i()}),s):s("gltf/handleBuffer missing uri in "+JSON.stringify(e))}function s(t,e){var i=t.json.buffers[e.buffer];e._typedArray=null;var s=e.byteLength||0,r=e.byteOffset||0;e._buffer=i._buffer.slice(r,r+s)}function r(i,s){var r=i.json.bufferViews[s.bufferView],o=e[s.type],a=t[s.componentType],n=a.BYTES_PER_ELEMENT*o;s.byteStride&&s.byteStride!==n||(s._typedArray=new a(r._buffer,s.byteOffset||0,s.count*o),s._itemSize=o)}function o(t,e){e._texture=new $a(t.modelNode,{src:t.json.images[e.source].uri?t.basePath+t.json.images[e.source].uri:undefined,flipY:!!e.flipY,encoding:"sRGB"})}function a(t,e){var i,s=t.json,r={},o=e.normalTexture;o&&(i=s.textures[o.index])&&(r.normalMap=i._texture);var a=e.occlusionTexture;a&&(i=s.textures[a.index])&&(r.occlusionMap=i._texture);var l=e.emissiveTexture;l&&(i=s.textures[l.index])&&(r.emissiveMap=i._texture);var h=e.emissiveFactor;switch(h&&(r.emissive=h),r.backfaces=!!e.doubleSided,e.alphaMode){case"NORMAL_OPAQUE":r.alphaMode="opaque";break;case"MASK":r.alphaMode="mask";break;case"BLEND":r.alphaMode="blend"}var u=e.alphaCutoff;u!==undefined&&(r.alphaCutoff=u);var c=e.extensions;if(c){var d=c.KHR_materials_pbrSpecularGlossiness;if(d){var p=d.diffuseFactor;null!==p&&p!==undefined&&(r.diffuse=p.slice(0,3),r.alpha=p[3]);var f=d.diffuseTexture;f&&(i=s.textures[f.index])&&(r.diffuseMap=i._texture);var _=d.specularFactor;null!==_&&_!==undefined&&(r.specular=_.slice(0,3));var g=d.glossinessFactor;null!==g&&g!==undefined&&(r.glossiness=g);var m=d.specularGlossinessTexture;return m&&(i=s.textures[m.index])&&(r.specularGlossinessMap=i._texture),new Ua(t.modelNode,r)}var v=c.KHR_materials_common;if(v){var P,b=v.technique,y=v.values||{},x="BLINN"===b,M="PHONG"===b,w="LAMBERT"===b,E=y.shininess;(x||M)&&null!==E&&E!==undefined?r.shininess=E:r.shininess=0;var C=y.diffuse;C&&(x||M||w)?n.isString(C)?(P=t.textures[C])&&(r.diffuseMap=P):r.diffuse=C.slice(0,3):r.diffuse=[0,0,0];var A=y.specular;A&&(x||M)?n.isString(A)?(P=t.textures[A])&&(r.specularMap=P):r.specular=A.slice(0,3):r.specular=[0,0,0];var S=y.emission;S?n.isString(S)?(P=t.textures[S])&&(r.emissiveMap=P):r.emissive=S.slice(0,3):r.emissive=[0,0,0];var D=y.transparency;null!==D&&D!==undefined?r.alpha=D:r.alpha=1;var L=y.transparent;return null!==L&&undefined,new Ht(t.scene,r)}}var R=e.pbrMetallicRoughness;if(R){var B=R.baseColorFactor;B&&(r.baseColor=B.slice(0,3),r.alpha=B[3]);var T=R.baseColorTexture;T&&(i=s.textures[T.index])&&(r.baseColorMap=i._texture);var F=R.metallicFactor;null!==F&&F!==undefined&&(r.metallic=F);var N=R.roughnessFactor;null!==N&&N!==undefined&&(r.roughness=N);var O=R.metallicRoughnessTexture;return O&&(i=s.textures[O.index])&&(r.metallicRoughnessMap=i._texture),new Ia(t.scene,r)}return new Ht(t.scene,r)}function l(t,e){var i,s,r,o,a=t.json,n=[],l=e.primitives;if(l)for(var h,u,c,d,p,f,_,g,m=0,v=l.length;m<v;m++)f={primitive:"triangles",compressGeometry:!0,edgeThreshold:t.edgeThreshold},null!==(u=(h=l[m]).indices)&&u!==undefined&&(r=a.accessors[u],f.indices=r._typedArray),(o=h.attributes)&&(null!==(c=o.POSITION)&&c!==undefined&&(r=a.accessors[c],f.positions=r._typedArray),null!==(d=o.NORMAL)&&d!==undefined&&(r=a.accessors[d],f.normals=r._typedArray),null!==(p=o.TEXCOORD_0)&&p!==undefined&&(r=a.accessors[p],f.uv=r._typedArray),_={},g=t.readableGeometry?new Gt(t.modelNode,f):new Na(t.modelNode,f),_.geometry=g,null!==(i=h.material)&&i!==undefined&&(s=a.materials[i])&&(_.material=s._material),n.push(_));e._mesh=n}function h(t,e,i,s){var r;if(s=s||t.modelNode,t.prioritizeGLTFNode){const i=t.prioritizeGLTFNode(t.modelNode.id,e);if(i===undefined||null===i)return}if(t.handleGLTFNode){var o={};if(!t.handleGLTFNode(t.modelNode.id,e,o))return;o.createEntity&&(r=o.createEntity)}const a=t.json,l=t.modelNode,c=e.children&&e.children.length>0;var d;if(e.matrix&&(d=e.matrix,i=i?M.mulMat4(i,d,M.mat4()):d),e.translation&&(d=M.translationMat4v(e.translation),i=i?M.mulMat4(i,d,d):d),e.rotation&&(d=M.quaternionToMat4(e.rotation),i=i?M.mulMat4(i,d,d):d),e.scale&&(d=M.scalingMat4v(e.scale),i=i?M.mulMat4(i,d,d):d),e.mesh!==undefined){var p=a.meshes[e.mesh];if(p){var f,_,g=p._mesh,m=g.length;if(!r&&m>0&&!c){for(var v=0,P=m;v<P;v++){let e={geometry:(f=g[v]).geometry,matrix:i};n.apply(t.modelNodeProps,e),e.material=f.material,_=new Da(l,e),s.addChild(_,!1)}return}if(r&&1===m&&!c){let e={geometry:(f=g[0]).geometry,matrix:i};return n.apply(t.modelNodeProps,e),e.material=f.material,n.apply(r,e),_=new Da(l,e),void s.addChild(_,!1)}if(r&&m>0&&!c){let e={matrix:i};n.apply(t.modelNodeProps,e),n.apply(r,e);let o=new Io(l,e);s.addChild(o,!1);for(let e=0,i=m;e<i;e++){let i={geometry:(f=g[e]).geometry};n.apply(t.modelNodeProps,i),i.material=f.material,n.apply(r,i),i.id=null,_=new Da(l,i),o.addChild(_,!1)}return}if(!r&&m>0&&c){let e={matrix:i};n.apply(t.modelNodeProps,e);let r=new Io(l,e);s.addChild(r,!1);for(let t=0,i=m;t<i;t++){let i={geometry:(f=g[t]).geometry};n.apply(e,i),i.id=null,i.matrix=null,i.material=f.material,_=new Da(l,i),r.addChild(_,!1)}i=null,s=r}if(r&&0===m&&c){let e={matrix:i};n.apply(t.modelNodeProps,e),n.apply(r,e),r.matrix=i;let o=new Io(l,e);s.addChild(o,!1),i=null,s=o}if(r&&m>0||c){let e={matrix:i};n.apply(t.modelNodeProps,e),r&&n.apply(r,e);let o=new Io(l,e);s.addChild(o,!1);for(let e=0,i=m;e<i;e++){let i={geometry:(f=g[e]).geometry};n.apply(t.modelProps,i),i.material=f.material,r&&n.apply(r,i),i.id=null,_=new Da(l,i),o.addChild(_,!1)}i=null,s=o}}}if(e.children){var b,y,x=e.children;for(let e=0,r=x.length;e<r;e++)y=x[e],(b=a.nodes[y])?h(t,b,i,s):u(t,"Node not found: "+e)}}function u(t,e){t.plugin.error(e)}}();class Ja{constructor(t){t=t||{}}load(t,e,i,s,r,o){tn(t,e,i,s=s||{},(function(){m.scheduleTask((function(){e.scene.fire("modelLoaded",e.id),e.fire("loaded",!0,!1)})),r&&r()}),(function(i){t.error(i),o&&o(i),e.fire("error",i)}))}parse(t,e,i,s,r,o){en(t,i,"",s=s||{},e,(function(){e.scene.fire("modelLoaded",e.id),e.fire("loaded",!0,!1),r&&r()}),(function(t){e.error(t),e.fire("error",t),o&&o(t)}))}}const tn=function(t,e,i,s,r,o){const a=t.viewer.scene.canvas.spinner;a.processes++,t.dataSource.getGLTF(i,(function(n){a.processes--,en(t,n,i,s,e,r,o)}),o)},en=function(){const t={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},e={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};return function(t,e,n,l,h,c){const d={src:n,loadBuffer:l.loadBuffer,handleGLTFNode:l.handleGLTFNode,json:e,scene:h.scene,plugin:t,performanceModel:h,geometryCreated:{},numObjects:0,nodes:[]},p=t.viewer.scene.canvas.spinner;p.processes++,function(t,e){const s=t.json.buffers;if(s){let r=s.length;for(let o=0,a=s.length;o<a;o++)i(t,s[o],(function(){0==--r&&e()}),(function(i){t.plugin.error(i),0==--r&&e()}))}else e()}(d,(function(){!function(t){const e=t.json.bufferViews;if(e)for(let i=0,r=e.length;i<r;i++)s(t,e[i])}(d),function(t){const e=t.json.buffers;if(e)for(let t=0,i=e.length;t<i;t++)e[t]._buffer=null}(d),function(t){const e=t.json.materials;if(e)for(let i=0,s=e.length;i<s;i++){const s=e[i],o=r(t,s);s._rgbaColor=o}}(d),p.processes--,function(t){const e=t.json,i=e.scene||0,s=e.scenes[i];if(!s)return void u(t,"glTF has no default scene");(function(t,e){const i=e.nodes;if(!i)return;const s=t.json;for(let e=0,r=i.length;e<r;e++){const r=s.nodes[i[e]];r?o(t,e):u(t,"Node not found: "+e)}})(t,s),function(t,e){const i=e.nodes;if(!i)return;const s=t.json;for(let e=0,r=i.length;e<r;e++){const r=s.nodes[i[e]];r?o(t,r):u(t,"Node not found: "+e)}t.plugin.viewer.scene.canvas.spinner.processes++;for(let e=0,r=i.length;e<r;e++){a(t,s.nodes[i[e]],null)}t.plugin.viewer.scene.canvas.spinner.processes--}(t,s)}(d),h.finalize(),c()}))};function i(t,e,i,s){const r=e.uri;r?t.plugin.dataSource.getArrayBuffer(t.src,r,(function(t){e._buffer=t,i()}),s):s("gltf/handleBuffer missing uri in "+JSON.stringify(e))}function s(t,e){const i=t.json.buffers[e.buffer];e._typedArray=null;const s=e.byteLength||0,r=e.byteOffset||0;e._buffer=i._buffer.slice(r,r+s)}function r(t,e){const i=new Float32Array([1,1,1,1]),s=e.extensions;if(s){const t=s.KHR_materials_pbrSpecularGlossiness;if(t){const e=t.diffuseFactor;null!==e&&e!==undefined&&i.set(e)}const e=s.KHR_materials_common;if(e){const t=e.technique,s=e.values||{},r="BLINN"===t,o="PHONG"===t,a="LAMBERT"===t,l=s.diffuse;l&&(r||o||a)&&(n.isString(l)||i.set(l));const h=s.transparency;null!==h&&h!==undefined&&(i[3]=h);const u=s.transparent;null!==u&&u!==undefined&&(i[3]=u)}}const r=e.pbrMetallicRoughness;if(r){const t=r.baseColorFactor;t&&i.set(t)}return i}function o(t,e){const i=t.json;if(e.mesh!==undefined){const t=i.meshes[e.mesh];t&&(t.instances=t.instances?t.instances+1:1)}if(e.children){const s=e.children;for(let e=0,r=s.length;e<r;e++){const r=s[e],a=i.nodes[r];a?o(t,a):u(t,"Node not found: "+e)}}}function a(t,e,i){const s=t.json;let r;if(e.matrix&&(r=e.matrix,i=i?M.mulMat4(i,r,M.mat4()):r),e.translation&&(r=M.translationMat4v(e.translation),i=i?M.mulMat4(i,r,M.mat4()):r),e.rotation&&(r=M.quaternionToMat4(e.rotation),i=i?M.mulMat4(i,r,M.mat4()):r),e.scale&&(r=M.scalingMat4v(e.scale),i=i?M.mulMat4(i,r,M.mat4()):r),e.mesh!==undefined){const r=s.meshes[e.mesh];if(r){let o;if(t.handleGLTFNode){const i={};if(!t.handleGLTFNode(t.performanceModel.id,e,i))return;i.createEntity&&(o=i.createEntity)}const a=t.performanceModel,h=i?i.slice():M.identityMat4(),u=r.primitives.length;if(u>0){const i=[];for(let n=0;n<u;n++){const u={id:a.id+"."+t.numObjects++,matrix:h},c=r.primitives[n],d=c.material;let p;if(null!==d&&d!==undefined&&(p=s.materials[d]),p?(u.color=p._rgbaColor,u.opacity=p._rgbaColor[3]):(u.color=new Float32Array([1,1,1]),u.opacity=1),o&&(o.colorize&&(u.color=o.colorize),o.opacity!==undefined&&null!==o.opacity&&(u.opacity=o.opacity)),r.instances>1){const s=a.id+"."+e.mesh+"."+n;if(!t.geometryCreated[s]){const e={id:s};l(t,c,e),a.createGeometry(e),t.geometryCreated[s]=!0}u.geometryId=s,a.createMesh(u),i.push(u.id)}else l(t,c,u),a.createMesh(u),i.push(u.id)}o?a.createEntity(n.apply(o,{meshIds:i})):a.createEntity({meshIds:i})}}}if(e.children){const r=e.children;for(let e=0,o=r.length;e<o;e++){const o=r[e],n=s.nodes[o];n?a(t,n,i):u(t,"Node not found: "+e)}}}function l(t,e,i){const s=e.attributes;if(!s)return;i.primitive="triangles";const r=e.indices;if(null!==r&&r!==undefined){const e=t.json.accessors[r];i.indices=h(t,e)}const o=s.POSITION;if(null!==o&&o!==undefined){const e=t.json.accessors[o];i.positions=h(t,e)}const a=s.NORMAL;if(null!==a&&a!==undefined){const e=t.json.accessors[a];i.normals=h(t,e)}i.indices&&(i.edgeIndices=Lt(i.positions,i.indices,null,10))}function h(i,s){const r=i.json.bufferViews[s.bufferView],o=e[s.type],a=t[s.componentType],n=a.BYTES_PER_ELEMENT*o;if(!s.byteStride||s.byteStride===n)return new a(r._buffer,s.byteOffset||0,s.count*o);u("interleaved buffer!")}function u(t,e){t.plugin.error(e)}}(),sn={IfcOpeningElement:{pickable:!1,visible:!1},IfcSpace:{colorize:[.137255,.403922,.870588],pickable:!1,visible:!1,opacity:.4},IfcWindow:{colorize:[.137255,.403922,.870588],opacity:.3},IfcPlate:{colorize:[.8470588235,.427450980392,0,.5],opacity:.3},DEFAULT:{}};class rn{constructor(){}getMetaModel(t,e,i){n.loadJSON(t,(t=>{e(t)}),(function(t){i(t)}))}getGLTF(t,e,i){n.loadJSON(t,(t=>{e(t)}),(function(t){i(t)}))}getArrayBuffer(t,e,i,s){!function(t,e,i,r){var o=()=>{};i=i||o,r=r||o;const a=/^data:(.*?)(;base64)?,(.*)$/,n=e.match(a);if(n){const t=!!n[2];var l=n[3];l=window.decodeURIComponent(l),t&&(l=window.atob(l));try{const t=new ArrayBuffer(l.length),e=new Uint8Array(t);for(var h=0;h<l.length;h++)e[h]=l.charCodeAt(h);window.setTimeout((function(){i(t)}),0)}catch(s){window.setTimeout((function(){r(s)}),0)}}else{const s=function(t){var e=t.lastIndexOf("/");return 0!==e?t.substring(0,e+1):""}(t),o=s+e,a=new XMLHttpRequest;a.open("GET",o,!0),a.responseType="arraybuffer",a.onreadystatechange=function(){4===a.readyState&&(200===a.status?i(a.response):r("loadArrayBuffer error : "+a.response))},a.send(null)}}(t,e,(t=>{i(t)}),(function(t){s(t)}))}}class on extends zo{constructor(t,e={}){super("GLTFLoader",t,e),this._sceneGraphLoader=new qa(this,e),this._performanceModelLoader=new Ja(this,e),this.dataSource=e.dataSource,this.objectDefaults=e.objectDefaults}set dataSource(t){this._dataSource=t||new rn}get dataSource(){return this._dataSource}set objectDefaults(t){this._objectDefaults=t||sn}get objectDefaults(){return this._objectDefaults}load(t={}){t.id&&this.viewer.scene.components[t.id]&&(this.error("Component with this ID already exists in viewer: "+t.id+" - will autogenerate this ID"),delete t.id);const e=!1!==t.performance,i=e?new So(this.viewer.scene,n.apply(t,{isModel:!0})):new Io(this.viewer.scene,n.apply(t,{isModel:!0})),s=i.id;if(!t.src&&!t.gltf)return this.error("load() param expected: src or gltf"),i;const r=e?this._performanceModelLoader:this._sceneGraphLoader;if(t.metaModelSrc||t.metaModelData){const e=t.objectDefaults||this._objectDefaults||sn,o=o=>{var a;if(this.viewer.metaScene.createMetaModel(s,o,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes}),this.viewer.scene.canvas.spinner.processes--,t.includeTypes){a={};for(let e=0,i=t.includeTypes.length;e<i;e++)a[t.includeTypes[e]]=!0}if(t.excludeTypes){({});for(let e=0,i=t.excludeTypes.length;e<i;e++)a[t.excludeTypes[e]]=!0}t.readableGeometry=!1,t.handleGLTFNode=(t,i,s)=>{const r=i.name;if(!r)return!0;const o=r,a=this.viewer.metaScene.metaObjects[o],n=(a?a.type:"DEFAULT")||"DEFAULT";s.createEntity={id:o,isObject:!0};const l=e[n];return l&&(!1===l.visible&&(s.createEntity.visible=!1),l.colorize&&(s.createEntity.colorize=l.colorize),!1===l.pickable&&(s.createEntity.pickable=!1),l.opacity!==undefined&&null!==l.opacity&&(s.createEntity.opacity=l.opacity)),!0},t.src?r.load(this,i,t.src,t):r.parse(this,i,t.gltf,t)};if(t.metaModelSrc){const e=t.metaModelSrc;this.viewer.scene.canvas.spinner.processes++,this._dataSource.getMetaModel(e,(t=>{this.viewer.scene.canvas.spinner.processes--,o(t)}),(t=>{this.error(`load(): Failed to load model metadata for model '${s} from  '${e}' - ${t}`),this.viewer.scene.canvas.spinner.processes--}))}else t.metaModelData&&o(t.metaModelData)}else t.handleGLTFNode=(t,e,i)=>{const s=e.name;if(!s)return!0;const r=s;return i.createEntity={id:r,isObject:!0},!0},t.src?r.load(this,i,t.src,t):r.parse(this,i,t.gltf,t);return i.once("destroyed",(()=>{this.viewer.metaScene.destroyMetaModel(s)})),i}destroy(){super.destroy()}}function an(t={}){let e=t.radiusTop||1;e<0&&(console.error("negative radiusTop not allowed - will invert"),e*=-1);let i=t.radiusBottom||1;i<0&&(console.error("negative radiusBottom not allowed - will invert"),i*=-1);let s=t.height||1;s<0&&(console.error("negative height not allowed - will invert"),s*=-1);let r=t.radialSegments||32;r<0&&(console.error("negative radialSegments not allowed - will invert"),r*=-1),r<3&&(r=3);let o=t.heightSegments||1;o<0&&(console.error("negative heightSegments not allowed - will invert"),o*=-1),o<1&&(o=1);const a=!!t.openEnded;let l=t.center;const h=l?l[0]:0,u=l?l[1]:0,c=l?l[2]:0,d=s/2,p=s/o,f=2*Math.PI/r,_=1/r,g=(e-i)/o,m=[],v=[],P=[],b=[];let y,x,M,w,E,C,A,S,D,L,R;const B=(90-180*Math.atan(s/(i-e))/Math.PI)/90;for(y=0;y<=o;y++)for(E=e-y*g,C=d-y*p,x=0;x<=r;x++)M=Math.sin(x*f),w=Math.cos(x*f),v.push(E*M),v.push(B),v.push(E*w),P.push(x*_),P.push(1*y/o),m.push(E*M+h),m.push(C+u),m.push(E*w+c);for(y=0;y<o;y++)for(x=0;x<=r;x++)A=y*(r+1)+x,S=A+r,b.push(A),b.push(S),b.push(S+1),b.push(A),b.push(S+1),b.push(A+1);if(!a&&e>0){for(D=m.length/3,v.push(0),v.push(1),v.push(0),P.push(.5),P.push(.5),m.push(0+h),m.push(d+u),m.push(0+c),x=0;x<=r;x++)M=Math.sin(x*f),w=Math.cos(x*f),L=.5*Math.sin(x*f)+.5,R=.5*Math.cos(x*f)+.5,v.push(e*M),v.push(1),v.push(e*w),P.push(L),P.push(R),m.push(e*M+h),m.push(d+u),m.push(e*w+c);for(x=0;x<r;x++)l=D,A=D+1+x,b.push(A),b.push(A+1),b.push(l)}if(!a&&i>0){for(D=m.length/3,v.push(0),v.push(-1),v.push(0),P.push(.5),P.push(.5),m.push(0+h),m.push(0-d+u),m.push(0+c),x=0;x<=r;x++)M=Math.sin(x*f),w=Math.cos(x*f),L=.5*Math.sin(x*f)+.5,R=.5*Math.cos(x*f)+.5,v.push(i*M),v.push(-1),v.push(i*w),P.push(L),P.push(R),m.push(i*M+h),m.push(0-d+u),m.push(i*w+c);for(x=0;x<r;x++)l=D,A=D+1+x,b.push(l),b.push(A+1),b.push(A)}return n.apply(t,{positions:m,normals:v,uv:P,indices:b})}function nn(t,e={}){const i="lightgrey",s=e.hoverColor||"rgba(0,0,0,0.4)";var r=500,o=r+r/3,a=o/24;const n=[{boundary:[6,6,6,6],color:e.frontColor||e.color||"#55FF55"},{boundary:[18,6,6,6],color:e.backColor||e.color||"#55FF55"},{boundary:[12,6,6,6],color:e.leftColor||e.color||"#FF5555"},{boundary:[0,6,6,6],color:e.rightColor||e.color||"#FF5555"},{boundary:[6,0,6,6],color:e.topColor||e.color||"#7777FF"},{boundary:[6,12,6,6],color:e.bottomColor||e.color||"#7777FF"}],l=[{label:"front",boundaries:[[7,7,4,4]],dir:[0,1,0],up:[0,0,1]},{label:"back",boundaries:[[19,7,4,4]],dir:[0,-1,0],up:[0,0,1]},{label:"right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,0,1]},{label:"left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,0,1]},{label:"top",boundaries:[[7,1,4,4]],dir:[0,0,-1],up:[0,1,0]},{label:"bottom",boundaries:[[7,13,4,4]],dir:[0,0,1],up:[0,-1,0]},{boundaries:[[7,5,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,0,-1],up:[1,0,1]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-1,-1],up:[0,-1,1]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,0,-1],up:[-1,0,1]},{boundaries:[[7,11,4,2]],dir:[0,1,1],up:[0,-1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,0,1],up:[-1,0,1]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,-1,1],up:[0,1,1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,0,1],up:[1,0,1]},{boundaries:[[5,7,2,4]],dir:[1,1,0],up:[0,0,1]},{boundaries:[[11,7,2,4]],dir:[-1,1,0],up:[0,0,1]},{boundaries:[[17,7,2,4]],dir:[-1,-1,0],up:[0,0,1]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,-1,0],up:[0,0,1]},{boundaries:[[5,11,2,2]],dir:[1,1,1],up:[-1,-1,1]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[1,-1,1],up:[-1,1,1]},{boundaries:[[5,5,2,2]],dir:[1,1,-1],up:[1,1,1]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-1,-1,1],up:[1,1,1]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-1,-1,-1],up:[-1,-1,1]},{boundaries:[[11,11,2,2]],dir:[-1,1,1],up:[1,-1,1]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[1,-1,-1],up:[1,-1,1]},{boundaries:[[11,5,2,2]],dir:[-1,1,-1],up:[-1,1,1]}],h=[{boundary:[6,6,6,6],color:e.frontColor||e.color||"#55FF55"},{boundary:[18,6,6,6],color:e.backColor||e.color||"#55FF55"},{boundary:[12,6,6,6],color:e.leftColor||e.color||"#FF5555"},{boundary:[0,6,6,6],color:e.rightColor||e.color||"#FF5555"},{boundary:[6,0,6,6],color:e.topColor||e.color||"#7777FF"},{boundary:[6,12,6,6],color:e.bottomColor||e.color||"#7777FF"}],u=[{label:"front",boundaries:[[7,7,4,4]],dir:[0,0,-1],up:[0,1,0]},{label:"back",boundaries:[[19,7,4,4]],dir:[0,0,1],up:[0,1,0]},{label:"right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,1,0]},{label:"left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,1,0]},{label:"top",boundaries:[[7,1,4,4]],dir:[0,-1,0],up:[0,0,-1]},{label:"bottom",boundaries:[[7,13,4,4]],dir:[0,1,0],up:[0,0,1]},{boundaries:[[7,5,4,2]],dir:[0,-1,-1],up:[0,1,-1]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,-1,0],up:[1,1,0]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-1,1],up:[0,1,1]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,-1,0],up:[-1,1,0]},{boundaries:[[7,11,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,1,0],up:[-1,1,0]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,1,1],up:[0,1,-1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,1,0],up:[1,1,0]},{boundaries:[[5,7,2,4]],dir:[1,0,-1],up:[0,1,0]},{boundaries:[[11,7,2,4]],dir:[-1,0,-1],up:[0,1,0]},{boundaries:[[17,7,2,4]],dir:[-1,0,1],up:[0,1,0]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,0,1],up:[0,1,0]},{boundaries:[[5,11,2,2]],dir:[1,1,-1],up:[-1,1,1]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[1,1,1],up:[-1,1,-1]},{boundaries:[[5,5,2,2]],dir:[1,-1,-1],up:[1,1,-1]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-1,1,1],up:[1,1,-1]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-1,-1,1],up:[-1,1,1]},{boundaries:[[11,11,2,2]],dir:[-1,1,-1],up:[1,1,1]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[1,-1,1],up:[1,1,1]},{boundaries:[[11,5,2,2]],dir:[-1,-1,-1],up:[-1,1,-1]}];for(let t=0,e=l.length;t<e;t++)M.normalizeVec3(l[t].dir,l[t].dir),M.normalizeVec3(u[t].dir,u[t].dir);var c=u;this._textureCanvas=document.createElement("canvas"),this._textureCanvas.width=o,this._textureCanvas.height=r,this._textureCanvas.style.width=o+"px",this._textureCanvas.style.height=r+"px",this._textureCanvas.style.padding="0",this._textureCanvas.style.margin="0",this._textureCanvas.style.top="0",this._textureCanvas.style.background=i,this._textureCanvas.style.position="absolute",this._textureCanvas.style.opacity="1.0",this._textureCanvas.style.visibility="hidden",this._textureCanvas.style["z-index"]=2e6;document.getElementsByTagName("body")[0].appendChild(this._textureCanvas);const d=this._textureCanvas.getContext("2d");function p(){for(let t=0,e=n.length;t<e;t++){const e=n[t],i=e.boundary,s=Math.round(i[0]*a),r=Math.round(i[1]*a),o=Math.round(i[2]*a),l=Math.round(i[3]*a);d.fillStyle=e.color,d.fillRect(s,r,o,l)}for(let n=0,l=c.length;n<l;n++){let l,h,u,p;const _=c[n],g=_.boundaries;for(var t=0,e=g.length;t<e;t++){const e=g[t];l=Math.round(e[0]*a),h=Math.round(e[1]*a),u=Math.round(e[2]*a),p=Math.round(e[3]*a),_.highlighted&&(d.fillStyle=_.highlighted?s:_.color||i,d.fillRect(l,h,u,p))}if(_.label){d.fillStyle="black",d.font="60px sans-serif",d.textAlign="center";var r=l+.5*u,o=h+.7*p;d.fillText(f(_.label),r,o,80)}}}var f=function(){const e={yUp:{front:"+Z",back:"-Z",right:"+X",left:"-X",top:"+Y",bottom:"-Y"},en:{front:"FRONT",back:"BACK",right:"RIGHT",left:"LEFT",top:"TOP",bottom:"BOTTOM"}};return function(i){var s;return(s=e[t.language||"en"])&&s[i]||i}}();this.setZUp=function(){!0,n,c=l,this.clear()},this.setYUp=function(){!1,h,c=u,this.clear()},this.clear=function(){d.fillStyle=i,d.fillRect(0,0,o,r);for(var t=0,e=c.length;t<e;t++){c[t].highlighted=!1}p()},this.getArea=function(t){const e=t[0]*o,i=r-t[1]*r;for(var s=0,n=c.length;s<n;s++){const t=c[s].boundaries;for(var l=0,h=t.length;l<h;l++){const r=t[l];if(e>=r[0]*a&&e<=(r[0]+r[2])*a&&i>=r[1]*a&&i<=(r[1]+r[3])*a)return s}}return-1},this.setAreaHighlighted=function(t,e){var i=c[t];if(!i)throw"Area not found: "+t;i.highlighted=!!e,p()},this.getAreaDir=function(t){var e=c[t];if(!e)throw"Unknown area: "+t;return e.dir},this.getAreaUp=function(t){var e=c[t];if(!e)throw"Unknown area: "+t;return e.up},this.getImage=function(){return this._textureCanvas},this.destroy=function(){this._textureCanvas&&(this._textureCanvas.parentNode.removeChild(this._textureCanvas),this._textureCanvas=null)},this.clear()}class ln extends zo{constructor(t,e={}){super("NavCube",t,e),t.navCube=this;try{this._navCubeScene=new oe(t,{canvasId:e.canvasId,canvasElement:e.canvasElement,transparent:!0}),this._navCubeCanvas=this._navCubeScene.canvas.canvas,this._navCubeScene.input.keyboardEnabled=!1}catch(m){return void this.error(m)}const i=this._navCubeScene;i.clearLights(),new At(i,{dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"}),new At(i,{dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new At(i,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),this._navCubeCamera=i.camera,this._navCubeCamera.ortho.scale=7,this._navCubeCamera.ortho.near=.1,this._navCubeCamera.ortho.far=2e3,this._zUp=Boolean(t.camera.zUp);var s=this;this._synchCamera=function(){var e=M.rotationMat4c(-90*M.DEGTORAD,1,0,0),i=M.vec3(),r=M.vec3(),o=M.vec3();return function(){var a=t.camera.eye,n=t.camera.look,l=t.camera.up;i=M.mulVec3Scalar(M.normalizeVec3(M.subVec3(a,n,i)),5),s._zUp?(M.transformVec3(e,i,r),M.transformVec3(e,l,o),s._navCubeCamera.look=[0,0,0],s._navCubeCamera.eye=M.transformVec3(e,i,r),s._navCubeCamera.up=M.transformPoint3(e,l,o)):(s._navCubeCamera.look=[0,0,0],s._navCubeCamera.eye=i,s._navCubeCamera.up=l)}}(),this._cubeTextureCanvas=new nn(t,e),this._cubeSampler=new $a(i,{image:this._cubeTextureCanvas.getImage(),flipY:!0,wrapS:"clampToEdge",wrapT:"clampToEdge"}),this._cubeMesh=new Da(i,{geometry:new Gt(i,{primitive:"triangles",normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],positions:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],uv:[.5,.6666,.25,.6666,.25,.3333,.5,.3333,.5,.6666,.5,.3333,.75,.3333,.75,.6666,.5,.6666,.5,1,.25,1,.25,.6666,.25,.6666,0,.6666,0,.3333,.25,.3333,.25,0,.5,0,.5,.3333,.25,.3333,.75,.3333,1,.3333,1,.6666,.75,.6666],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]}),material:new Ht(i,{diffuse:[.4,.4,.4],specular:[.4,.4,.4],emissive:[.6,.6,.6],diffuseMap:this._cubeSampler,emissiveMap:this._cubeSampler}),visible:!0,edges:!0}),this._shadow=new Da(i,{geometry:new Gt(i,an({center:[0,0,0],radiusTop:.001,radiusBottom:1.4,height:.01,radialSegments:20,heightSegments:1,openEnded:!0})),material:new Ht(i,{diffuse:[0,0,0],specular:[0,0,0],emissive:[0,0,0],alpha:.5}),position:[0,-1.5,0],visible:!0,pickable:!1,backfaces:!1}),this._onCameraMatrix=t.camera.on("matrix",this._synchCamera),this._onCameraWorldAxis=t.camera.on("worldAxis",(()=>{t.camera.zUp?(this._zUp=!0,this._cubeTextureCanvas.setZUp(),this._repaint(),this._synchCamera()):t.camera.yUp&&(this._zUp=!1,this._cubeTextureCanvas.setYUp(),this._repaint(),this._synchCamera())})),this._onCameraFOV=t.camera.perspective.on("fov",(t=>{this._synchProjection&&(this._navCubeCamera.perspective.fov=t)})),this._onCameraProjection=t.camera.on("projection",(t=>{this._synchProjection&&(this._navCubeCamera.projection=t)}));var r=-1;function o(t){var e=[0,0];if(t){for(var i=t.target,s=0,r=0;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;e[0]=t.pageX-s,e[1]=t.pageY-r}else t=window.event,e[0]=t.x,e[1]=t.y;return e}var a,n,l=null,h=null,u=!1,c=!1,d=0,p=null,f=null,_=.5;s._navCubeCanvas.addEventListener("mouseenter",s._onMouseEnter=function(t){c=!0}),s._navCubeCanvas.addEventListener("mouseleave",s._onMouseLeave=function(t){c=!1}),s._navCubeCanvas.addEventListener("mousedown",s._onMouseDown=function(t){if(1===t.which){l=t.x,h=t.y,a=t.clientX,n=t.clientY;var e=o(t),s=i.pick({canvasPos:e});u=!!s}}),document.addEventListener("mouseup",s._onMouseUp=function(t){if(1===t.which&&(u=!1,null!==l)){var e=o(t),a=i.pick({canvasPos:e,pickSurface:!0});if(a&&a.uv){var n=s._cubeTextureCanvas.getArea(a.uv);if(n>=0&&(document.body.style.cursor="pointer",r>=0&&(s._cubeTextureCanvas.setAreaHighlighted(r,!1),s._repaint(),r=-1),n>=0)){if(s._cubeTextureCanvas.setAreaHighlighted(n,!0),r=n,s._repaint(),t.x<l-3||t.x>l+3||t.y<h-3||t.y>h+3)return;var c=s._cubeTextureCanvas.getAreaDir(n);if(c){var d=s._cubeTextureCanvas.getAreaUp(n);g(c,d,(function(){r>=0&&(s._cubeTextureCanvas.setAreaHighlighted(r,!1),s._repaint(),r=-1);var t=i.pick({canvasPos:e,pickSurface:!0});if(t&&t.uv){var o=s._cubeTextureCanvas.getArea(t.uv);o!==undefined&&(document.body.style.cursor="pointer",r>=0&&(s._cubeTextureCanvas.setAreaHighlighted(r,!1),s._repaint(),r=-1),o>=0&&(s._cubeTextureCanvas.setAreaHighlighted(o,!0),r=o,s._repaint()))}}))}}}}}),document.addEventListener("mousemove",s._onMouseMove=function(e){if(r>=0&&(s._cubeTextureCanvas.setAreaHighlighted(r,!1),s._repaint(),r=-1),1!==e.buttons||u){if(u){var l=e.clientX,h=e.clientY;return document.body.style.cursor="move",void function(e,i){var s=(e-a)*-_,r=(i-n)*-_;s,d-=r,p!==undefined&&d<p&&(d=p),f!==undefined&&d>f&&(d=f),t.camera.orbitYaw(s),t.camera.orbitPitch(-r),a=e,n=i}(l,h)}if(c){var g=o(e),m=i.pick({canvasPos:g,pickSurface:!0});if(m){if(m.uv){document.body.style.cursor="pointer";var v=s._cubeTextureCanvas.getArea(m.uv);if(v===r)return;r>=0&&s._cubeTextureCanvas.setAreaHighlighted(r,!1),v>=0&&(s._cubeTextureCanvas.setAreaHighlighted(v,!0),s._repaint(),r=v)}}else document.body.style.cursor="default",r>=0&&(s._cubeTextureCanvas.setAreaHighlighted(r,!1),s._repaint(),r=-1)}}});var g=function(){var e=M.vec3();return function(i,r,o){var a=s._fitVisible?t.scene.getAABB(t.scene.visibleObjectIds):t.scene.aabb,n=M.getAABB3Diag(a);M.getAABB3Center(a,e);var l=Math.abs(n/Math.tan(27.5));t.cameraControl.pivotPos=e,s._cameraFly?t.cameraFlight.flyTo({look:e,eye:[e[0]-l*i[0],e[1]-l*i[1],e[2]-l*i[2]],up:r||[0,1,0],orthoScale:1.3*n,fitFOV:s._cameraFitFOV,duration:s._cameraFlyDuration},o):t.cameraFlight.jumpTo({look:e,eye:[e[0]-l*i[0],e[1]-l*i[1],e[2]-l*i[2]],up:r||[0,1,0],orthoScale:1.3*n,fitFOV:s._cameraFitFOV},o)}}();this.setVisible(e.visible),this.setCameraFitFOV(e.cameraFitFOV),this.setCameraFly(e.cameraFly),this.setCameraFlyDuration(e.cameraFlyDuration),this.setFitVisible(e.fitVisible),this.setSynchProjection(e.synchProjection)}send(t,e){if("language"===t)this._cubeTextureCanvas.clear(),this._repaint()}_repaint(){const t=this._cubeTextureCanvas.getImage();this._cubeMesh.material.diffuseMap.image=t,this._cubeMesh.material.emissiveMap.image=t}setVisible(t=!0){this._navCubeCanvas&&(this._cubeMesh.visible=t,this._shadow.visible=t,this._navCubeCanvas.style.visibility=t?"visible":"hidden")}getVisible(){return!!this._navCubeCanvas&&this._cubeMesh.visible}setFitVisible(t=!1){this._fitVisible=t}getFitVisible(){return this._fitVisible}setCameraFly(t=!0){this._cameraFly=t}getCameraFly(){return this._cameraFly}setCameraFitFOV(t=45){this._cameraFitFOV=t}getCameraFitFOV(){return this._cameraFitFOV}setCameraFlyDuration(t=.5){this._cameraFlyDuration=t}getCameraFlyDuration(){return this._cameraFlyDuration}setSynchProjection(t=!1){this._synchProjection=t}getSynchProjection(){return this._synchProjection}destroy(){this._navCubeCanvas&&(this.viewer.camera.off(this._onCameraMatrix),this.viewer.camera.off(this._onCameraWorldAxis),this.viewer.camera.perspective.off(this._onCameraFOV),this.viewer.camera.off(this._onCameraProjection),this._navCubeCanvas.removeEventListener("mouseenter",this._onMouseEnter),this._navCubeCanvas.removeEventListener("mouseleave",this._onMouseLeave),this._navCubeCanvas.removeEventListener("mousedown",this._onMouseDown),document.removeEventListener("mousemove",this._onMouseMove),document.removeEventListener("mouseup",this._onMouseUp),this._navCubeCanvas=null,this._cubeTextureCanvas.destroy(),this._cubeTextureCanvas=null,this._onMouseEnter=null,this._onMouseLeave=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null),this._navCubeScene.destroy(),this._navCubeScene=null,this._cubeMesh=null,this._shadow=null,super.destroy()}}new Float64Array([0,0,1]),new Float64Array(4);M.AABB3(),M.vec3();var hn=r(697),un=r.n(hn);function cn(t){return cn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},cn(t)}function dn(){dn=function(){return t};var t={},e=Object.prototype,i=e.hasOwnProperty,s=Object.defineProperty||function(t,e,i){t[e]=i.value},r="function"==typeof Symbol?Symbol:{},o=r.iterator||"@@iterator",a=r.asyncIterator||"@@asyncIterator",n=r.toStringTag||"@@toStringTag";function l(t,e,i){return Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{l({},"")}catch(S){l=function(t,e,i){return t[e]=i}}function h(t,e,i,r){var o=e&&e.prototype instanceof d?e:d,a=Object.create(o.prototype),n=new E(r||[]);return s(a,"_invoke",{value:y(t,i,n)}),a}function u(t,e,i){try{return{type:"normal",arg:t.call(e,i)}}catch(S){return{type:"throw",arg:S}}}t.wrap=h;var c={};function d(){}function p(){}function f(){}var _={};l(_,o,(function(){return this}));var g=Object.getPrototypeOf,m=g&&g(g(C([])));m&&m!==e&&i.call(m,o)&&(_=m);var v=f.prototype=d.prototype=Object.create(_);function P(t){["next","throw","return"].forEach((function(e){l(t,e,(function(t){return this._invoke(e,t)}))}))}function b(t,e){function r(s,o,a,n){var l=u(t[s],t,o);if("throw"!==l.type){var h=l.arg,c=h.value;return c&&"object"==cn(c)&&i.call(c,"__await")?e.resolve(c.__await).then((function(t){r("next",t,a,n)}),(function(t){r("throw",t,a,n)})):e.resolve(c).then((function(t){h.value=t,a(h)}),(function(t){return r("throw",t,a,n)}))}n(l.arg)}var o;s(this,"_invoke",{value:function(t,i){function s(){return new e((function(e,s){r(t,i,e,s)}))}return o=o?o.then(s,s):s()}})}function y(t,e,i){var s="suspendedStart";return function(r,o){if("executing"===s)throw new Error("Generator is already running");if("completed"===s){if("throw"===r)throw o;return A()}for(i.method=r,i.arg=o;;){var a=i.delegate;if(a){var n=x(a,i);if(n){if(n===c)continue;return n}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===s)throw s="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);s="executing";var l=u(t,e,i);if("normal"===l.type){if(s=i.done?"completed":"suspendedYield",l.arg===c)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(s="completed",i.method="throw",i.arg=l.arg)}}}function x(t,e){var i=e.method,s=t.iterator[i];if(undefined===s)return e.delegate=null,"throw"===i&&t.iterator["return"]&&(e.method="return",e.arg=undefined,x(t,e),"throw"===e.method)||"return"!==i&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+i+"' method")),c;var r=u(s,t.iterator,e.arg);if("throw"===r.type)return e.method="throw",e.arg=r.arg,e.delegate=null,c;var o=r.arg;return o?o.done?(e[t.resultName]=o.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=undefined),e.delegate=null,c):o:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,c)}function M(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function w(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function E(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(M,this),this.reset(!0)}function C(t){if(t){var e=t[o];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var s=-1,r=function e(){for(;++s<t.length;)if(i.call(t,s))return e.value=t[s],e.done=!1,e;return e.value=undefined,e.done=!0,e};return r.next=r}}return{next:A}}function A(){return{value:undefined,done:!0}}return p.prototype=f,s(v,"constructor",{value:f,configurable:!0}),s(f,"constructor",{value:p,configurable:!0}),p.displayName=l(f,n,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===p||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,f):(t.__proto__=f,l(t,n,"GeneratorFunction")),t.prototype=Object.create(v),t},t.awrap=function(t){return{__await:t}},P(b.prototype),l(b.prototype,a,(function(){return this})),t.AsyncIterator=b,t.async=function(e,i,s,r,o){void 0===o&&(o=Promise);var a=new b(h(e,i,s,r),o);return t.isGeneratorFunction(i)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},P(v),l(v,n,"Generator"),l(v,o,(function(){return this})),l(v,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var e=Object(t),i=[];for(var s in e)i.push(s);return i.reverse(),function r(){for(;i.length;){var t=i.pop();if(t in e)return r.value=t,r.done=!1,r}return r.done=!0,r}},t.values=C,E.prototype={constructor:E,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(w),!t)for(var e in this)"t"===e.charAt(0)&&i.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=undefined)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function s(i,s){return a.type="throw",a.arg=t,e.next=i,s&&(e.method="next",e.arg=undefined),!!s}for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r],a=o.completion;if("root"===o.tryLoc)return s("end");if(o.tryLoc<=this.prev){var n=i.call(o,"catchLoc"),l=i.call(o,"finallyLoc");if(n&&l){if(this.prev<o.catchLoc)return s(o.catchLoc,!0);if(this.prev<o.finallyLoc)return s(o.finallyLoc)}else if(n){if(this.prev<o.catchLoc)return s(o.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return s(o.finallyLoc)}}}},abrupt:function(t,e){for(var s=this.tryEntries.length-1;s>=0;--s){var r=this.tryEntries[s];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=t,a.arg=e,o?(this.method="next",this.next=o.finallyLoc,c):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),c},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e];if(i.finallyLoc===t)return this.complete(i.completion,i.afterLoc),w(i),c}},"catch":function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e];if(i.tryLoc===t){var s=i.completion;if("throw"===s.type){var r=s.arg;w(i)}return r}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,i){return this.delegate={iterator:C(t),resultName:e,nextLoc:i},"next"===this.method&&(this.arg=undefined),c}},t}function pn(t,e,i,s,r,o,a){try{var n=t[o](a),l=n.value}catch(h){return void i(h)}n.done?e(l):Promise.resolve(l).then(s,r)}function fn(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,(r=s.key,o=void 0,o=function(t,e){if("object"!==cn(t)||null===t)return t;var i=t[Symbol.toPrimitive];if(i!==undefined){var s=i.call(t,e||"default");if("object"!==cn(s))return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(r,"string"),"symbol"===cn(o)?o:String(o)),s)}var r,o}function _n(t,e){return _n=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},_n(t,e)}function gn(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var i,s=mn(t);if(e){var r=mn(this).constructor;i=Reflect.construct(s,arguments,r)}else i=s.apply(this,arguments);return function(t,e){if(e&&("object"===cn(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(this,i)}}function mn(t){return mn=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},mn(t)}var vn=function(e){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&_n(t,e)}(a,e);var i,s,r,o=gn(a);function a(t){var e;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,a),(e=o.call(this,t)).state={},e}return i=a,s=[{key:"componentDidMount",value:function(){var t,e=this,i=this.setViewer();t=new on(i),new ln(i,{canvasId:"myNavCubeCanvas",visible:!0}),this.props.models.forEach((function(e){var s={id:e,src:e,edges:!0,performance:!0};try{var r=t.load(s);r.on("loaded",(function(){i.cameraFlight.jumpTo(r)}))}catch(o){console.log("error",o)}})),i.scene.camera.projection=this.props.projection||"ortho";var s=null;i.scene.input.on("mousemove",(function(t){var r=i.scene.pick({canvasPos:t});r?s&&r.entity.id===s.id||(s&&(s.opacity=e.state.lastOpacity),s=r.entity,e.setState({lastOpacity:r.entity.opacity}),r.entity.opacity=.6):s&&(s.opacity=e.state.lastOpacity)})),i.cameraControl.on("picked",function(){var t,i=(t=dn().mark((function s(t){var i;return dn().wrap((function(s){for(;;)switch(s.prev=s.next){case 0:if(t.entity)try{t.entity.highlighted=1,i=e.state.viewer.scene.objects,Object.keys(i).forEach((function(e){i[e].id!==t.entity.id&&(i[e].highlighted=!1)})),e.props.onSelect([t.entity.id])}catch(r){e.setState({selection:[]})}case 1:case"end":return s.stop()}}),s)})),function(){var e=this,i=arguments;return new Promise((function(s,r){var o=t.apply(e,i);function a(t){pn(o,s,r,a,n,"next",t)}function n(t){pn(o,s,r,a,n,"throw",t)}a(undefined)}))});return function(t){return i.apply(this,arguments)}}()),i.cameraControl.on("pickedNothing",(function(){var t=e.state.viewer.scene.objects;Object.keys(t).forEach((function(e){t[e].highlighted=!1})),e.setState({selection:[]}),e.props.onSelect([])})),this.setState({viewer:i})}},{key:"getGuid",value:function(t){var e=[["0",10],["A",26],["a",26],["_",1],["$",1]].map((function(t){for(var e=[],i=t[0].charCodeAt(0),s=i+t[1],r=i;r<s;++r)e.push(r);return String.fromCharCode.apply(null,e)})).join(""),i=function(t,i){return(i&&4!=i?[0,6]:[0,6,12,18]).map((function(i){return e.substr(parseInt(t/(1<<i))%64,1)})).reverse().join("")},s=t.split("-"),r="";return s.forEach((function(t,e){0<e&&e<s.length-2?r+=t+"-":e===s.length-2&&(r+=t)})),function(t){t=t.replace(/-/g,"");var e=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30].map((function(e){return parseInt(t.substr(e,2),16)}));return i(e[0],2)+[1,4,7,10,13].map((function(t){return i((e[t]<<16)+(e[t+1]<<8)+e[t+2])})).join("")}(r)}},{key:"componentDidUpdate",value:function(){var t=this.state.viewer.scene.objects,e=this.props.selection;e!==this.state.lastQueried&&Object.keys(t).forEach((function(i){e.includes(t[i].id)?t[i].highlighted=!0:t[i].highlighted=!1}))}},{key:"setViewer",value:function(){return new Je({canvasId:"myCanvas",transparent:!0})}},{key:"render",value:function(){return t["default"].createElement("div",{className:"modelContainer",style:{position:"relative"}},t["default"].createElement("canvas",{id:"myCanvas",style:{width:"100%",height:this.props.height}}),t["default"].createElement("canvas",{style:{height:"200px",width:"200px",position:"absolute",right:0,bottom:150},className:"navCube",id:"myNavCubeCanvas"}),t["default"].createElement("canvas",{id:"mySectionPlanesOverviewCanvas",className:"sections"}))}}],s&&fn(i.prototype,s),r&&fn(i,r),Object.defineProperty(i,"prototype",{writable:!1}),a}(t.Component);function Pn(t,e){if(null==t)return{};var i,s,r={},o=Object.keys(t);for(s=0;s<o.length;s++)i=o[s],e.indexOf(i)>=0||(r[i]=t[i]);return r}function bn(){return bn=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(t[s]=i[s])}return t},bn.apply(this,arguments)}function yn(t){var e,i,s="";if("string"==typeof t||"number"==typeof t)s+=t;else if("object"==typeof t)if(Array.isArray(t))for(e=0;e<t.length;e++)t[e]&&(i=yn(t[e]))&&(s&&(s+=" "),s+=i);else for(e in t)t[e]&&(s&&(s+=" "),s+=e);return s}vn.propTypes={projection:un().oneOf(["ortho","perspective"]),height:un().number.isRequired,models:un().array.isRequired,metaModel:un().string,ifcGuidHandler:un().func},vn.defaultProps={projection:"ortho",ifcGuidHandler:function(t){console.log(t)},onSelect:function(t){console.log("guid",t.guid)}};const xn=function(){for(var t,e,i=0,s="";i<arguments.length;)(t=arguments[i++])&&(e=yn(t))&&(s&&(s+=" "),s+=e);return s};function Mn(t,e){const i=bn({},e);return Object.keys(t).forEach((s=>{if(s.toString().match(/^(components|slots)$/))i[s]=bn({},t[s],i[s]);else if(s.toString().match(/^(componentsProps|slotProps)$/)){const r=t[s]||{},o=e[s];i[s]={},o&&Object.keys(o)?r&&Object.keys(r)?(i[s]=bn({},o),Object.keys(r).forEach((t=>{i[s][t]=Mn(r[t],o[t])}))):i[s]=o:i[s]=r}else i[s]===undefined&&(i[s]=t[s])})),i}function wn(t,e,i){const s={};return Object.keys(t).forEach((r=>{s[r]=t[r].reduce(((t,s)=>(s&&(t.push(e(s)),i&&i[s]&&t.push(i[s])),t)),[]).join(" ")})),s}function En(t){let e="https://mui.com/production-error/?code="+t;for(let t=1;t<arguments.length;t+=1)e+="&args[]="+encodeURIComponent(arguments[t]);return"Minified MUI error #"+t+"; visit "+e+" for the full message."}function Cn(t,e=0,i=1){return Math.min(Math.max(e,t),i)}function An(t){if(t.type)return t;if("#"===t.charAt(0))return An(function(t){t=t.slice(1);const e=new RegExp(`.{1,${t.length>=6?2:1}}`,"g");let i=t.match(e);return i&&1===i[0].length&&(i=i.map((t=>t+t))),i?`rgb${4===i.length?"a":""}(${i.map(((t,e)=>e<3?parseInt(t,16):Math.round(parseInt(t,16)/255*1e3)/1e3)).join(", ")})`:""}(t));const e=t.indexOf("("),i=t.substring(0,e);if(-1===["rgb","rgba","hsl","hsla","color"].indexOf(i))throw new Error(En(9,t));let s,r=t.substring(e+1,t.length-1);if("color"===i){if(r=r.split(" "),s=r.shift(),4===r.length&&"/"===r[3].charAt(0)&&(r[3]=r[3].slice(1)),-1===["srgb","display-p3","a98-rgb","prophoto-rgb","rec-2020"].indexOf(s))throw new Error(En(10,s))}else r=r.split(",");return r=r.map((t=>parseFloat(t))),{type:i,values:r,colorSpace:s}}function Sn(t){const{type:e,colorSpace:i}=t;let{values:s}=t;return-1!==e.indexOf("rgb")?s=s.map(((t,e)=>e<3?parseInt(t,10):t)):-1!==e.indexOf("hsl")&&(s[1]=`${s[1]}%`,s[2]=`${s[2]}%`),s=-1!==e.indexOf("color")?`${i} ${s.join(" ")}`:`${s.join(", ")}`,`${e}(${s})`}function Dn(t){let e="hsl"===(t=An(t)).type||"hsla"===t.type?An(function(t){t=An(t);const{values:e}=t,i=e[0],s=e[1]/100,r=e[2]/100,o=s*Math.min(r,1-r),a=(t,e=(t+i/30)%12)=>r-o*Math.max(Math.min(e-3,9-e,1),-1);let n="rgb";const l=[Math.round(255*a(0)),Math.round(255*a(8)),Math.round(255*a(4))];return"hsla"===t.type&&(n+="a",l.push(e[3])),Sn({type:n,values:l})}(t)).values:t.values;return e=e.map((e=>("color"!==t.type&&(e/=255),e<=.03928?e/12.92:((e+.055)/1.055)**2.4))),Number((.2126*e[0]+.7152*e[1]+.0722*e[2]).toFixed(3))}function Ln(t,e){return t=An(t),e=Cn(e),"rgb"!==t.type&&"hsl"!==t.type||(t.type+="a"),"color"===t.type?t.values[3]=`/${e}`:t.values[3]=e,Sn(t)}function Rn(t,e){if(t=An(t),e=Cn(e),-1!==t.type.indexOf("hsl"))t.values[2]*=1-e;else if(-1!==t.type.indexOf("rgb")||-1!==t.type.indexOf("color"))for(let i=0;i<3;i+=1)t.values[i]*=1-e;return Sn(t)}function Bn(t,e){if(t=An(t),e=Cn(e),-1!==t.type.indexOf("hsl"))t.values[2]+=(100-t.values[2])*e;else if(-1!==t.type.indexOf("rgb"))for(let i=0;i<3;i+=1)t.values[i]+=(255-t.values[i])*e;else if(-1!==t.type.indexOf("color"))for(let i=0;i<3;i+=1)t.values[i]+=(1-t.values[i])*e;return Sn(t)}const Tn=function(t){var e=Object.create(null);return function(i){return e[i]===undefined&&(e[i]=t(i)),e[i]}};var Fn=/^((children|dangerouslySetInnerHTML|key|ref|autoFocus|defaultValue|defaultChecked|innerHTML|suppressContentEditableWarning|suppressHydrationWarning|valueLink|abbr|accept|acceptCharset|accessKey|action|allow|allowUserMedia|allowPaymentRequest|allowFullScreen|allowTransparency|alt|async|autoComplete|autoPlay|capture|cellPadding|cellSpacing|challenge|charSet|checked|cite|classID|className|cols|colSpan|content|contentEditable|contextMenu|controls|controlsList|coords|crossOrigin|data|dateTime|decoding|default|defer|dir|disabled|disablePictureInPicture|download|draggable|encType|enterKeyHint|form|formAction|formEncType|formMethod|formNoValidate|formTarget|frameBorder|headers|height|hidden|high|href|hrefLang|htmlFor|httpEquiv|id|inputMode|integrity|is|keyParams|keyType|kind|label|lang|list|loading|loop|low|marginHeight|marginWidth|max|maxLength|media|mediaGroup|method|min|minLength|multiple|muted|name|nonce|noValidate|open|optimum|pattern|placeholder|playsInline|poster|preload|profile|radioGroup|readOnly|referrerPolicy|rel|required|reversed|role|rows|rowSpan|sandbox|scope|scoped|scrolling|seamless|selected|shape|size|sizes|slot|span|spellCheck|src|srcDoc|srcLang|srcSet|start|step|style|summary|tabIndex|target|title|translate|type|useMap|value|width|wmode|wrap|about|datatype|inlist|prefix|property|resource|typeof|vocab|autoCapitalize|autoCorrect|autoSave|color|incremental|fallback|inert|itemProp|itemScope|itemType|itemID|itemRef|on|option|results|security|unselectable|accentHeight|accumulate|additive|alignmentBaseline|allowReorder|alphabetic|amplitude|arabicForm|ascent|attributeName|attributeType|autoReverse|azimuth|baseFrequency|baselineShift|baseProfile|bbox|begin|bias|by|calcMode|capHeight|clip|clipPathUnits|clipPath|clipRule|colorInterpolation|colorInterpolationFilters|colorProfile|colorRendering|contentScriptType|contentStyleType|cursor|cx|cy|d|decelerate|descent|diffuseConstant|direction|display|divisor|dominantBaseline|dur|dx|dy|edgeMode|elevation|enableBackground|end|exponent|externalResourcesRequired|fill|fillOpacity|fillRule|filter|filterRes|filterUnits|floodColor|floodOpacity|focusable|fontFamily|fontSize|fontSizeAdjust|fontStretch|fontStyle|fontVariant|fontWeight|format|from|fr|fx|fy|g1|g2|glyphName|glyphOrientationHorizontal|glyphOrientationVertical|glyphRef|gradientTransform|gradientUnits|hanging|horizAdvX|horizOriginX|ideographic|imageRendering|in|in2|intercept|k|k1|k2|k3|k4|kernelMatrix|kernelUnitLength|kerning|keyPoints|keySplines|keyTimes|lengthAdjust|letterSpacing|lightingColor|limitingConeAngle|local|markerEnd|markerMid|markerStart|markerHeight|markerUnits|markerWidth|mask|maskContentUnits|maskUnits|mathematical|mode|numOctaves|offset|opacity|operator|order|orient|orientation|origin|overflow|overlinePosition|overlineThickness|panose1|paintOrder|pathLength|patternContentUnits|patternTransform|patternUnits|pointerEvents|points|pointsAtX|pointsAtY|pointsAtZ|preserveAlpha|preserveAspectRatio|primitiveUnits|r|radius|refX|refY|renderingIntent|repeatCount|repeatDur|requiredExtensions|requiredFeatures|restart|result|rotate|rx|ry|scale|seed|shapeRendering|slope|spacing|specularConstant|specularExponent|speed|spreadMethod|startOffset|stdDeviation|stemh|stemv|stitchTiles|stopColor|stopOpacity|strikethroughPosition|strikethroughThickness|string|stroke|strokeDasharray|strokeDashoffset|strokeLinecap|strokeLinejoin|strokeMiterlimit|strokeOpacity|strokeWidth|surfaceScale|systemLanguage|tableValues|targetX|targetY|textAnchor|textDecoration|textRendering|textLength|to|transform|u1|u2|underlinePosition|underlineThickness|unicode|unicodeBidi|unicodeRange|unitsPerEm|vAlphabetic|vHanging|vIdeographic|vMathematical|values|vectorEffect|version|vertAdvY|vertOriginX|vertOriginY|viewBox|viewTarget|visibility|widths|wordSpacing|writingMode|x|xHeight|x1|x2|xChannelSelector|xlinkActuate|xlinkArcrole|xlinkHref|xlinkRole|xlinkShow|xlinkTitle|xlinkType|xmlBase|xmlns|xmlnsXlink|xmlLang|xmlSpace|y|y1|y2|yChannelSelector|z|zoomAndPan|for|class|autofocus)|(([Dd][Aa][Tt][Aa]|[Aa][Rr][Ii][Aa]|x)-.*))$/;const Nn=Tn((function(t){return Fn.test(t)||111===t.charCodeAt(0)&&110===t.charCodeAt(1)&&t.charCodeAt(2)<91}));var On=function(){function t(t){var e=this;this._insertTag=function(t){var i;i=0===e.tags.length?e.insertionPoint?e.insertionPoint.nextSibling:e.prepend?e.container.firstChild:e.before:e.tags[e.tags.length-1].nextSibling,e.container.insertBefore(t,i),e.tags.push(t)},this.isSpeedy=t.speedy===undefined||t.speedy,this.tags=[],this.ctr=0,this.nonce=t.nonce,this.key=t.key,this.container=t.container,this.prepend=t.prepend,this.insertionPoint=t.insertionPoint,this.before=null}var e=t.prototype;return e.hydrate=function(t){t.forEach(this._insertTag)},e.insert=function(t){this.ctr%(this.isSpeedy?65e3:1)==0&&this._insertTag(function(t){var e=document.createElement("style");return e.setAttribute("data-emotion",t.key),t.nonce!==undefined&&e.setAttribute("nonce",t.nonce),e.appendChild(document.createTextNode("")),e.setAttribute("data-s",""),e}(this));var e=this.tags[this.tags.length-1];if(this.isSpeedy){var i=function(t){if(t.sheet)return t.sheet;for(var e=0;e<document.styleSheets.length;e++)if(document.styleSheets[e].ownerNode===t)return document.styleSheets[e]}(e);try{i.insertRule(t,i.cssRules.length)}catch(s){0}}else e.appendChild(document.createTextNode(t));this.ctr++},e.flush=function(){this.tags.forEach((function(t){return t.parentNode&&t.parentNode.removeChild(t)})),this.tags=[],this.ctr=0},t}(),kn=Math.abs,In=String.fromCharCode,zn=Object.assign;function Vn(t){return t.trim()}function Un(t,e,i){return t.replace(e,i)}function Gn(t,e){return t.indexOf(e)}function Xn(t,e){return 0|t.charCodeAt(e)}function jn(t,e,i){return t.slice(e,i)}function Wn(t){return t.length}function Hn(t){return t.length}function Yn(t,e){return e.push(t),t}var Kn=1,$n=1,qn=0,Zn=0,Qn=0,Jn="";function tl(t,e,i,s,r,o,a){return{value:t,root:e,parent:i,type:s,props:r,children:o,line:Kn,column:$n,length:a,"return":""}}function el(t,e){return zn(tl("",null,null,"",null,null,0),t,{length:-t.length},e)}function il(){return Qn=Zn>0?Xn(Jn,--Zn):0,$n--,10===Qn&&($n=1,Kn--),Qn}function sl(){return Qn=Zn<qn?Xn(Jn,Zn++):0,$n++,10===Qn&&($n=1,Kn++),Qn}function rl(){return Xn(Jn,Zn)}function ol(){return Zn}function al(t,e){return jn(Jn,t,e)}function nl(t){switch(t){case 0:case 9:case 10:case 13:case 32:return 5;case 33:case 43:case 44:case 47:case 62:case 64:case 126:case 59:case 123:case 125:return 4;case 58:return 3;case 34:case 39:case 40:case 91:return 2;case 41:case 93:return 1}return 0}function ll(t){return Kn=$n=1,qn=Wn(Jn=t),Zn=0,[]}function hl(t){return Jn="",t}function ul(t){return Vn(al(Zn-1,pl(91===t?t+2:40===t?t+1:t)))}function cl(t){for(;(Qn=rl())&&Qn<33;)sl();return nl(t)>2||nl(Qn)>3?"":" "}function dl(t,e){for(;--e&&sl()&&!(Qn<48||Qn>102||Qn>57&&Qn<65||Qn>70&&Qn<97););return al(t,ol()+(e<6&&32==rl()&&32==sl()))}function pl(t){for(;sl();)switch(Qn){case t:return Zn;case 34:case 39:34!==t&&39!==t&&pl(Qn);break;case 40:41===t&&pl(t);break;case 92:sl()}return Zn}function fl(t,e){for(;sl()&&t+Qn!==57&&(t+Qn!==84||47!==rl()););return"/*"+al(e,Zn-1)+"*"+In(47===t?t:sl())}function _l(t){for(;!nl(rl());)sl();return al(t,Zn)}var gl="-ms-",ml="-moz-",vl="-webkit-",Pl="comm",bl="rule",yl="decl",xl="@import",Ml="@keyframes";function wl(t,e){for(var i="",s=Hn(t),r=0;r<s;r++)i+=e(t[r],r,t,e)||"";return i}function El(t,e,i,s){switch(t.type){case xl:case yl:return t["return"]=t["return"]||t.value;case Pl:return"";case Ml:return t["return"]=t.value+"{"+wl(t.children,s)+"}";case bl:t.value=t.props.join(",")}return Wn(i=wl(t.children,s))?t["return"]=t.value+"{"+i+"}":""}function Cl(t){return hl(Al("",null,null,null,[""],t=ll(t),0,[0],t))}function Al(t,e,i,s,r,o,a,n,l){for(var h=0,u=0,c=a,d=0,p=0,f=0,_=1,g=1,m=1,v=0,P="",b=r,y=o,x=s,M=P;g;)switch(f=v,v=sl()){case 40:if(108!=f&&58==Xn(M,c-1)){-1!=Gn(M+=Un(ul(v),"&","&\f"),"&\f")&&(m=-1);break}case 34:case 39:case 91:M+=ul(v);break;case 9:case 10:case 13:case 32:M+=cl(f);break;case 92:M+=dl(ol()-1,7);continue;case 47:switch(rl()){case 42:case 47:Yn(Dl(fl(sl(),ol()),e,i),l);break;default:M+="/"}break;case 123*_:n[h++]=Wn(M)*m;case 125*_:case 59:case 0:switch(v){case 0:case 125:g=0;case 59+u:p>0&&Wn(M)-c&&Yn(p>32?Ll(M+";",s,i,c-1):Ll(Un(M," ","")+";",s,i,c-2),l);break;case 59:M+=";";default:if(Yn(x=Sl(M,e,i,h,u,r,n,P,b=[],y=[],c),o),123===v)if(0===u)Al(M,e,x,x,b,o,c,n,y);else switch(99===d&&110===Xn(M,3)?100:d){case 100:case 109:case 115:Al(t,x,x,s&&Yn(Sl(t,x,x,0,0,r,n,P,r,b=[],c),y),r,y,c,n,s?b:y);break;default:Al(M,x,x,x,[""],y,0,n,y)}}h=u=p=0,_=m=1,P=M="",c=a;break;case 58:c=1+Wn(M),p=f;default:if(_<1)if(123==v)--_;else if(125==v&&0==_++&&125==il())continue;switch(M+=In(v),v*_){case 38:m=u>0?1:(M+="\f",-1);break;case 44:n[h++]=(Wn(M)-1)*m,m=1;break;case 64:45===rl()&&(M+=ul(sl())),d=rl(),u=c=Wn(P=M+=_l(ol())),v++;break;case 45:45===f&&2==Wn(M)&&(_=0)}}return o}function Sl(t,e,i,s,r,o,a,n,l,h,u){for(var c=r-1,d=0===r?o:[""],p=Hn(d),f=0,_=0,g=0;f<s;++f)for(var m=0,v=jn(t,c+1,c=kn(_=a[f])),P=t;m<p;++m)(P=Vn(_>0?d[m]+" "+v:Un(v,/&\f/g,d[m])))&&(l[g++]=P);return tl(t,e,i,0===r?bl:n,l,h,u)}function Dl(t,e,i){return tl(t,e,i,Pl,In(Qn),jn(t,2,-2),0)}function Ll(t,e,i,s){return tl(t,e,i,yl,jn(t,0,s),jn(t,s+1,-1),s)}var Rl=function(t,e,i){for(var s=0,r=0;s=r,r=rl(),38===s&&12===r&&(e[i]=1),!nl(r);)sl();return al(t,Zn)},Bl=function(t,e){return hl(function(t,e){var i=-1,s=44;do{switch(nl(s)){case 0:38===s&&12===rl()&&(e[i]=1),t[i]+=Rl(Zn-1,e,i);break;case 2:t[i]+=ul(s);break;case 4:if(44===s){t[++i]=58===rl()?"&\f":"",e[i]=t[i].length;break}default:t[i]+=In(s)}}while(s=sl());return t}(ll(t),e))},Tl=new WeakMap,Fl=function(t){if("rule"===t.type&&t.parent&&!(t.length<1)){for(var e=t.value,i=t.parent,s=t.column===i.column&&t.line===i.line;"rule"!==i.type;)if(!(i=i.parent))return;if((1!==t.props.length||58===e.charCodeAt(0)||Tl.get(i))&&!s){Tl.set(t,!0);for(var r=[],o=Bl(e,r),a=i.props,n=0,l=0;n<o.length;n++)for(var h=0;h<a.length;h++,l++)t.props[l]=r[n]?o[n].replace(/&\f/g,a[h]):a[h]+" "+o[n]}}},Nl=function(t){if("decl"===t.type){var e=t.value;108===e.charCodeAt(0)&&98===e.charCodeAt(2)&&(t["return"]="",t.value="")}};function Ol(t,e){switch(function(t,e){return 45^Xn(t,0)?(((e<<2^Xn(t,0))<<2^Xn(t,1))<<2^Xn(t,2))<<2^Xn(t,3):0}(t,e)){case 5103:return vl+"print-"+t+t;case 5737:case 4201:case 3177:case 3433:case 1641:case 4457:case 2921:case 5572:case 6356:case 5844:case 3191:case 6645:case 3005:case 6391:case 5879:case 5623:case 6135:case 4599:case 4855:case 4215:case 6389:case 5109:case 5365:case 5621:case 3829:return vl+t+t;case 5349:case 4246:case 4810:case 6968:case 2756:return vl+t+ml+t+gl+t+t;case 6828:case 4268:return vl+t+gl+t+t;case 6165:return vl+t+gl+"flex-"+t+t;case 5187:return vl+t+Un(t,/(\w+).+(:[^]+)/,vl+"box-$1$2"+gl+"flex-$1$2")+t;case 5443:return vl+t+gl+"flex-item-"+Un(t,/flex-|-self/,"")+t;case 4675:return vl+t+gl+"flex-line-pack"+Un(t,/align-content|flex-|-self/,"")+t;case 5548:return vl+t+gl+Un(t,"shrink","negative")+t;case 5292:return vl+t+gl+Un(t,"basis","preferred-size")+t;case 6060:return vl+"box-"+Un(t,"-grow","")+vl+t+gl+Un(t,"grow","positive")+t;case 4554:return vl+Un(t,/([^-])(transform)/g,"$1"+vl+"$2")+t;case 6187:return Un(Un(Un(t,/(zoom-|grab)/,vl+"$1"),/(image-set)/,vl+"$1"),t,"")+t;case 5495:case 3959:return Un(t,/(image-set\([^]*)/,vl+"$1$`$1");case 4968:return Un(Un(t,/(.+:)(flex-)?(.*)/,vl+"box-pack:$3"+gl+"flex-pack:$3"),/s.+-b[^;]+/,"justify")+vl+t+t;case 4095:case 3583:case 4068:case 2532:return Un(t,/(.+)-inline(.+)/,vl+"$1$2")+t;case 8116:case 7059:case 5753:case 5535:case 5445:case 5701:case 4933:case 4677:case 5533:case 5789:case 5021:case 4765:if(Wn(t)-1-e>6)switch(Xn(t,e+1)){case 109:if(45!==Xn(t,e+4))break;case 102:return Un(t,/(.+:)(.+)-([^]+)/,"$1"+vl+"$2-$3$1"+ml+(108==Xn(t,e+3)?"$3":"$2-$3"))+t;case 115:return~Gn(t,"stretch")?Ol(Un(t,"stretch","fill-available"),e)+t:t}break;case 4949:if(115!==Xn(t,e+1))break;case 6444:switch(Xn(t,Wn(t)-3-(~Gn(t,"!important")&&10))){case 107:return Un(t,":",":"+vl)+t;case 101:return Un(t,/(.+:)([^;!]+)(;|!.+)?/,"$1"+vl+(45===Xn(t,14)?"inline-":"")+"box$3$1"+vl+"$2$3$1"+gl+"$2box$3")+t}break;case 5936:switch(Xn(t,e+11)){case 114:return vl+t+gl+Un(t,/[svh]\w+-[tblr]{2}/,"tb")+t;case 108:return vl+t+gl+Un(t,/[svh]\w+-[tblr]{2}/,"tb-rl")+t;case 45:return vl+t+gl+Un(t,/[svh]\w+-[tblr]{2}/,"lr")+t}return vl+t+gl+t+t}return t}var kl=[function(t,e,i,s){if(t.length>-1&&!t["return"])switch(t.type){case yl:t["return"]=Ol(t.value,t.length);break;case Ml:return wl([el(t,{value:Un(t.value,"@","@"+vl)})],s);case bl:if(t.length)return function(t,e){return t.map(e).join("")}(t.props,(function(e){switch(function(t,e){return(t=e.exec(t))?t[0]:t}(e,/(::plac\w+|:read-\w+)/)){case":read-only":case":read-write":return wl([el(t,{props:[Un(e,/:(read-\w+)/,":"+ml+"$1")]})],s);case"::placeholder":return wl([el(t,{props:[Un(e,/:(plac\w+)/,":"+vl+"input-$1")]}),el(t,{props:[Un(e,/:(plac\w+)/,":"+ml+"$1")]}),el(t,{props:[Un(e,/:(plac\w+)/,gl+"input-$1")]})],s)}return""}))}}];const Il=function(t){var e=t.key;if("css"===e){var i=document.querySelectorAll("style[data-emotion]:not([data-s])");Array.prototype.forEach.call(i,(function(t){-1!==t.getAttribute("data-emotion").indexOf(" ")&&(document.head.appendChild(t),t.setAttribute("data-s",""))}))}var s=t.stylisPlugins||kl;var r,o,a={},n=[];r=t.container||document.head,Array.prototype.forEach.call(document.querySelectorAll('style[data-emotion^="'+e+' "]'),(function(t){for(var e=t.getAttribute("data-emotion").split(" "),i=1;i<e.length;i++)a[e[i]]=!0;n.push(t)}));var l,h,u,c,d=[El,(c=function(t){l.insert(t)},function(t){t.root||(t=t["return"])&&c(t)})],p=(h=[Fl,Nl].concat(s,d),u=Hn(h),function(t,e,i,s){for(var r="",o=0;o<u;o++)r+=h[o](t,e,i,s)||"";return r});o=function(t,e,i,s){l=i,wl(Cl(t?t+"{"+e.styles+"}":e.styles),p),s&&(f.inserted[e.name]=!0)};var f={key:e,sheet:new On({key:e,container:r,nonce:t.nonce,speedy:t.speedy,prepend:t.prepend,insertionPoint:t.insertionPoint}),nonce:t.nonce,inserted:a,registered:{},insert:o};return f.sheet.hydrate(n),f};const zl=function(t){for(var e,i=0,s=0,r=t.length;r>=4;++s,r-=4)e=1540483477*(65535&(e=255&t.charCodeAt(s)|(255&t.charCodeAt(++s))<<8|(255&t.charCodeAt(++s))<<16|(255&t.charCodeAt(++s))<<24))+(59797*(e>>>16)<<16),i=1540483477*(65535&(e^=e>>>24))+(59797*(e>>>16)<<16)^1540483477*(65535&i)+(59797*(i>>>16)<<16);switch(r){case 3:i^=(255&t.charCodeAt(s+2))<<16;case 2:i^=(255&t.charCodeAt(s+1))<<8;case 1:i=1540483477*(65535&(i^=255&t.charCodeAt(s)))+(59797*(i>>>16)<<16)}return(((i=1540483477*(65535&(i^=i>>>13))+(59797*(i>>>16)<<16))^i>>>15)>>>0).toString(36)};const Vl={animationIterationCount:1,borderImageOutset:1,borderImageSlice:1,borderImageWidth:1,boxFlex:1,boxFlexGroup:1,boxOrdinalGroup:1,columnCount:1,columns:1,flex:1,flexGrow:1,flexPositive:1,flexShrink:1,flexNegative:1,flexOrder:1,gridRow:1,gridRowEnd:1,gridRowSpan:1,gridRowStart:1,gridColumn:1,gridColumnEnd:1,gridColumnSpan:1,gridColumnStart:1,msGridRow:1,msGridRowSpan:1,msGridColumn:1,msGridColumnSpan:1,fontWeight:1,lineHeight:1,opacity:1,order:1,orphans:1,tabSize:1,widows:1,zIndex:1,zoom:1,WebkitLineClamp:1,fillOpacity:1,floodOpacity:1,stopOpacity:1,strokeDasharray:1,strokeDashoffset:1,strokeMiterlimit:1,strokeOpacity:1,strokeWidth:1};var Ul=/[A-Z]|^ms/g,Gl=/_EMO_([^_]+?)_([^]*?)_EMO_/g,Xl=function(t){return 45===t.charCodeAt(1)},jl=function(t){return null!=t&&"boolean"!=typeof t},Wl=Tn((function(t){return Xl(t)?t:t.replace(Ul,"-$&").toLowerCase()})),Hl=function(t,e){switch(t){case"animation":case"animationName":if("string"==typeof e)return e.replace(Gl,(function(t,e,i){return Kl={name:e,styles:i,next:Kl},e}))}return 1===Vl[t]||Xl(t)||"number"!=typeof e||0===e?e:e+"px"};function Yl(t,e,i){if(null==i)return"";if(i.__emotion_styles!==undefined)return i;switch(typeof i){case"boolean":return"";case"object":if(1===i.anim)return Kl={name:i.name,styles:i.styles,next:Kl},i.name;if(i.styles!==undefined){var s=i.next;if(s!==undefined)for(;s!==undefined;)Kl={name:s.name,styles:s.styles,next:Kl},s=s.next;return i.styles+";"}return function(t,e,i){var s="";if(Array.isArray(i))for(var r=0;r<i.length;r++)s+=Yl(t,e,i[r])+";";else for(var o in i){var a=i[o];if("object"!=typeof a)null!=e&&e[a]!==undefined?s+=o+"{"+e[a]+"}":jl(a)&&(s+=Wl(o)+":"+Hl(o,a)+";");else if(!Array.isArray(a)||"string"!=typeof a[0]||null!=e&&e[a[0]]!==undefined){var n=Yl(t,e,a);switch(o){case"animation":case"animationName":s+=Wl(o)+":"+n+";";break;default:s+=o+"{"+n+"}"}}else for(var l=0;l<a.length;l++)jl(a[l])&&(s+=Wl(o)+":"+Hl(o,a[l])+";")}return s}(t,e,i);case"function":if(t!==undefined){var r=Kl,o=i(t);return Kl=r,Yl(t,e,o)}}if(null==e)return i;var a=e[i];return a!==undefined?a:i}var Kl,$l=/label:\s*([^\s;\n{]+)\s*(;|$)/g;var ql=function(t,e,i){if(1===t.length&&"object"==typeof t[0]&&null!==t[0]&&t[0].styles!==undefined)return t[0];var s=!0,r="";Kl=undefined;var o=t[0];null==o||o.raw===undefined?(s=!1,r+=Yl(i,e,o)):r+=o[0];for(var a=1;a<t.length;a++)r+=Yl(i,e,t[a]),s&&(r+=o[a]);$l.lastIndex=0;for(var n,l="";null!==(n=$l.exec(r));)l+="-"+n[1];return{name:zl(r)+l,styles:r,next:Kl}},Zl=!!t.useInsertionEffect&&t.useInsertionEffect,Ql=Zl||function(t){return t()},Jl=(Zl||t.useLayoutEffect,(0,t.createContext)("undefined"!=typeof HTMLElement?Il({key:"css"}):null));Jl.Provider;var th=function(e){return(0,t.forwardRef)((function(i,s){var r=(0,t.useContext)(Jl);return e(i,r,s)}))},eh=(0,t.createContext)({});var ih=function(t,e,i){var s=t.key+"-"+e.name;!1===i&&t.registered[s]===undefined&&(t.registered[s]=e.styles)},sh=Nn,rh=function(t){return"theme"!==t},oh=function(t){return"string"==typeof t&&t.charCodeAt(0)>96?sh:rh},ah=function(t,e,i){var s;if(e){var r=e.shouldForwardProp;s=t.__emotion_forwardProp&&r?function(e){return t.__emotion_forwardProp(e)&&r(e)}:r}return"function"!=typeof s&&i&&(s=t.__emotion_forwardProp),s},nh=function(t){var e=t.cache,i=t.serialized,s=t.isStringTag;ih(e,i,s);Ql((function(){return function(t,e,i){ih(t,e,i);var s=t.key+"-"+e.name;if(t.inserted[e.name]===undefined){var r=e;do{t.insert(e===r?"."+s:"",r,t.sheet,!0),r=r.next}while(r!==undefined)}}(e,i,s)}));return null};const lh=function Lp(e,i){var s,r,o=e.__emotion_real===e,a=o&&e.__emotion_base||e;i!==undefined&&(s=i.label,r=i.target);var n=ah(e,i,o),l=n||oh(a),h=!l("as");return function(){var u=arguments,c=o&&e.__emotion_styles!==undefined?e.__emotion_styles.slice(0):[];if(s!==undefined&&c.push("label:"+s+";"),null==u[0]||u[0].raw===undefined)c.push.apply(c,u);else{0,c.push(u[0][0]);for(var d=u.length,p=1;p<d;p++)c.push(u[p],u[0][p])}var f=th((function(e,i,s){var o,u,d,p,f=h&&e.as||a,_="",g=[],m=e;if(null==e.theme){for(var v in m={},e)m[v]=e[v];m.theme=(0,t.useContext)(eh)}"string"==typeof e.className?(o=i.registered,u=g,d=e.className,p="",d.split(" ").forEach((function(t){o[t]!==undefined?u.push(o[t]+";"):p+=t+" "})),_=p):null!=e.className&&(_=e.className+" ");var P=ql(c.concat(g),i.registered,m);_+=i.key+"-"+P.name,r!==undefined&&(_+=" "+r);var b=h&&n===undefined?oh(f):l,y={};for(var x in e)h&&"as"===x||b(x)&&(y[x]=e[x]);return y.className=_,y.ref=s,(0,t.createElement)(t.Fragment,null,(0,t.createElement)(nh,{cache:i,serialized:P,isStringTag:"string"==typeof f}),(0,t.createElement)(f,y))}));return f.displayName=s!==undefined?s:"Styled("+("string"==typeof a?a:a.displayName||a.name||"Component")+")",f.defaultProps=e.defaultProps,f.__emotion_real=f,f.__emotion_base=a,f.__emotion_styles=c,f.__emotion_forwardProp=n,Object.defineProperty(f,"toString",{value:function(){return undefined,"."+r}}),f.withComponent=function(t,e){return Lp(t,bn({},i,e,{shouldForwardProp:ah(f,e,!0)})).apply(void 0,c)},f}};var hh=lh.bind();["a","abbr","address","area","article","aside","audio","b","base","bdi","bdo","big","blockquote","body","br","button","canvas","caption","cite","code","col","colgroup","data","datalist","dd","del","details","dfn","dialog","div","dl","dt","em","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","iframe","img","input","ins","kbd","keygen","label","legend","li","link","main","map","mark","marquee","menu","menuitem","meta","meter","nav","noscript","object","ol","optgroup","option","output","p","param","picture","pre","progress","q","rp","rt","ruby","s","samp","script","section","select","small","source","span","strong","style","sub","summary","sup","table","tbody","td","textarea","tfoot","th","thead","time","title","tr","track","u","ul","var","video","wbr","circle","clipPath","defs","ellipse","foreignObject","g","image","line","linearGradient","mask","path","pattern","polygon","polyline","radialGradient","rect","stop","svg","text","tspan"].forEach((function(t){hh[t]=hh(t)}));const uh=hh;const ch=(t,e)=>{Array.isArray(t.__emotion_styles)&&(t.__emotion_styles=e(t.__emotion_styles))};function dh(t){return null!==t&&"object"==typeof t&&t.constructor===Object}function ph(t){if(!dh(t))return t;const e={};return Object.keys(t).forEach((i=>{e[i]=ph(t[i])})),e}function fh(t,e,i={clone:!0}){const s=i.clone?bn({},t):t;return dh(t)&&dh(e)&&Object.keys(e).forEach((r=>{"__proto__"!==r&&(dh(e[r])&&r in t&&dh(t[r])?s[r]=fh(t[r],e[r],i):i.clone?s[r]=dh(e[r])?ph(e[r]):e[r]:s[r]=e[r])})),s}const _h=["values","unit","step"],gh=t=>{const e=Object.keys(t).map((e=>({key:e,val:t[e]})))||[];return e.sort(((t,e)=>t.val-e.val)),e.reduce(((t,e)=>bn({},t,{[e.key]:e.val})),{})};const mh={borderRadius:4},vh={xs:0,sm:600,md:900,lg:1200,xl:1536},Ph={keys:["xs","sm","md","lg","xl"],up:t=>`@media (min-width:${vh[t]}px)`};function bh(t,e,i){const s=t.theme||{};if(Array.isArray(e)){const t=s.breakpoints||Ph;return e.reduce(((s,r,o)=>(s[t.up(t.keys[o])]=i(e[o]),s)),{})}if("object"==typeof e){const t=s.breakpoints||Ph;return Object.keys(e).reduce(((s,r)=>{if(-1!==Object.keys(t.values||vh).indexOf(r)){s[t.up(r)]=i(e[r],r)}else{const t=r;s[t]=e[t]}return s}),{})}return i(e)}function yh(t={}){var e;return(null==(e=t.keys)?void 0:e.reduce(((e,i)=>(e[t.up(i)]={},e)),{}))||{}}function xh(t,e){return t.reduce(((t,e)=>{const i=t[e];return(!i||0===Object.keys(i).length)&&delete t[e],t}),e)}function Mh(t){if("string"!=typeof t)throw new Error(En(7));return t.charAt(0).toUpperCase()+t.slice(1)}function wh(t,e,i=!0){if(!e||"string"!=typeof e)return null;if(t&&t.vars&&i){const i=`vars.${e}`.split(".").reduce(((t,e)=>t&&t[e]?t[e]:null),t);if(null!=i)return i}return e.split(".").reduce(((t,e)=>t&&null!=t[e]?t[e]:null),t)}function Eh(t,e,i,s=i){let r;return r="function"==typeof t?t(i):Array.isArray(t)?t[i]||s:wh(t,i)||s,e&&(r=e(r,s,t)),r}const Ch=function(t){const{prop:e,cssProperty:i=t.prop,themeKey:s,transform:r}=t,o=t=>{if(null==t[e])return null;const o=t[e],a=wh(t.theme,s)||{};return bh(t,o,(t=>{let s=Eh(a,r,t);return t===s&&"string"==typeof t&&(s=Eh(a,r,`${e}${"default"===t?"":Mh(t)}`,t)),!1===i?s:{[i]:s}}))};return o.propTypes={},o.filterProps=[e],o};const Ah=function(t,e){return e?fh(t,e,{clone:!1}):t};const Sh={m:"margin",p:"padding"},Dh={t:"Top",r:"Right",b:"Bottom",l:"Left",x:["Left","Right"],y:["Top","Bottom"]},Lh={marginX:"mx",marginY:"my",paddingX:"px",paddingY:"py"},Rh=function(t){const e={};return i=>(e[i]===undefined&&(e[i]=t(i)),e[i])}((t=>{if(t.length>2){if(!Lh[t])return[t];t=Lh[t]}const[e,i]=t.split(""),s=Sh[e],r=Dh[i]||"";return Array.isArray(r)?r.map((t=>s+t)):[s+r]})),Bh=["m","mt","mr","mb","ml","mx","my","margin","marginTop","marginRight","marginBottom","marginLeft","marginX","marginY","marginInline","marginInlineStart","marginInlineEnd","marginBlock","marginBlockStart","marginBlockEnd"],Th=["p","pt","pr","pb","pl","px","py","padding","paddingTop","paddingRight","paddingBottom","paddingLeft","paddingX","paddingY","paddingInline","paddingInlineStart","paddingInlineEnd","paddingBlock","paddingBlockStart","paddingBlockEnd"],Fh=[...Bh,...Th];function Nh(t,e,i,s){var r;const o=null!=(r=wh(t,e,!1))?r:i;return"number"==typeof o?t=>"string"==typeof t?t:o*t:Array.isArray(o)?t=>"string"==typeof t?t:o[t]:"function"==typeof o?o:()=>undefined}function Oh(t){return Nh(t,"spacing",8)}function kh(t,e){if("string"==typeof e||null==e)return e;const i=t(Math.abs(e));return e>=0?i:"number"==typeof i?-i:`-${i}`}function Ih(t,e,i,s){if(-1===e.indexOf(i))return null;const r=function(t,e){return i=>t.reduce(((t,s)=>(t[s]=kh(e,i),t)),{})}(Rh(i),s);return bh(t,t[i],r)}function zh(t,e){const i=Oh(t.theme);return Object.keys(t).map((s=>Ih(t,e,s,i))).reduce(Ah,{})}function Vh(t){return zh(t,Bh)}function Uh(t){return zh(t,Th)}function Gh(t){return zh(t,Fh)}Vh.propTypes={},Vh.filterProps=Bh,Uh.propTypes={},Uh.filterProps=Th,Gh.propTypes={},Gh.filterProps=Fh;const Xh=function(...t){const e=t.reduce(((t,e)=>(e.filterProps.forEach((i=>{t[i]=e})),t)),{}),i=t=>Object.keys(t).reduce(((i,s)=>e[s]?Ah(i,e[s](t)):i),{});return i.propTypes={},i.filterProps=t.reduce(((t,e)=>t.concat(e.filterProps)),[]),i};function jh(t){return"number"!=typeof t?t:`${t}px solid`}const Wh=Ch({prop:"border",themeKey:"borders",transform:jh}),Hh=Ch({prop:"borderTop",themeKey:"borders",transform:jh}),Yh=Ch({prop:"borderRight",themeKey:"borders",transform:jh}),Kh=Ch({prop:"borderBottom",themeKey:"borders",transform:jh}),$h=Ch({prop:"borderLeft",themeKey:"borders",transform:jh}),qh=Ch({prop:"borderColor",themeKey:"palette"}),Zh=Ch({prop:"borderTopColor",themeKey:"palette"}),Qh=Ch({prop:"borderRightColor",themeKey:"palette"}),Jh=Ch({prop:"borderBottomColor",themeKey:"palette"}),tu=Ch({prop:"borderLeftColor",themeKey:"palette"}),eu=t=>{if(t.borderRadius!==undefined&&null!==t.borderRadius){const e=Nh(t.theme,"shape.borderRadius",4),i=t=>({borderRadius:kh(e,t)});return bh(t,t.borderRadius,i)}return null};eu.propTypes={},eu.filterProps=["borderRadius"];Xh(Wh,Hh,Yh,Kh,$h,qh,Zh,Qh,Jh,tu,eu);const iu=t=>{if(t.gap!==undefined&&null!==t.gap){const e=Nh(t.theme,"spacing",8),i=t=>({gap:kh(e,t)});return bh(t,t.gap,i)}return null};iu.propTypes={},iu.filterProps=["gap"];const su=t=>{if(t.columnGap!==undefined&&null!==t.columnGap){const e=Nh(t.theme,"spacing",8),i=t=>({columnGap:kh(e,t)});return bh(t,t.columnGap,i)}return null};su.propTypes={},su.filterProps=["columnGap"];const ru=t=>{if(t.rowGap!==undefined&&null!==t.rowGap){const e=Nh(t.theme,"spacing",8),i=t=>({rowGap:kh(e,t)});return bh(t,t.rowGap,i)}return null};ru.propTypes={},ru.filterProps=["rowGap"];Xh(iu,su,ru,Ch({prop:"gridColumn"}),Ch({prop:"gridRow"}),Ch({prop:"gridAutoFlow"}),Ch({prop:"gridAutoColumns"}),Ch({prop:"gridAutoRows"}),Ch({prop:"gridTemplateColumns"}),Ch({prop:"gridTemplateRows"}),Ch({prop:"gridTemplateAreas"}),Ch({prop:"gridArea"}));function ou(t,e){return"grey"===e?e:t}Xh(Ch({prop:"color",themeKey:"palette",transform:ou}),Ch({prop:"bgcolor",cssProperty:"backgroundColor",themeKey:"palette",transform:ou}),Ch({prop:"backgroundColor",themeKey:"palette",transform:ou}));function au(t){return t<=1&&0!==t?100*t+"%":t}const nu=Ch({prop:"width",transform:au}),lu=t=>{if(t.maxWidth!==undefined&&null!==t.maxWidth){const e=e=>{var i,s,r;return{maxWidth:(null==(i=t.theme)||null==(s=i.breakpoints)||null==(r=s.values)?void 0:r[e])||vh[e]||au(e)}};return bh(t,t.maxWidth,e)}return null};lu.filterProps=["maxWidth"];const hu=Ch({prop:"minWidth",transform:au}),uu=Ch({prop:"height",transform:au}),cu=Ch({prop:"maxHeight",transform:au}),du=Ch({prop:"minHeight",transform:au}),pu=(Ch({prop:"size",cssProperty:"width",transform:au}),Ch({prop:"size",cssProperty:"height",transform:au}),Xh(nu,lu,hu,uu,cu,du,Ch({prop:"boxSizing"})),{border:{themeKey:"borders",transform:jh},borderTop:{themeKey:"borders",transform:jh},borderRight:{themeKey:"borders",transform:jh},borderBottom:{themeKey:"borders",transform:jh},borderLeft:{themeKey:"borders",transform:jh},borderColor:{themeKey:"palette"},borderTopColor:{themeKey:"palette"},borderRightColor:{themeKey:"palette"},borderBottomColor:{themeKey:"palette"},borderLeftColor:{themeKey:"palette"},borderRadius:{themeKey:"shape.borderRadius",style:eu},color:{themeKey:"palette",transform:ou},bgcolor:{themeKey:"palette",cssProperty:"backgroundColor",transform:ou},backgroundColor:{themeKey:"palette",transform:ou},p:{style:Uh},pt:{style:Uh},pr:{style:Uh},pb:{style:Uh},pl:{style:Uh},px:{style:Uh},py:{style:Uh},padding:{style:Uh},paddingTop:{style:Uh},paddingRight:{style:Uh},paddingBottom:{style:Uh},paddingLeft:{style:Uh},paddingX:{style:Uh},paddingY:{style:Uh},paddingInline:{style:Uh},paddingInlineStart:{style:Uh},paddingInlineEnd:{style:Uh},paddingBlock:{style:Uh},paddingBlockStart:{style:Uh},paddingBlockEnd:{style:Uh},m:{style:Vh},mt:{style:Vh},mr:{style:Vh},mb:{style:Vh},ml:{style:Vh},mx:{style:Vh},my:{style:Vh},margin:{style:Vh},marginTop:{style:Vh},marginRight:{style:Vh},marginBottom:{style:Vh},marginLeft:{style:Vh},marginX:{style:Vh},marginY:{style:Vh},marginInline:{style:Vh},marginInlineStart:{style:Vh},marginInlineEnd:{style:Vh},marginBlock:{style:Vh},marginBlockStart:{style:Vh},marginBlockEnd:{style:Vh},displayPrint:{cssProperty:!1,transform:t=>({"@media print":{display:t}})},display:{},overflow:{},textOverflow:{},visibility:{},whiteSpace:{},flexBasis:{},flexDirection:{},flexWrap:{},justifyContent:{},alignItems:{},alignContent:{},order:{},flex:{},flexGrow:{},flexShrink:{},alignSelf:{},justifyItems:{},justifySelf:{},gap:{style:iu},rowGap:{style:ru},columnGap:{style:su},gridColumn:{},gridRow:{},gridAutoFlow:{},gridAutoColumns:{},gridAutoRows:{},gridTemplateColumns:{},gridTemplateRows:{},gridTemplateAreas:{},gridArea:{},position:{},zIndex:{themeKey:"zIndex"},top:{},right:{},bottom:{},left:{},boxShadow:{themeKey:"shadows"},width:{transform:au},maxWidth:{style:lu},minWidth:{transform:au},height:{transform:au},maxHeight:{transform:au},minHeight:{transform:au},boxSizing:{},fontFamily:{themeKey:"typography"},fontSize:{themeKey:"typography"},fontStyle:{themeKey:"typography"},fontWeight:{themeKey:"typography"},letterSpacing:{},textTransform:{},lineHeight:{},textAlign:{},typography:{cssProperty:!1,themeKey:"typography"}});const fu=function(){function t(t,e,i,s){const r={[t]:e,theme:i},o=s[t];if(!o)return{[t]:e};const{cssProperty:a=t,themeKey:n,transform:l,style:h}=o;if(null==e)return null;const u=wh(i,n)||{};if(h)return h(r);return bh(r,e,(e=>{let i=Eh(u,l,e);return e===i&&"string"==typeof e&&(i=Eh(u,l,`${t}${"default"===e?"":Mh(e)}`,e)),!1===a?i:{[a]:i}}))}return function e(i){var s;const{sx:r,theme:o={}}=i||{};if(!r)return null;const a=null!=(s=o.unstable_sxConfig)?s:pu;function n(i){let s=i;if("function"==typeof i)s=i(o);else if("object"!=typeof i)return i;if(!s)return null;const r=yh(o.breakpoints),n=Object.keys(r);let l=r;return Object.keys(s).forEach((i=>{const r=(n=s[i],h=o,"function"==typeof n?n(h):n);var n,h;if(null!==r&&r!==undefined)if("object"==typeof r)if(a[i])l=Ah(l,t(i,r,o,a));else{const t=bh({theme:o},r,(t=>({[i]:t})));!function(...t){const e=t.reduce(((t,e)=>t.concat(Object.keys(e))),[]),i=new Set(e);return t.every((t=>i.size===Object.keys(t).length))}(t,r)?l=Ah(l,t):l[i]=e({sx:r,theme:o})}else l=Ah(l,t(i,r,o,a))})),xh(n,l)}return Array.isArray(r)?r.map(n):n(r)}}();fu.filterProps=["sx"];const _u=fu,gu=["breakpoints","palette","spacing","shape"];const mu=function(t={},...e){const{breakpoints:i={},palette:s={},spacing:r,shape:o={}}=t,a=Pn(t,gu),n=function(t){const{values:e={xs:0,sm:600,md:900,lg:1200,xl:1536},unit:i="px",step:s=5}=t,r=Pn(t,_h),o=gh(e),a=Object.keys(o);function n(t){return`@media (min-width:${"number"==typeof e[t]?e[t]:t}${i})`}function l(t){return`@media (max-width:${("number"==typeof e[t]?e[t]:t)-s/100}${i})`}function h(t,r){const o=a.indexOf(r);return`@media (min-width:${"number"==typeof e[t]?e[t]:t}${i}) and (max-width:${(-1!==o&&"number"==typeof e[a[o]]?e[a[o]]:r)-s/100}${i})`}return bn({keys:a,values:o,up:n,down:l,between:h,only:function(t){return a.indexOf(t)+1<a.length?h(t,a[a.indexOf(t)+1]):n(t)},not:function(t){const e=a.indexOf(t);return 0===e?n(a[1]):e===a.length-1?l(a[e]):h(t,a[a.indexOf(t)+1]).replace("@media","@media not all and")},unit:i},r)}(i),l=function(t=8){if(t.mui)return t;const e=Oh({spacing:t}),i=(...t)=>(0===t.length?[1]:t).map((t=>{const i=e(t);return"number"==typeof i?`${i}px`:i})).join(" ");return i.mui=!0,i}(r);let h=fh({breakpoints:n,direction:"ltr",components:{},palette:bn({mode:"light"},s),spacing:l,shape:bn({},mh,o)},a);return h=e.reduce(((t,e)=>fh(t,e)),h),h.unstable_sxConfig=bn({},pu,null==a?void 0:a.unstable_sxConfig),h.unstable_sx=function(t){return _u({sx:t,theme:this})},h},vu=["variant"];function Pu(t){return 0===t.length}function bu(t){const{variant:e}=t,i=Pn(t,vu);let s=e||"";return Object.keys(i).sort().forEach((e=>{s+="color"===e?Pu(s)?t[e]:Mh(t[e]):`${Pu(s)?e:Mh(e)}${Mh(t[e].toString())}`})),s}const yu=["name","slot","skipVariantsResolver","skipSx","overridesResolver"],xu=["theme"],Mu=["theme"];function wu(t){return 0===Object.keys(t).length}const Eu=(t,e)=>e.components&&e.components[t]&&e.components[t].styleOverrides?e.components[t].styleOverrides:null,Cu=(t,e)=>{let i=[];e&&e.components&&e.components[t]&&e.components[t].variants&&(i=e.components[t].variants);const s={};return i.forEach((t=>{const e=bu(t.props);s[e]=t.style})),s},Au=(t,e,i,s)=>{var r,o;const{ownerState:a={}}=t,n=[],l=null==i||null==(r=i.components)||null==(o=r[s])?void 0:o.variants;return l&&l.forEach((i=>{let s=!0;Object.keys(i.props).forEach((e=>{a[e]!==i.props[e]&&t[e]!==i.props[e]&&(s=!1)})),s&&n.push(e[bu(i.props)])})),n};function Su(t){return"ownerState"!==t&&"theme"!==t&&"sx"!==t&&"as"!==t}const Du=mu();function Lu(t,e){return bn({toolbar:{minHeight:56,[t.up("xs")]:{"@media (orientation: landscape)":{minHeight:48}},[t.up("sm")]:{minHeight:64}}},e)}const Ru={black:"#000",white:"#fff"},Bu={50:"#fafafa",100:"#f5f5f5",200:"#eeeeee",300:"#e0e0e0",400:"#bdbdbd",500:"#9e9e9e",600:"#757575",700:"#616161",800:"#424242",900:"#212121",A100:"#f5f5f5",A200:"#eeeeee",A400:"#bdbdbd",A700:"#616161"},Tu={50:"#f3e5f5",100:"#e1bee7",200:"#ce93d8",300:"#ba68c8",400:"#ab47bc",500:"#9c27b0",600:"#8e24aa",700:"#7b1fa2",800:"#6a1b9a",900:"#4a148c",A100:"#ea80fc",A200:"#e040fb",A400:"#d500f9",A700:"#aa00ff"},Fu={50:"#ffebee",100:"#ffcdd2",200:"#ef9a9a",300:"#e57373",400:"#ef5350",500:"#f44336",600:"#e53935",700:"#d32f2f",800:"#c62828",900:"#b71c1c",A100:"#ff8a80",A200:"#ff5252",A400:"#ff1744",A700:"#d50000"},Nu={50:"#fff3e0",100:"#ffe0b2",200:"#ffcc80",300:"#ffb74d",400:"#ffa726",500:"#ff9800",600:"#fb8c00",700:"#f57c00",800:"#ef6c00",900:"#e65100",A100:"#ffd180",A200:"#ffab40",A400:"#ff9100",A700:"#ff6d00"},Ou={50:"#e3f2fd",100:"#bbdefb",200:"#90caf9",300:"#64b5f6",400:"#42a5f5",500:"#2196f3",600:"#1e88e5",700:"#1976d2",800:"#1565c0",900:"#0d47a1",A100:"#82b1ff",A200:"#448aff",A400:"#2979ff",A700:"#2962ff"},ku={50:"#e1f5fe",100:"#b3e5fc",200:"#81d4fa",300:"#4fc3f7",400:"#29b6f6",500:"#03a9f4",600:"#039be5",700:"#0288d1",800:"#0277bd",900:"#01579b",A100:"#80d8ff",A200:"#40c4ff",A400:"#00b0ff",A700:"#0091ea"},Iu={50:"#e8f5e9",100:"#c8e6c9",200:"#a5d6a7",300:"#81c784",400:"#66bb6a",500:"#4caf50",600:"#43a047",700:"#388e3c",800:"#2e7d32",900:"#1b5e20",A100:"#b9f6ca",A200:"#69f0ae",A400:"#00e676",A700:"#00c853"},zu=["mode","contrastThreshold","tonalOffset"],Vu={text:{primary:"rgba(0, 0, 0, 0.87)",secondary:"rgba(0, 0, 0, 0.6)",disabled:"rgba(0, 0, 0, 0.38)"},divider:"rgba(0, 0, 0, 0.12)",background:{paper:Ru.white,"default":Ru.white},action:{active:"rgba(0, 0, 0, 0.54)",hover:"rgba(0, 0, 0, 0.04)",hoverOpacity:.04,selected:"rgba(0, 0, 0, 0.08)",selectedOpacity:.08,disabled:"rgba(0, 0, 0, 0.26)",disabledBackground:"rgba(0, 0, 0, 0.12)",disabledOpacity:.38,focus:"rgba(0, 0, 0, 0.12)",focusOpacity:.12,activatedOpacity:.12}},Uu={text:{primary:Ru.white,secondary:"rgba(255, 255, 255, 0.7)",disabled:"rgba(255, 255, 255, 0.5)",icon:"rgba(255, 255, 255, 0.5)"},divider:"rgba(255, 255, 255, 0.12)",background:{paper:"#121212","default":"#121212"},action:{active:Ru.white,hover:"rgba(255, 255, 255, 0.08)",hoverOpacity:.08,selected:"rgba(255, 255, 255, 0.16)",selectedOpacity:.16,disabled:"rgba(255, 255, 255, 0.3)",disabledBackground:"rgba(255, 255, 255, 0.12)",disabledOpacity:.38,focus:"rgba(255, 255, 255, 0.12)",focusOpacity:.12,activatedOpacity:.24}};function Gu(t,e,i,s){const r=s.light||s,o=s.dark||1.5*s;t[e]||(t.hasOwnProperty(i)?t[e]=t[i]:"light"===e?t.light=Bn(t.main,r):"dark"===e&&(t.dark=Rn(t.main,o)))}function Xu(t){const{mode:e="light",contrastThreshold:i=3,tonalOffset:s=.2}=t,r=Pn(t,zu),o=t.primary||function(t="light"){return"dark"===t?{main:Ou[200],light:Ou[50],dark:Ou[400]}:{main:Ou[700],light:Ou[400],dark:Ou[800]}}(e),a=t.secondary||function(t="light"){return"dark"===t?{main:Tu[200],light:Tu[50],dark:Tu[400]}:{main:Tu[500],light:Tu[300],dark:Tu[700]}}(e),n=t.error||function(t="light"){return"dark"===t?{main:Fu[500],light:Fu[300],dark:Fu[700]}:{main:Fu[700],light:Fu[400],dark:Fu[800]}}(e),l=t.info||function(t="light"){return"dark"===t?{main:ku[400],light:ku[300],dark:ku[700]}:{main:ku[700],light:ku[500],dark:ku[900]}}(e),h=t.success||function(t="light"){return"dark"===t?{main:Iu[400],light:Iu[300],dark:Iu[700]}:{main:Iu[800],light:Iu[500],dark:Iu[900]}}(e),u=t.warning||function(t="light"){return"dark"===t?{main:Nu[400],light:Nu[300],dark:Nu[700]}:{main:"#ed6c02",light:Nu[500],dark:Nu[900]}}(e);function c(t){const e=function(t,e){const i=Dn(t),s=Dn(e);return(Math.max(i,s)+.05)/(Math.min(i,s)+.05)}(t,Uu.text.primary)>=i?Uu.text.primary:Vu.text.primary;return e}const d=({color:t,name:e,mainShade:i=500,lightShade:r=300,darkShade:o=700})=>{if(!(t=bn({},t)).main&&t[i]&&(t.main=t[i]),!t.hasOwnProperty("main"))throw new Error(En(11,e?` (${e})`:"",i));if("string"!=typeof t.main)throw new Error(En(12,e?` (${e})`:"",JSON.stringify(t.main)));return Gu(t,"light",r,s),Gu(t,"dark",o,s),t.contrastText||(t.contrastText=c(t.main)),t},p={dark:Uu,light:Vu};return fh(bn({common:bn({},Ru),mode:e,primary:d({color:o,name:"primary"}),secondary:d({color:a,name:"secondary",mainShade:"A400",lightShade:"A200",darkShade:"A700"}),error:d({color:n,name:"error"}),warning:d({color:u,name:"warning"}),info:d({color:l,name:"info"}),success:d({color:h,name:"success"}),grey:Bu,contrastThreshold:i,getContrastText:c,augmentColor:d,tonalOffset:s},p[e]),r)}const ju=["fontFamily","fontSize","fontWeightLight","fontWeightRegular","fontWeightMedium","fontWeightBold","htmlFontSize","allVariants","pxToRem"];const Wu={textTransform:"uppercase"},Hu='"Roboto", "Helvetica", "Arial", sans-serif';function Yu(t,e){const i="function"==typeof e?e(t):e,{fontFamily:s=Hu,fontSize:r=14,fontWeightLight:o=300,fontWeightRegular:a=400,fontWeightMedium:n=500,fontWeightBold:l=700,htmlFontSize:h=16,allVariants:u,pxToRem:c}=i,d=Pn(i,ju);const p=r/14,f=c||(t=>t/h*p+"rem"),_=(t,e,i,r,o)=>{return bn({fontFamily:s,fontWeight:t,fontSize:f(e),lineHeight:i},s===Hu?{letterSpacing:(a=r/e,Math.round(1e5*a)/1e5)+"em"}:{},o,u);var a},g={h1:_(o,96,1.167,-1.5),h2:_(o,60,1.2,-.5),h3:_(a,48,1.167,0),h4:_(a,34,1.235,.25),h5:_(a,24,1.334,0),h6:_(n,20,1.6,.15),subtitle1:_(a,16,1.75,.15),subtitle2:_(n,14,1.57,.1),body1:_(a,16,1.5,.15),body2:_(a,14,1.43,.15),button:_(n,14,1.75,.4,Wu),caption:_(a,12,1.66,.4),overline:_(a,12,2.66,1,Wu)};return fh(bn({htmlFontSize:h,pxToRem:f,fontFamily:s,fontSize:r,fontWeightLight:o,fontWeightRegular:a,fontWeightMedium:n,fontWeightBold:l},g),d,{clone:!1})}const Ku=.2,$u=.14,qu=.12;function Zu(...t){return[`${t[0]}px ${t[1]}px ${t[2]}px ${t[3]}px rgba(0,0,0,${Ku})`,`${t[4]}px ${t[5]}px ${t[6]}px ${t[7]}px rgba(0,0,0,${$u})`,`${t[8]}px ${t[9]}px ${t[10]}px ${t[11]}px rgba(0,0,0,${qu})`].join(",")}const Qu=["none",Zu(0,2,1,-1,0,1,1,0,0,1,3,0),Zu(0,3,1,-2,0,2,2,0,0,1,5,0),Zu(0,3,3,-2,0,3,4,0,0,1,8,0),Zu(0,2,4,-1,0,4,5,0,0,1,10,0),Zu(0,3,5,-1,0,5,8,0,0,1,14,0),Zu(0,3,5,-1,0,6,10,0,0,1,18,0),Zu(0,4,5,-2,0,7,10,1,0,2,16,1),Zu(0,5,5,-3,0,8,10,1,0,3,14,2),Zu(0,5,6,-3,0,9,12,1,0,3,16,2),Zu(0,6,6,-3,0,10,14,1,0,4,18,3),Zu(0,6,7,-4,0,11,15,1,0,4,20,3),Zu(0,7,8,-4,0,12,17,2,0,5,22,4),Zu(0,7,8,-4,0,13,19,2,0,5,24,4),Zu(0,7,9,-4,0,14,21,2,0,5,26,4),Zu(0,8,9,-5,0,15,22,2,0,6,28,5),Zu(0,8,10,-5,0,16,24,2,0,6,30,5),Zu(0,8,11,-5,0,17,26,2,0,6,32,5),Zu(0,9,11,-5,0,18,28,2,0,7,34,6),Zu(0,9,12,-6,0,19,29,2,0,7,36,6),Zu(0,10,13,-6,0,20,31,3,0,8,38,7),Zu(0,10,13,-6,0,21,33,3,0,8,40,7),Zu(0,10,14,-6,0,22,35,3,0,8,42,7),Zu(0,11,14,-7,0,23,36,3,0,9,44,8),Zu(0,11,15,-7,0,24,38,3,0,9,46,8)],Ju=["duration","easing","delay"],tc={easeInOut:"cubic-bezier(0.4, 0, 0.2, 1)",easeOut:"cubic-bezier(0.0, 0, 0.2, 1)",easeIn:"cubic-bezier(0.4, 0, 1, 1)",sharp:"cubic-bezier(0.4, 0, 0.6, 1)"},ec={shortest:150,shorter:200,short:250,standard:300,complex:375,enteringScreen:225,leavingScreen:195};function ic(t){return`${Math.round(t)}ms`}function sc(t){if(!t)return 0;const e=t/36;return Math.round(10*(4+15*e**.25+e/5))}function rc(t){const e=bn({},tc,t.easing),i=bn({},ec,t.duration);return bn({getAutoHeightDuration:sc,create:(t=["all"],s={})=>{const{duration:r=i.standard,easing:o=e.easeInOut,delay:a=0}=s;Pn(s,Ju);return(Array.isArray(t)?t:[t]).map((t=>`${t} ${"string"==typeof r?r:ic(r)} ${o} ${"string"==typeof a?a:ic(a)}`)).join(",")}},t,{easing:e,duration:i})}const oc={mobileStepper:1e3,fab:1050,speedDial:1050,appBar:1100,drawer:1200,modal:1300,snackbar:1400,tooltip:1500},ac=["breakpoints","mixins","spacing","palette","transitions","typography","shape"];function nc(t={},...e){const{mixins:i={},palette:s={},transitions:r={},typography:o={}}=t,a=Pn(t,ac);if(t.vars)throw new Error(En(18));const n=Xu(s),l=mu(t);let h=fh(l,{mixins:Lu(l.breakpoints,i),palette:n,shadows:Qu.slice(),typography:Yu(n,o),transitions:rc(r),zIndex:bn({},oc)});return h=fh(h,a),h=e.reduce(((t,e)=>fh(t,e)),h),h.unstable_sxConfig=bn({},pu,null==a?void 0:a.unstable_sxConfig),h.unstable_sx=function(t){return _u({sx:t,theme:this})},h}const lc=nc(),hc=t=>Su(t)&&"classes"!==t,uc=function(t={}){const{defaultTheme:e=Du,rootShouldForwardProp:i=Su,slotShouldForwardProp:s=Su}=t,r=t=>{const i=wu(t.theme)?e:t.theme;return _u(bn({},t,{theme:i}))};return r.__mui_systemSx=!0,(t,o={})=>{ch(t,(t=>t.filter((t=>!(null!=t&&t.__mui_systemSx)))));const{name:a,slot:n,skipVariantsResolver:l,skipSx:h,overridesResolver:u}=o,c=Pn(o,yu),d=l!==undefined?l:n&&"Root"!==n||!1,p=h||!1;let f=Su;"Root"===n?f=i:n?f=s:function(t){return"string"==typeof t&&t.charCodeAt(0)>96}(t)&&(f=undefined);const _=function(t,e){return uh(t,e)}(t,bn({shouldForwardProp:f,label:undefined},c)),g=(t,...i)=>{const s=i?i.map((t=>"function"==typeof t&&t.__emotion_real!==t?i=>{let{theme:s}=i,r=Pn(i,xu);return t(bn({theme:wu(s)?e:s},r))}:t)):[];let o=t;a&&u&&s.push((t=>{const i=wu(t.theme)?e:t.theme,s=Eu(a,i);if(s){const e={};return Object.entries(s).forEach((([s,r])=>{e[s]="function"==typeof r?r(bn({},t,{theme:i})):r})),u(t,e)}return null})),a&&!d&&s.push((t=>{const i=wu(t.theme)?e:t.theme;return Au(t,Cu(a,i),i,a)})),p||s.push(r);const n=s.length-i.length;if(Array.isArray(t)&&n>0){const e=new Array(n).fill("");o=[...t,...e],o.raw=[...t.raw,...e]}else"function"==typeof t&&t.__emotion_real!==t&&(o=i=>{let{theme:s}=i,r=Pn(i,Mu);return t(bn({theme:wu(s)?e:s},r))});return _(o,...s)};return _.withConfig&&(g.withConfig=_.withConfig),g}}({defaultTheme:lc,rootShouldForwardProp:hc}),cc=uc;const dc=t.createContext(null);const pc=function(e=null){const i=t.useContext(dc);return i&&(s=i,0!==Object.keys(s).length)?i:e;var s},fc=mu();const _c=function(t=fc){return pc(t)};function gc({props:t,name:e,defaultTheme:i}){const s=function(t){const{theme:e,name:i,props:s}=t;return e&&e.components&&e.components[i]&&e.components[i].defaultProps?Mn(e.components[i].defaultProps,s):s}({theme:_c(i),name:e,props:t});return s}function mc({props:t,name:e}){return gc({props:t,name:e,defaultTheme:lc})}const vc=function(...e){return t.useMemo((()=>e.every((t=>null==t))?null:t=>{e.forEach((e=>{!function(t,e){"function"==typeof t?t(e):t&&(t.current=e)}(e,t)}))}),e)},Pc="undefined"!=typeof window?t.useLayoutEffect:t.useEffect;const bc=function(e){const i=t.useRef(e);return Pc((()=>{i.current=e})),t.useCallback(((...t)=>(0,i.current)(...t)),[])};let yc,xc=!0,Mc=!1;const wc={text:!0,search:!0,url:!0,tel:!0,email:!0,password:!0,number:!0,date:!0,month:!0,week:!0,time:!0,datetime:!0,"datetime-local":!0};function Ec(t){t.metaKey||t.altKey||t.ctrlKey||(xc=!0)}function Cc(){xc=!1}function Ac(){"hidden"===this.visibilityState&&Mc&&(xc=!0)}function Sc(t){const{target:e}=t;try{return e.matches(":focus-visible")}catch(i){}return xc||function(t){const{type:e,tagName:i}=t;return!("INPUT"!==i||!wc[e]||t.readOnly)||"TEXTAREA"===i&&!t.readOnly||!!t.isContentEditable}(e)}const Dc=function(){const e=t.useCallback((t=>{var e;null!=t&&((e=t.ownerDocument).addEventListener("keydown",Ec,!0),e.addEventListener("mousedown",Cc,!0),e.addEventListener("pointerdown",Cc,!0),e.addEventListener("touchstart",Cc,!0),e.addEventListener("visibilitychange",Ac,!0))}),[]),i=t.useRef(!1);return{isFocusVisibleRef:i,onFocus:function(t){return!!Sc(t)&&(i.current=!0,!0)},onBlur:function(){return!!i.current&&(Mc=!0,window.clearTimeout(yc),yc=window.setTimeout((()=>{Mc=!1}),100),i.current=!1,!0)},ref:e}};function Lc(t,e){return Lc=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Lc(t,e)}const Rc=t["default"].createContext(null);function Bc(e,i){var s=Object.create(null);return e&&t.Children.map(e,(function(t){return t})).forEach((function(e){s[e.key]=function(e){return i&&(0,t.isValidElement)(e)?i(e):e}(e)})),s}function Tc(t,e,i){return null!=i[e]?i[e]:t.props[e]}function Fc(e,i,s){var r=Bc(e.children),o=function(t,e){function i(i){return i in e?e[i]:t[i]}t=t||{},e=e||{};var s,r=Object.create(null),o=[];for(var a in t)a in e?o.length&&(r[a]=o,o=[]):o.push(a);var n={};for(var l in e){if(r[l])for(s=0;s<r[l].length;s++){var h=r[l][s];n[r[l][s]]=i(h)}n[l]=i(l)}for(s=0;s<o.length;s++)n[o[s]]=i(o[s]);return n}(i,r);return Object.keys(o).forEach((function(a){var n=o[a];if((0,t.isValidElement)(n)){var l=a in i,h=a in r,u=i[a],c=(0,t.isValidElement)(u)&&!u.props["in"];!h||l&&!c?h||!l||c?h&&l&&(0,t.isValidElement)(u)&&(o[a]=(0,t.cloneElement)(n,{onExited:s.bind(null,n),"in":u.props["in"],exit:Tc(n,"exit",e),enter:Tc(n,"enter",e)})):o[a]=(0,t.cloneElement)(n,{"in":!1}):o[a]=(0,t.cloneElement)(n,{onExited:s.bind(null,n),"in":!0,exit:Tc(n,"exit",e),enter:Tc(n,"enter",e)})}})),o}var Nc=Object.values||function(t){return Object.keys(t).map((function(e){return t[e]}))},Oc=function(e){var i,s;function r(t,i){var s,r=(s=e.call(this,t,i)||this).handleExited.bind(function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(s));return s.state={contextValue:{isMounting:!0},handleExited:r,firstRender:!0},s}s=e,(i=r).prototype=Object.create(s.prototype),i.prototype.constructor=i,Lc(i,s);var o=r.prototype;return o.componentDidMount=function(){this.mounted=!0,this.setState({contextValue:{isMounting:!1}})},o.componentWillUnmount=function(){this.mounted=!1},r.getDerivedStateFromProps=function(e,i){var s,r,o=i.children,a=i.handleExited;return{children:i.firstRender?(s=e,r=a,Bc(s.children,(function(e){return(0,t.cloneElement)(e,{onExited:r.bind(null,e),"in":!0,appear:Tc(e,"appear",s),enter:Tc(e,"enter",s),exit:Tc(e,"exit",s)})}))):Fc(e,o,a),firstRender:!1}},o.handleExited=function(t,e){var i=Bc(this.props.children);t.key in i||(t.props.onExited&&t.props.onExited(e),this.mounted&&this.setState((function(e){var i=bn({},e.children);return delete i[t.key],{children:i}})))},o.render=function(){var e=this.props,i=e.component,s=e.childFactory,r=Pn(e,["component","childFactory"]),o=this.state.contextValue,a=Nc(this.state.children).map(s);return delete r.appear,delete r.enter,delete r.exit,null===i?t["default"].createElement(Rc.Provider,{value:o},a):t["default"].createElement(Rc.Provider,{value:o},t["default"].createElement(i,r,a))},r}(t["default"].Component);Oc.propTypes={},Oc.defaultProps={component:"div",childFactory:function(t){return t}};const kc=Oc;r(679);function Ic(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return ql(e)}var zc=function(){var t=Ic.apply(void 0,arguments),e="animation-"+t.name;return{name:e,styles:"@keyframes "+e+"{"+t.styles+"}",anim:1,toString:function(){return"_EMO_"+this.name+"_"+this.styles+"_EMO_"}}};var Vc=r(893);const Uc=function(e){const{className:i,classes:s,pulsate:r=!1,rippleX:o,rippleY:a,rippleSize:n,"in":l,onExited:h,timeout:u}=e,[c,d]=t.useState(!1),p=xn(i,s.ripple,s.rippleVisible,r&&s.ripplePulsate),f={width:n,height:n,top:-n/2+a,left:-n/2+o},_=xn(s.child,c&&s.childLeaving,r&&s.childPulsate);return l||c||d(!0),t.useEffect((()=>{if(!l&&null!=h){const t=setTimeout(h,u);return()=>{clearTimeout(t)}}return undefined}),[h,l,u]),(0,Vc.jsx)("span",{className:p,style:f,children:(0,Vc.jsx)("span",{className:_})})},Gc=t=>t,Xc=(()=>{let t=Gc;return{configure(e){t=e},generate:e=>t(e),reset(){t=Gc}}})(),jc={active:"active",checked:"checked",completed:"completed",disabled:"disabled",readOnly:"readOnly",error:"error",expanded:"expanded",focused:"focused",focusVisible:"focusVisible",required:"required",selected:"selected"};function Wc(t,e,i="Mui"){const s=jc[e];return s?`${i}-${s}`:`${Xc.generate(t)}-${e}`}function Hc(t,e,i="Mui"){const s={};return e.forEach((e=>{s[e]=Wc(t,e,i)})),s}const Yc=Hc("MuiTouchRipple",["root","ripple","rippleVisible","ripplePulsate","child","childLeaving","childPulsate"]),Kc=["center","classes","className"];let $c,qc,Zc,Qc,Jc=t=>t;const td=zc($c||($c=Jc`
  0% {
    transform: scale(0);
    opacity: 0.1;
  }

  100% {
    transform: scale(1);
    opacity: 0.3;
  }
`)),ed=zc(qc||(qc=Jc`
  0% {
    opacity: 1;
  }

  100% {
    opacity: 0;
  }
`)),id=zc(Zc||(Zc=Jc`
  0% {
    transform: scale(1);
  }

  50% {
    transform: scale(0.92);
  }

  100% {
    transform: scale(1);
  }
`)),sd=cc("span",{name:"MuiTouchRipple",slot:"Root"})({overflow:"hidden",pointerEvents:"none",position:"absolute",zIndex:0,top:0,right:0,bottom:0,left:0,borderRadius:"inherit"}),rd=cc(Uc,{name:"MuiTouchRipple",slot:"Ripple"})(Qc||(Qc=Jc`
  opacity: 0;
  position: absolute;

  &.${0} {
    opacity: 0.3;
    transform: scale(1);
    animation-name: ${0};
    animation-duration: ${0}ms;
    animation-timing-function: ${0};
  }

  &.${0} {
    animation-duration: ${0}ms;
  }

  & .${0} {
    opacity: 1;
    display: block;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background-color: currentColor;
  }

  & .${0} {
    opacity: 0;
    animation-name: ${0};
    animation-duration: ${0}ms;
    animation-timing-function: ${0};
  }

  & .${0} {
    position: absolute;
    /* @noflip */
    left: 0px;
    top: 0;
    animation-name: ${0};
    animation-duration: 2500ms;
    animation-timing-function: ${0};
    animation-iteration-count: infinite;
    animation-delay: 200ms;
  }
`),Yc.rippleVisible,td,550,(({theme:t})=>t.transitions.easing.easeInOut),Yc.ripplePulsate,(({theme:t})=>t.transitions.duration.shorter),Yc.child,Yc.childLeaving,ed,550,(({theme:t})=>t.transitions.easing.easeInOut),Yc.childPulsate,id,(({theme:t})=>t.transitions.easing.easeInOut)),od=t.forwardRef((function(e,i){const s=mc({props:e,name:"MuiTouchRipple"}),{center:r=!1,classes:o={},className:a}=s,n=Pn(s,Kc),[l,h]=t.useState([]),u=t.useRef(0),c=t.useRef(null);t.useEffect((()=>{c.current&&(c.current(),c.current=null)}),[l]);const d=t.useRef(!1),p=t.useRef(null),f=t.useRef(null),_=t.useRef(null);t.useEffect((()=>()=>{clearTimeout(p.current)}),[]);const g=t.useCallback((t=>{const{pulsate:e,rippleX:i,rippleY:s,rippleSize:r,cb:a}=t;h((t=>[...t,(0,Vc.jsx)(rd,{classes:{ripple:xn(o.ripple,Yc.ripple),rippleVisible:xn(o.rippleVisible,Yc.rippleVisible),ripplePulsate:xn(o.ripplePulsate,Yc.ripplePulsate),child:xn(o.child,Yc.child),childLeaving:xn(o.childLeaving,Yc.childLeaving),childPulsate:xn(o.childPulsate,Yc.childPulsate)},timeout:550,pulsate:e,rippleX:i,rippleY:s,rippleSize:r},u.current)])),u.current+=1,c.current=a}),[o]),m=t.useCallback(((t={},e={},i=(()=>{}))=>{const{pulsate:s=!1,center:o=r||e.pulsate,fakeElement:a=!1}=e;if("mousedown"===(null==t?void 0:t.type)&&d.current)return void(d.current=!1);"touchstart"===(null==t?void 0:t.type)&&(d.current=!0);const n=a?null:_.current,l=n?n.getBoundingClientRect():{width:0,height:0,left:0,top:0};let h,u,c;if(o||t===undefined||0===t.clientX&&0===t.clientY||!t.clientX&&!t.touches)h=Math.round(l.width/2),u=Math.round(l.height/2);else{const{clientX:e,clientY:i}=t.touches&&t.touches.length>0?t.touches[0]:t;h=Math.round(e-l.left),u=Math.round(i-l.top)}if(o)c=Math.sqrt((2*l.width**2+l.height**2)/3),c%2==0&&(c+=1);else{const t=2*Math.max(Math.abs((n?n.clientWidth:0)-h),h)+2,e=2*Math.max(Math.abs((n?n.clientHeight:0)-u),u)+2;c=Math.sqrt(t**2+e**2)}null!=t&&t.touches?null===f.current&&(f.current=()=>{g({pulsate:s,rippleX:h,rippleY:u,rippleSize:c,cb:i})},p.current=setTimeout((()=>{f.current&&(f.current(),f.current=null)}),80)):g({pulsate:s,rippleX:h,rippleY:u,rippleSize:c,cb:i})}),[r,g]),v=t.useCallback((()=>{m({},{pulsate:!0})}),[m]),P=t.useCallback(((t,e)=>{if(clearTimeout(p.current),"touchend"===(null==t?void 0:t.type)&&f.current)return f.current(),f.current=null,void(p.current=setTimeout((()=>{P(t,e)})));f.current=null,h((t=>t.length>0?t.slice(1):t)),c.current=e}),[]);return t.useImperativeHandle(i,(()=>({pulsate:v,start:m,stop:P})),[v,m,P]),(0,Vc.jsx)(sd,bn({className:xn(Yc.root,o.root,a),ref:_},n,{children:(0,Vc.jsx)(kc,{component:null,exit:!0,children:l})}))})),ad=od;function nd(t){return Wc("MuiButtonBase",t)}const ld=Hc("MuiButtonBase",["root","disabled","focusVisible"]),hd=["action","centerRipple","children","className","component","disabled","disableRipple","disableTouchRipple","focusRipple","focusVisibleClassName","LinkComponent","onBlur","onClick","onContextMenu","onDragLeave","onFocus","onFocusVisible","onKeyDown","onKeyUp","onMouseDown","onMouseLeave","onMouseUp","onTouchEnd","onTouchMove","onTouchStart","tabIndex","TouchRippleProps","touchRippleRef","type"],ud=cc("button",{name:"MuiButtonBase",slot:"Root",overridesResolver:(t,e)=>e.root})({display:"inline-flex",alignItems:"center",justifyContent:"center",position:"relative",boxSizing:"border-box",WebkitTapHighlightColor:"transparent",backgroundColor:"transparent",outline:0,border:0,margin:0,borderRadius:0,padding:0,cursor:"pointer",userSelect:"none",verticalAlign:"middle",MozAppearance:"none",WebkitAppearance:"none",textDecoration:"none",color:"inherit","&::-moz-focus-inner":{borderStyle:"none"},[`&.${ld.disabled}`]:{pointerEvents:"none",cursor:"default"},"@media print":{colorAdjust:"exact"}}),cd=t.forwardRef((function(e,i){const s=mc({props:e,name:"MuiButtonBase"}),{action:r,centerRipple:o=!1,children:a,className:n,component:l="button",disabled:h=!1,disableRipple:u=!1,disableTouchRipple:c=!1,focusRipple:d=!1,LinkComponent:p="a",onBlur:f,onClick:_,onContextMenu:g,onDragLeave:m,onFocus:v,onFocusVisible:P,onKeyDown:b,onKeyUp:y,onMouseDown:x,onMouseLeave:M,onMouseUp:w,onTouchEnd:E,onTouchMove:C,onTouchStart:A,tabIndex:S=0,TouchRippleProps:D,touchRippleRef:L,type:R}=s,B=Pn(s,hd),T=t.useRef(null),F=t.useRef(null),N=vc(F,L),{isFocusVisibleRef:O,onFocus:k,onBlur:I,ref:z}=Dc(),[V,U]=t.useState(!1);h&&V&&U(!1),t.useImperativeHandle(r,(()=>({focusVisible:()=>{U(!0),T.current.focus()}})),[]);const[G,X]=t.useState(!1);t.useEffect((()=>{X(!0)}),[]);const j=G&&!u&&!h;function W(t,e,i=c){return bc((s=>{e&&e(s);return!i&&F.current&&F.current[t](s),!0}))}t.useEffect((()=>{V&&d&&!u&&G&&F.current.pulsate()}),[u,d,V,G]);const H=W("start",x),Y=W("stop",g),K=W("stop",m),$=W("stop",w),q=W("stop",(t=>{V&&t.preventDefault(),M&&M(t)})),Z=W("start",A),Q=W("stop",E),J=W("stop",C),tt=W("stop",(t=>{I(t),!1===O.current&&U(!1),f&&f(t)}),!1),et=bc((t=>{T.current||(T.current=t.currentTarget),k(t),!0===O.current&&(U(!0),P&&P(t)),v&&v(t)})),it=()=>{const t=T.current;return l&&"button"!==l&&!("A"===t.tagName&&t.href)},st=t.useRef(!1),rt=bc((t=>{d&&!st.current&&V&&F.current&&" "===t.key&&(st.current=!0,F.current.stop(t,(()=>{F.current.start(t)}))),t.target===t.currentTarget&&it()&&" "===t.key&&t.preventDefault(),b&&b(t),t.target===t.currentTarget&&it()&&"Enter"===t.key&&!h&&(t.preventDefault(),_&&_(t))})),ot=bc((t=>{d&&" "===t.key&&F.current&&V&&!t.defaultPrevented&&(st.current=!1,F.current.stop(t,(()=>{F.current.pulsate(t)}))),y&&y(t),_&&t.target===t.currentTarget&&it()&&" "===t.key&&!t.defaultPrevented&&_(t)}));let at=l;"button"===at&&(B.href||B.to)&&(at=p);const nt={};"button"===at?(nt.type=R===undefined?"button":R,nt.disabled=h):(B.href||B.to||(nt.role="button"),h&&(nt["aria-disabled"]=h));const lt=vc(i,z,T);const ht=bn({},s,{centerRipple:o,component:l,disabled:h,disableRipple:u,disableTouchRipple:c,focusRipple:d,tabIndex:S,focusVisible:V}),ut=(t=>{const{disabled:e,focusVisible:i,focusVisibleClassName:s,classes:r}=t,o=wn({root:["root",e&&"disabled",i&&"focusVisible"]},nd,r);return i&&s&&(o.root+=` ${s}`),o})(ht);return(0,Vc.jsxs)(ud,bn({as:at,className:xn(ut.root,n),ownerState:ht,onBlur:tt,onClick:_,onContextMenu:Y,onFocus:et,onKeyDown:rt,onKeyUp:ot,onMouseDown:H,onMouseLeave:q,onMouseUp:$,onDragLeave:K,onTouchEnd:Q,onTouchMove:J,onTouchStart:Z,ref:lt,tabIndex:h?-1:S,type:R},nt,B,{children:[a,j?(0,Vc.jsx)(ad,bn({ref:N,center:o},D)):null]}))})),dd=cd,pd=Mh;function fd(t){return Wc("MuiButton",t)}const _d=Hc("MuiButton",["root","text","textInherit","textPrimary","textSecondary","textSuccess","textError","textInfo","textWarning","outlined","outlinedInherit","outlinedPrimary","outlinedSecondary","outlinedSuccess","outlinedError","outlinedInfo","outlinedWarning","contained","containedInherit","containedPrimary","containedSecondary","containedSuccess","containedError","containedInfo","containedWarning","disableElevation","focusVisible","disabled","colorInherit","textSizeSmall","textSizeMedium","textSizeLarge","outlinedSizeSmall","outlinedSizeMedium","outlinedSizeLarge","containedSizeSmall","containedSizeMedium","containedSizeLarge","sizeMedium","sizeSmall","sizeLarge","fullWidth","startIcon","endIcon","iconSizeSmall","iconSizeMedium","iconSizeLarge"]);const gd=t.createContext({}),md=["children","color","component","className","disabled","disableElevation","disableFocusRipple","endIcon","focusVisibleClassName","fullWidth","size","startIcon","type","variant"],vd=t=>bn({},"small"===t.size&&{"& > *:nth-of-type(1)":{fontSize:18}},"medium"===t.size&&{"& > *:nth-of-type(1)":{fontSize:20}},"large"===t.size&&{"& > *:nth-of-type(1)":{fontSize:22}}),Pd=cc(dd,{shouldForwardProp:t=>hc(t)||"classes"===t,name:"MuiButton",slot:"Root",overridesResolver:(t,e)=>{const{ownerState:i}=t;return[e.root,e[i.variant],e[`${i.variant}${pd(i.color)}`],e[`size${pd(i.size)}`],e[`${i.variant}Size${pd(i.size)}`],"inherit"===i.color&&e.colorInherit,i.disableElevation&&e.disableElevation,i.fullWidth&&e.fullWidth]}})((({theme:t,ownerState:e})=>{var i,s;return bn({},t.typography.button,{minWidth:64,padding:"6px 16px",borderRadius:(t.vars||t).shape.borderRadius,transition:t.transitions.create(["background-color","box-shadow","border-color","color"],{duration:t.transitions.duration.short}),"&:hover":bn({textDecoration:"none",backgroundColor:t.vars?`rgba(${t.vars.palette.text.primaryChannel} / ${t.vars.palette.action.hoverOpacity})`:Ln(t.palette.text.primary,t.palette.action.hoverOpacity),"@media (hover: none)":{backgroundColor:"transparent"}},"text"===e.variant&&"inherit"!==e.color&&{backgroundColor:t.vars?`rgba(${t.vars.palette[e.color].mainChannel} / ${t.vars.palette.action.hoverOpacity})`:Ln(t.palette[e.color].main,t.palette.action.hoverOpacity),"@media (hover: none)":{backgroundColor:"transparent"}},"outlined"===e.variant&&"inherit"!==e.color&&{border:`1px solid ${(t.vars||t).palette[e.color].main}`,backgroundColor:t.vars?`rgba(${t.vars.palette[e.color].mainChannel} / ${t.vars.palette.action.hoverOpacity})`:Ln(t.palette[e.color].main,t.palette.action.hoverOpacity),"@media (hover: none)":{backgroundColor:"transparent"}},"contained"===e.variant&&{backgroundColor:(t.vars||t).palette.grey.A100,boxShadow:(t.vars||t).shadows[4],"@media (hover: none)":{boxShadow:(t.vars||t).shadows[2],backgroundColor:(t.vars||t).palette.grey[300]}},"contained"===e.variant&&"inherit"!==e.color&&{backgroundColor:(t.vars||t).palette[e.color].dark,"@media (hover: none)":{backgroundColor:(t.vars||t).palette[e.color].main}}),"&:active":bn({},"contained"===e.variant&&{boxShadow:(t.vars||t).shadows[8]}),[`&.${_d.focusVisible}`]:bn({},"contained"===e.variant&&{boxShadow:(t.vars||t).shadows[6]}),[`&.${_d.disabled}`]:bn({color:(t.vars||t).palette.action.disabled},"outlined"===e.variant&&{border:`1px solid ${(t.vars||t).palette.action.disabledBackground}`},"contained"===e.variant&&{color:(t.vars||t).palette.action.disabled,boxShadow:(t.vars||t).shadows[0],backgroundColor:(t.vars||t).palette.action.disabledBackground})},"text"===e.variant&&{padding:"6px 8px"},"text"===e.variant&&"inherit"!==e.color&&{color:(t.vars||t).palette[e.color].main},"outlined"===e.variant&&{padding:"5px 15px",border:"1px solid currentColor"},"outlined"===e.variant&&"inherit"!==e.color&&{color:(t.vars||t).palette[e.color].main,border:t.vars?`1px solid rgba(${t.vars.palette[e.color].mainChannel} / 0.5)`:`1px solid ${Ln(t.palette[e.color].main,.5)}`},"contained"===e.variant&&{color:t.vars?t.vars.palette.text.primary:null==(i=(s=t.palette).getContrastText)?void 0:i.call(s,t.palette.grey[300]),backgroundColor:(t.vars||t).palette.grey[300],boxShadow:(t.vars||t).shadows[2]},"contained"===e.variant&&"inherit"!==e.color&&{color:(t.vars||t).palette[e.color].contrastText,backgroundColor:(t.vars||t).palette[e.color].main},"inherit"===e.color&&{color:"inherit",borderColor:"currentColor"},"small"===e.size&&"text"===e.variant&&{padding:"4px 5px",fontSize:t.typography.pxToRem(13)},"large"===e.size&&"text"===e.variant&&{padding:"8px 11px",fontSize:t.typography.pxToRem(15)},"small"===e.size&&"outlined"===e.variant&&{padding:"3px 9px",fontSize:t.typography.pxToRem(13)},"large"===e.size&&"outlined"===e.variant&&{padding:"7px 21px",fontSize:t.typography.pxToRem(15)},"small"===e.size&&"contained"===e.variant&&{padding:"4px 10px",fontSize:t.typography.pxToRem(13)},"large"===e.size&&"contained"===e.variant&&{padding:"8px 22px",fontSize:t.typography.pxToRem(15)},e.fullWidth&&{width:"100%"})}),(({ownerState:t})=>t.disableElevation&&{boxShadow:"none","&:hover":{boxShadow:"none"},[`&.${_d.focusVisible}`]:{boxShadow:"none"},"&:active":{boxShadow:"none"},[`&.${_d.disabled}`]:{boxShadow:"none"}})),bd=cc("span",{name:"MuiButton",slot:"StartIcon",overridesResolver:(t,e)=>{const{ownerState:i}=t;return[e.startIcon,e[`iconSize${pd(i.size)}`]]}})((({ownerState:t})=>bn({display:"inherit",marginRight:8,marginLeft:-4},"small"===t.size&&{marginLeft:-2},vd(t)))),yd=cc("span",{name:"MuiButton",slot:"EndIcon",overridesResolver:(t,e)=>{const{ownerState:i}=t;return[e.endIcon,e[`iconSize${pd(i.size)}`]]}})((({ownerState:t})=>bn({display:"inherit",marginRight:-4,marginLeft:8},"small"===t.size&&{marginRight:-2},vd(t)))),xd=t.forwardRef((function(e,i){const s=t.useContext(gd),r=mc({props:Mn(s,e),name:"MuiButton"}),{children:o,color:a="primary",component:n="button",className:l,disabled:h=!1,disableElevation:u=!1,disableFocusRipple:c=!1,endIcon:d,focusVisibleClassName:p,fullWidth:f=!1,size:_="medium",startIcon:g,type:m,variant:v="text"}=r,P=Pn(r,md),b=bn({},r,{color:a,component:n,disabled:h,disableElevation:u,disableFocusRipple:c,fullWidth:f,size:_,type:m,variant:v}),y=(t=>{const{color:e,disableElevation:i,fullWidth:s,size:r,variant:o,classes:a}=t;return bn({},a,wn({root:["root",o,`${o}${pd(e)}`,`size${pd(r)}`,`${o}Size${pd(r)}`,"inherit"===e&&"colorInherit",i&&"disableElevation",s&&"fullWidth"],label:["label"],startIcon:["startIcon",`iconSize${pd(r)}`],endIcon:["endIcon",`iconSize${pd(r)}`]},fd,a))})(b),x=g&&(0,Vc.jsx)(bd,{className:y.startIcon,ownerState:b,children:g}),M=d&&(0,Vc.jsx)(yd,{className:y.endIcon,ownerState:b,children:d});return(0,Vc.jsxs)(Pd,bn({ownerState:b,className:xn(s.className,y.root,l),component:n,disabled:h,focusRipple:!c,focusVisibleClassName:xn(y.focusVisible,p),ref:i,type:m},P,{classes:y,children:[x,o,M]}))})),Md=xd;function wd(t){return Wc("MuiFormGroup",t)}Hc("MuiFormGroup",["root","row","error"]);const Ed=t.createContext(undefined);function Cd(){return t.useContext(Ed)}function Ad({props:t,states:e,muiFormControl:i}){return e.reduce(((e,s)=>(e[s]=t[s],i&&"undefined"==typeof t[s]&&(e[s]=i[s]),e)),{})}const Sd=["className","row"],Dd=cc("div",{name:"MuiFormGroup",slot:"Root",overridesResolver:(t,e)=>{const{ownerState:i}=t;return[e.root,i.row&&e.row]}})((({ownerState:t})=>bn({display:"flex",flexDirection:"column",flexWrap:"wrap"},t.row&&{flexDirection:"row"}))),Ld=t.forwardRef((function(t,e){const i=mc({props:t,name:"MuiFormGroup"}),{className:s,row:r=!1}=i,o=Pn(i,Sd),a=bn({},i,{row:r,error:Ad({props:i,muiFormControl:Cd(),states:["error"]}).error}),n=(t=>{const{classes:e,row:i,error:s}=t;return wn({root:["root",i&&"row",s&&"error"]},wd,e)})(a);return(0,Vc.jsx)(Dd,bn({className:xn(n.root,s),ownerState:a,ref:e},o))})),Rd=["sx"],Bd=t=>{var e,i;const s={systemProps:{},otherProps:{}},r=null!=(e=null==t||null==(i=t.theme)?void 0:i.unstable_sxConfig)?e:pu;return Object.keys(t).forEach((e=>{r[e]?s.systemProps[e]=t[e]:s.otherProps[e]=t[e]})),s};function Td(t){return Wc("MuiTypography",t)}Hc("MuiTypography",["root","h1","h2","h3","h4","h5","h6","subtitle1","subtitle2","body1","body2","inherit","button","caption","overline","alignLeft","alignRight","alignCenter","alignJustify","noWrap","gutterBottom","paragraph"]);const Fd=["align","className","component","gutterBottom","noWrap","paragraph","variant","variantMapping"],Nd=cc("span",{name:"MuiTypography",slot:"Root",overridesResolver:(t,e)=>{const{ownerState:i}=t;return[e.root,i.variant&&e[i.variant],"inherit"!==i.align&&e[`align${pd(i.align)}`],i.noWrap&&e.noWrap,i.gutterBottom&&e.gutterBottom,i.paragraph&&e.paragraph]}})((({theme:t,ownerState:e})=>bn({margin:0},e.variant&&t.typography[e.variant],"inherit"!==e.align&&{textAlign:e.align},e.noWrap&&{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},e.gutterBottom&&{marginBottom:"0.35em"},e.paragraph&&{marginBottom:16}))),Od={h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",h6:"h6",subtitle1:"h6",subtitle2:"h6",body1:"p",body2:"p",inherit:"p"},kd={primary:"primary.main",textPrimary:"text.primary",secondary:"secondary.main",textSecondary:"text.secondary",error:"error.main"},Id=t.forwardRef((function(t,e){const i=mc({props:t,name:"MuiTypography"}),s=(t=>kd[t]||t)(i.color),r=function(t){const{sx:e}=t,i=Pn(t,Rd),{systemProps:s,otherProps:r}=Bd(i);let o;return o=Array.isArray(e)?[s,...e]:"function"==typeof e?(...t)=>{const i=e(...t);return dh(i)?bn({},s,i):s}:bn({},s,e),bn({},r,{sx:o})}(bn({},i,{color:s})),{align:o="inherit",className:a,component:n,gutterBottom:l=!1,noWrap:h=!1,paragraph:u=!1,variant:c="body1",variantMapping:d=Od}=r,p=Pn(r,Fd),f=bn({},r,{align:o,color:s,className:a,component:n,gutterBottom:l,noWrap:h,paragraph:u,variant:c,variantMapping:d}),_=n||(u?"p":d[c]||Od[c])||"span",g=(t=>{const{align:e,gutterBottom:i,noWrap:s,paragraph:r,variant:o,classes:a}=t;return wn({root:["root",o,"inherit"!==t.align&&`align${pd(e)}`,i&&"gutterBottom",s&&"noWrap",r&&"paragraph"]},Td,a)})(f);return(0,Vc.jsx)(Nd,bn({as:_,ref:e,ownerState:f,className:xn(g.root,a)},p))})),zd=Id;function Vd(t){return Wc("MuiFormControlLabel",t)}const Ud=Hc("MuiFormControlLabel",["root","labelPlacementStart","labelPlacementTop","labelPlacementBottom","disabled","label","error"]),Gd=["checked","className","componentsProps","control","disabled","disableTypography","inputRef","label","labelPlacement","name","onChange","slotProps","value"],Xd=cc("label",{name:"MuiFormControlLabel",slot:"Root",overridesResolver:(t,e)=>{const{ownerState:i}=t;return[{[`& .${Ud.label}`]:e.label},e.root,e[`labelPlacement${pd(i.labelPlacement)}`]]}})((({theme:t,ownerState:e})=>bn({display:"inline-flex",alignItems:"center",cursor:"pointer",verticalAlign:"middle",WebkitTapHighlightColor:"transparent",marginLeft:-11,marginRight:16,[`&.${Ud.disabled}`]:{cursor:"default"}},"start"===e.labelPlacement&&{flexDirection:"row-reverse",marginLeft:16,marginRight:-11},"top"===e.labelPlacement&&{flexDirection:"column-reverse",marginLeft:16},"bottom"===e.labelPlacement&&{flexDirection:"column",marginLeft:16},{[`& .${Ud.label}`]:{[`&.${Ud.disabled}`]:{color:(t.vars||t).palette.text.disabled}}}))),jd=t.forwardRef((function(e,i){var s;const r=mc({props:e,name:"MuiFormControlLabel"}),{className:o,componentsProps:a={},control:n,disabled:l,disableTypography:h,label:u,labelPlacement:c="end",slotProps:d={}}=r,p=Pn(r,Gd),f=Cd();let _=l;void 0===_&&"undefined"!=typeof n.props.disabled&&(_=n.props.disabled),void 0===_&&f&&(_=f.disabled);const g={disabled:_};["checked","name","onChange","value","inputRef"].forEach((t=>{"undefined"==typeof n.props[t]&&"undefined"!=typeof r[t]&&(g[t]=r[t])}));const m=Ad({props:r,muiFormControl:f,states:["error"]}),v=bn({},r,{disabled:_,labelPlacement:c,error:m.error}),P=(t=>{const{classes:e,disabled:i,labelPlacement:s,error:r}=t;return wn({root:["root",i&&"disabled",`labelPlacement${pd(s)}`,r&&"error"],label:["label",i&&"disabled"]},Vd,e)})(v),b=null!=(s=d.typography)?s:a.typography;let y=u;return null==y||y.type===zd||h||(y=(0,Vc.jsx)(zd,bn({component:"span"},b,{className:xn(P.label,null==b?void 0:b.className),children:y}))),(0,Vc.jsxs)(Xd,bn({className:xn(P.root,o),ownerState:v,ref:i},p,{children:[t.cloneElement(n,g),y]}))}));const Wd=function({controlled:e,"default":i,name:s,state:r="value"}){const{current:o}=t.useRef(e!==undefined),[a,n]=t.useState(i);return[o?e:a,t.useCallback((t=>{o||n(t)}),[])]};function Hd(t){return Wc("PrivateSwitchBase",t)}Hc("PrivateSwitchBase",["root","checked","disabled","input","edgeStart","edgeEnd"]);const Yd=["autoFocus","checked","checkedIcon","className","defaultChecked","disabled","disableFocusRipple","edge","icon","id","inputProps","inputRef","name","onBlur","onChange","onFocus","readOnly","required","tabIndex","type","value"],Kd=cc(dd)((({ownerState:t})=>bn({padding:9,borderRadius:"50%"},"start"===t.edge&&{marginLeft:"small"===t.size?-3:-12},"end"===t.edge&&{marginRight:"small"===t.size?-3:-12}))),$d=cc("input")({cursor:"inherit",position:"absolute",opacity:0,width:"100%",height:"100%",top:0,left:0,margin:0,padding:0,zIndex:1}),qd=t.forwardRef((function(t,e){const{autoFocus:i,checked:s,checkedIcon:r,className:o,defaultChecked:a,disabled:n,disableFocusRipple:l=!1,edge:h=!1,icon:u,id:c,inputProps:d,inputRef:p,name:f,onBlur:_,onChange:g,onFocus:m,readOnly:v,required:P=!1,tabIndex:b,type:y,value:x}=t,M=Pn(t,Yd),[w,E]=Wd({controlled:s,"default":Boolean(a),name:"SwitchBase",state:"checked"}),C=Cd();let A=n;C&&void 0===A&&(A=C.disabled);const S="checkbox"===y||"radio"===y,D=bn({},t,{checked:w,disabled:A,disableFocusRipple:l,edge:h}),L=(t=>{const{classes:e,checked:i,disabled:s,edge:r}=t;return wn({root:["root",i&&"checked",s&&"disabled",r&&`edge${pd(r)}`],input:["input"]},Hd,e)})(D);return(0,Vc.jsxs)(Kd,bn({component:"span",className:xn(L.root,o),centerRipple:!0,focusRipple:!l,disabled:A,tabIndex:null,role:undefined,onFocus:t=>{m&&m(t),C&&C.onFocus&&C.onFocus(t)},onBlur:t=>{_&&_(t),C&&C.onBlur&&C.onBlur(t)},ownerState:D,ref:e},M,{children:[(0,Vc.jsx)($d,bn({autoFocus:i,checked:s,defaultChecked:a,className:L.input,disabled:A,id:S?c:undefined,name:f,onChange:t=>{if(t.nativeEvent.defaultPrevented)return;const e=t.target.checked;E(e),g&&g(t,e)},readOnly:v,ref:p,required:P,ownerState:D,tabIndex:b,type:y},"checkbox"===y&&x===undefined?{}:{value:x},d)),w?r:u]}))}));function Zd(t){return Wc("MuiSvgIcon",t)}Hc("MuiSvgIcon",["root","colorPrimary","colorSecondary","colorAction","colorError","colorDisabled","fontSizeInherit","fontSizeSmall","fontSizeMedium","fontSizeLarge"]);const Qd=["children","className","color","component","fontSize","htmlColor","inheritViewBox","titleAccess","viewBox"],Jd=cc("svg",{name:"MuiSvgIcon",slot:"Root",overridesResolver:(t,e)=>{const{ownerState:i}=t;return[e.root,"inherit"!==i.color&&e[`color${pd(i.color)}`],e[`fontSize${pd(i.fontSize)}`]]}})((({theme:t,ownerState:e})=>{var i,s,r,o,a,n,l,h,u,c,d,p,f,_,g,m,v;return{userSelect:"none",width:"1em",height:"1em",display:"inline-block",fill:"currentColor",flexShrink:0,transition:null==(i=t.transitions)||null==(s=i.create)?void 0:s.call(i,"fill",{duration:null==(r=t.transitions)||null==(o=r.duration)?void 0:o.shorter}),fontSize:{inherit:"inherit",small:(null==(a=t.typography)||null==(n=a.pxToRem)?void 0:n.call(a,20))||"1.25rem",medium:(null==(l=t.typography)||null==(h=l.pxToRem)?void 0:h.call(l,24))||"1.5rem",large:(null==(u=t.typography)||null==(c=u.pxToRem)?void 0:c.call(u,35))||"2.1875rem"}[e.fontSize],color:null!=(d=null==(p=(t.vars||t).palette)||null==(f=p[e.color])?void 0:f.main)?d:{action:null==(_=(t.vars||t).palette)||null==(g=_.action)?void 0:g.active,disabled:null==(m=(t.vars||t).palette)||null==(v=m.action)?void 0:v.disabled,inherit:undefined}[e.color]}})),tp=t.forwardRef((function(t,e){const i=mc({props:t,name:"MuiSvgIcon"}),{children:s,className:r,color:o="inherit",component:a="svg",fontSize:n="medium",htmlColor:l,inheritViewBox:h=!1,titleAccess:u,viewBox:c="0 0 24 24"}=i,d=Pn(i,Qd),p=bn({},i,{color:o,component:a,fontSize:n,instanceFontSize:t.fontSize,inheritViewBox:h,viewBox:c}),f={};h||(f.viewBox=c);const _=(t=>{const{color:e,fontSize:i,classes:s}=t;return wn({root:["root","inherit"!==e&&`color${pd(e)}`,`fontSize${pd(i)}`]},Zd,s)})(p);return(0,Vc.jsxs)(Jd,bn({as:a,className:xn(_.root,r),focusable:"false",color:l,"aria-hidden":!u||undefined,role:u?"img":undefined,ref:e},f,d,{ownerState:p,children:[s,u?(0,Vc.jsx)("title",{children:u}):null]}))}));tp.muiName="SvgIcon";const ep=tp;function ip(e,i){function s(t,s){return(0,Vc.jsx)(ep,bn({"data-testid":`${i}Icon`,ref:s},t,{children:e}))}return s.muiName=ep.muiName,t.memo(t.forwardRef(s))}const sp=ip((0,Vc.jsx)("path",{d:"M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"}),"CheckBoxOutlineBlank"),rp=ip((0,Vc.jsx)("path",{d:"M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V5c0-1.1-.89-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"}),"CheckBox"),op=ip((0,Vc.jsx)("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10H7v-2h10v2z"}),"IndeterminateCheckBox");function ap(t){return Wc("MuiCheckbox",t)}const np=Hc("MuiCheckbox",["root","checked","disabled","indeterminate","colorPrimary","colorSecondary"]),lp=["checkedIcon","color","icon","indeterminate","indeterminateIcon","inputProps","size","className"],hp=cc(qd,{shouldForwardProp:t=>hc(t)||"classes"===t,name:"MuiCheckbox",slot:"Root",overridesResolver:(t,e)=>{const{ownerState:i}=t;return[e.root,i.indeterminate&&e.indeterminate,"default"!==i.color&&e[`color${pd(i.color)}`]]}})((({theme:t,ownerState:e})=>bn({color:(t.vars||t).palette.text.secondary},!e.disableRipple&&{"&:hover":{backgroundColor:t.vars?`rgba(${"default"===e.color?t.vars.palette.action.activeChannel:t.vars.palette.primary.mainChannel} / ${t.vars.palette.action.hoverOpacity})`:Ln("default"===e.color?t.palette.action.active:t.palette[e.color].main,t.palette.action.hoverOpacity),"@media (hover: none)":{backgroundColor:"transparent"}}},"default"!==e.color&&{[`&.${np.checked}, &.${np.indeterminate}`]:{color:(t.vars||t).palette[e.color].main},[`&.${np.disabled}`]:{color:(t.vars||t).palette.action.disabled}}))),up=(0,Vc.jsx)(rp,{}),cp=(0,Vc.jsx)(sp,{}),dp=(0,Vc.jsx)(op,{}),pp=t.forwardRef((function(e,i){var s,r;const o=mc({props:e,name:"MuiCheckbox"}),{checkedIcon:a=up,color:n="primary",icon:l=cp,indeterminate:h=!1,indeterminateIcon:u=dp,inputProps:c,size:d="medium",className:p}=o,f=Pn(o,lp),_=h?u:l,g=h?u:a,m=bn({},o,{color:n,indeterminate:h,size:d}),v=(t=>{const{classes:e,indeterminate:i,color:s}=t;return bn({},e,wn({root:["root",i&&"indeterminate",`color${pd(s)}`]},ap,e))})(m);return(0,Vc.jsx)(hp,bn({type:"checkbox",inputProps:bn({"data-indeterminate":h},c),icon:t.cloneElement(_,{fontSize:null!=(s=_.props.fontSize)?s:d}),checkedIcon:t.cloneElement(g,{fontSize:null!=(r=g.props.fontSize)?r:d}),ownerState:m,ref:i,className:xn(v.root,p)},f,{classes:v}))})),fp=pp;function _p(t){return _p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_p(t)}function gp(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,s)}return i}function mp(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?gp(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):gp(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function vp(t,e,i){return(e=function(t){var e=function(t,e){if("object"!==_p(t)||null===t)return t;var i=t[Symbol.toPrimitive];if(i!==undefined){var s=i.call(t,e||"default");if("object"!==_p(s))return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"===_p(e)?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function Pp(t){return function(t){if(Array.isArray(t))return Ep(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||wp(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function bp(){bp=function(){return t};var t={},e=Object.prototype,i=e.hasOwnProperty,s=Object.defineProperty||function(t,e,i){t[e]=i.value},r="function"==typeof Symbol?Symbol:{},o=r.iterator||"@@iterator",a=r.asyncIterator||"@@asyncIterator",n=r.toStringTag||"@@toStringTag";function l(t,e,i){return Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{l({},"")}catch(S){l=function(t,e,i){return t[e]=i}}function h(t,e,i,r){var o=e&&e.prototype instanceof d?e:d,a=Object.create(o.prototype),n=new E(r||[]);return s(a,"_invoke",{value:y(t,i,n)}),a}function u(t,e,i){try{return{type:"normal",arg:t.call(e,i)}}catch(S){return{type:"throw",arg:S}}}t.wrap=h;var c={};function d(){}function p(){}function f(){}var _={};l(_,o,(function(){return this}));var g=Object.getPrototypeOf,m=g&&g(g(C([])));m&&m!==e&&i.call(m,o)&&(_=m);var v=f.prototype=d.prototype=Object.create(_);function P(t){["next","throw","return"].forEach((function(e){l(t,e,(function(t){return this._invoke(e,t)}))}))}function b(t,e){function r(s,o,a,n){var l=u(t[s],t,o);if("throw"!==l.type){var h=l.arg,c=h.value;return c&&"object"==_p(c)&&i.call(c,"__await")?e.resolve(c.__await).then((function(t){r("next",t,a,n)}),(function(t){r("throw",t,a,n)})):e.resolve(c).then((function(t){h.value=t,a(h)}),(function(t){return r("throw",t,a,n)}))}n(l.arg)}var o;s(this,"_invoke",{value:function(t,i){function s(){return new e((function(e,s){r(t,i,e,s)}))}return o=o?o.then(s,s):s()}})}function y(t,e,i){var s="suspendedStart";return function(r,o){if("executing"===s)throw new Error("Generator is already running");if("completed"===s){if("throw"===r)throw o;return A()}for(i.method=r,i.arg=o;;){var a=i.delegate;if(a){var n=x(a,i);if(n){if(n===c)continue;return n}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===s)throw s="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);s="executing";var l=u(t,e,i);if("normal"===l.type){if(s=i.done?"completed":"suspendedYield",l.arg===c)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(s="completed",i.method="throw",i.arg=l.arg)}}}function x(t,e){var i=e.method,s=t.iterator[i];if(undefined===s)return e.delegate=null,"throw"===i&&t.iterator["return"]&&(e.method="return",e.arg=undefined,x(t,e),"throw"===e.method)||"return"!==i&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+i+"' method")),c;var r=u(s,t.iterator,e.arg);if("throw"===r.type)return e.method="throw",e.arg=r.arg,e.delegate=null,c;var o=r.arg;return o?o.done?(e[t.resultName]=o.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=undefined),e.delegate=null,c):o:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,c)}function M(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function w(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function E(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(M,this),this.reset(!0)}function C(t){if(t){var e=t[o];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var s=-1,r=function e(){for(;++s<t.length;)if(i.call(t,s))return e.value=t[s],e.done=!1,e;return e.value=undefined,e.done=!0,e};return r.next=r}}return{next:A}}function A(){return{value:undefined,done:!0}}return p.prototype=f,s(v,"constructor",{value:f,configurable:!0}),s(f,"constructor",{value:p,configurable:!0}),p.displayName=l(f,n,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===p||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,f):(t.__proto__=f,l(t,n,"GeneratorFunction")),t.prototype=Object.create(v),t},t.awrap=function(t){return{__await:t}},P(b.prototype),l(b.prototype,a,(function(){return this})),t.AsyncIterator=b,t.async=function(e,i,s,r,o){void 0===o&&(o=Promise);var a=new b(h(e,i,s,r),o);return t.isGeneratorFunction(i)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},P(v),l(v,n,"Generator"),l(v,o,(function(){return this})),l(v,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var e=Object(t),i=[];for(var s in e)i.push(s);return i.reverse(),function r(){for(;i.length;){var t=i.pop();if(t in e)return r.value=t,r.done=!1,r}return r.done=!0,r}},t.values=C,E.prototype={constructor:E,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(w),!t)for(var e in this)"t"===e.charAt(0)&&i.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=undefined)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function s(i,s){return a.type="throw",a.arg=t,e.next=i,s&&(e.method="next",e.arg=undefined),!!s}for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r],a=o.completion;if("root"===o.tryLoc)return s("end");if(o.tryLoc<=this.prev){var n=i.call(o,"catchLoc"),l=i.call(o,"finallyLoc");if(n&&l){if(this.prev<o.catchLoc)return s(o.catchLoc,!0);if(this.prev<o.finallyLoc)return s(o.finallyLoc)}else if(n){if(this.prev<o.catchLoc)return s(o.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return s(o.finallyLoc)}}}},abrupt:function(t,e){for(var s=this.tryEntries.length-1;s>=0;--s){var r=this.tryEntries[s];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=t,a.arg=e,o?(this.method="next",this.next=o.finallyLoc,c):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),c},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e];if(i.finallyLoc===t)return this.complete(i.completion,i.afterLoc),w(i),c}},"catch":function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e];if(i.tryLoc===t){var s=i.completion;if("throw"===s.type){var r=s.arg;w(i)}return r}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,i){return this.delegate={iterator:C(t),resultName:e,nextLoc:i},"next"===this.method&&(this.arg=undefined),c}},t}function yp(t,e,i,s,r,o,a){try{var n=t[o](a),l=n.value}catch(h){return void i(h)}n.done?e(l):Promise.resolve(l).then(s,r)}function xp(t){return function(){var e=this,i=arguments;return new Promise((function(s,r){var o=t.apply(e,i);function a(t){yp(o,s,r,a,n,"next",t)}function n(t){yp(o,s,r,a,n,"throw",t)}a(undefined)}))}}function Mp(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var s,r,o,a,n=[],l=!0,h=!1;try{if(o=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(s=o.call(i)).done)&&(n.push(s.value),n.length!==e);l=!0);}catch(u){h=!0,r=u}finally{try{if(!l&&null!=i["return"]&&(a=i["return"](),Object(a)!==a))return}finally{if(h)throw r}}return n}}(t,e)||wp(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function wp(t,e){if(t){if("string"==typeof t)return Ep(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?Ep(t,e):void 0}}function Ep(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,s=new Array(e);i<e;i++)s[i]=t[i];return s}const Cp=function(e){var i=e.piral,s=i.getData("CONSTANTS"),r=Mp((0,t.useState)([]),2),o=r[0],a=r[1],n=Mp((0,t.useState)(""),2),l=(n[0],n[1],Mp((0,t.useState)([]),2)),h=l[0],u=l[1],c=Mp((0,t.useState)(300),2),d=c[0],p=(c[1],Mp((0,t.useState)({}),2)),f=p[0],_=p[1],g=Mp((0,t.useState)([]),2),m=g[0],v=g[1];function P(){return(P=xp(bp().mark((function t(){var e,r,o;return bp().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e=i.getData(s.ACTIVE_PROJECT),t.next=3,i.getResourcesByContentType(e,"https://www.iana.org/assignments/media-types/model/gltf+json");case 3:r=t.sent,o=r.map((function(t){return t.resource.value})),a(o);case 6:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function b(){return(b=xp(bp().mark((function t(e){var r,o,a,n,l,h;return bp().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r=i.getData(s.ACTIVE_PROJECT),o=[],a=0,n=Object.keys(f);case 3:if(!(a<n.length)){t.next=12;break}return l=n[a],t.next=7,i.getAllReferences(f[l],e,r);case 7:h=t.sent,o.push(h);case 9:a++,t.next=3;break;case 12:i.setDataGlobal(s.SELECTED_CONCEPTS,o.flat());case 13:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function y(t,e){console.log("model :>> ",e),v((function(t){return t.includes(e)?t.filter((function(t){return t!=e})):[].concat(Pp(t),[e])})),_((function(i){return Object.keys(i).includes(e)?(delete(t=mp({},i))[e],t):i}))}function x(t){return M.apply(this,arguments)}function M(){return M=xp(bp().mark((function t(e){var r,o;return bp().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=i.getData(s.ACTIVE_PROJECT),t.next=3,i.getAssociatedConcepts(e,r);case 3:o=t.sent,_((function(t){return mp(mp({},t),{},vp({},e,o))}));case 5:case"end":return t.stop()}}),t)}))),M.apply(this,arguments)}return(0,t.useEffect)((function(){var t=i.getData(s.SELECTED_CONCEPTS);if(t){var e=t.map((function(t){return t.references})).flat();e=e.filter((function(t){return m.includes(t.document)})).map((function(t){return t.identifier})),u(e)}}),[m]),i.on("store-data",function(){var t=xp(bp().mark((function e(t){var i,r,o;return bp().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=t.name,r=t.value,i===s.SELECTED_CONCEPTS&&(console.log("value :>> ",r),console.log("activeModels :>> ",m),o=r.map((function(t){var e=[];return t.references.forEach((function(t){console.log("ref :>> ",t),m.includes(t.document)&&e.push(t.identifier)})),e})).flat(),console.log("subset :>> ",o),u(o));case 2:case"end":return e.stop()}}),e)})));return function(e){return t.apply(this,arguments)}}()),t["default"].createElement("div",null,t["default"].createElement("div",null,t["default"].createElement(Md,{onClick:function(){return function(){return P.apply(this,arguments)}()}},"Get GlTF models in project")),t["default"].createElement(Ld,null,o.length?t["default"].createElement("div",null,o.map((function(e){return t["default"].createElement(jd,{key:e,control:t["default"].createElement(fp,{onChange:function(){var t=xp(bp().mark((function i(t){return bp().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return y(t,e),i.next=3,x(e);case 3:case"end":return i.stop()}}),i)})));return function(e){return t.apply(this,arguments)}}()}),label:e})}))):t["default"].createElement(t["default"].Fragment,null)),m.length?t["default"].createElement("div",null,t["default"].createElement(vn,{height:d,models:m,projection:"perspective",onSelect:function(t){return b.apply(this,arguments)},selection:h})):t["default"].createElement("div",null,t["default"].createElement("p",{style:{paddingTop:"10%"}},"No glTF models selected ")))};const Ap=function(e){var i=e.piral,s=i.getData("CONSTANTS");return t.createElement("div",{id:"viewer-module"},i.getData(s.ACTIVE_PROJECT)?t.createElement(Cp,Object.assign({},e)):t.createElement("div",null,t.createElement("p",null,"Please activate a project first")))};function Sp(t){var e=t.getData("CONSTANTS"),i=t.makeState(t,e)((function(e){var i=e.state,s=e.actions;return t.withState(Ap,{app:t,state:i,actions:s})}));t.showNotification("Hello from ".concat(t.meta.name," component!"),{autoClose:2e3}),t.registerTile(i,{initialColumns:t.meta.initialColumns,initialRows:t.meta.initialRows,resizable:!0}),t.registerExtension(t.meta.link,i)}})(),o})())}}}));
//# sourceMappingURL=index.js.map